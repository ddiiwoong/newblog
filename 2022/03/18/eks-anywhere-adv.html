<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.18">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="Act as a catalyst RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Act as a catalyst Atom Feed">
<link rel="alternate" type="application/json" href="/feed.json" title="Act as a catalyst JSON Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-4ZT898XDT2"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-4ZT898XDT2",{})</script>
<link rel="search" type="application/opensearchdescription+xml" title="Cloud Catalyst" href="/opensearch.xml">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4362752107119680" crossorigin="anonymous"></script><title data-rh="true">EKS Anywhere Advanced Usages | Cloud Catalyst</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://ddii.dev/2022/03/18/eks-anywhere-adv"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" name="naver-site-verification" content="cbcc03783e5594725d3951f4e7f16ede80e69881"><meta data-rh="true" property="og:title" content="EKS Anywhere Advanced Usages | Cloud Catalyst"><meta data-rh="true" name="description" content="EKS Anywhere 로 구성된 쿠버네티스 클러스터 활용 "><meta data-rh="true" property="og:description" content="EKS Anywhere 로 구성된 쿠버네티스 클러스터 활용 "><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2022-03-18T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://www.linkedin.com/in/ddiiwoong/"><meta data-rh="true" property="article:tag" content="Kubernetes,vsphere,eks anywhere,eks connector,eks,opentelemetry,cilium,observability,prometheus,grafana,loki,microservice,istio"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://ddii.dev/2022/03/18/eks-anywhere-adv"><link data-rh="true" rel="alternate" href="https://ddii.dev/2022/03/18/eks-anywhere-adv" hreflang="en"><link data-rh="true" rel="alternate" href="https://ddii.dev/2022/03/18/eks-anywhere-adv" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://J5EMWGFKQM-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.1e7a31ee.css">
<link rel="preload" href="/assets/js/runtime~main.fedfc763.js" as="script">
<link rel="preload" href="/assets/js/main.1aff5f87.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top navbarHideable_ObN2"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo_transparent.svg" alt="Cloud Catalyst" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/logo_transparent.svg" alt="Cloud Catalyst" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">Cloud Catalyst</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/">Posts</a><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" docid="intro" href="/docs/intro">Docs</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/intro">Intro</a></li></ul></div></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/tags">Tags</a><a class="navbar__item navbar__link" href="/presentation">Presentation</a><a class="navbar__item navbar__link" href="/archive">Archive</a><a class="navbar__item navbar__link" href="/about">About</a><a class="navbar__item navbar__link" href="/pang4u">Pang4u</a><a href="https://github.com/ddiiwoong/newblog" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_S7eR colorModeToggle_vKtC"><button class="clean-btn toggleButton_rCf9 toggleButtonDisabled_Pu9x" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_v35p"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_nQuB"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_qEbK"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_a9qW thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_uKok margin-bottom--md">Recent Posts</div><ul class="sidebarItemList_Kvuv"><li class="sidebarItem_CF0Q"><a aria-current="page" class="sidebarItemLink_miNk sidebarItemLinkActive_RRTD" href="/2022/03/18/eks-anywhere-adv">EKS Anywhere Advanced Usages</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2022/03/06/eks-anywhere">EKS Anywhere on vSphere Homelab</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2022/02/05/what-is-tailscale">What is Tailscale?</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2021/06/11/synology-prometheus">Synology monitoring with Prometheus and snmp exporter</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2020/12/06/vSphere-with-Tanzu-homelab-2">vSphere with Tanzu homelab running on ASUS PN50 (2/2)</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_rzP5" itemprop="headline">EKS Anywhere Advanced Usages</h1><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2022-03-18T00:00:00.000Z" itemprop="datePublished">March 18, 2022</time> · <!-- -->18 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://www.linkedin.com/in/ddiiwoong/" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://s.gravatar.com/avatar/e8bfebcbeacb5b9a0c90614e792febf2?s=80" alt="Jinwoong Kim"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/ddiiwoong/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jinwoong Kim</span></a></div><small class="avatar__subtitle" itemprop="description">Technologist and Cloud Consultant</small></div></div></div></div></header><div id="post-content" class="markdown" itemprop="articleBody"><p>지난글에 이어 이번에는 홈랩으로 구성한 EKS Anywhere 클러스터에서 운영, 개발환경 구성을 위한 여러가지 도구를 설치해보는 과정을 정리하고자 한다. </p><p>지난 포스팅은 다음 링크에서 확인할 수 있다.</p><blockquote><p>이전글 - <a href="https://ddii.dev/kubernetes/eks-anywhere/" target="_blank" rel="noopener noreferrer">vSphere homelab 환경에서 EKS Anywhere 구성하기</a></p></blockquote><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="eks-connector">EKS Connector<a class="hash-link" href="#eks-connector" title="Direct link to heading">​</a></h2><p>EKS Connector를 통해 EKS Anywhere를 포함한 외부의 모든 클러스터를 AWS 콘솔에 연결할 수 있다. eks connector 컨테이너를 통해 proxy 형태로 외부 쿠버네티스 클러스터의 API서버에서 정보를 가져와 AWS System Manager로 전달하는 비동기 방식으로 워크로드 관리를 진행한다.</p><ul><li>유저가이드 - <a href="https://docs.aws.amazon.com/eks/latest/userguide/eks-connector.html" target="_blank" rel="noopener noreferrer">https://docs.aws.amazon.com/eks/latest/userguide/eks-connector.html</a>  </li><li>AWS 블로그 - <a href="https://aws.amazon.com/blogs/containers/connect-any-kubernetes-cluster-to-amazon-eks/" target="_blank" rel="noopener noreferrer">https://aws.amazon.com/blogs/containers/connect-any-kubernetes-cluster-to-amazon-eks/</a></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="클러스터-등록">클러스터 등록<a class="hash-link" href="#클러스터-등록" title="Direct link to heading">​</a></h3><p><img loading="lazy" src="https://d2908q01vomqb2.cloudfront.net/fe2ef495a1152561572949784c16bf23abb28057/2021/09/15/Screen-Shot-2021-09-03-at-4.28.27-PM.png" alt="overview" class="img_E7b_"></p><p>EKS Anywhere를 포함한 외부 K8s 클러스터는 AWS CLI, eksctl, 콘솔을 사용해서 등록(register)이 가능하다. eksctl로 등록을 진행하면 먼저 관련된 Role을 생성해주고 또한 ClusterRole, ClusterRoleBinding 및 Connector StatefulSet을 배포할 수 있도록 자동으로 manifest를 생성해주기 때문에 eksctl로 클러스터 등록을 진행하는 것이 편하다. AWS Managed IAM 역할인 <code>AWSServiceRoleForAmazonEKSConnector</code>을 생성하는 과정을 진행하기 때문에 에러가 발생을 한다. 에러가 난 이후에 AWS 콘솔이나 CLI를 통해 확인하면 새롭게 생성된 <code>AWSServiceRoleForAmazonEKSConnector</code> IAM 역할과 해당 역할에 연결된 Policy인 <code>AmazonEKSConnectorServiceRolePolicy</code>를 확인할 수 있다. </p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; eksctl register cluster --name homelab --provider eks_anywhere --profile jinwoong</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-03-09 18:50:44 [ℹ]  creating IAM role &quot;eksctl-20220309185044427640&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-03-09 18:50:49 [ℹ]  deleting IAM role &quot;eksctl-20220309185044427640&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Error: error registering cluster: error calling RegisterCluster: ResourcePropagationDelayException: Service linked role &#x27;arn:aws:iam::492935017096:role/aws-service-role/eks-connector.amazonaws.com/AWSServiceRoleForAmazonEKSConnector&#x27; is propagating, please retry later.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>실패를 진행한 후에 다시 등록 시도를 하면 아래 출력로그와 같이 명령어를 실행한 디렉토리에 EKS Connector 관련 리소스 manifests(eks-connector.yaml,eks-connector-clusterrole.yaml,eks-connector-console-dashboard-full-access-group.yaml)를 확인할 수 있다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; eksctl register cluster --name homelab --provider eks_anywhere --profile jinwoong</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-03-08 22:59:15 [ℹ️]  creating IAM role &quot;eksctl-20220308225915739385&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-03-08 22:59:29 [ℹ️]  registered cluster &quot;homelab&quot; successfully</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-03-08 22:59:29 [ℹ️]  wrote file eks-connector.yaml to /Users/jinwoong/study/eks-anywhere-homelab</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-03-08 22:59:29 [ℹ️]  wrote file eks-connector-clusterrole.yaml to /Users/jinwoong/study/eks-anywhere-homelab</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-03-08 22:59:29 [ℹ️]  wrote file eks-connector-console-dashboard-full-access-group.yaml to /Users/jinwoong/study/eks-anywhere-homelab</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-03-08 22:59:29 [!]  note: &quot;eks-connector-clusterrole.yaml&quot; and &quot;eks-connector-console-dashboard-full-access-group.yaml&quot; give full EKS Console access to IAM identity &quot;arn:aws:iam::492935017096:user/jinwoong&quot;, edit if required; read https://docs.aws.amazon.com/eks/latest/userguide/connector-grant-access.html for more info</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-03-08 22:59:29 [ℹ️]  run kubectl apply -f eks-connector.yaml,eks-connector-clusterrole.yaml,eks-connector-console-dashboard-full-access-group.yaml before 11 Mar 22 13:59 UTC to connect the cluster</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>eks-connector.yaml 에는 <code>Namespace</code>, <code>Secret</code>, <code>Role</code>, <code>ServiceAccount</code>, <code>RoleBinding</code>, <code>ConfigMap</code>과 배포될 <code>StatefulSet</code> 이 담겨있어 해당 파일은 그대로 사용하면 된다.</p><p>하지만 실제 콘솔에서 노드와 워크로드 정보를 보기 위해서 eks-connector-console-dashboard-full-access-group.yaml에 콘솔 접속이 필요한 IAM 사용자와 접근을 위한 특정 네임스페이스 정보를 <code>ClusterRole</code> 및 <code>ClusterRoleBinding</code>에 추가해야 한다. </p><p>자세한 내용은 <a href="https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/connector-grant-access.html" target="_blank" rel="noopener noreferrer">https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/connector-grant-access.html</a>에서 확인이 가능하다. </p><p>위에서 생성된 manifests가 EKS Anywhere 클러스터에 적용되면 StatefulSet 형태로 배포된 EKS Connect 에이전트는 Amazon EventBridge를 통해 EKS에 알림을 보내는 System Manager 서비스에 연결한다. 이후 EKS Connect는 연결된 클러스터의 kubernetes API 서버에 EKS 콘솔 요청을 전달하므로 생성한 서비스 어카운트를 EKS Connect 역할과 연결하여 AWS IAM 엔티티를 가장(impersonate) 할 수있는 권한을 부여하게 된다. </p><p>statefulset을 좀더 살펴보면 위에서 이야기하는 에이전트 역할을 하는 <code>connector-agent</code> 와 프록시 역할을 하는 <code>connector-proxy</code> 컨테이너 두개가 떠있는걸 볼 수 있다. 사용자가 콘솔에서 해당 클러스터의 노드나 워크로드 정보를 조회하게 되면 EKS는 System Manager 서비스에게 세션을 요청하고 이후 System Manager가 비동기 방식으로 <code>connector-agent</code> 컨테이너를 invoke하면 <code>connector-proxy</code> 컨테이너 위에서 마운트된 서비스 어카운트로 인증을 하고 가장(impersonation)한 상태로 EKS Anywhere 클러스트의 API를 호출해서 관련된 내용을 가져와서 보여주게 된다.</p><p><img loading="lazy" src="https://d2908q01vomqb2.cloudfront.net/fe2ef495a1152561572949784c16bf23abb28057/2021/09/15/Screen-Shot-2021-09-05-at-7.51.33-AM.png" alt="connector" class="img_E7b_"></p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; kubectl describe statefulset eks-connector -n eks-connector</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Name:               eks-connector</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Namespace:          eks-connector</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CreationTimestamp:  Wed, 09 Mar 2022 22:53:23 +0900</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Selector:           app=eks-connector</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Labels:             app=eks-connector</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Annotations:        &lt;none&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Replicas:           2 desired | 2 total</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Update Strategy:    RollingUpdate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Partition:        0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Pods Status:        2 Running / 0 Waiting / 0 Succeeded / 0 Failed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Pod Template:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   connector-agent:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Image:      public.ecr.aws/amazon-ssm-agent/amazon-ssm-agent:3.1.90.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Port:       &lt;none&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Host Port:  &lt;none&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Environment:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      AWS_EC2_METADATA_DISABLED:  true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Mounts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      /etc/amazon/ssm/amazon-ssm-agent.json from eks-agent-config (rw,path=&quot;amazon-ssm-agent.json&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      /etc/amazon/ssm/seelog.xml from eks-agent-config (rw,path=&quot;seelog.xml&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      /var/eks/shared from eks-connector-shared (rw)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      /var/lib/amazon/ssm/Vault from eks-agent-vault (rw)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   connector-proxy:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Image:      public.ecr.aws/eks-connector/eks-connector:0.0.3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Port:       &lt;none&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Host Port:  &lt;none&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Args:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Environment:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      POD_NAME:   (v1:metadata.name)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Mounts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      /var/eks/shared from eks-connector-shared (rw)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      /var/lib/amazon/ssm/Vault from eks-agent-vault (rw)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      /var/run/secrets/kubernetes.io/serviceaccount from service-account-token (rw)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="istio-환경-구성">Istio 환경 구성<a class="hash-link" href="#istio-환경-구성" title="Direct link to heading">​</a></h2><p>Istio 환경에서 앱을 배포하고 Tracing 가시성 확보를 하는 실습을 진행하기 위해 간단하게 구성에 대한 그림을 그려봤다. </p><p><img loading="lazy" alt="istio" src="/assets/images/istio_o11y-120b56627de7c677da542503b0d01b49.png" width="1148" height="388" class="img_E7b_"></p><p>Istio 환경에서 sidecar 형태로 envoy proxy가 각 Observability 구성요소로 데이터가 전달되도록 구성한다. 이때 사용되는 오픈소스 스택은 다음과 같다.</p><ul><li><p>Tracing </p><ul><li>Collect : <a href="https://github.com/open-telemetry/opentelemetry-collector" target="_blank" rel="noopener noreferrer">OpenTelemetry Collector</a></li><li>Backend : <a href="https://github.com/grafana/tempo" target="_blank" rel="noopener noreferrer">Tempo</a></li></ul></li><li><p>Logging</p><ul><li>Collect : <a href="https://github.com/fluent/fluent-bit" target="_blank" rel="noopener noreferrer">Fluentbit</a></li><li>Backend : <a href="https://github.com/grafana/loki" target="_blank" rel="noopener noreferrer">Loki</a></li></ul></li><li><p>Metrics</p><ul><li>Collect : <a href="https://istio.io/latest/docs/ops/integrations/prometheus/" target="_blank" rel="noopener noreferrer">Exporters</a></li><li>Backend : <a href="https://github.com/prometheus" target="_blank" rel="noopener noreferrer">Prometheus</a></li></ul></li><li><p>Visualization</p><ul><li><a href="https://github.com/grafana/grafana" target="_blank" rel="noopener noreferrer">Grafana</a></li></ul></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="istio-설치">Istio 설치<a class="hash-link" href="#istio-설치" title="Direct link to heading">​</a></h3><p>IstioOperator를 통해 Istio를 설치한다.</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; istioctl operator init</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>IstioOperator가 설치되면 리소스를 배포하여 istio 서비스를 생성할 수 있다. envoy proxy에는 다양한 헤더들을 통해 trace 정보를 propagate 할 수 있다. 다음과 같이 <code>x-b3-traceid</code>를 traceid로 로그 포맷을 구성하도록 하고 trace 활성화를 위해 <code>enableTracing: true</code> 를 설정하고 Prometheus에서 스크랩을 할 수 있도록 <code>enablePrometheusMerge: true</code>로 설정한다.</p><p>마지막으로 zipkin 프로토콜로 OpenTelemetry Collector로 전달할것이기 엔드포인드 정보도 미리 작성했다.</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> install.istio.io/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> IstioOperator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> istio</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">operator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> istio</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">profile</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">meshConfig</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">accessLogFile</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /dev/stdout</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">accessLogFormat</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token scalar string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      [%START_TIME%] &quot;%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%&quot; %RESPONSE_CODE% %RESPONSE_FLAGS% %RESPONSE_CODE_DETAILS% %CONNECTION_TERMINATION_DETAILS% &quot;%UPSTREAM_TRANSPORT_FAILURE_REASON%&quot; %BYTES_RECEIVED% %BYTES_SENT% %DURATION% %RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)% &quot;%REQ(X-FORWARDED-FOR)%&quot; &quot;%REQ(USER-AGENT)%&quot; &quot;%REQ(X-REQUEST-ID)%&quot; &quot;%REQ(:AUTHORITY)%&quot; &quot;%UPSTREAM_HOST%&quot; %UPSTREAM_CLUSTER% %UPSTREAM_LOCAL_ADDRESS% %DOWNSTREAM_LOCAL_ADDRESS% %DOWNSTREAM_REMOTE_ADDRESS% %REQUESTED_SERVER_NAME% %ROUTE_NAME% traceID=%REQ(x-b3-traceid)%</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">enableTracing</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">enablePrometheusMerge</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">defaultConfig</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">tracing</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">sampling</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">max_path_tag_length</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">99999</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">zipkin</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">address</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> otel</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">collector.tracing.svc</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">9411</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Istio의 대표적인 샘플앱인 <a href="https://istio.io/latest/docs/examples/bookinfo/" target="_blank" rel="noopener noreferrer">bookinfo</a>를 <code>bookinfo</code> 네임스페이스에 설치한다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; kubectl create ns bookinfo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; kubectl label namespace bookinfo istio-injection=enabled --overwrite</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; kubectl apply -n bookinfo -f https://raw.githubusercontent.com/istio/istio/release-1.10/samples/bookinfo/platform/kube/bookinfo.yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>서비스 접근을 위한 <code>Gateway</code>와 <code>VirtualService</code> 도 구성한다. </p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> networking.istio.io/v1alpha3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Gateway</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> bookinfo</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">gateway</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> bookinfo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">selector</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">istio</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ingressgateway </span><span class="token comment" style="color:#999988;font-style:italic"># use istio default controller</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">servers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">number</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">protocol</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> HTTP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">hosts</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;*&quot;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Mind the hosts. This matches all</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> networking.istio.io/v1alpha3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> VirtualService</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> bookinfo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> bookinfo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">hosts</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;*&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">gateways</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> tracing/bookinfo</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">gateway</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> bookinfo</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">gateway</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">match</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">uri</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">prefix</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;/&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">route</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">destination</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">host</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> productpage.bookinfo.svc.cluster.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">number</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9080</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>서비스 확인을 위해 <code>LoadBalancer</code>로 구성된 istio-ingressgateway EXTERNAL-IP인 <a href="http://192.168.31.10/productpage" target="_blank" rel="noopener noreferrer">http://192.168.31.10/productpage</a>로 접속을 확인할 수 있다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">❯ kubectl get svc -n istio-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                   TYPE           CLUSTER-IP       EXTERNAL-IP     PORT(S)                                      AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio-ingressgateway   LoadBalancer   10.97.92.31      192.168.31.10   15021:30184/TCP,80:32738/TCP,443:31058/TCP   2d23h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istiod                 ClusterIP      10.107.186.201   &lt;none&gt;          15010/TCP,15012/TCP,443/TCP,15014/TCP        2d23h</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="metric-server-설치">metric-server 설치<a class="hash-link" href="#metric-server-설치" title="Direct link to heading">​</a></h2><p><a href="https://github.com/kubernetes-sigs/metrics-server" target="_blank" rel="noopener noreferrer">https://github.com/kubernetes-sigs/metrics-server</a></p><p>HPA 나 Kubernetes 대시보드를 활용하기 위해서 metric-server를 설치한다. kubelet tls 인증서 에러가 날 경우 설치 파일을 받아서 ARG에 <code>--kubelet-insecure-tls</code> 플래그를 추가해서 설치하면 된다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">serviceaccount/metrics-server created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clusterrole.rbac.authorization.k8s.io/system:aggregated-metrics-reader created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clusterrole.rbac.authorization.k8s.io/system:metrics-server created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rolebinding.rbac.authorization.k8s.io/metrics-server-auth-reader created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clusterrolebinding.rbac.authorization.k8s.io/metrics-server:system:auth-delegator created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clusterrolebinding.rbac.authorization.k8s.io/system:metrics-server created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service/metrics-server created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment.apps/metrics-server created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiservice.apiregistration.k8s.io/v1beta1.metrics.k8s.io created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; kubectl top nodes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME             CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">192.168.31.186   175m         9%     2228Mi          29%       </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">192.168.31.187   82m          4%     893Mi           11%       </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">192.168.31.188   64m          3%     795Mi           10%       </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">192.168.31.189   134m         6%     1817Mi          23%       </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">192.168.31.190   43m          2%     636Mi           8% </span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="observability-stack-설치">Observability Stack 설치<a class="hash-link" href="#observability-stack-설치" title="Direct link to heading">​</a></h2><p>차트로 일괄배포를 위해 <a href="https://github.com/grafana/helm-charts/tree/main/charts/loki-stack" target="_blank" rel="noopener noreferrer">Loki-stack</a>를 사용했고, 테스트를 위한 구성으로 구성 변경을 한 chart values는 다음과 같다. </p><ul><li><a href="https://github.com/prometheus" target="_blank" rel="noopener noreferrer">Prometheus</a> - 시계열 데이터(메트릭)을 수집하고 저장하는 프로젝트이며, 키-밸류 형태로 쿼리와 연산이 가능한 모니터링 시스템이다. node-exporter, alertmanager, pushgateway 도 차트로 같이 설치한다. </li><li><a href="https://github.com/grafana/grafana" target="_blank" rel="noopener noreferrer">Grafana</a> - 데이터를 시각화하는 플랫폼으로 다양한 로그, 메트릭, 트레이스 데이터를 시작화하고 알림 관리를 할 수 있다.</li><li><a href="https://github.com/grafana/loki" target="_blank" rel="noopener noreferrer">Loki</a> - 다른 로깅 시스템과 달리 로그를 제외한 메타데이터 인덱싱만 하기 때문에 Prometheus처럼 레이블을 염두에 두고 설계된 로깅 데이터스토어 시스템이다.</li><li><a href="https://github.com/fluent/fluent-bit" target="_blank" rel="noopener noreferrer">Fluent Bit</a> - 로깅 컬렉터(Collector)로 fluentd 보다 경량화되고 빠른 로그 프로세스이자 전달자(Forwarder)로 다른 로깅 컬렉터인 promtail, filebeat, logstash는 false로 설정한다. </li><li><a href="https://github.com/grafana/tempo" target="_blank" rel="noopener noreferrer">Tempo</a> - Tempo는 분산 추적(Tracing)을 위한 비용 효율적인 백엔드 데이터스토어 프로젝트로 위에서 구성한 Prometheus, Grafana, Loki 등과 같은 다른 Observability 프로젝트와 통합이 쉬운것이 특징이다.</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="prometheus-loki-설치">Prometheus, Loki 설치<a class="hash-link" href="#prometheus-loki-설치" title="Direct link to heading">​</a></h3><p><code>Prometheus</code>와 <code>Loki</code>는 Loki-Stack으로 구성한다. fluent-bit는 별도 구성 파일을 필요로 하기 때문에 나중에 설치할 예정이다. Prometheus는 Persistent Volume은 별도로 구성하지 않은 상태로 <code>persistentVolume</code>을 <code>false</code>로 설정하여 배포한다.</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; kubectl create ns tracing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; helm repo add grafana https://grafana.github.io/helm-charts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; helm repo update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; helm install loki grafana/loki-stack --version 2.4.1 -n tracing -f - &lt;&lt; &#x27;EOF&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fluent-bit:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  enabled: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">promtail:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  enabled: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  enabled: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  server:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    persistentVolume:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      enabled: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  alertmanager:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    persistentVolume:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      enabled: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p><code>Tempo</code>는 로그 정보와 tracing을 수신할 리시버 프로토콜 들(zipkin, otlp)을 정의한 채로 Chart로 배포한다. </p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">helm install tempo grafana/tempo --version 0.7.4 -n tracing -f - &lt;&lt; &#x27;EOF&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tempo:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  extraArgs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;distributor.log-received-traces&quot;: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  receivers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    zipkin:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    otlp:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      protocols:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        http:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        grpc:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="opentelemetry-collector-구성">OpenTelemetry Collector 구성<a class="hash-link" href="#opentelemetry-collector-구성" title="Direct link to heading">​</a></h3><p>이제까지 observability 관련 데이터 저장소들을 구성했으니 마지막으로 트레이싱을 위한 도구인 <a href="https://opentelemetry.io/docs/collector/getting-started/" target="_blank" rel="noopener noreferrer">OpenTelemetry Collector</a>를 설치한다. </p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ConfigMap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> otel</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">collector</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token key atrule" style="color:#00a4db">app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> opentelemetry</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token key atrule" style="color:#00a4db">component</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> otel</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">collector</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">data</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">otel-collector-config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token scalar string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">   receivers:   </span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">     zipkin:</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">        endpoint: 0.0.0.0:9411</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">   exporters:</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">     otlp:</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">       endpoint: tempo.tracing.svc.cluster.local:55680</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">       insecure: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">   service:</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">     pipelines:</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">       traces:</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">         receivers: [zipkin]</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">         exporters: [otlp]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>초기 Collect 구성 컨피그는 다름과 같이 설정했다. 자세한 설정 방법은 <a href="https://opentelemetry.io/docs/collector/configuration/" target="_blank" rel="noopener noreferrer">https://opentelemetry.io/docs/collector/configuration/</a>에서 확인가능하다.</p><ul><li><code>spec.config.receivers.zipkin.endpoint</code>는 trace정보를 받을 엔드포인트 구성으로 zipkin 포맷으로 수신한다. </li><li><code>spec.config.exporters[]</code>에서는 Tempo로 보내기 위한 endpoint 설정을 한다.</li><li><code>spec.config.service</code>에서는 이후 collector에서 사용할 protocol이나 backend datasource 에 대한 설정이며 반드시 활성화가 되어야 사용이 가능하다.  </li></ul><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> otel</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">collector</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> opentelemetry</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">component</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> otel</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">collector</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">ports</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> otlp </span><span class="token comment" style="color:#999988;font-style:italic"># Default endpoint for OpenTelemetry receiver.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">55680</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">protocol</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> TCP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">targetPort</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">55680</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> jaeger</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">grpc </span><span class="token comment" style="color:#999988;font-style:italic"># Default endpoint for Jaeger gRPC receiver</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14250</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> jaeger</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">thrift</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">http </span><span class="token comment" style="color:#999988;font-style:italic"># Default endpoint for Jaeger HTTP receiver.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14268</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> zipkin </span><span class="token comment" style="color:#999988;font-style:italic"># Default endpoint for Zipkin receiver.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9411</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> metrics </span><span class="token comment" style="color:#999988;font-style:italic"># Default endpoint for querying metrics.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8888</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> prometheus </span><span class="token comment" style="color:#999988;font-style:italic"># prometheus exporter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8889</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">selector</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">component</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> otel</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">collector</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Service에서 주료 사용하게될 포트는 <code>zipkin</code>의 <code>9411</code>이다.</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> apps/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> otel</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">collector</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> opentelemetry</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">component</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> otel</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">collector</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">selector</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">matchLabels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> opentelemetry</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">component</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> otel</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">collector</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">template</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> opentelemetry</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">component</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> otel</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">collector</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">containers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">command</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;/otelcontribcol&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;--config=/conf/otel-collector-config.yaml&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;--mem-ballast-size-mib=683&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;--log-level=DEBUG&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> otel/opentelemetry</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">collector</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">contrib</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">0.29.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> otel</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">collector</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">ports</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">containerPort</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">55679</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Default endpoint for ZPages.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">containerPort</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">55680</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Default endpoint for OpenTelemetry receiver.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">containerPort</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14250</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Default endpoint for Jaeger HTTP receiver.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">containerPort</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14268</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Default endpoint for Jaeger HTTP receiver.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">containerPort</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9411</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Default endpoint for Zipkin receiver.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">containerPort</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8888</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Default endpoint for querying metrics.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">containerPort</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8889</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># prometheus exporter       </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">volumeMounts</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> otel</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">collector</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">vol</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">mountPath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">volumes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">configMap</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> otel</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">collector</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">items</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> otel</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">collector</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> otel</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">collector</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">config.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> otel</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">collector</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">vol</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="fluentbit-구성">Fluentbit 구성<a class="hash-link" href="#fluentbit-구성" title="Direct link to heading">​</a></h3><p>클러스터 dataplane과 controlplane의 logging 데이터를 <code>Loki</code> 엔드포인트로 전달하기 위한 config로 확인하고 Chart를 배포한다. </p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; helm repo add fluent https://fluent.github.io/helm-charts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; helm repo update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; helm install fluent-bit fluent/fluent-bit --version 0.16.1 -n tracing -f - &lt;&lt; &#x27;EOF&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">logLevel: trace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">config:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  service: |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    [SERVICE]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Flush 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Daemon Off</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Log_Level trace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Parsers_File custom_parsers.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        HTTP_Server On</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        HTTP_Listen 0.0.0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        HTTP_Port {{ .Values.service.port }}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  inputs: |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    [INPUT]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Name tail</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Path /var/log/containers/*.log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Parser cri</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Tag kube.*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Mem_Buf_Limit 5MB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  outputs: |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    [OUTPUT]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        name loki</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        match *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        host loki.tracing.svc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        port 3100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tenant_id &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        labels job=fluentbit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        label_keys $trace_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        auto_kubernetes_labels on</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  customParsers: |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    [PARSER]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Name cri</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Format regex</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Regex ^(?&lt;time&gt;[^ ]+) (?&lt;stream&gt;stdout|stderr) (?&lt;logtag&gt;[^ ]*) (?&lt;message&gt;.*)$</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Time_Key    time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Time_Format %Y-%m-%dT%H:%M:%S.%L%z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>마지막으로 위 3가지 데이터소스(Prometheus, Loki, Tempo)가 등록된 상태의 <code>Grafana</code> Chart를 배포한다. </p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; helm install grafana grafana/grafana -n tracing --version 6.13.5  -f - &lt;&lt; &#x27;EOF&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">datasources:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  datasources.yaml:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    apiVersion: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    datasources:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - name: Tempo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        type: tempo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        access: browser</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        orgId: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        uid: tempo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        url: http://tempo.tracing.svc:3100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        isDefault: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        editable: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - name: Prometehus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        type: prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        access: browser</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        orgId: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        uid: prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        url: http://loki-prometheus-server.tracing.svc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        isDefault: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        editable: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - name: Loki</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        type: loki</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        access: browser</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        orgId: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        uid: loki</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        url: http://loki.tracing.svc:3100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        isDefault: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        editable: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        jsonData:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          derivedFields:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - datasourceName: Tempo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              matcherRegex: &quot;traceID=(\\w+)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              name: TraceID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              url: &quot;$${__value.raw}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              datasourceUid: tempo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">env:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  JAEGER_AGENT_PORT: 6831</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">adminUser: admin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">adminPassword: password</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type: LoadBalancer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="bookinfo-productpage-접속-및-trace-확인">bookinfo productpage 접속 및 trace 확인<a class="hash-link" href="#bookinfo-productpage-접속-및-trace-확인" title="Direct link to heading">​</a></h3><p><code>LoadBalancer</code>로 구성된 istio-ingressgateway EXTERNAL-IP인 <a href="http://192.168.31.10/productpage" target="_blank" rel="noopener noreferrer">http://192.168.31.10/productpage</a>로 접속하는 상태에서 trace를 확인할 수 있다.</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; ISTIOINGRESSGW=$(kubectl get pod -n istio-system -l app=istio-ingressgateway -o jsonpath=&#x27;{.items[0].status.hostIP}&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo -e &quot;PRODUCTPAGE UI URL = http://$ISTIOINGRESSGW/productpage&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PRODUCTPAGE UI URL = http://192.168.31.187/productpage</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; for i in {1..100};  do curl -s $ISTIOINGRESSGW/productpage | grep -o &quot;&lt;title&gt;.*&lt;/title&gt;&quot; ; done</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Grafana Explorer 메뉴에서 <code>Loki</code> 데이터소스를 선택하고 Log browser에 <code>{app=&quot;productpage&quot;}</code>를 입력하게 되면 하나의 트랜잭션에 대한 트레이스 정보를 로그내에서 확인하고 해당 traceid 버튼을 클릭하거나 <code>Tempo</code> 메뉴에서 탐색을 하면 관련된 trace 정보를 확인할 수 있다.</p><p><img loading="lazy" alt="tempo" src="/assets/images/tempo-grafana-efca4b49fa3a35fde86bb842172288e4.png" width="1920" height="1091" class="img_E7b_"></p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="정리">정리<a class="hash-link" href="#정리" title="Direct link to heading">​</a></h2><p>이번 포스팅에서는 eks-anywhere 클러스터에 여러가지 3rd party 구성요소들을 설치하고 실제 운영환경과 유사하게 테스트를 진행해봤다. EKS를 사용하는 관점에서 유사한 경험을 바탕으로 개발환경을 가져갈수 있기에 vSphere를 기반으로 사내 서비스를 개발하는 팀에게는 좋은 하나의 선택지가 추가되었다고 볼 수 있다. Direct Connect나 VPN과 같이 네트워크 연결성만 확보된다면 실제 기업환경에서는 AWS 네이티브 서비스와의 연계가 더 용이해지기 때문에 좋은 개발, 테스트 환경으로 다가갈 수 있을거라 생각한다.  </p><p>재미있는 경험이었고 당분간은 개인프로젝트를 진행하는 홈랩 환경은 EKS Anywhere로 정착해서 테스트를 계속 진행하려고 한다. </p><blockquote><p>해당 포스팅은 현재 재직중인 회사에 관련이 없고, 개인 역량 개발을 위한 자료로 활용할 예정입니다.</p></blockquote></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_h6_j"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/kubernetes">Kubernetes</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/vsphere">vsphere</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/eks-anywhere">eks anywhere</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/eks-connector">eks connector</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/eks">eks</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/opentelemetry">opentelemetry</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/cilium">cilium</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/observability">observability</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/prometheus">prometheus</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/grafana">grafana</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/loki">loki</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/microservice">microservice</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/istio">istio</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/ddiiwoong/newblog/tree/main/blog/2022-03-18-eks-anywhere-adv.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><div></div><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/2022/03/06/eks-anywhere"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">EKS Anywhere on vSphere Homelab</div></a></div></nav></main><div class="col col--2"><div class="tableOfContents_cNA8 thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#eks-connector" class="table-of-contents__link toc-highlight">EKS Connector</a><ul><li><a href="#클러스터-등록" class="table-of-contents__link toc-highlight">클러스터 등록</a></li></ul></li><li><a href="#istio-환경-구성" class="table-of-contents__link toc-highlight">Istio 환경 구성</a><ul><li><a href="#istio-설치" class="table-of-contents__link toc-highlight">Istio 설치</a></li></ul></li><li><a href="#metric-server-설치" class="table-of-contents__link toc-highlight">metric-server 설치</a></li><li><a href="#observability-stack-설치" class="table-of-contents__link toc-highlight">Observability Stack 설치</a><ul><li><a href="#prometheus-loki-설치" class="table-of-contents__link toc-highlight">Prometheus, Loki 설치</a></li><li><a href="#opentelemetry-collector-구성" class="table-of-contents__link toc-highlight">OpenTelemetry Collector 구성</a></li><li><a href="#fluentbit-구성" class="table-of-contents__link toc-highlight">Fluentbit 구성</a></li><li><a href="#bookinfo-productpage-접속-및-trace-확인" class="table-of-contents__link toc-highlight">bookinfo productpage 접속 및 trace 확인</a></li></ul></li><li><a href="#정리" class="table-of-contents__link toc-highlight">정리</a></li></ul></div></div></div></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Blog</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/">Home</a></li><li class="footer__item"><a class="footer__link-item" href="/archive">Archive</a></li><li class="footer__item"><a class="footer__link-item" href="/tags">Tags</a></li></ul></div><div class="col footer__col"><div class="footer__title">Sponsors</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/pang4u">Pang4U</a></li><li class="footer__item"><a href="https://ko-fi.com/ddiiwoong" target="_blank" rel="noopener noreferrer" class="footer__link-item">Buy Me a Coffee<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/ddiiwoong" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/ddiiwoong" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.facebook.com/ddiiwoong" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://kr.linkedin.com/in/ddiiwoong" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div></div></footer></div>
<script src="/assets/js/runtime~main.fedfc763.js"></script>
<script src="/assets/js/main.1aff5f87.js"></script>
</body>
</html>