---
layout: single
title: "Tetragon"
comments: true
classes: wide
description: "eBPF ê¸°ë°˜ Tetragonë¥¼ ì‚¬ìš©í•˜ì—¬ Kubernetes í´ëŸ¬ìŠ¤í„°ì˜ ë³´ì•ˆ ë° í”„ë¡œì„¸ìŠ¤ ëª¨ë‹ˆí„°ë§"
authors: jinwoong
toc: true
toc_label: Table of Contents
slug: kubernetes/tetragon
date: 2024-10-27
categories:
  - Kubernetes
tags:
  - Tetragon
  - eBPF
  - security
  - kernel
  - kubernetes
  - systemcall
---

> í•´ë‹¹ í¬ìŠ¤íŒ…ì€ í˜„ì¬ ì¬ì§ì¤‘ì¸ íšŒì‚¬ì— ê´€ë ¨ì´ ì—†ê³ , ê°œì¸ ì—­ëŸ‰ ê°œë°œì„ ìœ„í•œ ìŠ¤í„°ë”” ìë£Œë¡œ í™œìš©í•  ì˜ˆì •ì…ë‹ˆë‹¤.

## Tetragon

Tetragonë¥¼ ì‚¬ìš©í•˜ì—¬ Kubernetes í´ëŸ¬ìŠ¤í„°ì˜ ë³´ì•ˆ ë° í”„ë¡œì„¸ìŠ¤ ëª¨ë‹ˆí„°ë§ì„ ìˆ˜í–‰í•˜ëŠ” ë°©ë²•ì— ëŒ€í•´ ê°„ë‹¨íˆ ì•Œì•„ë³´ì.

### Tetragonì´ë€ ë¬´ì—‡ì¸ê°€?

##### ê·¸ë¦¼ ì¶œì²˜: https://isovalent.com/blog/post/2022-05-16-tetragon/
![tetragon](https://isovalent.wpengine.com/wp-content/uploads/2022/06/enforcement2.png) 

[https://tetragon.io/](https://tetragon.io/)

Tetragonì€ eBPF(extended Berkeley Packet Filter)ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•˜ëŠ” ê°•ë ¥í•œ ë³´ì•ˆ ë° ëª¨ë‹ˆí„°ë§ ë„êµ¬ì´ë‹¤. eBPFëŠ” ì»¤ë„ ë ˆë²¨ì—ì„œ ì‹¤í–‰ë˜ëŠ” í”„ë¡œê·¸ë¨ìœ¼ë¡œ, ì‹œìŠ¤í…œ ì„±ëŠ¥ì— ìµœì†Œí•œì˜ ì˜í–¥ì„ ì£¼ë©´ì„œ ì‹¤ì‹œê°„ìœ¼ë¡œ ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•˜ê³  ì²˜ë¦¬í•  ìˆ˜ ìˆë‹¤. Tetragonì€ ì´ë¥¼ í™œìš©í•˜ì—¬ Kubernetes í™˜ê²½ì—ì„œ ë„¤íŠ¸ì›Œí¬ íŠ¸ë˜í”½, ì‹œìŠ¤í…œ í˜¸ì¶œ, ì»¨í…Œì´ë„ˆ í™œë™ ë“±ì„ ëª¨ë‹ˆí„°ë§í•˜ê³  ë¶„ì„í•  ìˆ˜ ìˆë‹¤.





<!--truncate-->

### Tetragonì€ ë°˜ë“œì‹œ Ciliumì´ ìˆì–´ì•¼ í•˜ë‚˜?

Tetragonì€ eBPFë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•œ ê°•ë ¥í•œ ë³´ì•ˆ ë° ëª¨ë‹ˆí„°ë§ ë„êµ¬ë¡œ, Kubernetes í™˜ê²½ì—ì„œì˜ ë°ì´í„° ìˆ˜ì§‘ ë° ë¶„ì„ì— ìµœì í™”ë˜ì–´ ìˆë‹¤. ê·¸ëŸ¬ë‚˜ Tetragonì„ ì‚¬ìš©í•˜ê¸° ìœ„í•´ ë°˜ë“œì‹œ Ciliumì´ í•„ìš”í•˜ì§€ëŠ” ì•Šë‹¤. 

Ciliumì€ Kubernetes í´ëŸ¬ìŠ¤í„°ì—ì„œ ë„¤íŠ¸ì›Œí¬ ì •ì±…ì„ ê´€ë¦¬í•˜ê³ , eBPFë¥¼ í™œìš©í•˜ì—¬ ì„±ëŠ¥ì„ ìµœì í™”í•˜ëŠ” CNI(ì»¨í…Œì´ë„ˆ ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤) í”ŒëŸ¬ê·¸ì¸ì´ë‹¤. Tetragonì€ Ciliumê³¼ í•¨ê»˜ ì‚¬ìš©í•  ë•Œ ê·¸ ê¸°ëŠ¥ì´ ë”ìš± ê°•í™”ë˜ì§€ë§Œ, Cilium ì—†ì´ë„ Tetragonì˜ ê¸°ë³¸ì ì¸ ê¸°ëŠ¥ì„ í™œìš©í•  ìˆ˜ ìˆë‹¤.

Ciliumì„ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ê²½ìš°, Tetragonì€ ì—¬ì „íˆ eBPFë¥¼ í†µí•´ ì‹œìŠ¤í…œ í˜¸ì¶œ, ë„¤íŠ¸ì›Œí¬ íŠ¸ë˜í”½, ì»¨í…Œì´ë„ˆ í™œë™ ë“±ì„ ëª¨ë‹ˆí„°ë§í•  ìˆ˜ ìˆë‹¤. ê·¸ëŸ¬ë‚˜ Ciliumì„ ì‚¬ìš©í•˜ë©´ Tetragonì˜ ì„±ëŠ¥ê³¼ í†µí•©ì„±ì´ í–¥ìƒë˜ë©°, ë³´ë‹¤ ì •êµí•œ ë„¤íŠ¸ì›Œí¬ ì •ì±…ì„ ì ìš©í•  ìˆ˜ ìˆëŠ” ì¥ì ì´ ìˆë‹¤.

ê²°ë¡ ì ìœ¼ë¡œ, Tetragonì€ Ciliumê³¼ í•¨ê»˜ ì‚¬ìš©í•  ë•Œ ìµœìƒì˜ ì„±ëŠ¥ì„ ë°œíœ˜í•˜ì§€ë§Œ, Cilium ì—†ì´ë„ ìœ ìš©í•˜ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ë„êµ¬ì´ë‹¤. ì‚¬ìš©ìì˜ í•„ìš”ì™€ í™˜ê²½ì— ë”°ë¼ ì ì ˆí•œ ì„ íƒì„ í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•˜ë‹¤.

## Tetragon ì„¤ì¹˜ ë° ì„¤ì •

### ìš”êµ¬ ì‚¬í•­ ë° í…ŒìŠ¤íŠ¸ í™˜ê²½
- Kubernetes í´ëŸ¬ìŠ¤í„° : Kind 1.31.0
- Helm 3
- Kubectl
- jq

### Kind ì„¤ì¹˜
Tetragonê°€ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•˜ë ¤ë©´ í˜¸ìŠ¤íŠ¸ /proc íŒŒì¼ ì‹œìŠ¤í…œì— ëŒ€í•œ ì•¡ì„¸ìŠ¤ ê¶Œí•œì´ ìˆì–´ì•¼ í•œë‹¤. Kind í´ëŸ¬ìŠ¤í„°ëŠ” ë‹¤ìŒ ëª…ë ¹ì„ í†µí•´ ì¼ ë…¸ë“œ í´ëŸ¬ìŠ¤í„°ë¥¼ ì‚¬ìš©í•œë‹¤ê³  ê°€ì •í•œë‹¤. 

```yaml
cat <<EOF > kind-config.yaml
apiVersion: kind.x-k8s.io/v1alpha4
kind: Cluster
nodes:
  - role: control-plane
    extraMounts:
      - hostPath: /proc
        containerPath: /procHost
EOF
kind create cluster --config kind-config.yaml

Creating cluster "kind" ...
 âœ“ Ensuring node image (kindest/node:v1.31.0) ğŸ–¼
 âœ“ Preparing nodes ğŸ“¦
 âœ“ Writing configuration ğŸ“œ
 âœ“ Starting control-plane ğŸ•¹ï¸
 âœ“ Installing CNI ğŸ”Œ
 âœ“ Installing StorageClass ğŸ’¾
Set kubectl context to "kind-kind"
You can now use your cluster with:

kubectl cluster-info --context kind-kind
```

### Tetragon ì„¤ì¹˜

ê¸°ë³¸ì ìœ¼ë¡œ Tetragonì€ ì´ë²¤íŠ¸ ë¡œê·¸ì˜ ë…¸ì´ì¦ˆë¥¼ ì¤„ì´ê¸° ìœ„í•´ kube-system ì´ë²¤íŠ¸ë¥¼ í•„í„°ë§í•œë‹¤. ê·¸ë¦¬ê³  ìœ„ì—ì„œ ì´ì•¼ê¸° í–ˆë˜ ê²ƒì²˜ëŸ¼ `proc` í˜¸ìŠ¤íŠ¸ íŒ¨ìŠ¤ë¥¼ í´ëŸ¬ìŠ¤í„° ë‚´ íŒ¨ìŠ¤ë¡œ ì„¤ì •í•˜ì—¬ `helm`ìœ¼ë¡œ ë°°í¬í•œë‹¤. ì„¤ì¹˜ê°€ ì™„ë£Œë˜ë©´ Tetragonì´ Kubernetes í´ëŸ¬ìŠ¤í„°ì— ë°°í¬ë˜ê³ , eBPF ê¸°ë°˜ì˜ ëª¨ë‹ˆí„°ë§ì´ ì‹œì‘ëœë‹¤.

```bash
EXTRA_HELM_FLAGS=(--set tetragon.hostProcPath=/procHost)
helm repo add cilium https://helm.cilium.io
helm repo update
helm install tetragon ${EXTRA_HELM_FLAGS[@]} cilium/tetragon -n kube-system
kubectl rollout status -n kube-system ds/tetragon -w

"cilium" has been added to your repositories
Hang tight while we grab the latest from your chart repositories...
...Successfully got an update from the "cilium" chart repository
Update Complete. âˆHappy Helming!âˆ
NAME: tetragon
LAST DEPLOYED: Sun Oct 27 00:56:55 2024
NAMESPACE: kube-system
STATUS: deployed
REVISION: 1
TEST SUITE: None
Waiting for daemon set "tetragon" rollout to finish: 0 of 1 updated pods are available...
daemon set "tetragon" successfully rolled out
```

### ìƒ˜í”Œ ì•± ë°°í¬

Tetragonì„ íƒìƒ‰í•˜ê¸° ìœ„í•´ ìƒ˜í”Œ ì›Œí¬ë¡œë“œê°€ í•„ìš”í•˜ë‹¤. ì—¬ê¸°ì„œëŠ” Ciliumì˜ ë°ëª¨ë¡œ ì£¼ë¡œ ì‚¬ìš©ë˜ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ `StarWars`ì„ ì‚¬ìš©í•  ì˜ˆì •ì´ë‹¤.

```bash
kubectl create -f https://raw.githubusercontent.com/cilium/cilium/v1.15.3/examples/minikube/http-sw-app.yaml
```

ë°°í¬ëœ ë¦¬ì†ŒìŠ¤ëŠ” ë‹¤ìŒê³¼ ìœ ì‚¬í•  ê²ƒì´ë‹¤.

```bash
kubectl get pods
NAME                        READY   STATUS    RESTARTS   AGE
deathstar-bf77cddc9-nz5sc   1/1     Running   0          2m51s
deathstar-bf77cddc9-sd2s8   1/1     Running   0          2m51s
tiefighter                  1/1     Running   0          2m51s
xwing                       1/1     Running   0          2m51s
```

Tetragon ë°ëª¬ ì„¸íŠ¸ê°€ ì¤€ë¹„ë˜ê³  íŒŒë“œê°€ ì‹¤í–‰ ì¤‘ì¸ ìƒíƒœê°€ ë˜ë©´, ë…¸ë“œì—ì„œ ì´ë²¤íŠ¸ ìˆ˜ì‹ ì„ ì‹œì‘í•  ìˆ˜ ìˆë‹¤. ë°”ë¡œ í”„ë¡œì„¸ìŠ¤ ì‹¤í–‰ì„ ëª¨ë‹ˆí„°ë§í•  ìˆ˜ ìˆê³ , Tetragonì€ ì¼ì¹˜í•˜ëŠ” ì´ë²¤íŠ¸ë¥¼ JSON í˜•ì‹ìœ¼ë¡œ ë‚´ë³´ë‚¸ë‹¤. ë‹¤ìŒ ëª…ë ¹ì„ í†µí•´ ë¡œê·¸ë¥¼ í™•ì¸ í•  ìˆ˜ ìˆë‹¤. 

```json
kubectl logs -n kube-system -l app.kubernetes.io/name=tetragon -c export-stdout -f | jq
{
  "process_exec": {
    "process": {
      "exec_id": "a2luZC1jb250cm9sLXBsYW5lOjc5MTM2NDIxODQwMjoxMjU5Mg==",
      "pid": 12592,
      "uid": 0,
      "cwd": "/run/containerd/io.containerd.runtime.v2.task/k8s.io/e1216138dabb7071aa17679a52b05f9cad566ffbf89f0a090c385fc0af644242/rootfs",
      "binary": "/kind/bin/mount-product-files.sh",
      "arguments": "/kind/bin/mount-product-files.sh",
      "flags": "execve clone",
      "start_time": "2024-10-26T16:02:01.948430838Z",
      "auid": 4294967295,
      "pod": {
        "namespace": "default",
        "name": "xwing",
        "container": {
          "id": "containerd://e1216138dabb7071aa17679a52b05f9cad566ffbf89f0a090c385fc0af644242",
          "name": "spaceship",
          "image": {
            "id": "quay.io/cilium/json-mock@sha256:5aad04835eda9025fe4561ad31be77fd55309af8158ca8663a72f6abb78c2603",
            "name": "sha256:56b43d7e51feffe637c2837a8c70da02be98a51099533f288c78fa369f5c6991"
          },
          "start_time": "2024-10-26T16:02:01Z",
          "pid": 7
        },
        "pod_labels": {
          "app.kubernetes.io/name": "xwing",
          "class": "xwing",
          "org": "alliance"
        },
        "workload": "xwing",
        "workload_kind": "Pod"
      },
      "docker": "e1216138dabb7071aa17679a52b05f9",
      "parent_exec_id": "a2luZC1jb250cm9sLXBsYW5lOjc5MTM1ODgxNDg2MToxMjU4Ng==",
      "tid": 12592
    },
    "parent": {
      "exec_id": "a2luZC1jb250cm9sLXBsYW5lOjc5MTM1ODgxNDg2MToxMjU4Ng==",
      "pid": 12586,
      "uid": 0,
      "cwd": "/run/containerd/io.containerd.runtime.v2.task/k8s.io/6b1f9e099116975f55078e5ff88ffd9cef985d871c1c1ff4c7af8e85398f2557",
      "binary": "/usr/local/sbin/runc",
      "arguments": "--root /run/containerd/runc/k8s.io --log /run/containerd/io.containerd.runtime.v2.task/k8s.io/e1216138dabb7071aa17679a52b05f9cad566ffbf89f0a090c385fc0af644242/log.json --log-format json --systemd-cgroup create --bundle /run/containerd/io.containerd.runtime.v2.task/k8s.io/e1216138dabb7071aa17679a52b05f9cad566ffbf89f0a090c385fc0af644242 --pid-file /run/containerd/io.containerd.runtime.v2.task/k8s.io/e1216138dabb7071aa17679a52b05f9cad566ffbf89f0a090c385fc0af644242/init.pid e1216138dabb7071aa17679a52b05f9cad566ffbf89f0a090c385fc0af644242",
      "flags": "execve",
      "start_time": "2024-10-26T16:02:01.943027380Z",
      "auid": 4294967295,
      "parent_exec_id": "a2luZC1jb250cm9sLXBsYW5lOjc5MTMzMTE2MDIzNjoxMjU3Ng==",
      "refcnt": 1,
      "tid": 12586
    }
  },
  "node_name": "kind-control-plane",
  "time": "2024-10-26T16:02:01.948430629Z"
}
...
```

ìœ„ ë¡œê·¸ëŠ” Tetragonì´ í´ëŸ¬ìŠ¤í„°ì—ì„œ ì‹¤í–‰ ì¤‘ì¸ í”„ë¡œì„¸ìŠ¤ì— ëŒ€í•œ ì •ë³´ë¥¼ JSON í˜•ì‹ìœ¼ë¡œ ì¶œë ¥í•œ ê²ƒì´ë‹¤. 

Tetragonì„ ì‚¬ìš©í•˜ì—¬ í´ëŸ¬ìŠ¤í„° ë‚´ì—ì„œ ì‹¤í–‰ë˜ëŠ” ëª¨ë“  í”„ë¡œì„¸ìŠ¤ë¥¼ ëª¨ë‹ˆí„°ë§í•  ìˆ˜ ìˆë‹¤. í•´ë‹¹ json ë¡œê·¸ëŠ” Tetragonì´ í”„ë¡œì„¸ìŠ¤ ì‹¤í–‰ì„ ëª¨ë‹ˆí„°ë§í•˜ê³  ìˆìœ¼ë©°, ê° í”„ë¡œì„¸ìŠ¤ì™€ ê´€ë ¨ëœ ìƒì„¸ ì •ë³´(ì»¨í…Œì´ë„ˆ, íŒŒë“œ, ë¶€ëª¨ í”„ë¡œì„¸ìŠ¤)ë¥¼ ì œê³µí•œë‹¤. ì´ë¥¼ í†µí•´ ë³´ì•ˆ ë° ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆëŠ”ê²ƒì´ Tetragonì˜ ê¸°ë³¸ ë™ì‘ ë°©ì‹ì´ë‹¤.


## Tetragon ì‚¬ìš© ì˜ˆì‹œ

### tetra CLI ì‚¬ìš©
Tetragon CLIì¸ `tetra`ì€ pod, host, namespace ë˜ëŠ” processë³„ë¡œ ì´ë²¤íŠ¸ë¥¼ í•„í„°ë§í•˜ëŠ” ë° ìœ ìš©í•˜ë‹¤. tetra CLIëŠ” [GitHub ë¦´ë¦¬ìŠ¤ í˜ì´ì§€](https://github.com/cilium/tetragon/releases)ì—ì„œ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆë‹¤. CLIë¥¼ ì‹¤í–‰í•  ì›Œí¬ìŠ¤í…Œì´ì…˜ì— Goê°€ ì„¤ì¹˜ë˜ì–´ ìˆëŠ” ê²½ìš°ì—ëŠ”, ë‹¤ìŒ ëª…ë ¹ì„ ì‚¬ìš©í•˜ì—¬ ë‹¤ìš´ë¡œë“œí•˜ê³  ì„¤ì¹˜í•  ìˆ˜ ìˆë‹¤.

```bash
GOOS=$(go env GOOS)
GOARCH=$(go env GOARCH)
curl -L --remote-name-all https://github.com/cilium/tetragon/releases/latest/download/tetra-${GOOS}-${GOARCH}.tar.gz{,.sha256sum}
sha256sum --check tetra-${GOOS}-${GOARCH}.tar.gz.sha256sum
sudo tar -C /usr/local/bin -xzvf tetra-${GOOS}-${GOARCH}.tar.gz
rm tetra-${GOOS}-${GOARCH}.tar.gz{,.sha256sum}
```

tetra CLIê°€ ì„¤ì¹˜ëœ í›„ JSON ì¶œë ¥ì„ tetra geteventsì— ì „ë‹¬í•˜ì—¬ `-o compact` ì˜µì…˜ì„ í†µí•´ ê°€ë…ì„± ìˆê²Œ ì´ë²¤íŠ¸ë¥¼ í™•ì¸ í•  ìˆ˜ ìˆë‹¤. ë§Œì•½ íŠ¹ì • ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì˜ ì´ë²¤íŠ¸ë§Œ í™•ì¸í•˜ëŠ” ë“±ì˜ ë³„ë„ì˜ í”Œë˜ê·¸ë¥¼ í†µí•´ í•„í„°ë§ í•  ìˆ˜ ìˆë‹¤. 

```bash
kubectl logs -n kube-system ds/tetragon -c export-stdout -f | tetra getevents -o compact

ğŸš€ process default/xwing /kind/bin/mount-product-files.sh /kind/bin/mount-product-files.sh
ğŸš€ process default/xwing /usr/bin/jq -r .bundle
ğŸ’¥ exit    default/xwing /usr/bin/jq -r .bundle 0
ğŸš€ process default/xwing /usr/bin/cp /kind/product_uuid /run/containerd/io.containerd.runtime.v2.task/k8s.io/e1216138dabb7071aa17679a52b05f9cad566ffbf89f0a090c385fc0af644242/rootfs/
ğŸ’¥ exit    default/xwing /usr/bin/cp /kind/product_uuid /run/containerd/io.containerd.runtime.v2.task/k8s.io/e1216138dabb7071aa17679a52b05f9cad566ffbf89f0a090c385fc0af644242/rootfs/ 0
ğŸ’¥ exit    default/xwing /kind/bin/mount-product-files.sh /kind/bin/mount-product-files.sh 0
ğŸš€ process default/xwing /usr/bin/bash /run.sh
ğŸš€ process default/xwing /usr/bin/tini -- /usr/local/bin/json-server --host  --port 80 --watch /default.json --middlewares /middleware.js
ğŸš€ process default/xwing /usr/local/bin/json-server node /usr/local/bin/json-server --host  --port 80 --watch /default.json --middlewares /middleware.js
ğŸš€ process default/xwing /usr/local/bin/node /usr/local/bin/json-server --host  --port 80 --watch /default.json --middlewares /middleware.js
```

### íŒŒì¼ ì‹œìŠ¤í…œ ì•¡ì„¸ìŠ¤ ì¶”ì  ë° ë„¤íŠ¸ì›Œí¬ íŠ¸ë˜í”½ ëª¨ë‹ˆí„°ë§

`TracingPolicy`ëŠ” ì»¤ë„ ì´ë²¤íŠ¸ì— ëŒ€í•œ ì‹¤ì‹œê°„ í•„í„°ë¥¼ ì‰½ê²Œ ì„¤ì •í•  ìˆ˜ ìˆëŠ” ì‚¬ìš©ì ì •ì˜ ë¦¬ì†ŒìŠ¤ì´ë‹¤. `TracingPolicy`ëŠ” ì‹œìŠ¤í…œ í˜¸ì¶œì´ ìˆ˜í–‰ë˜ë©´ ë“±ë¡ëœ ì •ì±…ì— ì¼ì¹˜ë  ê²½ìš° í•´ë‹¹ ì‘ì—…ì„ íŠ¸ë¦¬ê±° í•œë‹¤. ì²˜ìŒ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•  ë‚´ìš©ì€ íŠ¹ì • íŒŒë“œë‚´ì—ì„œ curlì„ ì‚¬ìš©í•´ì„œ ì™¸ë¶€ë¡œ ì ‘ì†í•˜ëŠ” ê²½ìš° ë°œìƒí•˜ëŠ” ì´ë²¤íŠ¸ë¥¼ ê°ì§€í•˜ëŠ” ê²ƒì„ êµ¬í˜„í•´ë³¸ ì˜ˆì‹œì´ë‹¤.

ë¨¼ì € ë‘ê°œì˜ ì •ì±…ì„ ì ìš©í•œë‹¤. í•˜ë‚˜ì”© ì‚´í´ë³´ì.

```bash
kubectl apply -f https://raw.githubusercontent.com/cilium/tetragon/refs/heads/main/examples/tracingpolicy/sys_write_follow_fd_prefix.yaml
```

í•´ë‹¹ ì •ì±…(`sys_write_follow_fd_prefix`)ì€ íŒŒì¼ì´ ì˜¤í”ˆë˜ê±°ë‚˜ ì½ê³ , ì“°ê¸°ê°€ ë°œìƒí•˜ëŠ” ì´ë²¤íŠ¸ë¥¼ í™•ì¸í•˜ëŠ” ì •ì±…ì´ë‹¤. `fd_install` í•¨ìˆ˜ëŠ” ìƒˆë¡œìš´ íŒŒì¼ ë””ìŠ¤í¬ë¦½í„°ê°€ ìƒì„±ë  ë•Œ í˜¸ì¶œëœë‹¤. ì´ í•¨ìˆ˜ëŠ” íŒŒì¼ ë””ìŠ¤í¬ë¦½í„° í…Œì´ë¸”ì— ìƒˆë¡œìš´ íŒŒì¼ ë””ìŠ¤í¬ë¦½í„°ë¥¼ ë“±ë¡í•˜ê³ , í•´ë‹¹ íŒŒì¼ ë””ìŠ¤í¬ë¦½í„°ê°€ ê°€ë¦¬í‚¤ëŠ” íŒŒì¼ ê°ì²´ë¥¼ ì„¤ì •í•œë‹¤. ì¦‰, í”„ë¡œì„¸ìŠ¤ê°€ íŒŒì¼ì„ ì—´ ë•Œ, ì»¤ë„ì€ `fd_install`ì„ í†µí•´ íŒŒì¼ ë””ìŠ¤í¬ë¦½í„°ë¥¼ í• ë‹¹í•˜ê³ , ì´ ë””ìŠ¤í¬ë¦½í„°ë¥¼ í†µí•´ ì´í›„ì— íŒŒì¼ì— ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ í•œë‹¤. 

`sys_read` í•¨ìˆ˜ëŠ” íŒŒì¼ ë””ìŠ¤í¬ë¦½í„°ë¥¼ í†µí•´ íŒŒì¼ì—ì„œ ë°ì´í„°ë¥¼ ì½ëŠ” ì‹œìŠ¤í…œ í˜¸ì¶œì´ë‹¤. ì´ í•¨ìˆ˜ëŠ” userê°€ ì§€ì •í•œ íŒŒì¼ ë””ìŠ¤í¬ë¦½í„°ë¥¼ ì‚¬ìš©í•˜ì—¬ í•´ë‹¹ íŒŒì¼ì—ì„œ ë°ì´í„°ë¥¼ ì½ì–´ì˜¤ëŠ” ì—­í• ì„ í•œë‹¤. sys_readëŠ” íŒŒì¼ ë””ìŠ¤í¬ë¦½í„°ê°€ ìœ íš¨í•œì§€ í™•ì¸í•˜ê³ , í•´ë‹¹ íŒŒì¼ì˜ ë‚´ìš©ì„ userspaceìœ¼ë¡œ ë³µì‚¬í•œë‹¤.

ì¦‰, `fd_install`ì´ íŒŒì¼ ë””ìŠ¤í¬ë¦½í„°ë¥¼ ì„¤ì •í•œ í›„, userëŠ” ì´ ë””ìŠ¤í¬ë¦½í„°ë¥¼ í†µí•´ sys_readë¥¼ í˜¸ì¶œí•˜ì—¬ íŒŒì¼ì˜ ë‚´ìš©ì„ ì½ì„ ìˆ˜ ìˆê²Œ ëœë‹¤. ì´ ë‘ í•¨ìˆ˜ëŠ” íŒŒì¼ I/O ì‘ì—…ì˜ ê¸°ë³¸ì ì¸ íë¦„ì—ì„œ ì„œë¡œ ì—°ê²°ë˜ì–´ ìˆë‹¤. 


```yaml
apiVersion: cilium.io/v1alpha1
kind: TracingPolicy
metadata:
  name: "sys-read-follow-prefix"
spec:
  kprobes:
  - call: "fd_install"
    syscall: false
    return: false
    args:
    - index: 0
      type: int
    - index: 1
      type: "file"
    selectors:
    - matchPIDs:
      - operator: NotIn
        followForks: true
        isNamespacePID: true 
        values:
        - 1
      matchArgs:
      - index: 1
        operator: "Prefix"
        values:
        - "/etc/"
      matchActions:
      - action: FollowFD
        argFd: 0
        argName: 1
  - call: "sys_close"
    syscall: true
    args:
    - index: 0
      type: "int"
    selectors:
    - matchActions:
      - action: UnfollowFD
        argFd: 0
        argName: 0
  - call: "sys_read"
    syscall: true
    args:
    - index: 0
      type: "fd"
    - index: 1
      type: "char_buf"
      returnCopy: true
    - index: 2
      type: "size_t"
  - call: "sys_write"
    syscall: true
    args:
    - index: 0
      type: "fd"
    - index: 1
      type: "char_buf"
      sizeArgIndex: 3
    - index: 2
      type: "size_t"
```

### ë„¤íŠ¸ì›Œí¬ íŠ¸ë˜í”½ ëª¨ë‹ˆí„°ë§


```bash
kubectl apply -f https://raw.githubusercontent.com/cilium/tetragon/refs/heads/main/examples/tracingpolicy/tcp-connect.yaml
```

í•´ë‹¹ ì •ì±…ì€ ë„¤íŠ¸ì›Œí¬ íŠ¸ë˜í”½ì„ ëª¨ë‹ˆí„°ë§í•œë‹¤. ì •ì±… ë‚´ìš©ì„ ì‚´í´ë³´ë©´ `tcp_connect`, `tcp_close` ë“±ì˜ ë„¤íŠ¸ì›Œí¬ ê¸°ë°˜ ì‹œìŠ¤í…œ ì½œì´ ë°œìƒí•˜ëŠ” ê²ƒì„ ëª¨ë‹ˆí„°ë§ í•˜ê²Œ ëœë‹¤. ì´ë¥¼ í†µí•´ íŒŒë“œ ë‚´ì—ì„œ ì–´ë–¤ ë„¤íŠ¸ì›Œí¬ ìš”ì²­ì´ ë°œìƒí–ˆëŠ”ì§€ ì¶”ì í•  ìˆ˜ ìˆë‹¤.


```yaml
apiVersion: cilium.io/v1alpha1
kind: TracingPolicy
metadata:
  name: "connect"
spec:
  kprobes:
  - call: "tcp_connect"
    syscall: false
    args:
    - index: 0
      type: "sock"
  - call: "tcp_close"
    syscall: false
    args:
    - index: 0
      type: "sock"
  - call: "tcp_sendmsg"
    syscall: false
    args:
    - index: 0
      type: "sock"
    - index: 2
      type: int
```

í•´ë‹¹ ì´ë²¤íŠ¸ ë“±ì„ ê°ì§€í•˜ê¸° ìœ„í•´ `tetra getevents -o compact` CLIëª…ë ¹ì„ ì‹¤í–‰í•´ ë†“ì.

```bash
kubectl logs -n kube-system ds/tetragon -c export-stdout -f | tetra getevents -o compact --namespaces default --pods xwing
ã„´```

ì´ì œ `xwing` íŒŒë“œì—ì„œ curl ëª…ë ¹ìœ¼ë¡œ ì™¸ë¶€ë¡œ í†µì‹ í•˜ëŠ” í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•´ë³¸ë‹¤. 

```bash
kubectl exec -it xwing -- curl google.com
<HTML><HEAD><meta http-equiv="content-type" content="text/html;charset=utf-8">
<TITLE>301 Moved</TITLE></HEAD><BODY>
<H1>301 Moved</H1>
The document has moved
<A HREF="http://www.google.com/">here</A>.
</BODY></HTML>
```


ì•„ê¹Œ ê±¸ì–´ë†¨ë˜ `tetra getevents -o compact` CLIëª…ë ¹ì„ í™•ì¸í•´ë³´ë©´ ë‹¤ìŒê³¼ ìœ ì‚¬í•œ ê²°ê³¼ë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

```
ğŸš€ process default/xwing /usr/bin/curl google.com
ğŸ“¬ open    default/xwing /usr/bin/curl /etc/ld.so.cache
ğŸ“ª close   default/xwing /usr/bin/curl
...
ğŸ“ª close   default/xwing /usr/bin/curl
ğŸ“¬ open    default/xwing /usr/bin/curl /etc/ssl/openssl.cnf
ğŸ“š read    default/xwing /usr/bin/curl /etc/ssl/openssl.cnf 4096 bytes
ğŸ“š read    default/xwing /usr/bin/curl /etc/ssl/openssl.cnf 4096 bytes
...
ğŸ“ª close   default/xwing /usr/bin/curl
ğŸ“ª close   default/xwing /usr/bin/curl
ğŸ“¬ open    default/xwing /usr/bin/curl /etc/nsswitch.conf
ğŸ“š read    default/xwing /usr/bin/curl /etc/nsswitch.conf 4096 bytes
ğŸ“š read    default/xwing /usr/bin/curl /etc/nsswitch.conf 4096 bytes
ğŸ“ª close   default/xwing /usr/bin/curl
ğŸ“¬ open    default/xwing /usr/bin/curl /etc/passwd
ğŸ“š read    default/xwing /usr/bin/curl /etc/passwd 4096 bytes
ğŸ“ª close   default/xwing /usr/bin/curl
ğŸ“ª close   default/xwing /usr/bin/curl
ğŸ“ª close   default/xwing /usr/bin/curl
ğŸ“ª close   default/xwing /usr/bin/curl
ğŸ“¬ open    default/xwing /usr/bin/curl /etc/host.conf
ğŸ“š read    default/xwing /usr/bin/curl /etc/host.conf 4096 bytes
ğŸ“š read    default/xwing /usr/bin/curl /etc/host.conf 4096 bytes
ğŸ“ª close   default/xwing /usr/bin/curl
ğŸ“¬ open    default/xwing /usr/bin/curl /etc/resolv.conf
ğŸ“š read    default/xwing /usr/bin/curl /etc/resolv.conf 4096 bytes
ğŸ“š read    default/xwing /usr/bin/curl /etc/resolv.conf 4096 bytes
ğŸ“ª close   default/xwing /usr/bin/curl
ğŸ“¬ open    default/xwing /usr/bin/curl /etc/hosts
ğŸ“š read    default/xwing /usr/bin/curl /etc/hosts 4096 bytes
ğŸ“š read    default/xwing /usr/bin/curl /etc/hosts 4096 bytes
ğŸ“ª close   default/xwing /usr/bin/curl
...
ğŸ“ª close   default/xwing /usr/bin/curl
ğŸ“¬ open    default/xwing /usr/bin/curl /etc/gai.conf
ğŸ“š read    default/xwing /usr/bin/curl /etc/gai.conf 4096 bytes
ğŸ“š read    default/xwing /usr/bin/curl /etc/gai.conf 4096 bytes
ğŸ“ª close   default/xwing /usr/bin/curl
...
ğŸ“ª close   default/xwing /usr/bin/curl
ğŸ”Œ connect default/xwing /usr/bin/curl tcp 10.244.0.9:34362 -> 142.250.207.110:80
ğŸ“¤ sendmsg default/xwing /usr/bin/curl tcp 10.244.0.9:34362 -> 142.250.207.110:80 bytes 74
ğŸ“ª close   default/xwing /usr/bin/curl
ğŸ“ª close   default/xwing /usr/bin/curl
ğŸ“ª close   default/xwing /usr/bin/curl
ğŸ§¹ close   default/xwing /usr/bin/curl tcp 10.244.0.9:34362 -> 142.250.207.110:80
ğŸ’¥ exit    default/xwing /usr/bin/curl google.com 0
ğŸš€ process default/xwing /usr/bin/sh
ğŸ“¬ open    default/xwing /usr/bin/sh /etc/ld.so.cache
ğŸ“ª close   default/xwing /usr/bin/sh
ğŸ“ª close   default/xwing /usr/bin/sh
ğŸ“ª close   default/xwing /usr/bin/sh
ğŸ“ª close   default/xwing /usr/bin/sh
ğŸ’¥ exit    default/xwing /usr/bin/sh  130
```

ìœ„ ë¡œê·¸ë¥¼ í†µí•´ Tetragonì´ í´ëŸ¬ìŠ¤í„° ë‚´ì—ì„œ ì‹¤í–‰ ì¤‘ì¸ curl í”„ë¡œì„¸ìŠ¤ì— ëŒ€í•œ ìƒì„¸í•œ ì´ë²¤íŠ¸ë¥¼ ê¸°ë¡í•œ ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤. 

- í”„ë¡œì„¸ìŠ¤ ì‹¤í–‰: curl ëª…ë ¹ì´ google.comì— ëŒ€í•œ ìš”ì²­ ì‹¤í–‰
- íŒŒì¼ ì ‘ê·¼: curl í”„ë¡œì„¸ìŠ¤ê°€ ì—¬ëŸ¬ íŒŒì¼ì„ ì—´ê³  ì½ëŠ” ê³¼ì • í™•ì¸. 
  /etc/ld.so.cache, /etc/ssl/openssl.cnf, /etc/nsswitch.conf, /etc/passwd, /etc/host.conf, /etc/resolv.conf, /etc/hosts, /etc/gai.conf ë“±ì˜ íŒŒì¼ì´ ì—´ë¦¬ê³  ì½íŒ ê²ƒìœ¼ë¡œ, ì´ëŠ” curlì´ ì™¸ë¶€ ìš”ì²­ì„ ì²˜ë¦¬í•˜ê¸° ìœ„í•´ í•„ìš”í•œ ì„¤ì • íŒŒì¼ì´ë‚˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¡œë“œí•˜ëŠ” ê³¼ì •ì´ë‹¤.
- ë„¤íŠ¸ì›Œí¬ ì—°ê²°: curlì´ tcp ì—°ê²°ì„ í†µí•´ 10.244.0.9:34362ì—ì„œ 142.250.207.110:80ìœ¼ë¡œ ì—°ê²°ì„ ì‹œë„í•œ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. 
- ë°ì´í„° ì „ì†¡: sendmsg ì´ë²¤íŠ¸ëŠ” curlì´ ë°ì´í„°ë¥¼ ì „ì†¡í–ˆìŒì„ ë‚˜íƒ€ë‚¸ë‹¤.
- í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ: curl í”„ë¡œì„¸ìŠ¤ê°€ ì„±ê³µì ìœ¼ë¡œ ì¢…ë£Œë˜ì—ˆìŒì„ ë‚˜íƒ€ë‚´ëŠ” exit ì´ë²¤íŠ¸ê°€ ê¸°ë¡ë˜ì–´ ìˆë‹¤. ì¢…ë£Œ ì½”ë“œ `0`ì€ ì •ìƒ ì¢…ë£Œë¥¼ ì˜ë¯¸í•œë‹¤.

## ê²°ë¡ 

Tetragonê³¼ eBPFë¥¼ ì‚¬ìš©í•˜ë©´ Kubernetes í™˜ê²½ì—ì„œ ê°•ë ¥í•œ ë³´ì•ˆ ë° ëª¨ë‹ˆí„°ë§ ê¸°ëŠ¥ì„ êµ¬í˜„í•  ìˆ˜ ìˆë‹¤. Tetragonì€ ì‹œìŠ¤í…œ í˜¸ì¶œì„ ì¶”ì í•˜ê³ , í”„ë¡œì„¸ìŠ¤ë³„ë¡œ í˜¸ì¶œ íšŸìˆ˜ë¥¼ ê¸°ë¡í•œë‹¤. ì´ëŸ¬í•œ ì´ë²¤íŠ¸ëŠ” ì»¤ë„ ë‚´ì—ì„œ ì§ì ‘ ëª¨ë‹ˆí„°ë§ë˜ë¯€ë¡œ ì´ëŸ¬í•œ í˜¸ì¶œ ì¶”ì  ì‘ì—…ì— ì•½ê°„ì˜ ì˜¤ë²„í—¤ë“œë§Œì´ ì¶”ê°€ë˜ì–´, Falcoì™€ ê°™ì€ ë„êµ¬ë³´ë‹¤ëŠ” ë¦¬ì†ŒìŠ¤ ì‚¬ìš© ì¸¡ë©´ì—ì„œëŠ” ìœ ë¦¬í•œ ì ì€ ì¡´ì¬í•œë‹¤. 

Tetragonì˜ ë‹¨ì ì€ ê´€ì°°, ì¶”ì ëœ í”„ë¡œì„¸ìŠ¤ë¥¼ kill í•  ìˆ˜ ìˆëŠ” ì¡°ì¹˜ê°€ í›„í–‰ì ì´ë¼ëŠ” ê²ƒì´ë‹¤. ì´ë²¤íŠ¸ê°€ ì¼ì–´ë‚˜ê³  ìˆê³  ì´ì „ì— ì˜ˆë°©í•˜ëŠ” ë°©ì‹ì€ ì•„ë‹ˆë‹¤ë¼ëŠ” ì‚¬ì‹¤ì„ ì´í•´í•´ì•¼ í•œë‹¤. í•˜ì§€ë§Œ ì»¤ë„ ë ˆë²¨ì—ì„œ ì´ë²¤íŠ¸ë¥¼ í•„í„°ë§í•˜ê³  ì´ì— ëŒ€í•œ ì¡°ì¹˜ë¥¼ ì·¨í•  ìˆ˜ ìˆëŠ” ì •ì±…ì„ ìˆ˜ë¦½í•˜ê³  ë§Œë“œëŠ” ì¸¡ë©´ì—ì„œëŠ” ë¸”ë™ë¦¬ìŠ¤íŠ¸ ë°©ì‹ìœ¼ë¡œ í•˜ëŠ” ì°¨ë‹¨ ë°©ì‹ì— ë¹„í•´ ìœ ì—°ì„±ì„ ì–´ëŠ ì •ë„ ë³´ì¥í•´ì¤„ ìˆ˜ ìˆëŠ” ê²ƒì€ ê°•ë ¥í•´ ë³´ì¸ë‹¤.

> í•´ë‹¹ í¬ìŠ¤íŒ…ì€ í˜„ì¬ ì¬ì§ì¤‘ì¸ íšŒì‚¬ì— ê´€ë ¨ì´ ì—†ê³ , ê°œì¸ ì—­ëŸ‰ ê°œë°œì„ ìœ„í•œ ìŠ¤í„°ë”” ìë£Œë¡œ í™œìš©í•  ì˜ˆì •ì…ë‹ˆë‹¤.
