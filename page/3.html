<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-list-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.18">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="Act as a catalyst RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Act as a catalyst Atom Feed">
<link rel="alternate" type="application/json" href="/feed.json" title="Act as a catalyst JSON Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-4ZT898XDT2"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-4ZT898XDT2",{})</script>
<link rel="search" type="application/opensearchdescription+xml" title="Cloud Catalyst" href="/opensearch.xml">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4362752107119680" crossorigin="anonymous"></script><title data-rh="true">Cloud Catalyst | Cloud Catalyst</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://ddii.dev/page/3"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="naver-site-verification" content="cbcc03783e5594725d3951f4e7f16ede80e69881"><meta data-rh="true" property="og:title" content="Cloud Catalyst | Cloud Catalyst"><meta data-rh="true" name="description" content="My little thought may as a catalyst in other engineer&#x27;s career"><meta data-rh="true" property="og:description" content="My little thought may as a catalyst in other engineer&#x27;s career"><meta data-rh="true" name="docusaurus_tag" content="blog_posts_list"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_posts_list"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://ddii.dev/page/3"><link data-rh="true" rel="alternate" href="https://ddii.dev/page/3" hreflang="en"><link data-rh="true" rel="alternate" href="https://ddii.dev/page/3" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://J5EMWGFKQM-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.1e7a31ee.css">
<link rel="preload" href="/assets/js/runtime~main.fedfc763.js" as="script">
<link rel="preload" href="/assets/js/main.1aff5f87.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top navbarHideable_ObN2"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo_transparent.svg" alt="Cloud Catalyst" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/logo_transparent.svg" alt="Cloud Catalyst" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">Cloud Catalyst</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/">Posts</a><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" docid="intro" href="/docs/intro">Docs</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/intro">Intro</a></li></ul></div></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/tags">Tags</a><a class="navbar__item navbar__link" href="/presentation">Presentation</a><a class="navbar__item navbar__link" href="/archive">Archive</a><a class="navbar__item navbar__link" href="/about">About</a><a class="navbar__item navbar__link" href="/pang4u">Pang4u</a><a href="https://github.com/ddiiwoong/newblog" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_S7eR colorModeToggle_vKtC"><button class="clean-btn toggleButton_rCf9 toggleButtonDisabled_Pu9x" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_v35p"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_nQuB"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_qEbK"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_a9qW thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_uKok margin-bottom--md">Recent Posts</div><ul class="sidebarItemList_Kvuv"><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2022/03/18/eks-anywhere-adv">EKS Anywhere Advanced Usages</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2022/03/06/eks-anywhere">EKS Anywhere on vSphere Homelab</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2022/02/05/what-is-tailscale">What is Tailscale?</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2021/06/11/synology-prometheus">Synology monitoring with Prometheus and snmp exporter</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2020/12/06/vSphere-with-Tanzu-homelab-2">vSphere with Tanzu homelab running on ASUS PN50 (2/2)</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2019/05/14/knative-on-aws">Knative on EKS</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2019-05-14T00:00:00.000Z" itemprop="datePublished">May 14, 2019</time> · <!-- -->12 min read</div></header><div class="markdown" itemprop="articleBody"><p>이번에는 Knative를 EKS에 구성해보려고 한다. 4월은 발표 및 여러가지 업무로 인해서 포스팅을 할 시간이 부족했지만 5월부터 조금씩 여유가 생겨서 더 바빠지기전에 좀 써보려고 한다. 사실 <a href="https://www.facebook.com/yongho1037" target="_blank" rel="noopener noreferrer">Facebook @최용호</a>님께서 한번 해보는것도 좋겠다고 하셔서 테스트를 진행하였다.  </p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="knative-on-eks">Knative on EKS<a class="hash-link" href="#knative-on-eks" title="Direct link to heading">​</a></h2><p>제목만 보면 Lambda나 ECS, Batch 서비스가 있는데 왜 이걸 써야하지? 라는 생각부터 하는 사람도 있을것 같다. 하지만 이전 포스팅들과 발표에서도 여러번 이야기 한것처럼 Knative는 간단하게 서버리스 워크로드를 빌드, 배포, 관리하기 위한 Kubernetes기반 FaaS플랫폼이고 현재 <a href="https://landscape.cncf.io/" target="_blank" rel="noopener noreferrer">CNCF Landscape</a>에서 가장 빠른 속도로 개발되고 있는 오픈소스 프로젝트 중 하나이다.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="eks-배포">EKS 배포<a class="hash-link" href="#eks-배포" title="Direct link to heading">​</a></h2><p>앞선 <a href="https://ddii.dev/kubernetes/eksworkshop/" target="_blank" rel="noopener noreferrer">eksworkshop 포스팅</a>에서처럼 간단한 배포를 위해 <code>eksctl</code>로 2-node 클러스터를 배포한다.<br>
<!-- -->사전 준비사항은 <a href="https://ddii.dev/kubernetes/eksworkshop/" target="_blank" rel="noopener noreferrer">이전 포스팅</a>이나 <a href="https://eksctl.io/" target="_blank" rel="noopener noreferrer">https://eksctl.io/</a>을 참고하자.  </p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ eksctl create cluster --name=eksworkshop-eksctl --nodes=2 --node-ami=auto</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>생성된 클러스터 상태를 확인한다. </p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get nodes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                                STATUS    ROLES     AGE       VERSION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ip-192-168-24-168.ap-northeast-2.compute.internal   Ready     &lt;none&gt;    2m        v1.11.9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ip-192-168-78-204.ap-northeast-2.compute.internal   Ready     &lt;none&gt;    2m        v1.11.9</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="istio-설치">istio 설치<a class="hash-link" href="#istio-설치" title="Direct link to heading">​</a></h2><p>Knative는 istio 의존성을 가지고 있기 때문에 Istio를 먼저 배포한다. 물론 <a href="https://ddii.dev/kubernetes/knative-using-gloo/" target="_blank" rel="noopener noreferrer">이전 포스팅</a>에서 설명한것 처럼 Gloo를 사용해도 되지만 이번에는 Istio를 설치하였다.  </p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl apply -f https://github.com/knative/serving/releases/download/v0.5.0/istio-crds.yaml </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl apply -f https://github.com/knative/serving/releases/download/v0.5.0/istio.yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>배포된 Pods, Services, Replicasets 을 확인한다.</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pods -n istio-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                     READY     STATUS      RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster-local-gateway-65c8b667c8-269cf   1/1       Running     0          17m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio-citadel-76bd44d8f7-5cltj           1/1       Running     0          17m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio-cleanup-secrets-7jpth              0/1       Completed   0          17m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio-egressgateway-b9d56b4f8-pdjhs      1/1       Running     0          17m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio-galley-7db7db89db-5stkp            1/1       Running     0          17m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio-ingressgateway-f77fbc787-npw9d     1/1       Running     0          17m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio-pilot-69f975bf4f-4dq4d             2/2       Running     0          17m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio-pilot-69f975bf4f-q9g8g             2/2       Running     0          16m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio-pilot-69f975bf4f-tnm92             2/2       Running     0          16m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio-policy-8db48cbcd-dl2th             2/2       Running     0          17m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio-security-post-install-xv8z6        0/1       Completed   0          17m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio-sidecar-injector-cd54ffccd-kj2n6   1/1       Running     0          17m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio-telemetry-d78cd45db-8x2cw          2/2       Running     0          17m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get svc -n istio-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                     TYPE           CLUSTER-IP       EXTERNAL-IP                                                                   PORT(S)                                                                                                                   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster-local-gateway    ClusterIP      10.100.97.146    &lt;none&gt;                                                                        80/TCP,443/TCP,31400/TCP,15011/TCP,8060/TCP,15030/TCP,15031/TCP                                                           17m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio-citadel            ClusterIP      10.100.147.235   &lt;none&gt;                                                                        8060/TCP,9093/TCP                                                                                                         17m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio-egressgateway      ClusterIP      10.100.25.44     &lt;none&gt;                                                                        80/TCP,443/TCP                                                                                                            17m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio-galley             ClusterIP      10.100.158.45    &lt;none&gt;                                                                        443/TCP,9093/TCP                                                                                                          17m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio-ingressgateway     LoadBalancer   10.100.62.157    a4e1d5201758f11e9b7f402c4d4b0376-510368564.ap-northeast-2.elb.amazonaws.com   80:31000/TCP,443:30753/TCP,31400:31922/TCP,15011:31331/TCP,8060:30389/TCP,853:30257/TCP,15030:30827/TCP,15031:30153/TCP   17m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio-pilot              ClusterIP      10.100.25.194    &lt;none&gt;                                                                        15010/TCP,15011/TCP,8080/TCP,9093/TCP                                                                                     17m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio-policy             ClusterIP      10.100.73.149    &lt;none&gt;                                                                        9091/TCP,15004/TCP,9093/TCP                                                                                               17m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio-sidecar-injector   ClusterIP      10.100.117.18    &lt;none&gt;                                                                        443/TCP                                                                                                                   17m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio-telemetry          ClusterIP      10.100.87.12     &lt;none&gt;                                                                        9091/TCP,15004/TCP,9093/TCP,42422/TCP                                                                                     17m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get rs -n istio-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                               DESIRED   CURRENT   READY     AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster-local-gateway-65c8b667c8   1         1         1         17m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio-citadel-76bd44d8f7           1         1         1         17m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio-egressgateway-b9d56b4f8      1         1         1         17m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio-galley-7db7db89db            1         1         1         17m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio-ingressgateway-f77fbc787     1         1         1         17m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio-pilot-69f975bf4f             3         3         3         17m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio-policy-8db48cbcd             1         1         1         17m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio-sidecar-injector-cd54ffccd   1         1         1         17m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio-telemetry-d78cd45db          1         1         1         17m</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Istio injection을 하기 위해 배포할 defaults namespace 전체에 Labeling을 한다.</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl label namespace default istio-injection=enabled</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">namespace/default labeled</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get namespaces --show-labels</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME           STATUS    AGE       LABELS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">default        Active    43m       istio-injection=enabled</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio-system   Active    27m       istio-injection=disabled</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-public    Active    43m       &lt;none&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system    Active    43m       &lt;none&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="knative-설치">Knative 설치<a class="hash-link" href="#knative-설치" title="Direct link to heading">​</a></h2><p>build, evening, serving 및 모니터링 리소스를 배포한다.</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f https://github.com/knative/serving/releases/download/v0.5.0/serving.yaml \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   -f https://github.com/knative/build/releases/download/v0.5.0/build.yaml \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   -f https://github.com/knative/eventing/releases/download/v0.5.0/release.yaml \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   -f https://github.com/knative/eventing-sources/releases/download/v0.5.0/eventing-sources.yaml \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   -f https://github.com/knative/serving/releases/download/v0.5.0/monitoring.yaml \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   -f https://raw.githubusercontent.com/knative/serving/v0.5.0/third_party/config/build/clusterrole.yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>모든 Knative namespaces 및 resources를 확인한다.</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get namespaces | grep knative</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">knative-build        Active    8m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">knative-eventing     Active    8m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">knative-monitoring   Active    8m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">knative-serving      Active    8m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">knative-sources      Active    8m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pods -n knative-serving</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                          READY     STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">activator-664b5b9598-dsjvq    2/2       Running   0          10m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">autoscaler-64d5bd84b8-bqghq   2/2       Running   0          10m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">controller-658b9d5c6c-tnwvz   1/1       Running   0          10m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">webhook-5dffbfbb8b-525vt      1/1       Running   0          10m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pods -n knative-build </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                READY     STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">build-controller-86f5b5b96d-zg8j2   1/1       Running   0          11m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">build-webhook-6fddd7c6df-68fkw      1/1       Running   0          11m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pods -n knative-eventing </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                            READY     STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">eventing-controller-6fdccd8c95-bckws            1/1       Running   0          11m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">in-memory-channel-controller-6fddb6655f-vbc64   1/1       Running   0          11m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">in-memory-channel-dispatcher-7684cd7c7d-ftqhc   2/2       Running   2          11m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">webhook-d496c66bd-688xz                         1/1       Running   0          11m</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pods -n knative-monitoring </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                  READY     STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">elasticsearch-logging-0               1/1       Running   0          14m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">elasticsearch-logging-1               1/1       Running   0          12m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">grafana-754bc795bb-wxwml              1/1       Running   0          14m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kibana-logging-7f7b9698bc-rrnw6       1/1       Running   0          14m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-state-metrics-5bccdf746f-fhv7t   4/4       Running   0          12m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">node-exporter-w9jlq                   2/2       Running   0          14m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">node-exporter-wgv2j                   2/2       Running   0          14m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-system-0                   1/1       Running   0          14m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-system-1                   1/1       Running   0          14m</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>모니터링 리소스도 확인한다. 위의 리소스를 보면 Fluentd가 배포되지 않은 상태이므로 DaemonSet으로 동작할수 있도록 아래와 같이 설정하면 DaemonSet을 확인할 수 있다.  </p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl label nodes --all beta.kubernetes.io/fluentd-ds-ready=&quot;true&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="build에서-사용할-docker-credential-설정">Build에서 사용할 Docker Credential 설정<a class="hash-link" href="#build에서-사용할-docker-credential-설정" title="Direct link to heading">​</a></h2><p>일단 Knative Build를 수행할때 일반적으로 Container Registry를 많이 사용하기 때문에 Registry Credential 설정을 해야한다.  </p><p>ECR의 경우 <a href="https://github.com/knative/build-templates" target="_blank" rel="noopener noreferrer">https://github.com/knative/build-templates</a>의 ecr_helper를 사용하면 쉽게 ECR account를 설정할 수 있지만 <code>Serving</code>단계에서 401에러가 나는 이유를 잡지 못해서 일단 Dockerhub를 가지고 진행하였다.</p><p>간단한 데모코드는 아래 repository에 미리 작성해놨다.  </p><p><a href="https://github.com/ddiiwoong/hello-python.git" target="_blank" rel="noopener noreferrer">https://github.com/ddiiwoong/hello-python.git</a></p><p><code>docker-secret.yaml</code> 을 보면 dockerhub push를 위해 basic-auth를 수행하게 되는데 dockerhub id/password 를 base64로 encoding해서 Secret으로 저장한다.  </p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> basic</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">user</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">pass</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">annotations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">build.knative.dev/docker-0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> https</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//index.docker.io/v1/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> kubernetes.io/basic</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">auth</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">data</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Use &#x27;echo -n &quot;username&quot; | base64&#x27; to generate this string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">username</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> BASE64_ENCODED_USERNAME</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Use &#x27;echo -n &quot;password&quot; | base64&#x27; to generate this string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">password</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> BASE64_ENCODED_PASSWORD</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>그리고 ServiceAccount <code>build-bot</code>을 생성하기 위한 yaml (sa.yaml)를 작성한다.  </p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ServiceAccount</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> build</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">bot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">secrets</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> basic</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">user</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">pass</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>위에서 작성한 Secret(basic-user-pass)과 ServiceAccount(build-bot)를 배포한다.  </p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl apply -f docker-secret.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">secret &quot;basic-user-pass&quot; created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl apply -f sa.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">serviceaccount &quot;build-bot&quot; created</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>저장된 Secret(basic-user-pass)과 ServiceAccount(build-bot)를 확인한다.</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                        TYPE                                  DATA      AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">basic-user-pass             kubernetes.io/basic-auth              2         2h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">build-bot-token-gfkg9       kubernetes.io/service-account-token   3         2h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">builder-token-kp7ww         kubernetes.io/service-account-token   3         10h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">default-token-9cpp5         kubernetes.io/service-account-token   3         10h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ecr-creds                   kubernetes.io/basic-auth              2         10h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio.build-bot             istio.io/key-and-cert                 3         2h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio.builder               istio.io/key-and-cert                 3         10h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio.default               istio.io/key-and-cert                 3         10h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio.knative-serve         istio.io/key-and-cert                 3         2h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">knative-serve-token-9j82l   kubernetes.io/service-account-token   3         2h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get sa</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME            SECRETS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">build-bot       2         2h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">builder         2         10h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">default         1         10h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">knative-serve   2         2h</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="python-코드-및-dockerfile-작성">Python 코드 및 Dockerfile 작성<a class="hash-link" href="#python-코드-및-dockerfile-작성" title="Direct link to heading">​</a></h2><p>TARGET 환경변수를 받아서 Hello World와 같이 출력하는 간단한 Flask기반 앱을 작성한다.  </p><p>간단한 데모코드는 아래 repository에 미리 작성해놨다.  </p><p><a href="https://github.com/ddiiwoong/hello-python.git" target="_blank" rel="noopener noreferrer">https://github.com/ddiiwoong/hello-python.git</a></p><div class="codeBlockContainer_I0IT language-py theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-py codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> os</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> flask </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> Flask</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">app </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Flask</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">__name__</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token decorator annotation punctuation" style="color:#393A34">@app</span><span class="token decorator annotation punctuation" style="color:#393A34">.</span><span class="token decorator annotation punctuation" style="color:#393A34">route</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;/&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">hello_world</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    target </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">environ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;TARGET&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;NOT SPECIFIED&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Hello World: {}!\n&#x27;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">format</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">target</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> __name__ </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;__main__&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    app</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">debug</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> host</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;0.0.0.0&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> port</span><span class="token operator" style="color:#393A34">=</span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">environ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;PORT&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8080</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>위 앱(app.py)을 배포하는 Dockerfile을 작성한다.</p><div class="codeBlockContainer_I0IT language-dockerfile theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-dockerfile codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">FROM python:alpine</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ENV APP_HOME /app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">COPY . $APP_HOME</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WORKDIR $APP_HOME</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN pip install Flask</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ENTRYPOINT [&quot;python&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CMD [&quot;app.py&quot;]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="knative-build">Knative Build<a class="hash-link" href="#knative-build" title="Direct link to heading">​</a></h2><p>미리 Dockerhub에서 <code>hello-python</code> repository(docker.io/ddiiwoong/hello-python)를 생성한다.<br>
<!-- -->그리고 위에서 생성한 <code>build-bot</code> 계정과 image tag <code>hello-python</code>정보를 Build template에 작성하여 배포한다.<br>
<!-- -->아래 Knative Build 과정은 <code>kaniko executor</code>를 사용하여 다음과 같은 과정을 수행한다.  </p><ol><li><code>spec.source</code> 에서 Source Clone (git)를 수행하고 이후  </li><li><code>spec.steps</code> 에서 Docker Build, Tag, Registry Login, Push를 수행한다.  </li></ol><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> build.knative.dev/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Build</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> python</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">build</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">serviceAccountName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> build</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">bot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">source</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">git</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">url</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> https</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//github.com/ddiiwoong/hello</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">python.git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">revision</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> master</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">steps</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> build</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">and</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">push</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gcr.io/kaniko</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">project/executor</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">v0.1.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">args</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">dockerfile=/workspace/Dockerfile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">destination=docker.io/ddiiwoong/hello</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">python</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">latest</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p><code>build</code>를 수행한다. </p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl apply -f build.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">build.build.knative.dev/python-build created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get build</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME           SUCCEEDED   REASON    STARTTIME   COMPLETIONTIME</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">python-build   True                  18m</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>정상적으로 Build가 완료되면 Dockerhub에 정의한 TAG(ddiiwoong/hello-python)로 이미지가 등록된걸 확인할 수 있다.  </p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ docker pull ddiiwoong/hello-python</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Using default tag: latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">latest: Pulling from ddiiwoong/hello-python</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">e7c96db7181b: Pull complete</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">799a5534f213: Pull complete</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">913b50bbe755: Pull complete</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">11154abc6081: Pull complete</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">c805e63f69fe: Pull complete</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">6eabcf0f7a50: Pull complete</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">74101057f4ec: Pull complete</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Digest: sha256:51dc4a7ce38a5e7894adcfc00eaee6c5ea6aca1ef6c7521f9b7ea6382c013b9b</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Status: Downloaded newer image for ddiiwoong/hello-python:latest</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="knative-serving-으로-배포">Knative Serving 으로 배포<a class="hash-link" href="#knative-serving-으로-배포" title="Direct link to heading">​</a></h2><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="serviceyaml">service.yaml<a class="hash-link" href="#serviceyaml" title="Direct link to heading">​</a></h4><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> serving.knative.dev/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> helloworld</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">python</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">runLatest</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">configuration</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">revisionTemplate</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">container</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ddiiwoong/hello</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">python</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">env</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> TARGET</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Python Sample v1 with Knative on EKS&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>빌드된 image (ddiiwoong/hello-python:latest)로 Knative Service를 생성한다.  </p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl apply -f service.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service.serving.knative.dev/helloworld-python created</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p><code>istio-system</code> Namespace에 <code>istio-ingressgateway</code> Service를 확인한다.  </p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get svc istio-ingressgateway --namespace istio-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                   TYPE           CLUSTER-IP      EXTERNAL-IP                                                                    PORT(S)                                                                                                                   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio-ingressgateway   LoadBalancer   10.100.208.80   a220723d475df11e980220a02e220b34-2021915778.ap-northeast-2.elb.amazonaws.com   80:31581/TCP,443:31490/TCP,31400:30367/TCP,15011:32495/TCP,8060:31418/TCP,853:30310/TCP,15030:32405/TCP,15031:31410/TCP   13h</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>ALB: a220723d475df11e980220a02e220b34-2021915778.ap-northeast-2.elb.amazonaws.com  </p><p>위와 같이 AWS LoadBalancer로 배포면 ALB가 자동으로 생성되므로 추후 eksctl로 클러스터를 삭제하기 전에 반드시 LoadBalancer 형태로 배포된 서비스를 삭제하고 진행해야 한다.  </p><p>Knative Service를 확인한다. </p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get ksvc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                DOMAIN                                  LATESTCREATED             LATESTREADY               READY     REASON</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helloworld-python   helloworld-python.default.example.com   helloworld-python-4rw95   helloworld-python-4rw95   True</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>위에서 얻은 두가지 정보(LoadBalancer, Domain)로 생성된 app을 테스트한다.<br>
<!-- -->Knative는 내부적으로 example.com이라고 하는 기본 domain을 사용하므로 내부적으로는 <code>helloworld-python.default.example.com</code>으로 curl을 실행하게 된다.  </p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ curl -H &quot;Host:helloworld-python.default.example.com&quot; http://a220723d475df11e980220a02e220b34-2021915778.ap-northeast-2.elb.amazonaws.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Hello World: Python Sample v1 with Knative on EKS!</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p><code>Cold Start</code>(default timeout 5분) 때문에 잠시 응답이 늦어질 수도 있지만(2-5초) 잠시 기다리면 위처럼 결과를 확인할 수 있다.  </p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="정리">정리<a class="hash-link" href="#정리" title="Direct link to heading">​</a></h2><p>위에서도 잠깐 언급했지만 Lambda나 ECS, Batch 서비스가 있는데 Knative on EKS 를 구지 왜 하느냐라고 궁금해하는 분들이 계실지도 모른다. 하지만 다들 아래와 같은 고민을 해봤을거라 생각한다.  </p><p>컨테이너와 Kubernetes가 DevOps도구로서의 표준이 되어가는 시대에 Lambda를 쓸지 오픈소스를 쓸지에 대한 고민은 결국 이식성과 벤더 종속성을 제거하고 운영효율화 측면에서 그 답을 찾을수 있을것 같다.  </p><p>현재 몸담고 있는 최근 프로젝트에서 Lambda, ECS, Batch 등을 사용하는 경우가 많아졌는데 실제 엔터프라이즈에서 정해진 자원내에서 정해진 일을 할때는 매니지드 서비스가 적합하다고 생각한다. 하지만 On-Premise 또는 그에 준하는 Kubernetes 클러스터를 운영하는 조직에서는 Knative를 사용하여 컨테이너 기반 서비리스 워크로드를 구현하는 것이 향후 Hybrid 관점에서 확장성과 벤더 종속성을 제거하는데 큰 도움이 될것이라 생각한다.  </p><p>조금씩 Kubernetes 및 생태계 Learning에 대한 피로도가 증가하고 있고 Hype Driven Development(설레발 주도개발)가 되는것 같아서 아쉬운 부분은 있지만 현재 가장 핫한 기술이고 관심도가 높기 때문에 배워두면 언젠가는 써먹게 될거라 확신한다.  </p><p>다시한번 Conference driven development(architecture)가 되지 않도록 자중하고 Loudest Guy가 되지 않도록 조심해야할 것 같다.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/knative">Knative</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/kubernetes">Kubernetes</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/faa-s">FaaS</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/aws">AWS</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/lambda">Lambda</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/serverless">Serverless</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/eks">EKS</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2019/03/29/eksworkshop">eksworkshop</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2019-03-29T00:00:00.000Z" itemprop="datePublished">March 29, 2019</time> · <!-- -->15 min read</div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="amazon-eks-elastic-container-service-for-kubernetes">Amazon EKS (Elastic Container Service for Kubernetes)<a class="hash-link" href="#amazon-eks-elastic-container-service-for-kubernetes" title="Direct link to heading">​</a></h2><p>Kubernetes Managed Service인 Amazon EKS가 2018년 7월 출시되고 2019년 1월 정식으로 서울리전에 출시되었다. 개인적으로 완전관리형 Kubernetes 출시가 늦어져서 AWS 행보가 다소 늦다고 생각은 했으나 ALB와 VPC연동, 여러가지 기존 OpenSource와의 연결고리를 배제하고 자체 Managed서비스와 연동할것들이 많기 때문에 당연히 타사에 비해 늦어진걸로 보인다. 언제나 그랬지만 오픈소스를 받아들이는 느낌이 아니라 뭔가 완성된 제품을 쓰는 느낌(?)이다. 물론 불편한 부분과 감수해야할 내용들은 조금 있지만 기존 AWS 충성 User에게 호응을 얻을수 있기 때문이 아닐까라는 생각을 해보면서 포스팅을 시작하려고 한다.  </p><p>오픈소스가 아닌 Managed서비스에 대한 리뷰는 처음이지만 4월 10일 <a href="https://www.meetup.com/ko-KR/awskrug/events/260024327/" target="_blank" rel="noopener noreferrer">AWS판교소모임</a> 발표도 있고, 실제 고려중인 아키텍처에 포함이 되어야 하는 EKS에 대해서 살펴보고 eskworkshop 튜토리얼을 실행해보면서 다른 관리형 Kubernetes 서비스들에 비해 어떤 사항을 좀더 고민해야 하는지 정리해보고 넘어가면 좋을듯 하다.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="eksworkshopcom">eksworkshop.com<a class="hash-link" href="#eksworkshopcom" title="Direct link to heading">​</a></h2><p><a href="https://eksworkshop.com/" target="_blank" rel="noopener noreferrer">https://eksworkshop.com/</a><br>
<!-- -->Kubernete를 처음접하는 유저를 위한 기본 개념과 아키텍처, 그리고 VPC, ALB를 활용하여 EKS에 대한 설치, 구성, 데모앱 배포 등을 해볼수 있는 튜토리얼 사이트이다.  </p><p><a href="https://www.facebook.com/groups/awskrug/" target="_blank" rel="noopener noreferrer">AWSKRUG</a>에서 한글화 작업도 진행중이다.  <a href="https://awskrug.github.io/eks-workshop/deploy/" target="_blank" rel="noopener noreferrer">한글화 링크</a></p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="eksworkshop-따라하기전-사전-준비사항">eksworkshop 따라하기전 사전 준비사항<a class="hash-link" href="#eksworkshop-따라하기전-사전-준비사항" title="Direct link to heading">​</a></h2><p>eksworkshop에서는 기본적으로 workshop이라는 신규 IAM 계정을 생성하고 Cloud9 Workspace 와 몇가지 설정들을 진행하지만 <a href="https://www.meetup.com/ko-KR/awskrug/events/260024327/" target="_blank" rel="noopener noreferrer">AWS판교소모임</a>을 위해 최대한 비용이 드는 구성요소를 배제하고 작성하고자 한다.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="aws-account">AWS account<a class="hash-link" href="#aws-account" title="Direct link to heading">​</a></h3><p>Free Tier는 EKS를 자유롭게 활용할수 없다.<br>
<!-- -->관련 issue - <a href="https://github.com/aws/containers-roadmap/issues/78" target="_blank" rel="noopener noreferrer">https://github.com/aws/containers-roadmap/issues/78</a>  </p><p>실제 사용중인 계정이나 Credit이 확보된 계정이 필요하다.  </p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="iam-설정-json-template">IAM 설정 (JSON template)<a class="hash-link" href="#iam-설정-json-template" title="Direct link to heading">​</a></h3><p>EKSworkshop에서는 Full administrator 계정을 필요로 하지만 eksctl로 배포를 진행하므로 그 기준으로 IAM설정을 진행한다.  </p><p><a href="https://github.com/terraform-aws-modules/terraform-aws-eks/blob/master/examples/eks_test_fixture/README.md" target="_blank" rel="noopener noreferrer">terraform eks iam 설정</a>을 참고하려고 했지만 eksctl과 terraform과의 약간 다른 방식의 배포로 인해 어쩔수없이 EKS Full Access권한을 할당하였다.<br>
<!-- -->(다른 유경험자의 도움이 필요한 상황 ㅠㅠ)</p><p>자세한 JSON 내용은 <a href="https://github.com/ddiiwoong/eksworkshop/blob/master/iam_for_eksworkshop.json" target="_blank" rel="noopener noreferrer">링크</a>를 참고한다.  </p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="kubectl-aws-iam-authenticator">kubectl, aws-iam-authenticator<a class="hash-link" href="#kubectl-aws-iam-authenticator" title="Direct link to heading">​</a></h3><ul><li>kubectl : kubernetes CLI</li><li>aws-iam-authenticator : AWS IAM Authenticator CLI</li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="kubectl-config를-저장하기-위해-kube-directory를-생성">kubectl config를 저장하기 위해 .kube directory를 생성<a class="hash-link" href="#kubectl-config를-저장하기-위해-kube-directory를-생성" title="Direct link to heading">​</a></h4><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> -p ~/.kube</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="kubectl-설치-linux">kubectl 설치 (linux)<a class="hash-link" href="#kubectl-설치-linux" title="Direct link to heading">​</a></h4><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> --silent --location -o /usr/local/bin/kubectl </span><span class="token string" style="color:#e3116c">&quot;https://amazon-eks.s3-us-west-2.amazonaws.com/1.11.5/2018-12-06/bin/linux/amd64/kubectl&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">chmod</span><span class="token plain"> +x /usr/local/bin/kubectl</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="kubectl-설치-macos-homebrew">kubectl 설치 (MacOS Homebrew)<a class="hash-link" href="#kubectl-설치-macos-homebrew" title="Direct link to heading">​</a></h4><p>MacOS는 brew로 설치하였다.<br>
<a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/#install-with-homebrew-on-macos" target="_blank" rel="noopener noreferrer">https://kubernetes.io/docs/tasks/tools/install-kubectl/#install-with-homebrew-on-macos</a></p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ brew </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> kubernetes-cli</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="kubectl-설치-windows-powershell">kubectl 설치 (windows PowerShell)<a class="hash-link" href="#kubectl-설치-windows-powershell" title="Direct link to heading">​</a></h4><p><a href="https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/install-kubectl.html" target="_blank" rel="noopener noreferrer">https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/install-kubectl.html</a></p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">curl -o kubectl.exe https://amazon-eks.s3-us-west-2.amazonaws.com/1.10.3/2018-07-26/bin/windows/amd64/kubectl.exe</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="kubectl-설치-확인">kubectl 설치 확인<a class="hash-link" href="#kubectl-설치-확인" title="Direct link to heading">​</a></h4><p>현재 MacOS에서는 1.11.7 버전이 설치되어 있다. (다른경로로 설치됨)</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl version --short --client</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Client Version: v1.11.7-dispatcher</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="aws-iam-authenticator-설치">aws-iam-authenticator 설치<a class="hash-link" href="#aws-iam-authenticator-설치" title="Direct link to heading">​</a></h4><p>Amazon EKS는 IAM을 사용하여 Kubernetes용 AWS IAM Authenticator를 통해 Kubernetes 클러스터에 인증을 제공한다.  Go(버전 1.7이상)가 설치되어 있으면 아래와 같이 진행하면 된다. </p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ go get -u -v github.com/kubernetes-sigs/aws-iam-authenticator/cmd/aws-iam-authenticator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">mv</span><span class="token plain"> ~/go/bin/aws-iam-authenticator /usr/local/bin/aws-iam-authenticator</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>만약 Go설치가 안되어 있다면 다음 링크를 통해 설치 진행할수 있다.<br>
<a href="https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/install-aws-iam-authenticator.html" target="_blank" rel="noopener noreferrer">https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/install-aws-iam-authenticator.html</a></p><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="aws-iam-authenticator-binary-다운로드">aws-iam-authenticator binary 다운로드<a class="hash-link" href="#aws-iam-authenticator-binary-다운로드" title="Direct link to heading">​</a></h4><p>Linux: <a href="https://amazon-eks.s3-us-west-2.amazonaws.com/1.10.3/2018-07-26/bin/linux/amd64/aws-iam-authenticator" target="_blank" rel="noopener noreferrer">https://amazon-eks.s3-us-west-2.amazonaws.com/1.10.3/2018-07-26/bin/linux/amd64/aws-iam-authenticator</a><br>
<!-- -->MacOS: <a href="https://amazon-eks.s3-us-west-2.amazonaws.com/1.10.3/2018-07-26/bin/darwin/amd64/aws-iam-authenticator" target="_blank" rel="noopener noreferrer">https://amazon-eks.s3-us-west-2.amazonaws.com/1.10.3/2018-07-26/bin/darwin/amd64/aws-iam-authenticator</a><br>
<!-- -->Windows: <a href="https://amazon-eks.s3-us-west-2.amazonaws.com/1.10.3/2018-07-26/bin/windows/amd64/aws-iam-authenticator.exe" target="_blank" rel="noopener noreferrer">https://amazon-eks.s3-us-west-2.amazonaws.com/1.10.3/2018-07-26/bin/windows/amd64/aws-iam-authenticator.exe</a></p><h5 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="macos의-경우">MacOS의 경우<a class="hash-link" href="#macos의-경우" title="Direct link to heading">​</a></h5><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> -o aws-iam-authenticator https://amazon-eks.s3-us-west-2.amazonaws.com/1.10.3/2018-07-26/bin/darwin/amd64/aws-iam-authenticator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">chmod</span><span class="token plain"> +x ./aws-iam-authenticator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">cp</span><span class="token plain"> ./aws-iam-authenticator </span><span class="token environment constant" style="color:#36acaa">$HOME</span><span class="token plain">/bin/aws-iam-authenticator </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable environment constant" style="color:#36acaa">PATH</span><span class="token operator" style="color:#393A34">=</span><span class="token environment constant" style="color:#36acaa">$HOME</span><span class="token plain">/bin:</span><span class="token environment constant" style="color:#36acaa">$PATH</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h5 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="macos-bash-환경변수-추가">MacOS bash 환경변수 추가<a class="hash-link" href="#macos-bash-환경변수-추가" title="Direct link to heading">​</a></h5><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;export PATH=$HOME/bin:$PATH&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token plain"> ~/.bash_profile</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h5 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="macos-zsh-환경변수-추가">MacOS zsh 환경변수 추가<a class="hash-link" href="#macos-zsh-환경변수-추가" title="Direct link to heading">​</a></h5><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;export PATH=$HOME/bin:$PATH&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token plain"> ~/.zshrc</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="aws-iam-authenticator-binary-확인">aws-iam-authenticator binary 확인<a class="hash-link" href="#aws-iam-authenticator-binary-확인" title="Direct link to heading">​</a></h4><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ aws-iam-authenticator </span><span class="token builtin class-name">help</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="eksctl">eksctl<a class="hash-link" href="#eksctl" title="Direct link to heading">​</a></h3><p><img loading="lazy" src="https://github.com/weaveworks/eksctl/blob/master/logo/eksctl.png?raw=true" alt="mascot" class="img_E7b_"></p><p>eksctl은 weaveworks에서 contribute하고 있는 오픈소스로 EKS 클러스터를 생성하는 간단한 CLI 도구이다. Go로 작성되어 있고 CloudFormation을 기본으로 동작한다.  </p><p><a href="https://eksctl.io/" target="_blank" rel="noopener noreferrer">https://eksctl.io/</a><br>
<a href="https://github.com/weaveworks/eksctl" target="_blank" rel="noopener noreferrer">https://github.com/weaveworks/eksctl</a></p><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="eksctl-binary-다운로드">eksctl binary 다운로드<a class="hash-link" href="#eksctl-binary-다운로드" title="Direct link to heading">​</a></h4><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> --silent --location </span><span class="token string" style="color:#e3116c">&quot;https://github.com/weaveworks/eksctl/releases/download/latest_release/eksctl_</span><span class="token string variable" style="color:#36acaa">$(</span><span class="token string variable function" style="color:#d73a49">uname</span><span class="token string variable" style="color:#36acaa"> -s</span><span class="token string variable" style="color:#36acaa">)</span><span class="token string" style="color:#e3116c">_amd64.tar.gz&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">tar</span><span class="token plain"> xz -C /tmp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">mv</span><span class="token plain"> -v /tmp/eksctl /usr/local/bin</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="macos-homebrew-설치">MacOS Homebrew 설치<a class="hash-link" href="#macos-homebrew-설치" title="Direct link to heading">​</a></h4><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ brew tap weaveworks/tap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ brew </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> weaveworks/tap/eksctl</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="windows-설치-powershell-chocolatey">Windows 설치 (PowerShell, chocolatey)<a class="hash-link" href="#windows-설치-powershell-chocolatey" title="Direct link to heading">​</a></h4><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">chocolatey install eksctl</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="eksctl-동작확인">eksctl 동작확인<a class="hash-link" href="#eksctl-동작확인" title="Direct link to heading">​</a></h4><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ eksctl version</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="cli-api-자격증명-구성">CLI API 자격증명 구성<a class="hash-link" href="#cli-api-자격증명-구성" title="Direct link to heading">​</a></h4><p>사전설정한 aws configure가 있는지 확인. 기존 Terraform이나 kops 사용한적이 있으면 건너뛰어도 된다.  </p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">ls</span><span class="token plain">  ~/.aws</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>없을경우 aws 자격증명을 생성한다.</p><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="awscredentials">~/.aws/credentials<a class="hash-link" href="#awscredentials" title="Direct link to heading">​</a></h4><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">[default]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aws_access_key_id={EXAMPLE}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aws_secret_access_key={EXAMPLEKEY}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="awsconfig">~/.aws/config<a class="hash-link" href="#awsconfig" title="Direct link to heading">​</a></h4><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">[default]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">region=ap-northeast-2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output=json</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="eks-배포">EKS 배포<a class="hash-link" href="#eks-배포" title="Direct link to heading">​</a></h2><p>kubectl, aws-iam-authenticator, eksctl, AWS 자격증명 환경까지 구성되어 있으면 바로 배포가 가능하다.  </p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ eksctl create cluster --name</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">eksworkshop-eksctl --nodes</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> --node-ami</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">auto</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ℹ</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  using region ap-northeast-2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ℹ</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  setting availability zones to </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ap-northeast-2a ap-northeast-2c ap-northeast-2a</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ℹ</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  subnets </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> ap-northeast-2a - public:192.168.0.0/19 private:192.168.96.0/19</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ℹ</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  subnets </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> ap-northeast-2c - public:192.168.32.0/19 private:192.168.128.0/19</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ℹ</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  subnets </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> ap-northeast-2a - public:192.168.64.0/19 private:192.168.160.0/19</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ℹ</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  nodegroup </span><span class="token string" style="color:#e3116c">&quot;ng-cfb3cb01&quot;</span><span class="token plain"> will use </span><span class="token string" style="color:#e3116c">&quot;ami-0c7972077aa002104&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">AmazonLinux2/1.11</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ℹ</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  creating EKS cluster </span><span class="token string" style="color:#e3116c">&quot;eksworkshop-eksctl&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;ap-northeast-2&quot;</span><span class="token plain"> region</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ℹ</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  will create </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> separate CloudFormation stacks </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> cluster itself and the initial nodegroup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ℹ</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> you encounter any issues, check CloudFormation console or try </span><span class="token string" style="color:#e3116c">&#x27;eksctl utils describe-stacks --region=ap-northeast-2 --name=eksworkshop-eksctl&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ℹ</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  creating cluster stack </span><span class="token string" style="color:#e3116c">&quot;eksctl-eksworkshop-eksctl-cluster&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ℹ</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  creating nodegroup stack </span><span class="token string" style="color:#e3116c">&quot;eksctl-eksworkshop-eksctl-nodegroup-ng-cfb3cb01&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ℹ</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  --nodes-min</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> was </span><span class="token builtin class-name">set</span><span class="token plain"> automatically</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ℹ</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  --nodes-max</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> was </span><span class="token builtin class-name">set</span><span class="token plain"> automatically</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">✔</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  all EKS cluster resource </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;eksworkshop-eksctl&quot;</span><span class="token plain"> had been created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">✔</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  saved kubeconfig as </span><span class="token string" style="color:#e3116c">&quot;/Users/ddii/.kube/config&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ℹ</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  nodegroup </span><span class="token string" style="color:#e3116c">&quot;ng-cfb3cb01&quot;</span><span class="token plain"> has </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ℹ</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  waiting </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> at least </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> to become ready </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;ng-cfb3cb01&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ℹ</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  nodegroup </span><span class="token string" style="color:#e3116c">&quot;ng-cfb3cb01&quot;</span><span class="token plain"> has </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ℹ</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;ip-192-168-42-42.ap-northeast-2.compute.internal&quot;</span><span class="token plain"> is ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ℹ</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;ip-192-168-66-165.ap-northeast-2.compute.internal&quot;</span><span class="token plain"> is ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ℹ</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  kubectl </span><span class="token builtin class-name">command</span><span class="token plain"> should work with </span><span class="token string" style="color:#e3116c">&quot;/Users/ddii/.kube/config&quot;</span><span class="token plain">, try </span><span class="token string" style="color:#e3116c">&#x27;kubectl get nodes&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">✔</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  EKS cluster </span><span class="token string" style="color:#e3116c">&quot;eksworkshop-eksctl&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;ap-northeast-2&quot;</span><span class="token plain"> region is ready</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>서울리전(ap-northeast-2)기준 약 15-20분이 소요되며 <code>eksctl</code> 기본 설정값은 다음과 같다.</p><ul><li>클러스터명은 자동생성, --name 옵션으로 지정가능 (eksworkshop-eksctl)</li><li>CloudFormation : eksctl-{$Cluster_Name}-cluster</li><li>m5.large * 2 instances (<a href="https://github.com/awslabs/amazon-eks-ami/blob/7f6c8cb3597e17f6e5f7df96d12bccf5604dc909/amazon-eks-nodegroup.yaml" target="_blank" rel="noopener noreferrer">EKS Instance Type</a> NodeInstanceType.AllowedValues 참고)</li><li>Default AMI : AWS EKS AMI (custom EKS AMI 가능 - Packer활용)</li><li>Default Region : us-west-2</li><li>dedicated VPC : 192.168.0.0/16 </li><li>kubernetes version : 1.11.x (<a href="https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/platform-versions.html" target="_blank" rel="noopener noreferrer">EKS Version</a> 참고)</li><li>StorageClass : gp2 (<a href="https://kubernetes.io/docs/concepts/storage/storage-classes/#aws-ebs" target="_blank" rel="noopener noreferrer">AWS EBS</a> 참고)</li><li>CNI : <a href="https://github.com/aws/amazon-vpc-cni-k8s" target="_blank" rel="noopener noreferrer">Amazon VPC</a></li><li>Node Autoscaler : --node-min, --node-max Auto Scaling 설정</li><li>기본 Pod 개수 : <a href="https://github.com/awslabs/amazon-eks-ami/blob/7f6c8cb3597e17f6e5f7df96d12bccf5604dc909/files/eni-max-pods.txt" target="_blank" rel="noopener noreferrer">참고</a></li><li>nodegroup : worker가 포함되는 group </li><li>kubeconfig : ~/.kube/config 로 통합됨</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="config-file-사용">Config File 사용<a class="hash-link" href="#config-file-사용" title="Direct link to heading">​</a></h3><p><a href="https://github.com/weaveworks/eksctl/tree/master/examples" target="_blank" rel="noopener noreferrer">https://github.com/weaveworks/eksctl/tree/master/examples</a>를 참고하여 <code>YAML</code>형태로 작성하여 배포가능하다. </p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ eksctl create cluster -f example.yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>기존에 관리하는 VPC subnet정보 및 AutoScaling, AZ(availabilityZones)설정, nodegroup 관리, node Instance에 preBootstrapCommand등을 아래 예시와 같이 미리 작성하면 GitOps측면에서 활용도가 더욱 높아질수 있다.</p><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="05-advanced-nodegroupsyaml">05-advanced-nodegroups.yaml<a class="hash-link" href="#05-advanced-nodegroupsyaml" title="Direct link to heading">​</a></h4><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># An advanced example of ClusterConfig object with customised nodegroups:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> eksctl.io/v1alpha4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ClusterConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cluster</span><span class="token punctuation" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">5</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">region</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> eu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">west</span><span class="token punctuation" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">nodeGroups</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ng1</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">public</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">instanceType</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> m5.xlarge</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">minSize</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">maxSize</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">nodegroup-type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> frontend</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">workloads</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">iam</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">withAddonPolicies</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">autoScaler</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ng2</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">private</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">instanceType</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> m5.large</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">desiredCapacity</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">nodegroup-type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> backend</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">cluster</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">addons</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">privateNetworking</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">preBootsrapCommand</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># allow docker registries to be deployed as cluster service </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;echo {\&quot;insecure-registries\&quot;: [\&quot;172.20.0.0/16\&quot;,\&quot;10.100.0.0/16\&quot;]} &gt; /etc/docker/daemon.json&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;systemctl restart docker&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ng3</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">private</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">b</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">instanceType</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> c3.8xlarge</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">desiredCapacity</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">nodegroup-type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> very</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">special</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">science</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">workloads</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">privateNetworking</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">availabilityZones</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;eu-west-2a&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># use single AZ to optimise data transfer between isntances</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">preBootstrapCommand</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># disable hyperthreading</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;for n in $(cat /sys/devices/system/cpu/cpu*/topology/thread_siblings_list | cut -s -d, -f2- | tr &#x27;,&#x27; &#x27;\n&#x27; | sort -un); do echo 0 &gt; /sys/devices/system/cpu/cpu${n}/online; done&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># cluster AZs must be set explicitly for single AZ nodegroup example to work</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">availabilityZones</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;eu-west-2a&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;eu-west-2b&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;eu-west-2c&quot;</span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="kubernetes-대시보드-배포">Kubernetes 대시보드 배포<a class="hash-link" href="#kubernetes-대시보드-배포" title="Direct link to heading">​</a></h2><p>Kubernetes 공식 대시보드는 기본으로 배포되지 않기 때문에 수동으로 배포해야한다. 설치 방법은 <a href="https://kubernetes.io/docs/tasks/access-application-cluster/web-ui-dashboard/" target="_blank" rel="noopener noreferrer">공식 문서</a>에서 확인가능하다.  </p><p>위에서 구성된 클러스터에서 Kubernetes 대시보드를 배포한다.</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v1.10.1/src/deploy/recommended/kubernetes-dashboard.yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>접속을 위해 kube-proxy 기능을 활용하여 8080포트로 expose를 진행한다. 모든 인터페이스에서 필터링없이 접속이 가능하도록 옵션을 지정한다.
아래 명령은 터미널에서 백그라운드로 계속 동작한다.  </p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl proxy --port</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">8080</span><span class="token plain"> --address</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;0.0.0.0&#x27;</span><span class="token plain"> --disable-filter</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">W0328 </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:39:09.061754    </span><span class="token number" style="color:#36acaa">9100</span><span class="token plain"> proxy.go:139</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Request filter disabled, your proxy is vulnerable to XSRF attacks, please be cautious</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>TOKEN으로 접속하기 위해 aws-iam-authenticator를 통해 해당 클러스터 token을 확인한다.  </p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ aws-iam-authenticator token -i eksworkshop-eksctl --token-only</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">k8s-aws-v1.aHR0cHM6Ly9zdHMuYXAtbm9ydGhlYXN0LTIuYW1hem9uYXdzLmNvbS8_QWN0aW9uPUdldENhbGxlcklkZW50aXR5JlZlcnNpb249MjAxMS0wNi0xNSZYLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFKMjVNVjJSVVZQNlRWTURBJTJGMjAxOTAzMjglMkZhcC1ub3J0aGVhc3QtMiUyRnN0cyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMTkwMzI4VDA3NDEwNVomWC1BbXotRXhwaXJlcz0wJlgtQW16LVNpZ25lZEhlYWRlcnM9aG9zdCUzQngtazhzLWF3cy1pZCZYLUFtei1TaWduYXR1cmU9Yjc0NzkzYzUwOTU5NDYwMzMxMjY2YjExYWY4ODBkM2Q2OWQ5MWRhYzFhZWY1NjZmZTAwNTNlNWY2MTM0NGFlZQ</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>그냥 localhost:8080 으로만 접속하면 구성된 클러스터 kube API list를 확인되므로 아래 경로로 접속한다.<br>
<!-- -->위에서 출력된 TOKEN값으로 로그인한다. Token 세션 Timeout이 있으니 세션만료시 <code>aws-iam-authenticator</code> 명령을 통해 갱신값을 입력하면 된다.  </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">http://localhost:8080/api/v1/namespaces/kube-system/services/https:kubernetes-dashboard:/proxy/#!/login</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p><img loading="lazy" alt="dashboard" src="/assets/images/k8s_dashboard-b1c80ac04a6d1ec9d73b613952ef37c1.png" width="1950" height="1118" class="img_E7b_"></p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="microservice-app-배포">Microservice app 배포<a class="hash-link" href="#microservice-app-배포" title="Direct link to heading">​</a></h2><p>가장 기본적인 <a href="https://microservices-demo.github.io/" target="_blank" rel="noopener noreferrer">Sock Shop</a>을 배포하기 위해 Git Clone 수행</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone https://github.com/microservices-demo/microservices-demo.git sockshop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token builtin class-name">cd</span><span class="token plain"> sockshop/deploy/kubernetes</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p><code>NodePort</code>로 되어있는 Front-End Service를 <code>LoadBalancer</code>로 수정한다.</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">sed</span><span class="token plain"> -i </span><span class="token string" style="color:#e3116c">&#x27;s/NodePort/LoadBalancer/g&#x27;</span><span class="token plain"> complete-demo.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> complete-demo.yaml </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">grep</span><span class="token plain"> LoadBalancer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> type: LoadBalancer</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>namespace 생성 및 sock-shop 배포</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl create namespace sock-shop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl apply -f complete-demo.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get all</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>서비스 접속확인을 위해서는 ALB배포시간(DNS전파)이 일정 소요되므로 잠시후 접속을 시도한다.</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get svc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME           TYPE           CLUSTER-IP       EXTERNAL-IP                                                                 PORT</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">S</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">        AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">carts          ClusterIP      </span><span class="token number" style="color:#36acaa">10.100</span><span class="token plain">.84.58     </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">                                                                      </span><span class="token number" style="color:#36acaa">80</span><span class="token plain">/TCP         1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">carts-db       ClusterIP      </span><span class="token number" style="color:#36acaa">10.100</span><span class="token plain">.227.156   </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">                                                                      </span><span class="token number" style="color:#36acaa">27017</span><span class="token plain">/TCP      1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">catalogue      ClusterIP      </span><span class="token number" style="color:#36acaa">10.100</span><span class="token plain">.206.52    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">                                                                      </span><span class="token number" style="color:#36acaa">80</span><span class="token plain">/TCP         1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">catalogue-db   ClusterIP      </span><span class="token number" style="color:#36acaa">10.100</span><span class="token plain">.119.66    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">                                                                      </span><span class="token number" style="color:#36acaa">3306</span><span class="token plain">/TCP       1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">front-end      LoadBalancer   </span><span class="token number" style="color:#36acaa">10.100</span><span class="token plain">.249.164   a4c42cfe951be11e9bb8c0a8cd8a2e5d-8156023.ap-northeast-2.elb.amazonaws.com   </span><span class="token number" style="color:#36acaa">80</span><span class="token plain">:30001/TCP   1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">orders         ClusterIP      </span><span class="token number" style="color:#36acaa">10.100</span><span class="token plain">.160.17    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">                                                                      </span><span class="token number" style="color:#36acaa">80</span><span class="token plain">/TCP         1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">orders-db      ClusterIP      </span><span class="token number" style="color:#36acaa">10.100</span><span class="token plain">.70.203    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">                                                                      </span><span class="token number" style="color:#36acaa">27017</span><span class="token plain">/TCP      1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payment        ClusterIP      </span><span class="token number" style="color:#36acaa">10.100</span><span class="token plain">.57.233    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">                                                                      </span><span class="token number" style="color:#36acaa">80</span><span class="token plain">/TCP         1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">queue-master   ClusterIP      </span><span class="token number" style="color:#36acaa">10.100</span><span class="token plain">.146.109   </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">                                                                      </span><span class="token number" style="color:#36acaa">80</span><span class="token plain">/TCP         1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmq       ClusterIP      </span><span class="token number" style="color:#36acaa">10.100</span><span class="token plain">.32.115    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">                                                                      </span><span class="token number" style="color:#36acaa">5672</span><span class="token plain">/TCP       1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">shipping       ClusterIP      </span><span class="token number" style="color:#36acaa">10.100</span><span class="token plain">.180.174   </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">                                                                      </span><span class="token number" style="color:#36acaa">80</span><span class="token plain">/TCP         1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">user           ClusterIP      </span><span class="token number" style="color:#36acaa">10.100</span><span class="token plain">.211.41    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">                                                                      </span><span class="token number" style="color:#36acaa">80</span><span class="token plain">/TCP         1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">user-db        ClusterIP      </span><span class="token number" style="color:#36acaa">10.100</span><span class="token plain">.87.142    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">                                                                      </span><span class="token number" style="color:#36acaa">27017</span><span class="token plain">/TCP      1h</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>브라우저에서 ALB주소 <code>a4c42cfe951be11e9bb8c0a8cd8a2e5d-8156023.ap-northeast-2.elb.amazonaws.com</code> 로 접속하여 sock-shop Demo Web을 확인할수 있다.  </p><p><img loading="lazy" alt="sockshop" src="/assets/images/sock-shop-42ee8cb05cf4ad155e4890fd1370a6d8.png" width="719" height="800" class="img_E7b_"></p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="eks-클러스터-및-삭제">EKS 클러스터 및 삭제<a class="hash-link" href="#eks-클러스터-및-삭제" title="Direct link to heading">​</a></h2><p>위에서 외부접속을 위해 LoadBalancer를 수동으로 설정하였으므로 EC2 - Load Balancer서 프로비저닝된 ALB를 삭제하고 진행해야 한다.  </p><p>클러스터에서 실행 중인 모든 서비스를 다시 확인하고 EXTERNAL-IP값과 연결된 모든 서비스를 삭제한다.  </p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get svc --all-namespaces</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl delete svc front-end</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>ALB와 VPC 삭제가 완료된것을 확인하고 클러스터를 삭제하자.  </p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ eksctl delete cluster --name</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">eksworkshop-eksctl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ℹ</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  deleting EKS cluster </span><span class="token string" style="color:#e3116c">&quot;eksworkshop-eksctl&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ℹ</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  will delete stack </span><span class="token string" style="color:#e3116c">&quot;eksctl-eksworkshop-eksctl-nodegroup-ng-3af535b7&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ℹ</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  waiting </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> stack </span><span class="token string" style="color:#e3116c">&quot;eksctl-eksworkshop-eksctl-nodegroup-ng-3af535b7&quot;</span><span class="token plain"> to get deleted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ℹ</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  will delete stack </span><span class="token string" style="color:#e3116c">&quot;eksctl-eksworkshop-eksctl-cluster&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">✔</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  kubeconfig has been updated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">✔</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  the following EKS cluster resource</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;eksworkshop-eksctl&quot;</span><span class="token plain"> will be deleted: cluster. If </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> doubt, check CloudFormation console</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="정리">정리<a class="hash-link" href="#정리" title="Direct link to heading">​</a></h2><p>서울 리전(ap-northeast-2)에 EKS가 오픈되고 Production환경을 EKS로 넘어가는 기업들이 많아지고 있는건 아주 긍정적인 현상이다.<br>
<!-- -->또한 엄청난 속도의 기술개발과 다양한 툴들로 Kubernetes Cluster를 구성하거나 Microservice형태의 App을 배포하는것은 점점 대중화 되어가고 있다.<br>
<!-- -->실제 Production에서 구현을 하기 위해서는 보안 및 성능을 동시에 고려한 네트워크(CNI), Ingress 설정이나 전체 클러스터 퍼포먼스 측면에서의 파라미터 튜닝이 더욱 더 중요해지고 관련된 DevOps(SRE) 인력들의 중요도가 높아질것은 분명해 보인다.  </p><p>EKS를 오픈소스 측면에서 고려했을때에는 예전에 페이스북이나 다른곳에서 종종 이야기 했던것처럼 AWS 고유의 Lock-in 전략을 엄청나게 고민하고 발표한듯한 생각이 한 느낌을 지울수는 없는건 사실이지만 훌륭한 제품인건 확실하고 단기간에 서비스 성장속도를 낼 수 있는 서비스라 생각한다.  </p><p>마지막으로 Managed Kubernetes의 선택은 엔지니어의 몫으로 보고 각 벤더별 비교한 아래 링크를 참조해서 선정 기준을 잡으면 더욱 좋을것 같다.<br>
<a href="https://docs.google.com/spreadsheets/d/1U0x4-NQegEPGM7eVTKJemhkPy18LWuHW5vX8uZzqzYo/edit#gid=0" target="_blank" rel="noopener noreferrer">https://docs.google.com/spreadsheets/d/1U0x4-NQegEPGM7eVTKJemhkPy18LWuHW5vX8uZzqzYo/edit#gid=0</a></p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/eks">eks</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/aws">aws</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/kubernetes">Kubernetes</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/eskworkshop">eskworkshop</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/kubectl">kubectl</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/managed-kubernetes">Managed Kubernetes</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2019/03/21/git-sync">git-sync</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2019-03-21T00:00:00.000Z" itemprop="datePublished">March 21, 2019</time> · <!-- -->9 min read</div></header><div class="markdown" itemprop="articleBody"><p>git repo를 kubernetes volume으로 구현할수 있는 sidecar pattern <code>git-sync</code> 프로젝트에 대해서 알아본다.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="git-sync">git-sync<a class="hash-link" href="#git-sync" title="Direct link to heading">​</a></h2><p><a href="https://github.com/kubernetes" target="_blank" rel="noopener noreferrer">Kubernetes Github</a>에 방문하면 다양한 프로젝트들을 볼 수 있다.<br>
<a href="https://github.com/kubernetes/kubernetes" target="_blank" rel="noopener noreferrer">Kubernetes Project</a>부터 minikube, kubeadm, kubectl, kubelet, dashboard등 필수적으로 필요하거나 많이 사용되는 프로젝트를 볼 수 있는데,
기존에 storage volume 으로 활용되던 <a href="https://kubernetes.io/docs/concepts/storage/volumes/#gitrepo" target="_blank" rel="noopener noreferrer">gitrepo</a>가 <code>deprecated</code> 되어서 방법을 찾다가 유사한 프로젝트를 공식 repo에서 우연히 발견하게 되었다.  </p><p><a href="https://github.com/kubernetes/git-sync" target="_blank" rel="noopener noreferrer">git-sync</a>는 sidecar 방식으로 git repository를 clone하는 프로젝트이다.  </p><p>최초 한번 clone도 가능하고 일정한 간격으로 끌어와서 응용프로그램에 사용할 수 있고 원하는 branch, Tag 또는 특정 git hash 기반으로 pulling이 가능하다.  </p><p>upstream의 repository에서 대상이 변경되었을때 다시 pulling하고, webhook기능을 추가하여 비동기성으로 POST 요청이 있을때만 git-sync를 수행할수 있기 때문에
Continuous Deployment를 간단하게 구현하는데 활용될 수 있다. </p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="github-ssh설정">GitHub SSH설정<a class="hash-link" href="#github-ssh설정" title="Direct link to heading">​</a></h2><p>git 내용을 pulling을 할때 https, ssh 방법을 사용하는데 GitHub ssh key를 kubernetes cluster의 secret으로 사용을 할수 있기 때문에 ssh 방식을 사용하는 방법을 작성하였다.  </p><p>아래 모든 과정은 MacOS에서 진행하였고 다른 OS는 아래 링크에서 확인 가능하다.<br>
<a href="https://help.github.com/en/articles/connecting-to-github-with-ssh" target="_blank" rel="noopener noreferrer">https://help.github.com/en/articles/connecting-to-github-with-ssh</a></p><p>사용하고자 하는 터미널에서 등록키를 확인하자.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="기존에-등록된-ssh-key-확인">기존에 등록된 SSH key 확인<a class="hash-link" href="#기존에-등록된-ssh-key-확인" title="Direct link to heading">​</a></h3><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ ls -al ~/.ssh</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="새로운-ssh-key-생성">새로운 SSH key 생성<a class="hash-link" href="#새로운-ssh-key-생성" title="Direct link to heading">​</a></h3><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ ssh-keygen -t rsa -b 4096 -C &quot;ddiiwoong@gmail.com&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Start the SSH key creation process</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; Enter file in which the key is (/Users/you/.ssh/id_rsa): [Hit enter]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; Key has comment &#x27;/Users/you/.ssh/id_rsa&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; Enter new passphrase (empty for no passphrase): [Type new passphrase]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; Enter same passphrase again: [One more time for luck]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; Your identification has been saved with the new passphrase.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="ssh-agent-실행중인지-확인">ssh agent 실행중인지 확인<a class="hash-link" href="#ssh-agent-실행중인지-확인" title="Direct link to heading">​</a></h3><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">eval “$(ssh-agent -s)”</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; Agent pid 59566</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="생성된-키를-keychain에-저장-및-확인">생성된 키를 keychain에 저장 및 확인<a class="hash-link" href="#생성된-키를-keychain에-저장-및-확인" title="Direct link to heading">​</a></h3><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ ssh-add -K ~/.ssh/id_rsa</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ cat ~/.ssh/id_rsa.pub</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="복사-및-github에-추가">복사 및 github에 추가<a class="hash-link" href="#복사-및-github에-추가" title="Direct link to heading">​</a></h3><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ pbcopy &lt; ~/.ssh/id_rsa.pub</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Setting - SSH and GPG keys - SSH keys - New SSH key<br>
<code>Title</code>은 구분자로 입력하고 GitHub password를 한번더 입력하고 완료한다.  </p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="터미널에서-ssh접속-확인">터미널에서 SSH접속 확인<a class="hash-link" href="#터미널에서-ssh접속-확인" title="Direct link to heading">​</a></h3><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ ssh -T git@github.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Hi ddiiwoong! You&#x27;ve successfully authenticated, but GitHub does not provide shell access.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="git-sync를-위한-secret-등록">git-sync를 위한 secret 등록<a class="hash-link" href="#git-sync를-위한-secret-등록" title="Direct link to heading">​</a></h2><p><a href="https://github.com/kubernetes/git-sync/blob/master/docs/ssh.md" target="_blank" rel="noopener noreferrer">https://github.com/kubernetes/git-sync/blob/master/docs/ssh.md</a></p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="secret-생성">secret 생성<a class="hash-link" href="#secret-생성" title="Direct link to heading">​</a></h3><p>위에서 생성한 SSH key를 Kubernetes Cluster에 Secret resource로 저장을 한다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ ssh-keyscan github.com &gt; /tmp/known_hosts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># github.com:22 SSH-2.0-babeld-9d924d26</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># github.com:22 SSH-2.0-babeld-9d924d26</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># github.com:22 SSH-2.0-babeld-9d924d26</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>known_hosts와 key를 Secret으로 저장한다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl create secret generic git-creds \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --from-file=ssh=$HOME/.ssh/id_rsa \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --from-file=known_hosts=/tmp/known_hosts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get secret git-creds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME        TYPE      DATA      AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">git-creds   Opaque    2         1d</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="sample-ngnix-배포">sample ngnix 배포<a class="hash-link" href="#sample-ngnix-배포" title="Direct link to heading">​</a></h2><p>기본적으로 <code>git-sync/cmd/git-sync/main.go</code> 소스를 확인하면 여러가지 flag를 확인할 수 있는데 주로 사용하는 옵션은 다음과 같다.</p><ul><li>ssh : pulling 방식 (default=false)</li><li>root : git clone이 수행되는 root directory (default=&quot;$HOME/git&quot;)</li><li>repo : clone 대상 Repository (default=&quot;&quot;)</li><li>branch : branch (default=master)</li><li>rev : git revision (tag or hash) to check out</li><li>depth : commit depth (default=0)</li><li>dest : repository 배포 directory</li></ul><p>기타 옵션들은 <code>git-sync/cmd/git-sync/main.go</code> 에서 확인이 가능하며 해당 옵션들을 변수로 처리하여 활용하면 된다.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="git-sync-demoyaml-작성">git-sync-demo.yaml 작성<a class="hash-link" href="#git-sync-demoyaml-작성" title="Direct link to heading">​</a></h3><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: extensions/v1beta1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    app: git-sync-demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: git-sync-demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  namespace: default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  replicas: 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  selector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    matchLabels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      app: git-sync-demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  template:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        app: git-sync-demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - name: nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        image: nginx:1.14-alpine</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ports:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - containerPort: 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        volumeMounts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - name: git-sync-volume</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          mountPath: /usr/share/nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - name: git-sync</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        image: k8s.gcr.io/git-sync:v3.1.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        imagePullPolicy: Always</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        args:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         - &quot;-ssh&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         - &quot;-repo=git@github.com:ddiiwoong/git-sync-demo.git&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         - &quot;-root=/usr/share/nginx&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         - &quot;-dest=html&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         - &quot;-branch=master&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         - &quot;-depth=1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        volumeMounts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - name: git-sync-volume</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          mountPath: /usr/share/nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - name: git-secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          mountPath: /etc/git-secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      volumes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - name: git-sync-volume</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        emptyDir: {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - name: git-secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        secret:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          secretName: git-creds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          defaultMode: 288 # = mode 0440</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      securityContext:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fsGroup: 65533 # to make SSH key readable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: git-sync-demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type: NodePort</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  selector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    app: git-sync-demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ports:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - protocol: TCP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    port: 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    targetPort: 80</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="확인사항">확인사항<a class="hash-link" href="#확인사항" title="Direct link to heading">​</a></h3><p>일단 ngnix로 1.14-alpine Image를 기본으로 하고 git-sync container가 sidecar로 들어가도록 작성하였다.<br>
<!-- -->실제 동작하는 순서대로 manifest를 아래서부터 살펴보자.</p><ul><li>git-sync-volume은 <code>emptyDir</code>, git-secret은 <code>secret</code> volume 설정<div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    volumes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - name: git-sync-volume</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      emptyDir: {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - name: git-secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      secret:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        secretName: git-creds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        defaultMode: 288 # = mode 0440</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></li><li>sidecar container image를 <code>k8s.gcr.io/git-sync:v3.1.1</code>로 설정</li><li><code>git-sync-volume</code>, <code>git-sync-volume</code> volume을 <code>git-sync</code> sidecar에 마운트</li><li>위에서 이야기한 <code>git-sync</code> flag, args로 설정<div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - name: git-sync</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      image: k8s.gcr.io/git-sync:v3.1.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      imagePullPolicy: Always</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      args:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       - &quot;-ssh&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       - &quot;-repo=git@github.com:ddiiwoong/git-sync-demo.git&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       - &quot;-root=/usr/share/nginx&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       - &quot;-dest=html&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       - &quot;-branch=master&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       - &quot;-depth=1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      volumeMounts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - name: git-sync-volume</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mountPath: /usr/share/nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - name: git-secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mountPath: /etc/git-secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></li><li>nginx 기본 위치가 <code>/usr/share/nginx</code> 이므로 mount 위치를 git-sync-volume으로 설정<div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - name: nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      image: nginx:1.14-alpine</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ports:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - containerPort: 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      volumeMounts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - name: git-sync-volume</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mountPath: /usr/share/nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></li></ul><p>위 nginx를 배포하고 접속하면 <code>Hello git-sync demo v1.0</code>를 확인할 수 있다.</p><p>결국 git repo code (static html page)는 <code>/usr/share/nginx/html</code> 위치에 clone 되는것처럼 보이지만
실제 clone 위치를 확인해보면 symbolic link로 특정 revision dir를 가리키고 있다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl exec -it git-sync-demo-665c9c9ddf-6nwc4 sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Defaulting container name to nginx.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Use &#x27;kubectl describe pod/git-sync-demo-665c9c9ddf-6nwc4 -n default&#x27; to see all of the containers in this pod.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/ # cd /usr/share/nginx/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/usr/share/nginx # ls -al</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">total 16</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxrwsrwx    4 root     nogroup       4096 Mar 21 06:54 .</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-xr-x    1 root     root          4096 Mar  8 03:09 ..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-sr-x    9 65533    nogroup       4096 Mar 21 06:54 .git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lrwxrwxrwx    1 65533    nogroup         44 Mar 21 06:54 html -&gt; rev-07aa36f719091d75b5665203fa5846a549e7d540</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-sr-x    2 65533    nogroup       4096 Mar 21 06:54 rev-07aa36f719091d75b5665203fa5846a549e7d540</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/usr/share/nginx # cat ./html/index.html</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;!DOCTYPE html&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;html&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;head&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;title&gt;Hello git-sync demo&lt;/title&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;/head&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;body&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;h1&gt;Hello git-sync demo v1.0&lt;/h1&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;/body&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;/html&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>github에 있는 위 index.html 내용을 수정하고 commit을 하게 되면 실시간으로 아래와 같이 revision 정보 및 내용이 바뀐것을 확인할수 있다.  </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">/usr/share/nginx # ls -al</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">total 16</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxrwsrwx    4 root     nogroup       4096 Mar 21 13:40 .</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-xr-x    1 root     root          4096 Mar  8 03:09 ..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-sr-x    9 65533    nogroup       4096 Mar 21 13:40 .git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lrwxrwxrwx    1 65533    nogroup         44 Mar 21 13:40 html -&gt; rev-b125908649135856d79c515c17decba68797a6cb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-sr-x    2 65533    nogroup       4096 Mar 21 13:40 rev-b125908649135856d79c515c17decba68797a6cb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/usr/share/nginx # cat ./html/index.html</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;!DOCTYPE html&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;html&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;head&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;title&gt;Hello git-sync demo&lt;/title&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;/head&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;body&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;h1&gt;Hello git-sync demo v1.1&lt;/h1&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;/body&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;/html&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="정리">정리<a class="hash-link" href="#정리" title="Direct link to heading">​</a></h2><p>git-sync를 간단하게 테스트해봤다.<br>
<!-- -->간단하게 <code>sidecar</code> 방식의 clone tool로서 <code>git-sync</code>를 활용하면 여러가지로 충분히 활용이 가능할 것이다.<br>
<!-- -->포스팅을 작성하면서 떠오른 활용용도를 정리하면 아래와 같다. 어찌보면 sidecar pattern의 활용방안이라고도 볼수 있다.</p><ul><li>CDN을 사용하지 않고 git에서 소규모로 컨텐츠를 가져올때</li><li>DBMS가 필요없을 정도의 적은 데이터를 가져올때</li><li>jekyll이나 hugo 같은 정적 사이트(블로그)의 sidecar 패턴 (GitPage처럼 markdown을 추가하고 git commit하면 바로 사이트에 반영되는 방식)</li><li>nginx, haproxy, apache와 같이 config 변경이 필요할때 webhook방식으로 설정을 변경한후 pod를 재기동하는 GitOps 구현</li></ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/git-sync">git-sync</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/git-ops">GitOps</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/kubernetes">Kubernetes</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ssh-git">ssh git</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/sidecar">sidecar</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/sidecar-pattern">sidecar pattern</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2019/03/20/vscode-server">VScode Server</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2019-03-20T00:00:00.000Z" itemprop="datePublished">March 20, 2019</time> · <!-- -->6 min read</div></header><div class="markdown" itemprop="articleBody"><p>IntelliJ IDEA를 사용하다가 개발업무를 거의 손놓다시피 하다보니 라이센스를 연장하지 못하게 되었고 주로 Local에서 VScode를 사용하고 있다. 현재 부서와 업무도 바뀌었고 워낙 고가다보니 IDE를 부서비로 구매하도 어렵다. 뭐 얼마나 한다고 말할수도 있겠지만 업무특성상 개발툴을 사달라고 할수 없고 최근 크롬북이나 아이패드 프로같은 태블릿을 가지고 다니시는 분들도 많고 단순 필기나 메모가 아닌 온라인 환경에서 블로깅 포스팅 정도는 할수 있다는 가정으로 Web IDE를 구성하는 포스팅을 시작해본다. </p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="web-ide">Web IDE<a class="hash-link" href="#web-ide" title="Direct link to heading">​</a></h2><p>이번 포스팅을 쓰기 시작하면서 2017년 AWS re;invent에선가 Cloud9 제품이 출시되어서 Lambda에서 사용했던 장면이 갑자기 떠올랐다. Cloud 9은 <a href="https://github.com/c9/core" target="_blank" rel="noopener noreferrer">https://github.com/c9/core</a>를 기반으로 instance를 띄는것을 기본으로 한다. Lambda의 기본 에디터도 나쁘진 않지만 Cloud9에서 강조하는 부분은 코드 협업이다. </p><p><img loading="lazy" src="https://d1.awsstatic.com/product-marketing/Tulip/C9-Collab-Image@3x.e03a65d9488633c154358430540ab363dd1e8f45.png" alt="cloud9" class="img_E7b_"></p><p>AWS에서 서비스로 출시되기 이전에도 Dockerhub에서도 종종 확인할수 있었지만 현재는 찾아보기 어렵다. </p><p>국내에는 Cloud 형태로 <a href="https://ide.goorm.io/" target="_blank" rel="noopener noreferrer">GoormIDE</a> 제품이 있다.<br>
<!-- -->Free 에디션도 있으니 따로 확인해보면 된다. (응원합니다!)</p><p>이외에도 <a href="https://github.com/theia-ide/theia" target="_blank" rel="noopener noreferrer">https://github.com/theia-ide/theia</a>, <a href="https://github.com/codercom/code-server" target="_blank" rel="noopener noreferrer">https://github.com/codercom/code-server</a>와 같은 Web기반 오픈소스가 존재하고 둘다 상용이나 Beta형태로 서비스 중이다. </p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="code-server">code-server<a class="hash-link" href="#code-server" title="Direct link to heading">​</a></h2><p><a href="https://github.com/codercom/code-server" target="_blank" rel="noopener noreferrer">code-server</a>는 원격서버 형태로 동작하는 브라우저 기반 <a href="https://github.com/Microsoft/vscode" target="_blank" rel="noopener noreferrer">VSCode</a> IDE이다.</p><p>그런데 왜 구지 VScode 설치형을 냅두고 Server로 구동하느냐? 아래와 같이 설명하고 있다.</p><ul><li>Chromebook, Table(IPAD) 에서 Coding 가능</li><li>저사양 Client에서도 Cloud 기반 Server의 이점 사용가능</li><li>Battery! (제일 중요포인트) </li></ul><p>구동방식은 여러방식이 존재한다. </p><ul><li>Hosted : <a href="https://coder.com/" target="_blank" rel="noopener noreferrer">coder</a> - Enterprise </li><li>Docker<div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ docker run -t -p 127.0.0.1:8443:8443 -v &quot;${PWD}:/root/project&quot; codercom/code-server code-server --allow-http --no-auth</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></li><li>Bianry<div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ code-server &lt;initial directory to open&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="code-server-kubernetes에-배포">code-server kubernetes에 배포<a class="hash-link" href="#code-server-kubernetes에-배포" title="Direct link to heading">​</a></h2><p>공식 <a href="https://hub.docker.com/r/codercom/code-server" target="_blank" rel="noopener noreferrer">Image</a>와 <a href="https://github.com/codercom/code-server/blob/master/Dockerfile" target="_blank" rel="noopener noreferrer">Dockerfile</a>는 해당 링크를 참조한다.
살짝 변경해서 재빌드하려고 했는데 맥북 메모리가 부족한지 <code>yarn build</code>할때 <code>Serve fails with Error Code 137</code> 가 발생하였다. 이문제는 나중에 해결하기로 하고 일단 배포하자.  </p><p>로컬 minikube에서 테스트하기 위해<br>
<a href="https://github.com/codercom/code-server/blob/master/deployment/deployment.yaml" target="_blank" rel="noopener noreferrer">https://github.com/codercom/code-server/blob/master/deployment/deployment.yaml</a> 에서 ClusterIP를  NodePort로 수정하고 패스워드를 로그에서 확인하지 않고 사용할수 있도록 <code>1234</code>로 설정하고 배포한다. </p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="deploymentyaml">deployment.yaml<a class="hash-link" href="#deploymentyaml" title="Direct link to heading">​</a></h3><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Namespace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: code-server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> name: code-server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> namespace: code-server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ports:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> - port: 8443</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   name: https</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   protocol: TCP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> selector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   app: code-server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> type: NodePort</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: extensions/v1beta1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    app: code-server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: code-server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  namespace: code-server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  selector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    matchLabels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      app: code-server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  replicas: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  template:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        app: code-server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - image: codercom/code-server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        imagePullPolicy: Always</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        name: code-server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ports:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - containerPort: 8443</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          name: https</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        args:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         - &quot;--password=1234&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl create -f deployment.yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>이후 서비스 확인 및 minikube service로 expose 시킨다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get svc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME          TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">code-server   NodePort   10.111.206.64   &lt;none&gt;        8443:32665/TCP   15m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ minikube service code-server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ minikube service list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-------------|---------------|-----------------------------|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  NAMESPACE  |     NAME      |             URL             |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-------------|---------------|-----------------------------|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| code-server | code-server   | http://192.168.99.102:32665 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| default     | git-sync-demo | http://192.168.99.102:31595 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| default     | kubernetes    | No node port                |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| kube-system | kube-dns      | No node port                |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-------------|---------------|-----------------------------|</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>해당 URL로 접속하여 패스워드 <code>1234</code>를 입력하면 vscode가 원격으로 실행된 것을 확인할수 있다.
<img loading="lazy" alt="vscode" src="/assets/images/vscode-9cbf83b87dd9237022b17c9f3a7c07b2.png" width="1810" height="1263" class="img_E7b_"></p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="정리">정리<a class="hash-link" href="#정리" title="Direct link to heading">​</a></h2><p>실제 사용을 해보면 아직 버그가 많다. 애드온이나 플러그인 설치시 제대로 동작을 하지 않는 경우도 있었고
<a href="https://github.com/kubernetes/git-sync" target="_blank" rel="noopener noreferrer">git-sync</a> 프로젝트와 연동을 통해 실제 gitOPS를 구현해보고자 하였으나 배포후에 mount된 repository volume에 변경사항이 발생시 갑자기 UI가 먹통이 되는 경우가 발생하기도 하였다. Kubernetes플랫폼을 개발자에게 PaaS형태로 제공하는 경우 webIDE의 좋은 옵션이 될수 있을것 같다.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/vscode">vscode</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/code-server">code-server</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/kubernetes">kubernetes</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/online-coding">online coding</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/goorm-ide">GoormIDE</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/cloud-9">Cloud9</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2019/03/11/k3s-homelab">K3s on Raspberry Pi Cluster</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2019-03-11T00:00:00.000Z" itemprop="datePublished">March 11, 2019</time> · <!-- -->13 min read</div></header><div class="markdown" itemprop="articleBody"><p>이번에는 경량 Kubernetes라고 이야기하는 <a href="https://github.com/rancher/k3s" target="_blank" rel="noopener noreferrer">K3s</a>를 Raspberry Pi 클러스터상에 구동하려고 한다.
순수하게 개인의견으로 작성하였고 절대 제품이나 부품홍보를 하고자 하는 의도는 전혀 없다.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="k3s">K3s?<a class="hash-link" href="#k3s" title="Direct link to heading">​</a></h2><p><strong>K3s</strong>는 Rancher Lab에서 최소자원을 사용하는 Kubernetes 클러스터 구성을 위한 솔루션으로 시작되었고 2019년 3월 12일 현재 0.2버전이 릴리즈된 상태이다. 바이너리 전체가 40mb가 되지 않고 설치가 쉽다는 점에서 최근 트위터 상에서 이슈가 되고 있는 프로젝트라고 할 수 있다. </p><p>주로 Edge, IoT 등 저전력, 저사양 기반 ARM계열 컴퓨팅에 최적화 되어 있고 실제 실험적이긴 하지만 간단한 기능이나 baremetal 기반 클러스터 테스트를 집에서 해보기에는 딱 좋은 프로젝트라 할 수 있다. 이미 vSphere, OpenStack기반으로 테스트는 차고 넘치게 해봤지만 일단 물리적인 케이스부터 보고나면 하드웨어를 좋아하는 사람들에게는 아주 재미있는 장난감이 아닐수 없을 것이다. </p><p><a href="https://github.com/rancher/k3s" target="_blank" rel="noopener noreferrer">K3s Github</a> 상세 설명에 보면 Cloud Provider, Storage Plugin은 제거하였고  default 저장소가 <code>etcd</code>가 아닌 <code>sqlite3</code>으로 되어있다고 한다. </p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="사전-준비사항">사전 준비사항<a class="hash-link" href="#사전-준비사항" title="Direct link to heading">​</a></h2><ul><li><p>최소 2개 이상의 Raspberry Pi 2B/3B/3B+, 4ea<br>
<!-- -->오픈마켓에서 할인쿠폰 적용해서 Raspberry Pi 3B+, 4ea를 <code>166,820원</code>(대당 42,000원) 정도에 구매하였다.<br>
<!-- -->최저가 검색으로 대당 46,000원 정도 했던것 같다. </p></li><li><p>Stackable Case<br>
<a href="https://www.amazon.com/gp/product/B07CTG5N3V/ref=ppx_yo_dt_b_asin_title_o00_s00?ie=UTF8&amp;psc=1" target="_blank" rel="noopener noreferrer">iUniker Raspberry Pi Cluster Case</a> 강추!! (개인적으로 쿨러와 디자인이 맘에 듬)<br>
<!-- -->배송비포함 29.19달러, 약 <code>33,000원</code></p></li><li><p>micro SDHC 4ea<br>
<!-- -->16GB로도 충분하지만 삼성전자 micro SDHC CLASS10 UHS-I EVO (32GB), 4ea를 오픈마켓에서 사게되면 배송료 포함해서 8,500원 * 4ea = <code>34,000원</code>에 구매가 가능하다. 오픈마켓에서는 개당 배송료를 내야한다. 하지만 쿠팡에서는 2ea를 로켓배송으로 15,380원에 구매가 가능하므로 약 <code>31,000원</code>에 4개를 구매할수 있다. </p></li><li><p>멀티충전기<br>
<!-- -->1만원대 후반에서 2만원 초반이면 6포트 충전기를 구매할수 있는데 구매했던 가장 큰 기준은 Pi 4대를 동시에 2.5A 전류를 안정적으로 공급하려면 최대 10A를 지원하는 멀티 충전기를 사야했었고 4-5포트 짜리 충전기들은 대부분 최대 전류가 8A로 충족하지 못해 4포트만 사용하더라도 안정적인 전류 공급을 위해 6포트 충전기로 선택하였다.<br>
<!-- -->쿠팡 로켓배송 - 포*지 가정용 6포트 급속 멀티 충전기, <code>22,900원</code></p></li><li><p>micro 5pin 20cm 2.4A 지원 케이블 4ea<br>
<!-- -->Pi 권장 전류가 2.5A라고 했지만 2.4A, 3A 짜리중에 저렴한 2.4A 지원 숏케이블로 구매하였다.<br>
<!-- -->오픈마켓에서 배송료 포함, <code>7800원</code></p></li><li><p>UTP Cat5e 30cm 케이블 4ea<br>
<!-- -->그냥 제일싼걸로 오픈마켓에서 배송료 포함 <code>4,100원</code>에 구매하였다.</p></li><li><p>기가비트 지원되는 5포트 이상 스위치 허브(공유기)<br>
<!-- -->집에 있던 공유기 활용 (iptime A1004) 하였지만 최저 5포트 이상 스위치 허브중 제일 싼 모델은 <code>16,000원</code>대로 가격 형성중이다. </p></li></ul><p>실제 위 스펙으로 대충 구매를 진행하게 되면 18.4 + 3.3 + 3.1 + 2.3 + 0.8 + 0.4 + 1.6 = <code>29.9만원</code> 정도 소요가 될 것으로 예상된다. 집에 굴러다는 부품이나 충전기, 케이블, SD카드들을 활용하면 <code>25만원</code> 이내로도 충분히 가능하다.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="구매-제품-조립">구매 제품 조립<a class="hash-link" href="#구매-제품-조립" title="Direct link to heading">​</a></h2><p>조립은 그다지 어렵지 않은데 케이스 구매시 제공되는 방열판(CPU, GPU, RAM)을 꼼꼼하게 붙이고 쿨러를 GPIO에 연결한다.<br>
<!-- -->그렇게 어려운 점은 없지만 본체를 케이스에 고정할때 너트가 작아 손이 큰 사람은 조금 힘들 수도 있을 것 같다. </p><p>케이스의 CPU 쿨러가 화룡점정이다.</p><p><img loading="lazy" alt="cases" src="/assets/images/cases-614af9823c3d08feb1cdfd6feecda887.jpg" width="1224" height="689" class="img_E7b_"><br>
<img loading="lazy" alt="heat" src="/assets/images/heat-7b312fa5a5ca45bc55e98323ffdbb690.jpg" width="689" height="1224" class="img_E7b_"><br>
<img loading="lazy" alt="cooler" src="/assets/images/cooler-01a1339b8c2d113ec8cdd527cd9a51f8.jpg" width="1224" height="689" class="img_E7b_">
<img loading="lazy" alt="3stack" src="/assets/images/3stack-c5510bb36fd5f49a56c318a4a175f3fb.jpg" width="1224" height="689" class="img_E7b_">
<img loading="lazy" alt="charger" src="/assets/images/charger-fbc5086db8ea25c819ef915b0f298f5e.jpg" width="1224" height="689" class="img_E7b_">
<img loading="lazy" alt="full" src="/assets/images/fullstack-a0ea32c22662582ec85641753804eaf0.jpg" width="1224" height="689" class="img_E7b_">
<img loading="lazy" alt="complete" src="/assets/images/complete-8db0eac9257463f0ad669a0bc12541ef.jpg" width="1224" height="689" class="img_E7b_"></p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="os-설치">OS 설치<a class="hash-link" href="#os-설치" title="Direct link to heading">​</a></h2><p>SD카드에 설치는 MacOS상에서 진행하였다.</p><p><a href="https://www.raspberrypi.org/downloads/raspbian/" target="_blank" rel="noopener noreferrer">Raspbian Lite</a>를 내려받아 <a href="https://www.balena.io/etcher/" target="_blank" rel="noopener noreferrer">Etcher</a>를 사용하여 OS를 설치한다. </p><p>자세한 추가적인 설치방법은 다음 링크를 통해서도 확인이 가능하다.<br>
<a href="https://www.raspberrypi.org/documentation/installation/installing-images/README.md" target="_blank" rel="noopener noreferrer">Installing operating system images</a>  </p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="환경-설정">환경 설정<a class="hash-link" href="#환경-설정" title="Direct link to heading">​</a></h2><p>Mac에서는 <code>/Volumes/boot</code>에 마운트가 된다. OS마다 다르지만 Linux에서는 <code>/mnt/boot</code>, Windows에서는 <code>boot</code> 로 마운트가 된다.</p><p>SSH Service 자동 활성화를 위해 위 OS별 mount된 root 경로에 ssh 빈 파일을 생성하게 되면 reboot이후에 SSH 접속이 가능해진다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo touch /Volumes/boot/ssh</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>또한 container 사용을 위해 root경로의 <code>cmdline.txt</code> 파일 마지막에 cgroup 설정을 추가한다.  </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">cgroup_memory=1 cgroup_enable=memory</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>SD카드를 만들고 각각의 Pi에 장착후에 UTP케이블과 전원을 모두 연결한다.
부팅이 완료되면 default id/pass 인 <code>pi/raspberry</code>로 로그인 하고 <code>sudo raspi-config</code> 를 통해 패스워드 변경, hostname 설정, GPU memory split 설정 등을 완료하자.<br>
<!-- -->나중에는 PXE booting 및 ansible 자동화로 구현하면 무인환경 설치가 가능할것 같다. (Edge Computing)</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">┌───────────────────┤ Raspberry Pi Software Configuration Tool (raspi-config) ├────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                                                                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│        1 Change User Password Change password for the current user                               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│        2 Network Options      Configure network settings                                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│        3 Boot Options         Configure options for start-up                                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│        4 Localisation Options Set up language and regional settings to match your location       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│        5 Interfacing Options  Configure connections to peripherals                               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│        6 Overclock            Configure overclocking for your Pi                                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│        7 Advanced Options     Configure advanced settings                                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│        8 Update               Update this tool to the latest version                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│        9 About raspi-config   Information about this configuration tool                          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                                                                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                                                                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                                                                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                           &lt;Select&gt;                           &lt;Finish&gt;                            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                                                                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└──────────────────────────────────────────────────────────────────────────────────────────────────┘</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><ul><li>1 Change User Password</li><li>2 Network Options - hostname<ul><li>k3s-master, k3s-slave-01, k3s-slave-02, k3s-slave-03</li></ul></li><li>4 Localisation Options - TimeZone<ul><li>Asia, Seoul</li></ul></li><li>7 Advanced Options - GPU Memory split <ul><li>16mb</li></ul></li></ul><p>모두 완료가 되었으면 pi들을 재기동하자.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo reboot</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="k3s-클러스터-생성">k3s 클러스터 생성<a class="hash-link" href="#k3s-클러스터-생성" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="server-기동">Server 기동<a class="hash-link" href="#server-기동" title="Direct link to heading">​</a></h3><p>armhf(arm hard float) 지원이 되는 최신 릴리즈 v0.2.0를 다운받는다.  </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ wget -O k3s https://github.com/rancher/k3s/releases/download/v0.2.0/k3s-armhf &amp;&amp; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  chmod +x k3s &amp;&amp; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  sudo mv k3s /usr/local/bin/k3s</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Master node 기동 (백그라운드)</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo k3s server &amp;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>해당 node를 Control plane 형태로 분리시켜 workload에서 제외하려면 <code>--disable-agent</code> 옵션을 사용한다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">&amp; k3s server --disable-agent</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>정상적으로 k3s 기동이 완료되면 <code>/etc/rancher/k3s/k3s.yaml</code>에서 Kubeconfig를 확인할수 있다. 그리고 node 상태도 확인이 가능하다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo k3s kubectl get nodes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME          STATUS   ROLES    AGE   VERSION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">k3s-master    Ready    &lt;none&gt;   21h   v1.13.4-k3s.1</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="node-추가">node 추가<a class="hash-link" href="#node-추가" title="Direct link to heading">​</a></h3><p><code>/var/lib/rancher/k3s/server/manifests</code> 에서 TOKEN을 확인한다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo cat /var/lib/rancher/k3s/server/node-token</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">K100fa5235031f2b8e92e01b8bd3255142422a7aeaa47657ad4c68969d35cddbf3a::node:431342ac6204466e8f81445edb8c2e3a</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>worker node에 접속한다음 동일하게 최신 릴리즈 v0.2.0를 다운받는다.  </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ wget -O k3s https://github.com/rancher/k3s/releases/download/v0.2.0/k3s-armhf &amp;&amp; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  chmod +x k3s &amp;&amp; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  sudo mv k3s /usr/local/bin/k3s</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>위에서 나온 TOKEN값과 Kube API Endpoint정보로 node들을 차례로 추가 시키면 모든 작업이 완료된다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ export NODE_TOKEN=&quot;K100fa5235031f2b8e92e01b8bd3255142422a7aeaa47657ad4c68969d35cddbf3a::node:431342ac6204466e8f81445edb8c2e3a&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ export MASTER_IP=&quot;https://192.168.0.14:6443&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo k3s agent --server https://${MASTER_IP}:6443 --token ${NODE_TOKEN} &amp;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>완성된 클러스터를 확인한다. 외부 로컬에서 확인하려면 <code>/etc/rancher/k3s/k3s.yaml</code> 파일을 <code>~/.kube/config</code>에 추가하면 된다. 클러스터 내부에서 kubectl 명령은 k3s 바이너리 내부에 포함되어 있으므로 <code>sudo k3s kubectl</code> 명령을 사용하였다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo k3s kubectl get node -o wide</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME          STATUS   ROLES    AGE   VERSION         INTERNAL-IP    EXTERNAL-IP   OS-IMAGE                         KERNEL-VERSION   CONTAINER-RUNTIME</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">k3s-master    Ready    &lt;none&gt;   22h   v1.13.4-k3s.1   192.168.1.14   &lt;none&gt;        Raspbian GNU/Linux 9 (stretch)   4.14.79-v7+      containerd://1.2.4+unknown</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">k3s-slave01   Ready    &lt;none&gt;   21h   v1.13.4-k3s.1   192.168.1.15   &lt;none&gt;        Raspbian GNU/Linux 9 (stretch)   4.14.79-v7+      containerd://1.2.4+unknown</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">k3s-slave02   Ready    &lt;none&gt;   10h   v1.13.4-k3s.1   192.168.1.16   &lt;none&gt;        Raspbian GNU/Linux 9 (stretch)   4.14.79-v7+      containerd://1.2.4+unknown</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">k3s-slave03   Ready    &lt;none&gt;   10h   v1.13.4-k3s.1   192.168.1.17   &lt;none&gt;        Raspbian GNU/Linux 9 (stretch)   4.14.79-v7+      containerd://1.2.4+unknown</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>node 상세정보를 보면 기본적으로 K8s <code>v1.13.4</code>, runtime은 <code>containerd</code>를 사용하고 있음을 알 수 있다.  </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo k3s kubectl get svc --all-namespaces</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAMESPACE     NAME         TYPE           CLUSTER-IP     EXTERNAL-IP                 PORT(S)                      AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">default       kubernetes   ClusterIP      10.43.0.1      &lt;none&gt;                      443/TCP                      21h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   kube-dns     ClusterIP      10.43.0.10     &lt;none&gt;                      53/UDP,53/TCP,9153/TCP       21h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   traefik      LoadBalancer   10.43.19.160   192.168.1.14,192.168.1.15   80:32304/TCP,443:31690/TCP   21h</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Rancher쪽에서도 오늘날짜(3/12)로 F5가 Nginx를 인수하는것을 예견했던 것일까?<br>
<!-- -->Service를 확인하면 traefik이 기본으로 되어있다. 아래처럼 기본적으로 loadbalancer로 활용되고 있는 traefik을 Helm Chart CRD를 통해 배포된것을 확인할 수 있다. 또한 얼마전 졸업한 CoreDNS도 보인다.   </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo k3s kubectl get pod --all-namespaces</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAMESPACE     NAME                             READY   STATUS      RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   coredns-7748f7f6df-qflx9         1/1     Running     0          21h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   helm-install-traefik-dqqg9       0/1     Completed   0          21h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   svclb-traefik-598fd65c97-4xtkf   2/2     Running     0          21h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   svclb-traefik-598fd65c97-vbsqv   2/2     Running     0          19h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   traefik-6876857645-2sqg9         1/1     Running     0          21h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo k3s kubectl get crd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                            CREATED AT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">addons.k3s.cattle.io            2019-03-11T16:46:22Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helmcharts.k3s.cattle.io        2019-03-11T16:46:22Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">listenerconfigs.k3s.cattle.io   2019-03-11T16:46:22Z</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="정리">정리<a class="hash-link" href="#정리" title="Direct link to heading">​</a></h2><p>아주 적은비용(?)으로 취미삼아 k3s 클러스터를 구성해봤다.<br>
<!-- -->아직 ARM계열에서 kubernetes workload를 구동하는 것은 시기상조이긴 하지만 기존에 kubeadm을 가지고 pi에 배포하는것에 비하면 설치 난이도나 자원사용량 측면에서 장점이 많은 프로젝트이다.<br>
<!-- -->해외 블로그나 트위터를 보면 최근 <code>k3s</code>에 대한 관심도가 높아지는것을 확인할 수 있는데 단순히 취미생활만이 아니라 IoT, Edge에서의 Serverless Workload 수행이라던지 ARM 계열 최적화된 모습만으로도 충분히 가능성은 보여준것 같다.<br>
<!-- -->Rancher 2.0 이후로 Kubernetes 연관된 관심도가 떨어졌었는데 엔지니어들의 관심을 끄는데는 성공한듯 하고 AWS의 Greengrass, Firecracker와 동일선상에서 봐도 견줄만한 가치가 있다고 생각된다.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/kubernetes">Kubernetes</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/rancher">Rancher</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/k-3-s">K3s</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/raspberry">Raspberry</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/homelab">Homelab</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/page/2"><div class="pagination-nav__label">Newer Entries</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/page/4"><div class="pagination-nav__label">Older Entries</div></a></div></nav></main></div></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Blog</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/">Home</a></li><li class="footer__item"><a class="footer__link-item" href="/archive">Archive</a></li><li class="footer__item"><a class="footer__link-item" href="/tags">Tags</a></li></ul></div><div class="col footer__col"><div class="footer__title">Sponsors</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/pang4u">Pang4U</a></li><li class="footer__item"><a href="https://ko-fi.com/ddiiwoong" target="_blank" rel="noopener noreferrer" class="footer__link-item">Buy Me a Coffee<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/ddiiwoong" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/ddiiwoong" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.facebook.com/ddiiwoong" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://kr.linkedin.com/in/ddiiwoong" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div></div></footer></div>
<script src="/assets/js/runtime~main.fedfc763.js"></script>
<script src="/assets/js/main.1aff5f87.js"></script>
</body>
</html>