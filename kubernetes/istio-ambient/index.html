<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.18">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="Act as a catalyst RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Act as a catalyst Atom Feed">
<link rel="alternate" type="application/json" href="/feed.json" title="Act as a catalyst JSON Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","G-4ZT898XDT2","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-4ZT898XDT2"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-4ZT898XDT2",{anonymize_ip:!0})</script>
<link rel="search" type="application/opensearchdescription+xml" title="Cloud Catalyst" href="/opensearch.xml">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4362752107119680" crossorigin="anonymous"></script><title data-rh="true">Istio Ambient Mode on K3d | Cloud Catalyst</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://ddii.dev/kubernetes/istio-ambient/"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" name="naver-site-verification" content="cbcc03783e5594725d3951f4e7f16ede80e69881"><meta data-rh="true" property="og:title" content="Istio Ambient Mode on K3d | Cloud Catalyst"><meta data-rh="true" name="description" content="K3d 클러스터에서 Istio Ambient 모드 구성"><meta data-rh="true" property="og:description" content="K3d 클러스터에서 Istio Ambient 모드 구성"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2024-10-20T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://www.linkedin.com/in/ddiiwoong/"><meta data-rh="true" property="article:tag" content="Istio,Ambient,Service-Mesh,Sidecarless"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://ddii.dev/kubernetes/istio-ambient/"><link data-rh="true" rel="alternate" href="https://ddii.dev/kubernetes/istio-ambient/" hreflang="en"><link data-rh="true" rel="alternate" href="https://ddii.dev/kubernetes/istio-ambient/" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://UTLA0DRN66-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.1e7a31ee.css">
<link rel="preload" href="/assets/js/runtime~main.da14d478.js" as="script">
<link rel="preload" href="/assets/js/main.36bea237.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top navbarHideable_ObN2"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo-catalyst.svg" alt="Cloud Catalyst" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/logo-catalyst.svg" alt="Cloud Catalyst" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">Cloud Catalyst</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/">Posts</a><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" docid="introduction" href="/docs/prometheus/introduction/">Docs</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/prometheus/introduction/">Prometheus</a></li></ul></div></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/tags/">Tags</a><a class="navbar__item navbar__link" href="/presentation/">Presentation</a><a class="navbar__item navbar__link" href="/archive/">Archive</a><a class="navbar__item navbar__link" href="/about/">About</a><a class="navbar__item navbar__link" href="/pang4u/">Pang4u</a><a href="https://github.com/ddiiwoong/newblog" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_S7eR colorModeToggle_vKtC"><button class="clean-btn toggleButton_rCf9 toggleButtonDisabled_Pu9x" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_v35p"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_nQuB"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_qEbK"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_a9qW thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_uKok margin-bottom--md">Recent Posts</div><ul class="sidebarItemList_Kvuv"><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kubernetes/tetragon/">Tetragon</a></li><li class="sidebarItem_CF0Q"><a aria-current="page" class="sidebarItemLink_miNk sidebarItemLinkActive_RRTD" href="/kubernetes/istio-ambient/">Istio Ambient Mode on K3d</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kubernetes/gatewayapi/">AWS Gateway API Controller</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kubernetes/headless-service/">Kubernetes Headless Service</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kubernetes/externaldns/">ExternalDNS</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_rzP5" itemprop="headline">Istio Ambient Mode on K3d</h1><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2024-10-20T00:00:00.000Z" itemprop="datePublished">October 20, 2024</time> · <!-- -->25 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://www.linkedin.com/in/ddiiwoong/" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://s.gravatar.com/avatar/e8bfebcbeacb5b9a0c90614e792febf2?s=80" alt="Jinwoong Kim"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/ddiiwoong/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jinwoong Kim</span></a></div><small class="avatar__subtitle" itemprop="description">Technologist and Cloud Consultant</small></div></div></div></div></header><div id="post-content" class="markdown" itemprop="articleBody"><blockquote><p>해당 포스팅은 현재 재직중인 회사에 관련이 없고, 개인 역량 개발을 위한 스터디 자료로 활용할 예정입니다.</p></blockquote><p>이번 포스팅의 목적은 K3d 클러스터에 Istio Ambient 모드를 구성하고 기본 개념을 이해하는 것이다.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="istio-ambient-mesh">Istio Ambient Mesh<a class="hash-link" href="#istio-ambient-mesh" title="Direct link to heading">​</a></h2><p><img loading="lazy" src="https://istio.io/latest/blog/2022/introducing-ambient-mesh/traditional-istio.png" alt="https://istio.io/latest/blog/2022/introducing-ambient-mesh/traditional-istio.png" class="img_E7b_"></p><p>위 그림처럼 Istio의 기본 구성으로 동작하는 사이드카(<code>sidecar</code>) 방식는 애플리케이션을 직접 리팩토링에 하는 것에 비해 상당한 이점이 있지만, 애플리케이션과 Istio 데이터 플레인을 완벽하게 분리하지는 못한다. 사이드카를 애플리케이션에 <code>inject</code>하려면 해당 Kubernetes 파드 스펙을 수정하고 파드 내에서 트래픽을 리디렉션(Redirect)해야 한다. 따라서 사이드카를 설치하거나 업그레이드하려면 애플리케이션 파드를 다시 시작해야 하므로 워크로드에 지장을 줄 수 있다. 그리고, 사이드카 프록시는 관련 워크로드 전용이므로 각 개별 파드의 사용량에 대비하여 CPU 및 메모리 리소스를 프로비저닝해야 한다. 이로 인해 대규모 리소스 예약(reservation)이 추가되어 클러스터 전체에서 리소스 활용도가 낮아질 수 있다. 일반적으로 Istio의 사이드카가 수행하는 트래픽 캡처 및 HTTP 처리는 계산 비용이 많이 발생하기도 하며 표준 형태가 아닌 HTTP 구현을 사용하는 일부 애플리케이션을 중단시킬 수 있다.</p><p><code>Istio</code>는 기존에 사이드카를 사용하여 모든 데이터 플레인 기능을 구현했지만, 이는 모든 기능을 사용해야 하는 부담이 있었다. Istio는 각 파드에 사이드카를 배포하지 않도록 허용하는 <code>Ambient</code> 기능을 22년에 소개했다. Ambient 모드에서 Istio는 CNI 역할을 하며 파드에서 들어오고 나가는 네트워크 트래픽을 가로채 여러가지 규칙을 적용하게 된다. Istio의 기능을 두 개의 계층으로 분리하여 필요에 따라 기능을 선택적으로 사용할 수 있도록 한다. 이를 통해 사용자는 Istio를 점진적으로 도입하고, 필요에 따라 보안 오버레이(overlay) 네트워크에서 L7 처리 방식으로 전환할 수 있다. <code>보안 오버레이</code>라는 용어는 ztunnel 프록시를 통해 Ambient 메시에서 구현되는 일련의 L4 네트워킹 기능을 총칭하여 설명하는 데 사용된다. 사이드카의 수를 줄여 각 요청에 대한 L7 처리 단계 수를 줄임으로써 리소스 소비(CPU, 메모리)를 줄이고 Istio의 성능을 향상시키는 것이 주요 목적이다.</p><p><img loading="lazy" src="https://istio.io/latest/blog/2022/introducing-ambient-mesh/ambient-secure-overlay.png" alt="https://istio.io/latest/blog/2022/introducing-ambient-mesh/ambient-secure-overlay.png" class="img_E7b_"></p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="ztunnel">Ztunnel<a class="hash-link" href="#ztunnel" title="Direct link to heading">​</a></h3><p>Ambient 메시는 쿠버네티스 클러스터의 각 노드에 배포되어 실행되는 데몬셋 기반의 공유 에이전트인 <code>Ztunnel</code>을 사용한다. Ztunnel은 Ambient 메시에서 노드 프록시를 구현하기 위한 목적으로 기능 세트를 최소로하여 Ambient에 필요한 최소한의 요구 사항만 구현하는 것이다. ztunnel 프록시는 Rust로 작성되었으며 mTLS, 인증, L4 권한 부여, 원격 측정과 같은 L3 및 L4 기능을 처리하도록 의도적으로 범위가 설정되어 있다. ztunnel은 L3 및 L4 트래픽이 워크로드, 다른 ztunnel 프록시 또는 웨이포인트 프록시로 직접 효율적이고 안전하게 전송되도록 보장한다.</p><p><a href="https://github.com/istio/ztunnel?tab=readme-ov-file#feature-scope" target="_blank" rel="noopener noreferrer">ztunnel의 범위를 명시적으로 벗어난 기능</a>은 다음과 같다.</p><ul><li>사용자 HTTP 트래픽 종료</li><li>반복할 가치가 있는 사용자 HTTP 트래픽 종료</li><li><code>ext_authz</code>, WASM, 연동 확장(linked-in extensions), Lua 등과 같은 일반적인 확장성</li></ul><p>일반적으로 ztunnel은 일반적인 확장성 프록시를 목표로 하지 않으며, 이러한 작업에는 <code>Envoy</code>가 더 적합하다. </p><p>전송 계층에서는 <a href="https://istio.io/latest/docs/ambient/architecture/hbone/" target="_blank" rel="noopener noreferrer">HBONE</a>이라는 HTTP CONNECT 기반 트래픽 터널링 프로토콜을 통해 구현된다.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="waypoint-proxy">Waypoint Proxy<a class="hash-link" href="#waypoint-proxy" title="Direct link to heading">​</a></h3><p><img loading="lazy" src="https://istio.io/latest/blog/2022/introducing-ambient-mesh/ambient-waypoint.png" alt="https://istio.io/latest/blog/2022/introducing-ambient-mesh/ambient-waypoint.png" class="img_E7b_"></p><p>위에서 이야기했듯이 L7 처리는 ztunnel에서 구현되지 않고 별도의 <code>Waypoint Proxy</code> 파드를 통해 진행된다. <code>Waypoint Proxy</code>는 사이드카 데이터 플레인 모드에 사용하는 것과 동일한 엔진인 Envoy 프록시를 사용한다. <code>Waypoint Proxy</code>는 애플리케이션 파드 외부에서 독립적으로 설치, 실행, 업그레이드 된다. 앰비언트 모드에서 Istio의 일부 사용 사례는 L4 보안 오버레이 기능만으로 해결될 수 있으며, L7 기능이 필요하지 않으므로 <code>Waypoint Proxy</code>를 배포할 필요가 없다. 고급 트래픽 관리 및 L7 네트워킹 기능이 필요한 경우는 <code>Waypoint Proxy</code> 배포가 필요하다.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="install-istio-ambient">Install Istio Ambient<a class="hash-link" href="#install-istio-ambient" title="Direct link to heading">​</a></h2><p>간단하게 Istio Ambient 테스트를 진행하기 위해서 K3d 클러스터에서 ArgoCD를 사용하여 샘플 애플리케이션 배포를 진행한다. 최종적으로 구성하고자 하는 그림은 다음과 같이 4개의 노드에 각 컴포넌트를 배치하는 것이다. (그림 출처: <a href="https://istio.io/latest/blog/2023/traffic-for-ambient-and-sidecar/" target="_blank" rel="noopener noreferrer">https://istio.io/latest/blog/2023/traffic-for-ambient-and-sidecar/</a>)</p><p><img loading="lazy" src="https://istio.io/latest/blog/2023/traffic-for-ambient-and-sidecar/sidecar-to-ambient.png" alt="demo" class="img_E7b_"></p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="prerequisites">Prerequisites<a class="hash-link" href="#prerequisites" title="Direct link to heading">​</a></h3><ul><li><a href="https://k3d.io/" target="_blank" rel="noopener noreferrer">K3d Cluster</a> 4 nodes(agents)</li><li>kubectl</li><li><a href="https://github.com/argoproj/argo-cd/releases" target="_blank" rel="noopener noreferrer">ArgoCD</a> Non-HA</li><li>Docker 또는 Rancher Desktop</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="k3d-기반-istion-ambient-설치">K3d 기반 Istion Ambient 설치<a class="hash-link" href="#k3d-기반-istion-ambient-설치" title="Direct link to heading">​</a></h3><p><code>k3d</code>는 기본적으로 <code>Treaefik</code> 프록시를 설치하게 되어 있지만  Istio는 자체적으로 Ingress Gateway와 같은 프록시 기능을 제공하기 때문에 충돌을 방지하기 위해 설치시 <code>--k3s-arg &quot;--disable=traefik@server:*&quot;</code> 옵션을 사용하여 Traefik을 비활성화할 수 있다.</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ k3d cluster create --api-port </span><span class="token number" style="color:#36acaa">6550</span><span class="token plain"> -p </span><span class="token string" style="color:#e3116c">&#x27;9080:80@loadbalancer&#x27;</span><span class="token plain"> -p </span><span class="token string" style="color:#e3116c">&#x27;9443:443@loadbalancer&#x27;</span><span class="token plain"> --agents </span><span class="token number" style="color:#36acaa">4</span><span class="token plain"> --k3s-arg </span><span class="token string" style="color:#e3116c">&#x27;--disable=traefik@server:*&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">0000</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> portmapping </span><span class="token string" style="color:#e3116c">&#x27;9080:80&#x27;</span><span class="token plain"> targets the loadbalancer: defaulting to </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">servers:*:proxy agents:*:proxy</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">0000</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> portmapping </span><span class="token string" style="color:#e3116c">&#x27;9443:443&#x27;</span><span class="token plain"> targets the loadbalancer: defaulting to </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">servers:*:proxy agents:*:proxy</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">0000</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Prep: Network</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">0000</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Created network </span><span class="token string" style="color:#e3116c">&#x27;k3d-k3s-default&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">0000</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Created image volume k3d-k3s-default-images</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">0000</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Starting new tools node</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">0000</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Starting </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;k3d-k3s-default-tools&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">0001</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Creating </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;k3d-k3s-default-server-0&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">0001</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Creating </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;k3d-k3s-default-agent-0&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">0001</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Creating </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;k3d-k3s-default-agent-1&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">0001</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Creating </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;k3d-k3s-default-agent-2&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">0001</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Creating </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;k3d-k3s-default-agent-3&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">0001</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Creating LoadBalancer </span><span class="token string" style="color:#e3116c">&#x27;k3d-k3s-default-serverlb&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">0001</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Using the k3d-tools </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> to gather environment information</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">0001</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> HostIP: using network gateway </span><span class="token number" style="color:#36acaa">172.22</span><span class="token plain">.0.1 address</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">0001</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Starting cluster </span><span class="token string" style="color:#e3116c">&#x27;k3s-default&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">0001</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Starting servers</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">0001</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Starting </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;k3d-k3s-default-server-0&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">0004</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Starting agents</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">0004</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Starting </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;k3d-k3s-default-agent-2&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">0004</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Starting </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;k3d-k3s-default-agent-0&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">0004</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Starting </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;k3d-k3s-default-agent-1&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">0004</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Starting </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;k3d-k3s-default-agent-3&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">0013</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Starting helpers</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">0013</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Starting </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;k3d-k3s-default-serverlb&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">0020</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Injecting records </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> hostAliases </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">incl. host.k3d.internal</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> and </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">6</span><span class="token plain"> network members into CoreDNS configmap</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">0022</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Cluster </span><span class="token string" style="color:#e3116c">&#x27;k3s-default&#x27;</span><span class="token plain"> created successfully</span><span class="token operator" style="color:#393A34">!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">0022</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> You can now use it like this:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl cluster-info</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Istio를 설치할 때 기본 Flannel CNI와 함께 k3d를 사용하는 경우에는, CNI 구성 및 바이너리에 표준이 아닌 위치를 사용하기 때문에 설치 명령에 몇 가지 값을 추가해야 한다. </p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ istioctl </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> --set </span><span class="token assign-left variable" style="color:#36acaa">profile</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">ambient --set values.cni.cniConfDir</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/var/lib/rancher/k3s/agent/etc/cni/net.d --set values.cni.cniBinDir</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/bin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">   </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      /</span><span class="token operator" style="color:#393A34">||</span><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     / </span><span class="token operator" style="color:#393A34">||</span><span class="token plain">     </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /  </span><span class="token operator" style="color:#393A34">||</span><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   /   </span><span class="token operator" style="color:#393A34">||</span><span class="token plain">       </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  /    </span><span class="token operator" style="color:#393A34">||</span><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> /     </span><span class="token operator" style="color:#393A34">||</span><span class="token plain">         </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/______</span><span class="token operator" style="color:#393A34">||</span><span class="token plain">__________</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">____________________</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">__       _____/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">_____/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">This will </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> the Istio </span><span class="token number" style="color:#36acaa">1.23</span><span class="token plain">.2 </span><span class="token string" style="color:#e3116c">&quot;ambient&quot;</span><span class="token plain"> profile </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">with components: Istio core, Istiod, CNI, and Ztunnel</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> into the cluster. Proceed? </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">y/N</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> y</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">✔ Istio core installed ⛵️</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">✔ Istiod installed 🧠</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">✔ CNI installed 🪢</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">✔ Ztunnel installed 🔒</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">✔ Installation complete                                                                                                                                                  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Made this installation the default </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> cluster-wide operations.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The ambient profile has been installed successfully, enjoy Istio without sidecars</span><span class="token operator" style="color:#393A34">!</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>설치가 완료된 이후의 클러스터의 <code>istio</code> 컴포넌트 점검 <code>istioctl verify-install</code> 명령을 통해 확인할 수 있다. 기본으로 배포가 되었기 때문에 특별한 옵션없이 점검을 수행하면 <code>default</code> 리비전만 점검을 수행한다.</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ istioctl verify-install</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> Istio control planes detected, checking --revision </span><span class="token string" style="color:#e3116c">&quot;default&quot;</span><span class="token plain"> only</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">✔ Deployment: istiod.istio-system checked successfully</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">. </span><span class="token comment" style="color:#999988;font-style:italic">## 중략</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">✔ CustomResourceDefinition: workloadgroups.networking.istio.io.istio-system checked successfully</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Checked </span><span class="token number" style="color:#36acaa">14</span><span class="token plain"> custom resource definitions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Checked </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> Istio Deployments</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Checked </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> Istio Daemonsets</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">✔ Istio is installed and verified successfully</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>ArgoCD 배포를 진행한다. Non-HA YAML 매니페스트를 사용하여 <a href="https://github.com/argoproj/argo-cd/releases" target="_blank" rel="noopener noreferrer">ArgoCD 최신버전</a>(설치당시 2.12.6 버전)으로 배포를 진행한다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl create namespace argocd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/v2.12.6/manifests/install.yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>설치가 완료되고 ArgoCD 컴포넌트를 확인해보면 다음과 비슷하게 보일 것이다.</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pods -n argocd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                               READY   STATUS    RESTARTS      AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">argocd-application-controller-0                    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     Running   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">             12m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">argocd-applicationset-controller-75d8c9495-fpd69   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     Running   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">             12m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">argocd-dex-server-7c9b44b9f9-wcmth                 </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     Running   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">10m ago</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">   12m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">argocd-notifications-controller-77f49c7745-jdq4p   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     Running   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">             12m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">argocd-redis-575c96bc4f-xvwrk                      </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     Running   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">             12m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">argocd-repo-server-7f44b474d7-r8n5m                </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     Running   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">             12m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">argocd-server-5f4dd5d648-brghh                     </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     Running   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">             12m</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>ArgoCD 패스워드를 변경하기 위해 <code>bcrypt</code>로 <code>KANS</code>로 암호화하고 <code>argocd-secret</code> 리소스를 patch한다. 참고로 encrypt는 <a href="https://bcrypt-generator.com/" target="_blank" rel="noopener noreferrer">https://bcrypt-generator.com/</a>에서 진행했다. </p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl -n argocd patch secret argocd-secret </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -p </span><span class="token string" style="color:#e3116c">&#x27;{&quot;stringData&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    &quot;admin.password&quot;: &quot;$2a$12$PFnmDf/NBL4PQTe5x/oqT.DKtkmc2stvPdvrDaeaYwu.nwq4izE6G&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    &quot;admin.passwordMtime&quot;: &quot;&#x27;</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable function" style="color:#d73a49">date</span><span class="token variable" style="color:#36acaa"> +%FT%T%Z</span><span class="token variable" style="color:#36acaa">)</span><span class="token string" style="color:#e3116c">&#x27;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  }}&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">secret/argocd-secret patched</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl port-forward svc/argocd-server -n argocd 9999:443</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="sample-app-rollout-배포">Sample App Rollout 배포<a class="hash-link" href="#sample-app-rollout-배포" title="Direct link to heading">​</a></h3><p><img loading="lazy" src="https://istio.io/latest/docs/ambient/getting-started/deploy-sample-app/bookinfo.svg" alt="https://istio.io/latest/docs/ambient/getting-started/deploy-sample-app/bookinfo.svg" class="img_E7b_"></p><p>해당 그림과 같은 샘플 애플리케이션을 배포하기 위해서 Argo Rollout 최신 버전도 배포한다.</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl create namespace argo-rollouts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -n argo-rollouts -f https://github.com/argoproj/argo-rollouts/releases/latest/download/install.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">namespace/argo-rollouts created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">customresourcedefinition.apiextensions.k8s.io/analysisruns.argoproj.io created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">customresourcedefinition.apiextensions.k8s.io/analysistemplates.argoproj.io created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">customresourcedefinition.apiextensions.k8s.io/clusteranalysistemplates.argoproj.io created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">customresourcedefinition.apiextensions.k8s.io/experiments.argoproj.io created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">customresourcedefinition.apiextensions.k8s.io/rollouts.argoproj.io created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">serviceaccount/argo-rollouts created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clusterrole.rbac.authorization.k8s.io/argo-rollouts created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clusterrole.rbac.authorization.k8s.io/argo-rollouts-aggregate-to-admin created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clusterrole.rbac.authorization.k8s.io/argo-rollouts-aggregate-to-edit created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clusterrole.rbac.authorization.k8s.io/argo-rollouts-aggregate-to-view created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clusterrolebinding.rbac.authorization.k8s.io/argo-rollouts created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">configmap/argo-rollouts-config created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">secret/argo-rollouts-notification-secret created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service/argo-rollouts-metrics created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment.apps/argo-rollouts created</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="0번-노드-foo-네임스페이스에-sleep-배포">0번 노드 foo 네임스페이스에 sleep 배포<a class="hash-link" href="#0번-노드-foo-네임스페이스에-sleep-배포" title="Direct link to heading">​</a></h4><p>foo 네임스페이스에서 <code>sleep</code> 서비스를 실행하고 해당 네임스페이스에 대해 Istio 사이드카 인젝션을 사용하려면 <code>foo</code> 네임스페이스에 Istio injection 라벨을 추가해야 한다.</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl create namespace foo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">namespace/foo created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl label namespace foo istio-injection</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">enabled</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">namespace/foo labeled</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p><code>k3d-k3s-default-agent-0</code> 노드에 배포하기 위해 <code>nodeSelector</code> 구문을 추가하고 <code>foo</code> 네임스페이스에 배포한다.</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">cat &lt;&lt;EOF </span><span class="token punctuation" style="color:#393A34">|</span><span class="token plain"> kubectl create </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">n foo </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">f </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> sleep</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> sleep</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">service</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> sleep</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">ports</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">selector</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> sleep</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> apps/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> sleep</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">replicas</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">selector</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">matchLabels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> sleep</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">template</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> sleep</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">terminationGracePeriodSeconds</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">containers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> sleep</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> curlimages/curl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">command</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;/bin/sleep&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;3650d&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">imagePullPolicy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> IfNotPresent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">volumeMounts</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">mountPath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /etc/sleep/tls</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> secret</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">volume</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">volumes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> secret</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">volume</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">secret</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">secretName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> sleep</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">optional</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">nodeSelector</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">kubernetes.io/hostname</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;k3d-k3s-default-agent-0&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Ambient 모드이지만 Istio injection이 오버라이드 되면서 추가적인 사이드카가 있는채로 배포된 것을 확인할 수있다.
<img loading="lazy" alt="foo" src="/assets/images/foo-2f57727301709b8156e6192366520f7f.png" width="1274" height="138" class="img_E7b_"></p><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="1번-노드-bar-1-네임스페이스에-httpbin-배포">1번 노드 bar-1 네임스페이스에 httpbin 배포<a class="hash-link" href="#1번-노드-bar-1-네임스페이스에-httpbin-배포" title="Direct link to heading">​</a></h4><p><code>bar-1</code> 네임스페이스에서 <code>httpbin</code> 서비스를 실행하고, 해당 네임스페이스에 대해 Ambient 모드를 사용하려면 <code>bar-1</code> 네임스페이스에 라벨을 추가해야 한다.</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl create namespace bar-1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">namespace/foo created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl label namespace bar-1 istio.io/dataplane-mode</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">ambient</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">namespace/bar-1 labeled</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p><code>k3d-k3s-default-agent-1</code> 노드에 배포하기 위해 <code>nodeSelector</code> 구문을 추가하고 <code>bar-1</code> 네임스페이스에 배포한다.</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">cat &lt;&lt;EOF </span><span class="token punctuation" style="color:#393A34">|</span><span class="token plain"> kubectl create </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">n bar</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">1 </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">f </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> httpbin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> httpbin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">service</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> httpbin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">ports</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">targetPort</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">selector</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> httpbin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> apps/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> httpbin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">replicas</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">selector</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">matchLabels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> httpbin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">template</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> httpbin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">containers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> docker.io/kennethreitz/httpbin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">imagePullPolicy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> IfNotPresent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> httpbin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">ports</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">containerPort</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">nodeSelector</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">kubernetes.io/hostname</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;k3d-k3s-default-agent-1&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="2번-노드-waypoint-proxy-배포">2번 노드 waypoint proxy 배포<a class="hash-link" href="#2번-노드-waypoint-proxy-배포" title="Direct link to heading">​</a></h4><p>웨이포인트 프록시는 쿠버네티스 게이트웨이 리소스를 사용하여 배포된다. 대부분의 쿠버네티스 클러스터에는 기본적으로 쿠버네티스 게이트웨이 API CRD가 설치되어 있지 않으므로, 게이트웨이 API를 사용하기 전에 설치되어 있는지 확인해야 한다. </p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get crd gateways.gateway.networking.k8s.io </span><span class="token operator" style="color:#393A34">&amp;&gt;</span><span class="token plain"> /dev/null </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> kubectl apply -f https://github.com/kubernetes-sigs/gateway-api/releases/download/v1.1.0/standard-install.yaml</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">customresourcedefinition.apiextensions.k8s.io/gatewayclasses.gateway.networking.k8s.io created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">customresourcedefinition.apiextensions.k8s.io/gateways.gateway.networking.k8s.io created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">customresourcedefinition.apiextensions.k8s.io/grpcroutes.gateway.networking.k8s.io created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">customresourcedefinition.apiextensions.k8s.io/httproutes.gateway.networking.k8s.io created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">customresourcedefinition.apiextensions.k8s.io/referencegrants.gateway.networking.k8s.io created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p><code>istioctl waypoint</code> 명령어를 사용하여 Gateway API 리소스를 생성, 적용 또는 나열할 수 있다. waypoint가 배포된 후에는 전체 네임스페이스(또는 선택한 서비스 또는 파드)를 등록해야  한다. 특정 네임스페이스에 대한 waypoint proxy를 배포하기 전에 네임스페이스가 <code>istio.io/dataplane-mode: ambient</code>로 레이블이 지정되어 있는지 확인해야 한다.</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get ns -L istio.io/dataplane-mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME              STATUS   AGE    DATAPLANE-MODE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">argo-rollouts     Active   147m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">argocd            Active   172m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bar-1             Active   69m    ambient</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">default           Active   3h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">foo               Active   102m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">istio-system      Active   176m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-node-lease   Active   3h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-public       Active   3h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system       Active   3h</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>현재 Ambient가 등록되어 있는 네임스페이스는 <code>bar-1</code> 뿐이다. </p><p>구성 예시 그림에 보면 helloworld 앱을 <code>bar-2</code> 네임스페이스에 배포하고, waypoint가 해당 네임스페이스의 서비스에 대한 트래픽을 처리할 수 있도록 구성할 수 있다. 먼저, helloworld 앱을 배포할 네임스페이스 <code>bar-2</code>를 추가하고, 해당 네임스페이스에 대해 Ambient 모드를 사용하기 위해 <code>bar-2</code> 네임스페이스에 라벨을 추가해야 한다.</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl create namespace bar-2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">namespace/bar-2 created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl label namespace bar-2 istio.io/dataplane-mode</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">ambient</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">namespace/bar-2 labeled</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p><code>istioctl waypoint generate</code>로 waypoint proxy에 대한 쿠버네티스 <code>Gateway</code> API 리소스 manifest를 생성할 수 있다.</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ istioctl waypoint generate --for </span><span class="token function" style="color:#d73a49">service</span><span class="token plain"> -n bar-2</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl apply </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">f </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> &lt;&lt;EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gateway.networking.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Gateway</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">istio.io/waypoint-for</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> waypoint</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> bar</span><span class="token punctuation" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">gatewayClassName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> istio</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">waypoint</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">listeners</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> mesh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">15008</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">protocol</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> HBONE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gateway.gateway.networking.k8s.io/waypoint created</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>생성된 Gateway Resource를 직접 배포하거나 아래와 같이 <code>istioctl waypoint apply</code> 명령을 사용해서 waypoint를 배포하는 경우 --enroll-namespace 매개변수를 사용하여 네임스페이스에 자동으로 레이블을 지정할 수 있다.</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ istioctl waypoint apply -n bar-2 --enroll-namespace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">waypoint bar-2/waypoint applied</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">namespace bar-2 labeled with </span><span class="token string" style="color:#e3116c">&quot;istio.io/use-waypoint: waypoint&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>waypoint proxy가 배포되면, 리소스에서 명시적으로 사용하도록 구성하기 전까지는 어떤 리소스에서도 waypoint를 사용하지 않는다. </p><p>Gateway 리소스가 적용되면 Istiod는 리소스를 모니터링하고 해당 waypoint 배포 및 사용자를 위한 서비스를 자동으로 배포 및 관리하게 된다. waypoint가 모든 트래픽을 처리하거나, 클러스터의 워크로드(포드 또는 VM)로 직접 전송되는 트래픽만 처리하거나, 트래픽을 전혀 처리하지 않을 수도 있다. 예를 들어 waypoint가 모든 트래픽을 처리한다고 설정하는 경우 Prometheus 스크래핑 같은 내부 용도로 사용시 모든 트래픽이 L7 처리가 되는 오버헤드가 발생하기 때문에 아래와 같은 옵션을 <code>istio.io/waypoint-for</code> 레이블에 설정해서 정의하게 된다.</p><ul><li><code>istio.io/waypoint-for: service</code>: 쿠버네티스 서비스</li><li><code>istio.io/waypoint-for: workload</code>: 파드 또는 VM IP</li><li><code>istio.io/waypoint-for: all</code>: 서비스와 워크로드 트래픽 모두</li><li><code>istio.io/waypoint-for: none</code>: 전달 없음 (테스트 용)</li></ul><p>배포가 완료되면 아래와 같이 <code>bar-2</code> 네임스페이스에서 쿠버네티스 서비스로 전달되는 트래픽에 대해서만 트래픽을 수신하는 waypoint proxy pod를 확인할 수 있다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get gateway -A</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAMESPACE   NAME       CLASS            ADDRESS        PROGRAMMED   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bar-2       waypoint   istio-waypoint   10.43.241.18   True         21m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pod -n bar-2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                        READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">waypoint-7674fbc875-s9mgw   1/1     Running   0          22m</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="3번-노드-helloworld-application-배포">3번 노드 helloworld Application 배포<a class="hash-link" href="#3번-노드-helloworld-application-배포" title="Direct link to heading">​</a></h4><p><code>k3d-k3s-default-agent-3</code> 노드에 배포하기 위해 <code>nodeSelector</code> 구문을 추가하고 <code>bar-2</code> 네임스페이스에 배포한다.</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">cat &lt;&lt;EOF </span><span class="token punctuation" style="color:#393A34">|</span><span class="token plain"> kubectl create </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">n bar</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">2 </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">f </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> helloworld</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">ports</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">selector</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> helloworld</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> apps/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> helloworld</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">replicas</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">selector</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">matchLabels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> helloworld</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">template</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> helloworld</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">containers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> helloworld</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> docker.io/istio/examples</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">helloworld</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">imagePullPolicy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Always</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">ports</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">containerPort</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">protocol</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> TCP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">resources</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">requests</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">cpu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;100m&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">nodeSelector</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">kubernetes.io/hostname</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;k3d-k3s-default-agent-3&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>배포가 완료되면 의도한 대로 각 네임스페이스에 정상적으로 등록되어 있는지 확인한다.</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pod -n foo -o wide</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                     READY   STATUS    RESTARTS   AGE     IP          NODE                      NOMINATED NODE   READINESS GATES</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sleep-6885445f75-6zxh5   </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">/2     Running   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          3h33m   </span><span class="token number" style="color:#36acaa">10.42</span><span class="token plain">.0.5   k3d-k3s-default-agent-0   </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">           </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pod -n bar-1 -o wide</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                      READY   STATUS    RESTARTS   AGE    IP          NODE                      NOMINATED NODE   READINESS GATES</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">httpbin-55d7b9f77-65rjk   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     Running   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          3h7m   </span><span class="token number" style="color:#36acaa">10.42</span><span class="token plain">.1.7   k3d-k3s-default-agent-1   </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">           </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pod -n bar-2 -o wide</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                        READY   STATUS    RESTARTS   AGE   IP          NODE                       NOMINATED NODE   READINESS GATES</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helloworld-5996d5d8-2l55k   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     Running   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          22m   </span><span class="token number" style="color:#36acaa">10.42</span><span class="token plain">.2.6   k3d-k3s-default-agent-2    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">           </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">waypoint-7674fbc875-s9mgw   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     Running   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          96m   </span><span class="token number" style="color:#36acaa">10.42</span><span class="token plain">.4.5   k3d-k3s-default-server-0   </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">           </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="네트워크-트래픽-흐름-체크-sleep---httpbin">네트워크 트래픽 흐름 체크 (sleep -&gt; httpbin)<a class="hash-link" href="#네트워크-트래픽-흐름-체크-sleep---httpbin" title="Direct link to heading">​</a></h3><p><code>sleep</code>에서 나가는 트래픽의 흐름을 확인해보자. K3d로 배포했기 때문에 노드 접근은 <code>docker</code>나 <code>nerdctl</code> 명령으로 진행한다. 먼저 httpbin으로 접속해보자. </p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ ❯ kubectl </span><span class="token builtin class-name">exec</span><span class="token plain"> -it deploy/sleep -n foo </span><span class="token function" style="color:#d73a49">sleep</span><span class="token plain"> -- </span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> http://httpbin.bar-1:8000/get</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;args&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;headers&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;Accept&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;*/*&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;Host&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;httpbin.bar-1:8000&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;User-Agent&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;curl/8.10.1&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;X-Envoy-Attempt-Count&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;1&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;X-Envoy-Decorator-Operation&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;httpbin.bar-1.svc.cluster.local:8000/*&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;X-Envoy-Peer-Metadata&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;ChoKCkNMVVNURVJfSUQSDBoKS3ViZXJuZXRlcwp5CgZMQUJFTFMSbyptCg4KA2FwcBIHGgVzbGVlcAoqCh9zZXJ2aWNlLmlzdGlvLmlvL2Nhbm9uaWNhbC1uYW1lEgcaBXNsZWVwCi8KI3NlcnZpY2UuaXN0aW8uaW8vY2Fub25pY2FsLXJldmlzaW9uEggaBmxhdGVzdAogCgROQU1FEhgaFnNsZWVwLTY4ODU0NDVmNzUtNnp4aDUKEgoJTkFNRVNQQUNFEgUaA2ZvbwpFCgVPV05FUhI8GjprdWJlcm5ldGVzOi8vYXBpcy9hcHBzL3YxL25hbWVzcGFjZXMvZm9vL2RlcGxveW1lbnRzL3NsZWVwChgKDVdPUktMT0FEX05BTUUSBxoFc2xlZXA=&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;X-Envoy-Peer-Metadata-Id&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;sidecar~10.42.0.5~sleep-6885445f75-6zxh5.foo~foo.svc.cluster.local&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;origin&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;10.42.0.5&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;url&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;http://httpbin.bar-1:8000/get&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>헤더의 <code>origin</code>이나 <code>X-Envoy-Peer-Metadata-Id</code>를 보면 <code>sleep</code> 파드에서 넘어온 트래픽이라는 것을 확인할 수 있다.</p><p><code>sleep</code> 파드의 iptable을 확인해보자. <code>istio-proxy</code> 컨테이너 PID는 다음과 같이 확인할 수 있다.</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">docker</span><span class="token plain"> </span><span class="token builtin class-name">exec</span><span class="token plain"> -it k3d-k3s-default-agent-0 </span><span class="token function" style="color:#d73a49">ps</span><span class="token plain"> -ef </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">grep</span><span class="token plain"> istio</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">24459</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1337</span><span class="token plain">     /usr/local/bin/envoy -c etc/istio/proxy/envoy-rev.json --drain-t</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p><code>istio-proxy</code>의 iptable을 위에서 확인한 PID <code>24459</code> 네임스페이스(ns) 컨텍스트로 진입해서 확인해보면 마지막 <code>ISTIO_REDIRECT</code> 체인에서 <code>localhost:5001</code>로 Redirect 되는 것을 볼 수 있다.</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">docker</span><span class="token plain"> </span><span class="token builtin class-name">exec</span><span class="token plain"> -it k3d-k3s-default-agent-0 nsenter --net --target </span><span class="token number" style="color:#36acaa">24459</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">~ </span><span class="token comment" style="color:#999988;font-style:italic"># iptables -t nat -vnL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Chain PREROUTING </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">policy ACCEPT </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> packets, </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> bytes</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pkts bytes target     prot opt </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain">     out     </span><span class="token builtin class-name">source</span><span class="token plain">               destination</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">908</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">54480</span><span class="token plain"> ISTIO_INBOUND  </span><span class="token number" style="color:#36acaa">6</span><span class="token plain">    --  *      *       </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0.0/0            </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0.0/0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Chain INPUT </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">policy ACCEPT </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> packets, </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> bytes</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pkts bytes target     prot opt </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain">     out     </span><span class="token builtin class-name">source</span><span class="token plain">               destination</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Chain OUTPUT </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">policy ACCEPT </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> packets, </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> bytes</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pkts bytes target     prot opt </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain">     out     </span><span class="token builtin class-name">source</span><span class="token plain">               destination</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token number" style="color:#36acaa">21</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">1260</span><span class="token plain"> ISTIO_OUTPUT  </span><span class="token number" style="color:#36acaa">6</span><span class="token plain">    --  *      *       </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0.0/0            </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0.0/0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Chain POSTROUTING </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">policy ACCEPT </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> packets, </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> bytes</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pkts bytes target     prot opt </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain">     out     </span><span class="token builtin class-name">source</span><span class="token plain">               destination</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Chain ISTIO_INBOUND </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> references</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pkts bytes target     prot opt </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain">     out     </span><span class="token builtin class-name">source</span><span class="token plain">               destination</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> RETURN     </span><span class="token number" style="color:#36acaa">6</span><span class="token plain">    --  *      *       </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0.0/0            </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0.0/0            tcp dpt:15008</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> RETURN     </span><span class="token number" style="color:#36acaa">6</span><span class="token plain">    --  *      *       </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0.0/0            </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0.0/0            tcp dpt:15020</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">908</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">54480</span><span class="token plain"> RETURN     </span><span class="token number" style="color:#36acaa">6</span><span class="token plain">    --  *      *       </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0.0/0            </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0.0/0            tcp dpt:15021</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> RETURN     </span><span class="token number" style="color:#36acaa">6</span><span class="token plain">    --  *      *       </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0.0/0            </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0.0/0            tcp dpt:15090</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> ISTIO_IN_REDIRECT  </span><span class="token number" style="color:#36acaa">6</span><span class="token plain">    --  *      *       </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0.0/0            </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0.0/0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Chain ISTIO_IN_REDIRECT </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> references</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pkts bytes target     prot opt </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain">     out     </span><span class="token builtin class-name">source</span><span class="token plain">               destination</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">60</span><span class="token plain"> REDIRECT   </span><span class="token number" style="color:#36acaa">6</span><span class="token plain">    --  *      *       </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0.0/0            </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0.0/0            redir ports </span><span class="token number" style="color:#36acaa">15006</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Chain ISTIO_OUTPUT </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> references</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pkts bytes target     prot opt </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain">     out     </span><span class="token builtin class-name">source</span><span class="token plain">               destination</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">120</span><span class="token plain"> RETURN     </span><span class="token number" style="color:#36acaa">6</span><span class="token plain">    --  *      *       </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0.0/0            </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0.0/0            tcp dpt:15020</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> RETURN     </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">    --  *      lo      </span><span class="token number" style="color:#36acaa">127.0</span><span class="token plain">.0.6            </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0.0/0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">60</span><span class="token plain"> ISTIO_IN_REDIRECT  </span><span class="token number" style="color:#36acaa">6</span><span class="token plain">    --  *      lo      </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0.0/0           </span><span class="token operator" style="color:#393A34">!</span><span class="token number" style="color:#36acaa">127.0</span><span class="token plain">.0.1            tcp dpt:</span><span class="token operator" style="color:#393A34">!</span><span class="token number" style="color:#36acaa">15008</span><span class="token plain"> owner </span><span class="token environment constant" style="color:#36acaa">UID</span><span class="token plain"> match </span><span class="token number" style="color:#36acaa">1337</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> RETURN     </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">    --  *      lo      </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0.0/0            </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0.0/0            </span><span class="token operator" style="color:#393A34">!</span><span class="token plain"> owner </span><span class="token environment constant" style="color:#36acaa">UID</span><span class="token plain"> match </span><span class="token number" style="color:#36acaa">1337</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token number" style="color:#36acaa">15</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">900</span><span class="token plain"> RETURN     </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">    --  *      *       </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0.0/0            </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0.0/0            owner </span><span class="token environment constant" style="color:#36acaa">UID</span><span class="token plain"> match </span><span class="token number" style="color:#36acaa">1337</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> ISTIO_IN_REDIRECT  </span><span class="token number" style="color:#36acaa">6</span><span class="token plain">    --  *      lo      </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0.0/0           </span><span class="token operator" style="color:#393A34">!</span><span class="token number" style="color:#36acaa">127.0</span><span class="token plain">.0.1            tcp dpt:</span><span class="token operator" style="color:#393A34">!</span><span class="token number" style="color:#36acaa">15008</span><span class="token plain"> owner GID match </span><span class="token number" style="color:#36acaa">1337</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> RETURN     </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">    --  *      lo      </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0.0/0            </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0.0/0            </span><span class="token operator" style="color:#393A34">!</span><span class="token plain"> owner GID match </span><span class="token number" style="color:#36acaa">1337</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> RETURN     </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">    --  *      *       </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0.0/0            </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0.0/0            owner GID match </span><span class="token number" style="color:#36acaa">1337</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> RETURN     </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">    --  *      *       </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0.0/0            </span><span class="token number" style="color:#36acaa">127.0</span><span class="token plain">.0.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">3</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">180</span><span class="token plain"> ISTIO_REDIRECT  </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">    --  *      *       </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0.0/0            </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0.0/0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Chain ISTIO_REDIRECT </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> references</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pkts bytes target     prot opt </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain">     out     </span><span class="token builtin class-name">source</span><span class="token plain">               destination</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">3</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">180</span><span class="token plain"> REDIRECT   </span><span class="token number" style="color:#36acaa">6</span><span class="token plain">    --  *      *       </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0.0/0            </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0.0/0            redir ports </span><span class="token number" style="color:#36acaa">15001</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>이번엔 <code>httpbin</code> 파드와 같은 노드의 <code>ztunnel</code> 파드의 로그를 확인해보자. 위에서 <code>sleep</code> 파드에서 접근했기 때문에 src 워크로드의 정보를 통해 이를 확인할 수 있다. </p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl logs ztunnel-9t97l -n istio-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2024</span><span class="token plain">-10-19T17:46:36.635961Z info    access  connection complete src.addr</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10.42</span><span class="token plain">.0.5:56742 src.workload</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;sleep-6885445f75-6zxh5&quot;</span><span class="token plain"> src.namespace</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;foo&quot;</span><span class="token plain"> src.identity</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;spiffe://cluster.local/ns/foo/sa/default&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="네트워크-트래픽-흐름-체크-sleep---helloworld">네트워크 트래픽 흐름 체크 (sleep -&gt; helloworld)<a class="hash-link" href="#네트워크-트래픽-흐름-체크-sleep---helloworld" title="Direct link to heading">​</a></h3><p>Istio 컨트롤 플레인에는 서비스 메시의 모든 서비스 정보와 구성이 존재한다. <code>helloworld</code> 파드가 <code>wayfront</code> proxy와 함께 배포되면, <code>sleep</code> 파드 사이드카가 수신하는 <code>helloworld</code> 서비스의 EDS 구성이 <code>envoy_internal_address</code> 유형으로 변경된다. 사이드카를 통과하는 요청 트래픽이 <a href="https://istio.io/latest/docs/ambient/architecture/hbone/" target="_blank" rel="noopener noreferrer">HBONE(HTTP 기반 overlay 네트워크)</a> 프로토콜을 통해 세번째 노드의 <code>wayfront</code> proxy 포트 15008로 포워딩되는 것을 확인할 수 있다.</p><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="helloworld-로그-확인-정리중">helloworld 로그 확인 정리중<a class="hash-link" href="#helloworld-로그-확인-정리중" title="Direct link to heading">​</a></h4><hr><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="정리">정리<a class="hash-link" href="#정리" title="Direct link to heading">​</a></h2><p>이번 포스팅에서는 Istio Ambient 모드의 기능과 설치 방법, 샘플 애플리케이션 배포 및 트래픽 흐름에 대한 개괄적인 내용을 정리해봤다. </p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="reference">Reference<a class="hash-link" href="#reference" title="Direct link to heading">​</a></h2><ul><li><a href="https://istio.io/latest/blog/2022/introducing-ambient-mesh/" target="_blank" rel="noopener noreferrer">https://istio.io/latest/blog/2022/introducing-ambient-mesh/</a></li><li><a href="https://sysnet4admin.gitbook.io/cncf/cloud-native/service-mesh/istio/ambient-mesh/introducing-ambient-mesh" target="_blank" rel="noopener noreferrer">https://sysnet4admin.gitbook.io/cncf/cloud-native/service-mesh/istio/ambient-mesh/introducing-ambient-mesh</a></li><li><a href="https://www.youtube.com/watch?v=bbfiYMzHtH0&amp;list=WL&amp;index=1" target="_blank" rel="noopener noreferrer">https://www.youtube.com/watch?v=bbfiYMzHtH0&amp;list=WL&amp;index=1</a> </li></ul><blockquote><p>해당 포스팅은 현재 재직중인 회사에 관련이 없고, 개인 역량 개발을 위한 스터디 자료로 활용할 예정입니다.</p></blockquote></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_h6_j"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/istio/">Istio</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ambient/">Ambient</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/service-mesh/">Service-Mesh</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/sidecarless/">Sidecarless</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/ddiiwoong/newblog/tree/main/blog/2024-10-20-istio-ambient-mode.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><div></div><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/kubernetes/tetragon/"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Tetragon</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/kubernetes/gatewayapi/"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">AWS Gateway API Controller</div></a></div></nav></main><div class="col col--2"><div class="tableOfContents_cNA8 thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#istio-ambient-mesh" class="table-of-contents__link toc-highlight">Istio Ambient Mesh</a><ul><li><a href="#ztunnel" class="table-of-contents__link toc-highlight">Ztunnel</a></li><li><a href="#waypoint-proxy" class="table-of-contents__link toc-highlight">Waypoint Proxy</a></li></ul></li><li><a href="#install-istio-ambient" class="table-of-contents__link toc-highlight">Install Istio Ambient</a><ul><li><a href="#prerequisites" class="table-of-contents__link toc-highlight">Prerequisites</a></li><li><a href="#k3d-기반-istion-ambient-설치" class="table-of-contents__link toc-highlight">K3d 기반 Istion Ambient 설치</a></li><li><a href="#sample-app-rollout-배포" class="table-of-contents__link toc-highlight">Sample App Rollout 배포</a></li><li><a href="#네트워크-트래픽-흐름-체크-sleep---httpbin" class="table-of-contents__link toc-highlight">네트워크 트래픽 흐름 체크 (sleep -&gt; httpbin)</a></li><li><a href="#네트워크-트래픽-흐름-체크-sleep---helloworld" class="table-of-contents__link toc-highlight">네트워크 트래픽 흐름 체크 (sleep -&gt; helloworld)</a></li></ul></li><li><a href="#정리" class="table-of-contents__link toc-highlight">정리</a></li><li><a href="#reference" class="table-of-contents__link toc-highlight">Reference</a></li></ul></div></div></div></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Blog</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/">Home</a></li><li class="footer__item"><a class="footer__link-item" href="/archive/">Archive</a></li><li class="footer__item"><a class="footer__link-item" href="/tags/">Tags</a></li></ul></div><div class="col footer__col"><div class="footer__title">Sponsors</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/pang4u/">Pang4U</a></li><li class="footer__item"><a href="https://ko-fi.com/ddiiwoong" target="_blank" rel="noopener noreferrer" class="footer__link-item">Buy Me a Coffee<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/ddiiwoong" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/ddiiwoong" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.facebook.com/ddiiwoong" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://kr.linkedin.com/in/ddiiwoong" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div></div></footer></div>
<script src="/assets/js/runtime~main.da14d478.js"></script>
<script src="/assets/js/main.36bea237.js"></script>
</body>
</html>