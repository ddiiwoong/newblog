<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.18">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="Act as a catalyst RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Act as a catalyst Atom Feed">
<link rel="alternate" type="application/json" href="/feed.json" title="Act as a catalyst JSON Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","G-4ZT898XDT2","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-4ZT898XDT2"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-4ZT898XDT2",{anonymize_ip:!0})</script>
<link rel="search" type="application/opensearchdescription+xml" title="Cloud Catalyst" href="/opensearch.xml">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4362752107119680" crossorigin="anonymous"></script><title data-rh="true">vSphere with Tanzu homelab running on ASUS PN50 (1/2) | Cloud Catalyst</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://ddii.dev/kubernetes/vSphere-with-Tanzu-homelab"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" name="naver-site-verification" content="cbcc03783e5594725d3951f4e7f16ede80e69881"><meta data-rh="true" property="og:title" content="vSphere with Tanzu homelab running on ASUS PN50 (1/2) | Cloud Catalyst"><meta data-rh="true" name="description" content="이번 포스트에서는 Tanzu Cluster를 단일 홈랩 vSphere 서버에 올려본다"><meta data-rh="true" property="og:description" content="이번 포스트에서는 Tanzu Cluster를 단일 홈랩 vSphere 서버에 올려본다"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2020-11-30T00:00:00.000Z"><meta data-rh="true" property="article:tag" content="Kubernetes,Tanzu,vSphere,Homelab,ASUS,PN50"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://ddii.dev/kubernetes/vSphere-with-Tanzu-homelab"><link data-rh="true" rel="alternate" href="https://ddii.dev/kubernetes/vSphere-with-Tanzu-homelab" hreflang="en"><link data-rh="true" rel="alternate" href="https://ddii.dev/kubernetes/vSphere-with-Tanzu-homelab" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://J5EMWGFKQM-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.1e7a31ee.css">
<link rel="preload" href="/assets/js/runtime~main.62ad1f5f.js" as="script">
<link rel="preload" href="/assets/js/main.43a59d48.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top navbarHideable_ObN2"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo-catalyst.svg" alt="Cloud Catalyst" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/logo-catalyst.svg" alt="Cloud Catalyst" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">Cloud Catalyst</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/">Posts</a><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" docid="intro" href="/docs/intro">Docs</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/intro">Intro</a></li></ul></div></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/tags">Tags</a><a class="navbar__item navbar__link" href="/presentation">Presentation</a><a class="navbar__item navbar__link" href="/archive">Archive</a><a class="navbar__item navbar__link" href="/about">About</a><a class="navbar__item navbar__link" href="/pang4u">Pang4u</a><a href="https://github.com/ddiiwoong/newblog" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_S7eR colorModeToggle_vKtC"><button class="clean-btn toggleButton_rCf9 toggleButtonDisabled_Pu9x" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_v35p"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_nQuB"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_qEbK"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_a9qW thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_uKok margin-bottom--md">Recent Posts</div><ul class="sidebarItemList_Kvuv"><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kubernetes/eks-anywhere-adv">EKS Anywhere Advanced Usages</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kubernetes/eks-anywhere">EKS Anywhere on vSphere Homelab</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kubernetes/what-is-tailscale">What is Tailscale?</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/prometheus/synology-prometheus">Synology monitoring with Prometheus and snmp exporter</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kubernetes/vSphere-with-Tanzu-homelab-2">vSphere with Tanzu homelab running on ASUS PN50 (2/2)</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_rzP5" itemprop="headline">vSphere with Tanzu homelab running on ASUS PN50 (1/2)</h1><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2020-11-30T00:00:00.000Z" itemprop="datePublished">November 30, 2020</time> · <!-- -->19 min read</div></header><div id="post-content" class="markdown" itemprop="articleBody"><p>스타트업으로 이직후 정신없는 6개월을 보냈고 집에서 하는 사이드 프로젝트나 공부하는 것들이 소홀해지는것 같아 마음을 다잡고자 작성하는 포스팅이다. 최근 몇개월 간은 회사 블로그 글만 작성하다보니 개인 블로그를 거의 못하고 있어서 회사 제품과는 아직까지 거리가 있는 플랫폼 공부차 작성한다. 순수하게 정보공유차 작성하는 것이며, 특정회사의 회사의 제품이나 플랫폼을 홍보하고자 함은 아니다.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="tanzu">Tanzu<a class="hash-link" href="#tanzu" title="Direct link to heading">​</a></h2><p><a href="https://tanzu.vmware.com/content/blog/simplify-your-approach-to-application-modernization-with-4-simple-editions-for-the-tanzu-portfolio" target="_blank" rel="noopener noreferrer">https://tanzu.vmware.com/content/blog/simplify-your-approach-to-application-modernization-with-4-simple-editions-for-the-tanzu-portfolio</a>  </p><p>Tanzu는 애플리케이션을 개발, 구동, 운영하는 모든 컨테이너 환경을 통합 관리하는 쿠버네티스를 상용화 한 제품으로 이해하는 것이 가장 쉽다. </p><p><img loading="lazy" alt="tanzu" src="/assets/images/tanzu-31ee2ad3f4e378ea6b48dd7368fad618.png" width="550" height="272" class="img_E7b_"><br>
<!-- -->(출처 : VM웨어 코리아 발표자료 갈무리)</p><p>포트폴리오를 간단히 살펴보면 기존 인프라를 구성하는 레이어인 vSphere 위에 <code>VMware Tanzu Kubernetes Grid</code>를 볼 수 있다.  </p><p>오늘은 기존 Pivotal 이나 Spring Boot를 제외한 플랫폼 레이어의 TKG(Tanzu Kubernetes Grid)를 홈랩으로 구성하는 과정을 정리했다. </p><p>모든 과정은 virtuallyGhetto 블로그를 참고하여 작성했고 가장 따라한 부분은 아래 포스팅이니 NUC으로 구성하려면 원문을 참고하면 된다.<br>
<a href="https://www.virtuallyghetto.com/2020/11/complete-vsphere-with-tanzu-homelab-with-just-32gb-of-memory.html#comments" target="_blank" rel="noopener noreferrer">https://www.virtuallyghetto.com/2020/11/complete-vsphere-with-tanzu-homelab-with-just-32gb-of-memory.html#comments</a></p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="준비사항hardware">준비사항(Hardware)<a class="hash-link" href="#준비사항hardware" title="Direct link to heading">​</a></h2><ul><li><p>ASUS PN50<br>
<a href="https://www.asus.com/kr/Mini-PCs/Mini-PC-PN50/" target="_blank" rel="noopener noreferrer">https://www.asus.com/kr/Mini-PCs/Mini-PC-PN50/</a></p><p>PN50 베어본을 선택한 이유는 일단 AMD Ryzen 4800u CPU가 저전력인데도 불구하고 8코어 16스레드, 64GB sodimm이 지원되며, 2.5인치와 M.2 SSD가 동시 장착이 가능하다는 점이다. 온보드 NIC 드라이버가 vSphere 7.0에서 지원되지 않지만 USB Network Adapter를 통해 구성이 가능했기 때문에 망설임 없이 구매를 결정했다. 구입은 네이버 검색(asus pn50 4800u)을 통해 71만원 정도에 구매를 했다. 이도 스마일 캐시를 직접 구매해서 실제 구매금액은 65만원 정도가 소요되었다.</p></li><li><p>SODIMM DDR4 32G PC4-25600 (TeamGroup)<br>
<!-- -->해당 제품은 가성비로 가장 저렴하게 살 수 있는 국내 워런티가 가능한 SODIMM 메모리로 32G 2개를 구매했으며 네이버 검색으로 2개 25만원 정도로 구매했다.</p></li><li><p>2.5 SSD (ADATA SU655 240GB)<br>
<!-- -->ESXi 서버 설치용으로 사용하기 위해 기존에 갖고 있던 ADATA SU655 240GB를 사용했고 현재 3.5만원 정도에 구매가능하다. </p></li><li><p>M.2 SSD (WD BLACK SN750 M.2 NVMe 500GB)<br>
<!-- -->아마존에서 직구한 녀석으로 69.99달러 소요되었다. 배대지 가격을 합치면 8.5만원 정도 소요되었다. </p></li><li><p>Gigabit USB Lancard (tplink UE300C)<br>
<!-- -->ESXi 7.0버전에서 온보드 NIC 인식이 불가능한 이유로 별도로 기기비트 유선 랜카드를 구매했다. 1.5만원 정도에 구매가능 하고 3년 보증이 되는 TPLINK제품으로 선택하였다.<br>
<a href="https://coupa.ng/bM0lN8" target="_blank" rel="noopener noreferrer">https://coupa.ng/bM0lN8</a> -&gt; <code>해당 링크를 통해 구매하면 저에게 쿠팡 파트너스를 통해 적립금이 지급되니 필요하신 분은 아래를 통해 구매를 부탁드립니다</code></p></li></ul><p>실제 위 스펙으로 대충 구매를 진행하게 되면 <code>104만원</code> 정도 소요가 될것으로 예상된다. 환율이나 할인을 전혀 받지 않고 1개의 SSD로 구성한다고 가정해도 약 8코어 16스레드 64GB 머신을 <code>110만원</code> 정도로 구성이 가능하다. 물론 서버나 워크스테이션이나 Intel NUC기반으로도 구성이 가능하지만 전력소모와 집안을 차지하는 부피를 고려하면 금액적으로 메리트가 있다고 생각한다.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="준비사항software">준비사항(Software)<a class="hash-link" href="#준비사항software" title="Direct link to heading">​</a></h2><ul><li><p>Windows PC (with Powershell, WSL) or MAC
Window를 사용을 하지 않고 MAC이나 리눅스로 구성하려 했으나 온보드 NIC 인식을 위한 드라이버 통합 커스텀 이미지 작성 편의를 위해 Window 환경을 사용하였다.</p></li><li><p><a href="https://www.ventoy.net/en/index.html" target="_blank" rel="noopener noreferrer">ventoy</a><br>
<!-- -->ESXi 부팅 이미지 제작을 위한 툴이며 <a href="https://rufus.ie/" target="_blank" rel="noopener noreferrer">rufus</a>에 비해 활용도가 높다.</p></li><li><p><a href="https://my.vmware.com/en/group/vmware/downloads/info/slug/datacenter_cloud_infrastructure/vmware_vsphere/7_0" target="_blank" rel="noopener noreferrer">vSphere 7.0 Update 1</a><br>
<!-- -->평가판은 <a href="https://my.vmware.com/en/group/vmware/evalcenter?p=vsphere-eval-7" target="_blank" rel="noopener noreferrer">https://my.vmware.com/en/group/vmware/evalcenter?p=vsphere-eval-7</a> 에서 다운로드가 가능하다.</p></li><li><p><a href="https://github.com/PowerShell/PowerShell/releases/tag/v7.1.0" target="_blank" rel="noopener noreferrer">PowerShell 7.10</a><br>
<!-- -->기본적으로 Window에는 6.x 버전의 PowerShell이 설치되어 있기 때문에 7.1.0 버전을 신규로 설치해야 한다.</p></li><li><p><a href="https://www.powershellgallery.com/packages?q=VMware.PowerCLI" target="_blank" rel="noopener noreferrer">PowerCLI</a><br>
<a href="https://www.powershellgallery.com/packages/VMware.PowerCLI/12.1.0.17009493" target="_blank" rel="noopener noreferrer">https://www.powershellgallery.com/packages/VMware.PowerCLI/12.1.0.17009493</a>
커스텀 ESXi 7.0 이미지 제작을 위해 필요하다.</p></li><li><p><a href="https://flings.vmware.com/usb-network-native-driver-for-esxi?download_url=https%3A%2F%2Fdownload3.vmware.com%2Fsoftware%2Fvmw-tools%2FUSBNND%2FESXi701-VMKUSB-NIC-FLING-40599856-component-17078334.zip" target="_blank" rel="noopener noreferrer">USB Network Native Driver for ESXi</a><br>
<!-- -->PN50 USB NIC(RTL8153) 인식을 위한 네이티브 드라이버.</p></li><li><p><a href="https://my.vmware.com/group/vmware/downloads/details?downloadGroup=OVFTOOL440P01&amp;productId=974" target="_blank" rel="noopener noreferrer">OVFTool</a><br>
<!-- -->OVA를 배포하기 위한 도구로 Linux 64 bundle로 WSL에 설치한다. </p></li><li><p><a href="https://my.vmware.com/group/vmware/evalcenter?p=vsphere-eval-7" target="_blank" rel="noopener noreferrer">vcsa-deploy</a><br>
<!-- -->vCenter를 배포하는 도구로 이미지내에 포함되어 있기 때문에 vCenter Server Appliance ISO를 다운받아 압축을 풀면 확인할 수 있다. </p></li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="최종-예상-구성요소">최종 예상 구성요소<a class="hash-link" href="#최종-예상-구성요소" title="Direct link to heading">​</a></h2><ul><li>vCenter Server Appliance</li><li>VMFS Storage</li><li>vSphere with Tanzu Cluster</li><li>HAProxy</li><li>Router (Forwarding, DNS)</li><li>Supervisor Control Plane VMs (Master 2ea, Worker 3ea)</li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="esxi-설치">ESXi 설치<a class="hash-link" href="#esxi-설치" title="Direct link to heading">​</a></h2><p>초반에도 이야기 했듯이 ESXi 7.0이상에서는 ASUS PN50의 온보드 인터페이스를 사용하지 못한다. 그래서 별도로 구매한 USB 인터페이스의 RTL8153 칩셋을 이미지에 통합시키는 작업이 필요하다.  </p><p>드라이버 이미지 통합을 위한 내용은 아래 포스팅을 참고했다.  </p><ul><li><a href="https://www.virten.net/2020/09/esxi-on-amd-ryzen-based-asus-pn50/" target="_blank" rel="noopener noreferrer">https://www.virten.net/2020/09/esxi-on-amd-ryzen-based-asus-pn50/</a></li><li><a href="https://www.virten.net/2020/04/how-to-add-the-usb-nic-fling-to-esxi-7-0-base-image/" target="_blank" rel="noopener noreferrer">https://www.virten.net/2020/04/how-to-add-the-usb-nic-fling-to-esxi-7-0-base-image/</a></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="esxi-다운로드">ESXi 다운로드<a class="hash-link" href="#esxi-다운로드" title="Direct link to heading">​</a></h3><p>다음 링크에서 <code>VMware vSphere 7.0 Update 1</code> 를 다운로드 한다.  </p><ul><li><a href="https://my.vmware.com/en/group/vmware/downloads/info/slug/datacenter_cloud_infrastructure/vmware_vsphere/7_0" target="_blank" rel="noopener noreferrer">https://my.vmware.com/en/group/vmware/downloads/info/slug/datacenter_cloud_infrastructure/vmware_vsphere/7_0</a></li></ul><p>기본적으로 VMware 회원가입이 필요하며 라이센스가 없는 경우 60일 trial로 가능하다.  </p><ul><li><a href="https://my.vmware.com/en/group/vmware/evalcenter?p=vsphere-eval-7" target="_blank" rel="noopener noreferrer">https://my.vmware.com/en/group/vmware/evalcenter?p=vsphere-eval-7</a></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="usb-network-native-driver-for-esxi">USB Network Native Driver for ESXi<a class="hash-link" href="#usb-network-native-driver-for-esxi" title="Direct link to heading">​</a></h3><p>USB NIC Fling 드라이버를 준비한다. </p><ul><li><a href="https://flings.vmware.com/usb-network-native-driver-for-esxi?download_url=https%3A%2F%2Fdownload3.vmware.com%2Fsoftware%2Fvmw-tools%2FUSBNND%2FESXi701-VMKUSB-NIC-FLING-40599856-component-17078334.zip" target="_blank" rel="noopener noreferrer">https://flings.vmware.com/usb-network-native-driver-for-esxi?download_url=https%3A%2F%2Fdownload3.vmware.com%2Fsoftware%2Fvmw-tools%2FUSBNND%2FESXi701-VMKUSB-NIC-FLING-40599856-component-17078334.zip
</a></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="powershell-710-설치">PowerShell 7.1.0 설치<a class="hash-link" href="#powershell-710-설치" title="Direct link to heading">​</a></h3><p>기본적으로 Window에는 6.x 버전의 PowerShell이 설치되어 있기 때문에 특정 스크립트를 구동하기 위해서는 7.1.0 버전을 신규로 설치해야 한다.  </p><ul><li><a href="https://github.com/PowerShell/PowerShell" target="_blank" rel="noopener noreferrer">https://github.com/PowerShell/PowerShell</a></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="powercli-준비">PowerCLI 준비<a class="hash-link" href="#powercli-준비" title="Direct link to heading">​</a></h3><p>PowerCLI 다운로드 및 설치</p><ul><li><a href="https://www.powershellgallery.com/packages/VMware.PowerCLI/12.1.0.17009493" target="_blank" rel="noopener noreferrer">https://www.powershellgallery.com/packages/VMware.PowerCLI/12.1.0.17009493</a></li></ul><p>관리자 권한으로 PowerShell을 실행하고 PowerCLI 모듈 설치전에 실행 권한을 수정한다.  </p><ul><li>참고 : <a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_execution_policies?view=powershell-7.1" target="_blank" rel="noopener noreferrer">https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_execution_policies?view=powershell-7.1</a></li></ul><div class="codeBlockContainer_I0IT language-powershell theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-powershell codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">Set-ExecutionPolicy -ExecutionPolicy RemoteSigned</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>PowerCLI를 설치한다.</p><div class="codeBlockContainer_I0IT language-powershell theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-powershell codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">Install-Module -Name VMware.PowerCLI -Scope CurrentUser</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="image-profile-확인">Image Profile 확인<a class="hash-link" href="#image-profile-확인" title="Direct link to heading">​</a></h3><p>포스팅을 하는 20년 11월 29일 최신 ESXi 이미지는 <code>ESXi-7.0U1b-17168206-standard</code>로 vSphere ESXi 7.0 이미지 프로필은 아래에서 확인이 가능하다.  </p><ul><li><a href="https://www.virten.net/vmware/vmware-esxi-image-profiles/" target="_blank" rel="noopener noreferrer">https://www.virten.net/vmware/vmware-esxi-image-profiles/</a></li></ul><p>stable 릴리스로 구성하기 위해 이전 릴리스인 <code>ESXi-7.0.1-16850804-standard</code> 이미지 프로필로 설치를 진행한다.  </p><p>설치 프로세스를 살펴보면 <code>Add-EsxSoftwareDepot</code>로 repo설정을 하고 <code>Export-ESXImageProfile</code>를 통해 원하는 이미지 프로필의 bundle을 다운로드 받는다. 위에서 다운로드 받은 드라이버를 <code>Add-EsxSoftwarePackage</code>로 패키지를 추가하고 새로운 ISO이미지를 생성하는 과정을 알 수 있다.  </p><p>이미지 프로필 변경을 통해 원하는 이미지 버전으로 구성이 가능하다.  </p><div class="codeBlockContainer_I0IT language-powershell theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-powershell codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">Add-EsxSoftwareDepot https://hostupdate.vmware.com/software/VUM/PRODUCTION/main/vmw-depot-index.xml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Export-ESXImageProfile -ImageProfile &quot;ESXi-7.0.1-16850804-standard&quot; -ExportToBundle -filepath  ESXi-7.0.1-16850804-standard.zip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Remove-EsxSoftwareDepot https://hostupdate.vmware.com/software/VUM/PRODUCTION/main/vmw-depot-index.xml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Add-EsxSoftwareDepot .\ESXi-7.0.0-15843807-standard.zip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Add-EsxSoftwareDepot .\ESXi701-VMKUSB-NIC-FLING-40599856-component-17078334.zip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">New-EsxImageProfile -CloneProfile &quot;ESXi-7.0.1-16850804-standard&quot; -name &quot;ESXi-7.0.1-16850804-USBNIC&quot; -Vendor &quot;virten.net&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Add-EsxSoftwarePackage -ImageProfile &quot;ESXi-7.0.1-16850804-USBNIC&quot; -SoftwarePackage &quot;vmkusb-nic-fling&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Export-ESXImageProfile -ImageProfile &quot;ESXi-7.0.1-16850804-USBNIC&quot; -ExportToIso -filepath ESXi-7.0.1-16850804-USBNIC.iso</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Export-ESXImageProfile -ImageProfile &quot;ESXi-7.0.1-16850804-USBNIC&quot; -ExportToBundle -filepath ESXi-7.0.1-16850804-USBNIC.zip</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="esxi-설치-이미지-제작">ESXi 설치 이미지 제작<a class="hash-link" href="#esxi-설치-이미지-제작" title="Direct link to heading">​</a></h3><p>ESXi 부팅 이미지 제작은 <a href="https://rufus.ie/" target="_blank" rel="noopener noreferrer">rufus</a>, <a href="https://www.ventoy.net/en/index.html" target="_blank" rel="noopener noreferrer">ventoy</a> 둘 중 편한 도구로 선택하면 되는데 ventoy가 조금 더 활용도가 높다고 판단하여 진행했고, OS설치 USB 생성은 생략한다. </p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="부팅-및-설치">부팅 및 설치<a class="hash-link" href="#부팅-및-설치" title="Direct link to heading">​</a></h3><p>일반적인 바이오스 설정과 동일하게 Boot 우선순위를 USB로 설정하고 다음과 같은 ventoy화면에서 앞서 생성한 <code>ESXi-7.0.1-16850804-USBNIC.iso</code> 이미지로 ESXi 설치를 진행한다.</p><p><img loading="lazy" src="https://nuanceofiqlusion.files.wordpress.com/2020/07/ventoymainmenu-e1594484932538.png" alt="ventoy" class="img_E7b_">
<a href="https://nuanceofiqlusion.files.wordpress.com/2020/07/ventoymainmenu-e1594484932538.png" target="_blank" rel="noopener noreferrer">https://nuanceofiqlusion.files.wordpress.com/2020/07/ventoymainmenu-e1594484932538.png</a>  </p><p>이후 친숙한 DCUI(Direct Console User Interface)로 접속하여 F2모드로 접속하여 Static IP 설정과 network 테스트를 진행한다.  </p><p><img loading="lazy" alt="esxi" src="/assets/images/esxi7-5ef7454cef904dde1696b3ce9d0028a2.png" width="640" height="480" class="img_E7b_"></p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="vsphere-web-client-접속">vSphere Web Client 접속<a class="hash-link" href="#vsphere-web-client-접속" title="Direct link to heading">​</a></h3><p>설정한 Static IP로 접속하여 환경을 점검한다.  </p><p><img loading="lazy" alt="nw" src="/assets/images/esxi_network-290297edf5689dc50b1a67459aed6a37.png" width="1138" height="687" class="img_E7b_"></p><p>Management Network에 vSwitch0이 구성된 것을 확인할 수 있다.  </p><p>그리고 설치한 M.2 SSD로 datastore2를 추가하여 vCenter 설치를 진행하도록 한다.</p><p><img loading="lazy" alt="storage" src="/assets/images/esxi_storage-564ca3d7a6401db1e1aef917ab9048b3.png" width="1143" height="458" class="img_E7b_"></p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="router-설치-및-환경-구성">Router 설치 및 환경 구성<a class="hash-link" href="#router-설치-및-환경-구성" title="Direct link to heading">​</a></h2><p>Router VM은 DNS 서버의 역할뿐 아니라 앞으로 구성될 내부 네트워크(10.10.0.0/24 &amp; 10.20.0.0/24)와 외부 네트워크의 포워딩과 NAT 역할을 수행한다.  </p><p>Photon OS 3.0 OVA로 배포되며 <a href="https://my.vmware.com/group/vmware/downloads/details?downloadGroup=OVFTOOL440P01&amp;productId=974" target="_blank" rel="noopener noreferrer">OVFTool</a>를 사용하여 배포를 진행하는데 이미 작성된 배포 스크립트를 활용한다. </p><ul><li><a href="https://packages.vmware.com/photon/3.0/Rev3/ova/photon-hw13_uefi-3.0-a383732.ova" target="_blank" rel="noopener noreferrer">Photon OS 3.0 OVA</a></li><li><a href="https://github.com/lamw/vsphere-with-tanzu-homelab-scripts.git" target="_blank" rel="noopener noreferrer">https://github.com/lamw/vsphere-with-tanzu-homelab-scripts</a></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="router-설치">Router 설치<a class="hash-link" href="#router-설치" title="Direct link to heading">​</a></h3><p>스크립트 실행은 동일한 PowerShell이 동작하는 Window WSL2 환경에서 수행했기 때문에 Window <code>hosts</code> 파일과 WSL환경의 <code>/etc/hosts</code> 파일에 아래와 같이 사용하고자 하는 IP주소를 미리 등록해놓는다.  </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">192.168.0.10    esxi-01.tanzu.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">192.168.0.201   router.tanzu.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">192.168.0.202   vcsa.tanzu.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">192.168.0.203   haproxy.tanzu.local</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p><a href="https://github.com/lamw/vsphere-with-tanzu-homelab-scripts.git" target="_blank" rel="noopener noreferrer">스크립트 레포</a>의 <code>deploy_photon_router_ova.sh</code>를 자신의 환경에 맞게 수정한다. WSL내에서 Window 시스템내에 다운로드한 OVA파일 경로는 WSL내에서 실행될 것이기에 <code>/mnt/c/esxi/photon-hw13_uefi-3.0-a383732.ova</code>로 변경하였다. Router와 ESXi hostname, password등을 확인하고 Network과 Datastore는 위에서 확인한 내용으로 수정한다.</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># William Lam</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># www.virtuallyghetto</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PhotonOVA=&quot;/mnt/c/esxi/photon-hw13_uefi-3.0-a383732.ova&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PhotonRouterVMName=&quot;router.tanzu.local&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ESXiHostname=&quot;esxi-01.tanzu.local&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ESXiUsername=&quot;root&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ESXiPassword=&#x27;VMware1!&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PhotonRouterNetwork=&quot;VM Network&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PhotonRouterDatastore=&quot;datastore1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">### DO NOT EDIT BEYOND HERE ###</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ovftool \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--name=${PhotonRouterVMName} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--X:waitForIpv4 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--powerOn \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--acceptAllEulas \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--noSSLVerify \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--datastore=${PhotonRouterDatastore} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--net:&quot;None=${PhotonRouterNetwork}&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">${PhotonOVA} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;vi://${ESXiUsername}:${ESXiPassword}@${ESXiHostname}&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>스크립드를 실행하면 OVA파일을 배포하게 된다.  </p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ ./deploy_photon_router_ova.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Opening OVA source: /mnt/c/esxi/photon-hw13_uefi-3.0-a383732.ova</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The manifest validates</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The provided certificate is in valid period</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Source is signed and the certificate validates</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Certificate information:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CertIssuer:/C=US/ST=California/L=Palo Alto/O=VMware, Inc.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CertSubject:/C=US/ST=California/L=Palo Alto/O=VMware, Inc.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -----BEGIN CERTIFICATE-----</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -----END CERTIFICATE-----</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Warning:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> - Line -1: Unsupported value &#x27;uefi.secureBoot.enabled&#x27; for attribute &#x27;key&#x27; on element &#x27;ExtraConfig&#x27;.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Opening VI target: vi://root@esxi-01.tanzu.local:443/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Deploying to VI: vi://root@esxi-01.tanzu.local:443/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Transfer Completed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Powering on VM: router.tanzu.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Task Completed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Received IP address: 192.168.0.47</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Completed successfully</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>위와 같이 DHCP를 통해 임의의 주소(192.168.0.47)를 할당 받게 되고 해당 IP로 SSH접속하여 기본 패스워드(<code>changeme</code>)를 원하는 패스워드로 변경한다.</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ ssh root@192.168.0.47</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The authenticity of host &#x27;192.168.0.47 (192.168.0.47)&#x27; can&#x27;t be established.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ECDSA key fingerprint is SHA256:ESpN1DMTIu9PKWW4QZIYs4DZ602SsdhjxEYhugkmi+g.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Are you sure you want to continue connecting (yes/no/[fingerprint])? yes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Warning: Permanently added &#x27;192.168.0.47&#x27; (ECDSA) to the list of known hosts.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Password:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cat &gt; /etc/systemd/network/10-static-eth0.network &lt;&lt; EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">You are required to change your password immediately (administrator enforced)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Changing password for root.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Current password:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">New password:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Retype new password:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 08:58:54 up 32 min,  0 users,  load average: 0.00, 0.00, 0.00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tdnf update info not available yet!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@photon-machine [ ~ ]#</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@photon-machine [ ~ ]# exit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">logout</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Connection to 192.168.0.47 closed.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="router-환경-구성">Router 환경 구성<a class="hash-link" href="#router-환경-구성" title="Direct link to heading">​</a></h3><p>위 스크립트 <a href="https://github.com/lamw/vsphere-with-tanzu-homelab-scripts" target="_blank" rel="noopener noreferrer">레포지토리</a>에서 DNS역할, 포워딩을 수행하도록 <a href="https://github.com/lamw/vsphere-with-tanzu-homelab-scripts/blob/master/setup_photon_router.sh" target="_blank" rel="noopener noreferrer"><code>setup_photon_router.sh</code></a>를 수정한다. </p><ul><li><code>PHOTON_ROUTER_IP</code>=192.168.0.201 : Router 설정할 IP</li><li><code>PHOTON_ROUTER_GW</code>=192.168.0.1 : Router의 게이트웨이</li><li><code>PHOTON_ROUTER_DNS</code>=192.168.0.1 : Router의 Forwader DNS</li><li><code>SETUP_DNS_SERVER</code>=1 : Router가 클러스터 내 DNS 역할을 수행</li></ul><p>위 설정 이외에도 추후 내부 네트워크 구성을 위한 iptables 구성이 포함되어 있다.  </p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PHOTON_ROUTER_IP=192.168.0.201</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PHOTON_ROUTER_GW=192.168.0.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PHOTON_ROUTER_DNS=192.168.0.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SETUP_DNS_SERVER=1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tdnf -y update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if [ ${SETUP_DNS_SERVER} -eq 1 ]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tdnf install -y unbound</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cat &gt; /etc/unbound/unbound.conf &lt;&lt; EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    server:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        interface: 0.0.0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        port: 53</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        do-ip4: yes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        do-udp: yes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        access-control: 192.168.0.0/24 allow</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        access-control: 10.10.0.0/24 allow</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        access-control: 10.20.0.0/24 allow</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        verbosity: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local-zone: &quot;tanzu.local.&quot; static</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local-data: &quot;router.tanzu.local A 192.168.0.201&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local-data-ptr: &quot;192.168.0.201 router.tanzu.local&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local-data: &quot;vcsa.tanzu.local A 192.168.0.202&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local-data-ptr: &quot;192.168.0.202 vcsa.tanzu.local&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local-data: &quot;haproxy.tanzu.local A 192.168.0.203&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local-data-ptr: &quot;192.168.0.203 haproxy.tanzu.local&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local-data: &quot;esxi-01.tanzu.local A 192.168.0.10&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local-data-ptr: &quot;192.168.0.10 esxi-01.tanzu.local&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>해당 스크립트를 수행하고 나면 IP가 변경되고 외부에서도 Router DNS를 통해 쿼리가 가능한것을 확인할 수 있다.  </p><div class="codeBlockContainer_I0IT language-powershell theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-powershell codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">PS C:\Users\rokak&gt; nslookup vmware.com 192.168.0.201</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">서버:    router.tanzu.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Address:  192.168.0.201</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">권한 없는 응답:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">이름:    vmware.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Addresses:  2a02:e980:b5::b7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            2a02:e980:b1::b7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            45.60.101.183</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            45.60.11.183</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="vcsavcenter-server-appliance-배포-및-구성">VCSA(vCenter Server Appliance) 배포 및 구성<a class="hash-link" href="#vcsavcenter-server-appliance-배포-및-구성" title="Direct link to heading">​</a></h3><p><code>vcsa-deploy</code>를 사용하여 배포를 진행한다. <code>vcsa-deploy</code>는 VCSA 이미지내에 바이너리 형태로 존재하기 때문에 먼저 VCSA 7.0 Update 1 ISO를 다운로드한다.  </p><ul><li><a href="https://my.vmware.com/group/vmware/evalcenter?p=vsphere-eval-7" target="_blank" rel="noopener noreferrer">https://my.vmware.com/group/vmware/evalcenter?p=vsphere-eval-7</a></li></ul><p>위 스크립트 <a href="https://github.com/lamw/vsphere-with-tanzu-homelab-scripts" target="_blank" rel="noopener noreferrer">레포지토리</a>에서 <a href="https://github.com/lamw/vsphere-with-tanzu-homelab-scripts/blob/master/vcsa.tanzu.local.json" target="_blank" rel="noopener noreferrer"><code>vcsa.tanzu.local.json</code></a>를 수정한다.  </p><p>패스워드, <code>Network</code>와 <code>Datastore</code>를 설정하고 <code>dns_servers</code>를 Router IP로 변경한다. 나머지는 기본값으로 설정한다. </p><div class="codeBlockContainer_I0IT language-json theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-json codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;deployment_network&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;VM Network&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;datastore&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;datastore2&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;appliance&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;__comments&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;thin_disk_mode&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;deployment_option&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;tiny&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;name&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;vcsa.tanzu.local&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;network&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;ip_family&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;ipv4&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;mode&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;static&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;system_name&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;vcsa.tanzu.local&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;ip&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;192.168.0.202&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;prefix&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;24&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;gateway&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;192.168.0.1&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;dns_servers&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;192.168.0.201&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>위에서 다운로드 받았던 VCSA ISO를 압축을 풀고 위 스크립트를 참조하여 배포 명령을 실행한다. </p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ cd VMware-VCSA-all-7.0.1-17004997/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ ./vcsa-deploy install --accept-eula --acknowledge-ceip --no-ssl-certificate-verification /mnt/c/esxi/vsphere-with-tanzu-homelab-scripts/vcsa.tanzu.local.json</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>vCenter가 설치가 완료된 후 SSH로 접속한다. 기본 Shell이 Bash가 아니므로 <code>shell</code> 명령으로 접속한후 <code>chsh -s /bin/bash</code>로 기본 Shell을 Bash로 변경한다.  </p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ ssh root@192.168.0.202</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The authenticity of host &#x27;192.168.0.202 (192.168.0.202)&#x27; can&#x27;t be established.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ECDSA key fingerprint is SHA256:oMr5nJ9RDeZS9E3m586kSFDoNXM76yNiLYaIyDQ6ca4.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Are you sure you want to continue connecting (yes/no/[fingerprint])? yes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Warning: Permanently added &#x27;192.168.0.202&#x27; (ECDSA) to the list of known hosts.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">VMware vCenter Server 7.0.1.00100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Type: vCenter Server with an embedded Platform Services Controller</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@192.168.0.202&#x27;s password:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Connected to service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * List APIs: &quot;help api list&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * List Plugins: &quot;help pi list&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * Launch BASH: &quot;shell&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Command&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Command&gt; shell</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Shell access is granted to root</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@vcsa [ ~ ]# chsh -s /bin/bash</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="vcsa-설정-변경">VCSA 설정 변경<a class="hash-link" href="#vcsa-설정-변경" title="Direct link to heading">​</a></h3><p>메모리 절약을 위해 마스터 노드 개수를 변경한다. <code>/etc/vmware/wcp/wcpsvc.yaml</code> 에서 <code>clusterconfig.minmasters</code> 와 <code>clusterconfig.maxmasters</code> 값을 2로 변경하면 된다. 자세한 내용은 다음 링크를 참조한다.</p><ul><li><a href="https://www.virtuallyghetto.com/2020/04/deploying-a-minimal-vsphere-with-kubernetes-environment.html" target="_blank" rel="noopener noreferrer">https://www.virtuallyghetto.com/2020/04/deploying-a-minimal-vsphere-with-kubernetes-environment.html</a></li></ul><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">logging</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">level</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> debug</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">maxsizemb</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># By default, WCP Agent VM OVF URL points to the ovf bundled in vCSA, served</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># through lighttpd web server. To override it, set kubevmconfig.ovfurl param.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#kubevm:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#  ovfurl: &#x27;https://this_vc_pnid:5480/wcpagent/photon-ova-%%SIZE%%.ovf&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#  apiserverport: 6443</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#  authproxyport: 443</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">rhttpproxy_port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">443</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">clusterconfig</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">minmasters</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">maxmasters</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">disable_ssl</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace_graceful_disable_duration</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1800</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">upgrade_precheck_timeout</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">300</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># force_upgrade_clusters:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">force_version_for_enable</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1\.18\..*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">logging_fluentbit_enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># logging_fluentbit_rsyslog: &quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">csisetting</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token key atrule" style="color:#00a4db">csi_enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">hdcsconfig</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">ovf_url</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;file:///storage/lifecycle/vmware-hdcs&#x27;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>vCenter UI사용을 위해 <a href="https://github.com/lamw/vsphere-with-tanzu-homelab-scripts/blob/master/setup_vcsa.ps1" target="_blank" rel="noopener noreferrer"><code>setup_vcsa.ps1</code></a> 스크립트를 수정한다.  </p><div class="codeBlockContainer_I0IT language-powershell theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-powershell codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">.\setup_vcsa.ps1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Connect-VIServer: C:\esxi\vsphere-with-tanzu-homelab-scripts\setup_vcsa.ps1:17</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Line |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  17 |  $vc = Connect-VIServer $VCSAHostname -User $VCSAUsername -Password $V …</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     |        ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     | 2020-11-30 오전 12:45:18 Connect-VIServer  The SSL connection could not be established,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     | see inner exception.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>위와 같이 SSL connection 에러가 발생하기 때문에 인증서 체크를 무시하는 설정을 먼서 한다. </p><div class="codeBlockContainer_I0IT language-powershell theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-powershell codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">Set-PowerCLIConfiguration -InvalidCertificateAction:Ignore</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p><code>$VCSAPassword</code>, <code>$DatastoreName</code>, <code>$ESXiPassword</code> 등을 수정하고 스크립트를 실행한다.</p><div class="codeBlockContainer_I0IT language-powershell theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-powershell codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">PS C:\esxi\vsphere-with-tanzu-homelab-scripts&gt; .\setup_vcsa.ps1</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>설치가 완료되면 신규UI로 접속이 가능해진다. 이제부터는 VCSA로 직접 접속이 가능하다.<br>
<!-- -->기본 로그인 아이디는 <code>administrator@vsphere.local</code>로 <code>vcsa.tanzu.local.json</code> 에서 설정한 패스워드로 접속하면 vCenter 기반의 Client UI를 확인할 수 있다. 정상적으로 클러스터에 연결된 ESXi 호스트 정보를 확인할 수 있다.  </p><p><img loading="lazy" alt="VCSA" src="/assets/images/vcsa_home-4abc614139248554017057d16eaf1911.png" width="1007" height="460" class="img_E7b_"></p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="정리">정리<a class="hash-link" href="#정리" title="Direct link to heading">​</a></h2><p>일단 아주 작은 하드웨어로 가성비 좋은 클러스터를 구축할 수 있는 PN50으로 Tanzu 클러스터 구성을 하기 위한 기초작업이 완료되었다.  </p><p>글이 길어지는 관계로 VDS(vSphere Distributed Switch)를 구성하는 이후 부분은 다음 포스팅에서 계속 이어나갈 예정이다. </p><blockquote><p>다음글 - <a href="https://ddii.dev/kubernetes/vSphere-with-Tanzu-homelab-2/" target="_blank" rel="noopener noreferrer">vSphere with Tanzu homelab running on ASUS PN50 (2/2)</a></p></blockquote></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_h6_j"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/kubernetes">Kubernetes</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/tanzu">Tanzu</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/v-sphere">vSphere</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/homelab">Homelab</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/asus">ASUS</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/pn-50">PN50</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/ddiiwoong/newblog/tree/main/blog/2020-11-30-vSphere-with-Tanzu-homelab.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><div></div><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/kubernetes/vSphere-with-Tanzu-homelab-2"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">vSphere with Tanzu homelab running on ASUS PN50 (2/2)</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/retrospective/2020plan"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">2019 Retrospective</div></a></div></nav></main><div class="col col--2"><div class="tableOfContents_cNA8 thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#tanzu" class="table-of-contents__link toc-highlight">Tanzu</a></li><li><a href="#준비사항hardware" class="table-of-contents__link toc-highlight">준비사항(Hardware)</a></li><li><a href="#준비사항software" class="table-of-contents__link toc-highlight">준비사항(Software)</a></li><li><a href="#최종-예상-구성요소" class="table-of-contents__link toc-highlight">최종 예상 구성요소</a></li><li><a href="#esxi-설치" class="table-of-contents__link toc-highlight">ESXi 설치</a><ul><li><a href="#esxi-다운로드" class="table-of-contents__link toc-highlight">ESXi 다운로드</a></li><li><a href="#usb-network-native-driver-for-esxi" class="table-of-contents__link toc-highlight">USB Network Native Driver for ESXi</a></li><li><a href="#powershell-710-설치" class="table-of-contents__link toc-highlight">PowerShell 7.1.0 설치</a></li><li><a href="#powercli-준비" class="table-of-contents__link toc-highlight">PowerCLI 준비</a></li><li><a href="#image-profile-확인" class="table-of-contents__link toc-highlight">Image Profile 확인</a></li><li><a href="#esxi-설치-이미지-제작" class="table-of-contents__link toc-highlight">ESXi 설치 이미지 제작</a></li><li><a href="#부팅-및-설치" class="table-of-contents__link toc-highlight">부팅 및 설치</a></li><li><a href="#vsphere-web-client-접속" class="table-of-contents__link toc-highlight">vSphere Web Client 접속</a></li></ul></li><li><a href="#router-설치-및-환경-구성" class="table-of-contents__link toc-highlight">Router 설치 및 환경 구성</a><ul><li><a href="#router-설치" class="table-of-contents__link toc-highlight">Router 설치</a></li><li><a href="#router-환경-구성" class="table-of-contents__link toc-highlight">Router 환경 구성</a></li><li><a href="#vcsavcenter-server-appliance-배포-및-구성" class="table-of-contents__link toc-highlight">VCSA(vCenter Server Appliance) 배포 및 구성</a></li><li><a href="#vcsa-설정-변경" class="table-of-contents__link toc-highlight">VCSA 설정 변경</a></li></ul></li><li><a href="#정리" class="table-of-contents__link toc-highlight">정리</a></li></ul></div></div></div></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Blog</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/">Home</a></li><li class="footer__item"><a class="footer__link-item" href="/archive">Archive</a></li><li class="footer__item"><a class="footer__link-item" href="/tags">Tags</a></li></ul></div><div class="col footer__col"><div class="footer__title">Sponsors</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/pang4u">Pang4U</a></li><li class="footer__item"><a href="https://ko-fi.com/ddiiwoong" target="_blank" rel="noopener noreferrer" class="footer__link-item">Buy Me a Coffee<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/ddiiwoong" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/ddiiwoong" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.facebook.com/ddiiwoong" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://kr.linkedin.com/in/ddiiwoong" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div></div></footer></div>
<script src="/assets/js/runtime~main.62ad1f5f.js"></script>
<script src="/assets/js/main.43a59d48.js"></script>
</body>
</html>