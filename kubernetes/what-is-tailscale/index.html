<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.18">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="Act as a catalyst RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Act as a catalyst Atom Feed">
<link rel="alternate" type="application/json" href="/feed.json" title="Act as a catalyst JSON Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","G-4ZT898XDT2","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-4ZT898XDT2"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-4ZT898XDT2",{anonymize_ip:!0})</script>
<link rel="search" type="application/opensearchdescription+xml" title="Cloud Catalyst" href="/opensearch.xml">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4362752107119680" crossorigin="anonymous"></script><title data-rh="true">What is Tailscale? | Cloud Catalyst</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://ddii.dev/kubernetes/what-is-tailscale/"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" name="naver-site-verification" content="cbcc03783e5594725d3951f4e7f16ede80e69881"><meta data-rh="true" property="og:title" content="What is Tailscale? | Cloud Catalyst"><meta data-rh="true" name="description" content="wireguard와 tailscale을 비교하고 kubernetes 환경에서 활용방안 검토"><meta data-rh="true" property="og:description" content="wireguard와 tailscale을 비교하고 kubernetes 환경에서 활용방안 검토"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2022-02-05T00:00:00.000Z"><meta data-rh="true" property="article:tag" content="Kubernetes,wireguard,tailscale,vpn,network"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://ddii.dev/kubernetes/what-is-tailscale/"><link data-rh="true" rel="alternate" href="https://ddii.dev/kubernetes/what-is-tailscale/" hreflang="en"><link data-rh="true" rel="alternate" href="https://ddii.dev/kubernetes/what-is-tailscale/" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://UTLA0DRN66-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.1e7a31ee.css">
<link rel="preload" href="/assets/js/runtime~main.b55c82e1.js" as="script">
<link rel="preload" href="/assets/js/main.17aa71ed.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top navbarHideable_ObN2"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo-catalyst.svg" alt="Cloud Catalyst" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/logo-catalyst.svg" alt="Cloud Catalyst" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">Cloud Catalyst</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/">Posts</a><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" docid="introduction" href="/docs/prometheus/introduction/">Docs</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/prometheus/introduction/">Prometheus</a></li></ul></div></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/tags/">Tags</a><a class="navbar__item navbar__link" href="/presentation/">Presentation</a><a class="navbar__item navbar__link" href="/archive/">Archive</a><a class="navbar__item navbar__link" href="/about/">About</a><a class="navbar__item navbar__link" href="/pang4u/">Pang4u</a><a href="https://github.com/ddiiwoong/newblog" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_S7eR colorModeToggle_vKtC"><button class="clean-btn toggleButton_rCf9 toggleButtonDisabled_Pu9x" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_v35p"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_nQuB"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_qEbK"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_a9qW thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_uKok margin-bottom--md">Recent Posts</div><ul class="sidebarItemList_Kvuv"><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kubernetes/kops-cloud9/">kOps with Cloud9</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kubernetes/kops-cilium/">kOps with Cilium</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kubernetes/eks-cni-custom/">EKS CNI Custom Networking</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kubernetes/eks-anywhere-adv/">EKS Anywhere Advanced Usages</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kubernetes/eks-anywhere/">EKS Anywhere on vSphere Homelab</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_rzP5" itemprop="headline">What is Tailscale?</h1><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2022-02-05T00:00:00.000Z" itemprop="datePublished">February 5, 2022</time> · <!-- -->29 min read</div></header><div id="post-content" class="markdown" itemprop="articleBody"><blockquote><p>해당 포스팅은 현재 재직중인 회사에 관련이 없고, 개인 역량 개발을 위한 자료로 활용할 예정입니다.</p></blockquote><p>이직을 하고 블로그에 손을 놓고 있다가 페이스북 <a href="https://ko-kr.facebook.com/groups/" target="_blank" rel="noopener noreferrer">Kubernetes Korea Group</a>에 올라온 <a href="https://gasidaseo.notion.site/c9cd413265ea4ea1b1ae38eb36dfda94" target="_blank" rel="noopener noreferrer">쿠버네티스 네트워킹 스터디 모집 공고</a>를 보게되었다. 이직후에 대부분의 프로젝트가 쿠버네티스 기반으로 진행되다 보니 네트워크 전문가 이신 <a href="https://www.facebook.com/jongho.seo.5811" target="_blank" rel="noopener noreferrer">가시다</a>님의 <a href="https://cloudneta.github.io/" target="_blank" rel="noopener noreferrer">팀 블로그</a>나 이나 여러 양질의 게시글들을 참고만 하다가 조금더 깊이 학습을 하고 싶어 스터디를 신청했고, 간단한 면접(??)후에 정식으로 스터디에 참여하게 되었다.  </p><p>본론으로 돌아가서 calico 스터디를 진행하다가 <a href="https://www.wireguard.com/" target="_blank" rel="noopener noreferrer">wireguard</a>라는 opensource vpn을 알게 되었고 해당 패키지를 이것저것 테스트하다가 기존에 사용중인 <a href="https://tailscale.com/" target="_blank" rel="noopener noreferrer">tailscale</a> 과 유사하다는 것을 인지하고 내부 구성을 조금 찾아보기로 했다.  </p><p>확인해보니 tailscale은 wireguard 기반으로 하는 동일 기술의 상용 솔루션이였고, 이에 몇가지 공부차 정리를 위해 해당 포스트를 작성하게 되었다. </p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="wireguard">Wireguard<a class="hash-link" href="#wireguard" title="Direct link to heading">​</a></h2><ul><li><a href="https://www.wireguard.com/" target="_blank" rel="noopener noreferrer">https://www.wireguard.com/</a></li></ul><p>먼저 WireGuard를 간단하게 정의하면 보안에 초점을 두고 단순함과 쉬운 사용을 대표적인 특징으로 내세우는 오픈소스 기반 VPN 소프트웨어로 IPsec과 OpenVPN보다 사용하기 용이하고 가벼운 것을 강점으로 <a href="https://lore.kernel.org/wireguard/CAHmME9qOpDeraWo5rM31EWQW574KEduRBTL-+0A2ZyqBNDeYkg@mail.gmail.com/T/#u" target="_blank" rel="noopener noreferrer">Linux 5.6 커널 이후부터 기본 패키지</a>로 탑재가 되었다. 제이슨 도넨필드(Jason Donenfeld, <a href="https://twitter.com/zx2c4" target="_blank" rel="noopener noreferrer">@zx2c4</a>)가 설계한 WireGuard는 암호화 민첩성, 즉 다양한 암호화, 키 교환, 해싱 알고리즘에 대한 선택권을 제공한다는 개념을 버리고 아주 간결한 코드 구조를 통해 커널에서 직접 동작하고 주요 암호 알고리즘에 대해서 병렬처리하므로 빠른 속도를 자랑한다.  </p><p>홈페이지에 게시된 몇가지 특징을 정리하면 </p><ul><li>Simple &amp; Easy-to-use : SSH 처럼 키교환 방식으로 진행되고 WireGuard에 의해 관리되기 때문에 쉽게 사용이 가능하고, IP가 변경되는 모바일 로밍중에서 연결이 보장되는 것이 특징이다. </li><li>Cryptographically Sound : <a href="http://www.noiseprotocol.org/" target="_blank" rel="noopener noreferrer">Noise protocol framework</a>, <a href="http://cr.yp.to/ecdh.html" target="_blank" rel="noopener noreferrer">Curve25519</a>, <a href="http://cr.yp.to/chacha.html" target="_blank" rel="noopener noreferrer">ChaCha20</a>, <a href="http://cr.yp.to/mac.html" target="_blank" rel="noopener noreferrer">Poly1305</a>, <a href="https://blake2.net/" target="_blank" rel="noopener noreferrer">BLAKE2</a>, <a href="https://131002.net/siphash/" target="_blank" rel="noopener noreferrer">SipHash24</a>, <a href="https://eprint.iacr.org/2010/264" target="_blank" rel="noopener noreferrer">HKDF</a> 와 같은 가장 빠르고 최신의 암호, 해시 알고리즘을 사용한다.  </li><li>Minimal Attack Surface : WireGuard는 구현 용이성과 단순성을 염두에 두고 설계되었다. 매우 적은 코드 라인으로 구현되서 보안 취약점에 대해 쉽게 감사할 수 있다. 그만큼 철저히 검증될 가능성이 높고, 예상치 못한 곳에서의 버그로 인한 취약점이 발생할 가능성이 상대적으로 적다는 얘기가 된다.  </li><li>High Performance : 모든 것이 kernel에서 동작하고 안전한 네트워킹이 매우 빠른 속도 로 동작하기 때문에 스마트폰과 백본 라우터와 같은 작은 임베디드 장치 등 모두에 적합하다.  </li><li>Well Defined &amp; Thoroughly Considered : Wireguard는 <a href="https://www.wireguard.com/papers/wireguard.pdf" target="_blank" rel="noopener noreferrer">백서</a>가 발행될 정도로 기술적으로 여러가지 고려사항들을 명확하게 정의해놨다.</li></ul><p>관련한 자세한 내용은 <a href="https://www.wireguard.com/papers/wireguard.pdf" target="_blank" rel="noopener noreferrer">백서</a> 를 참고한다.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="wireguard-in-calico-cni">Wireguard in Calico CNI<a class="hash-link" href="#wireguard-in-calico-cni" title="Direct link to heading">​</a></h3><p>스터디를 진행할때는 쿠버네티스 파드와 파드 사이의 패킷을 네트워크 레벨로 암호화 하는 도구로 Calico에 내장된 WireGuard 플러그인을 사용해서 파드간 터널을 설정하고 트래픽을 암호화 하는 테스트를 진행하게 되었다. Calico CNI에서 구성하는 방법은 <code>calicoctl</code>를 사용해서 설정하기 때문에 간단하다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ calicoctl patch felixconfiguration default --type=&#x27;merge&#x27; -p &#x27;{&quot;spec&quot;:{&quot;wireguardEnabled&quot;:true}}&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ calicoctl get felixconfiguration default -o yaml | grep wireguardEnabled</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  wireguardEnabled: true</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>파드간의 ping test를 진행하고 난 이후 파드 레벨에서 패킷 덤프한 내용을 wireshark로 확인한 내용이다. 그림에서처럼 icmp 패킷은 확인이 안되고 udp와 wireguard 프로토콜을 통해 데이터가 암호화 된것을 확인할 수 있다.</p><p><img loading="lazy" alt="wg" src="/assets/images/wg-9118a771c7d571be3495eeef652b7e06.png" width="1002" height="575" class="img_E7b_"></p><p>이번 포스팅에서는 tailscale 활용방안을 소개하는 것으로 간단하게 calico를 통해 wireguard 설정하는 것은 넘어간다. 다른 좋은 내용들은 다음 링크들에서 확인할 수 있다.  </p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="참고자료">참고자료<a class="hash-link" href="#참고자료" title="Direct link to heading">​</a></h3><ul><li><a href="https://tech.devsisters.com/posts/wireguard-vpn-1/" target="_blank" rel="noopener noreferrer">WireGuard로 멋진 VPN 서버 구축하기 - devsisters</a></li><li><a href="https://slowbootkernelhacks.blogspot.com/2020/09/wireguard-vpn.html" target="_blank" rel="noopener noreferrer">WireGuard VPN 해부 - Slowboot</a></li><li><a href="https://github.com/squat/kilo" target="_blank" rel="noopener noreferrer">Kilo - multi-cloud k8s network overlay built on WireGuard</a></li><li><a href="https://git.zx2c4.com/wireguard-go/about/" target="_blank" rel="noopener noreferrer">Go implementation of WireGuard</a></li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="tailscale">Tailscale<a class="hash-link" href="#tailscale" title="Direct link to heading">​</a></h2><ul><li><a href="https://tailscale.com/" target="_blank" rel="noopener noreferrer">https://tailscale.com/</a></li></ul><p>TailScale은 서버, 컴퓨터 및 클라우드 인스턴스간에 보안 네트워크를 만드는 VPN으로 Wireguard 프로토콜을 사용해서 만든 클라우드 서비스이다. Tailscale이 어떻게 동작하는지는 <a href="https://tailscale.com/blog/how-tailscale-works/" target="_blank" rel="noopener noreferrer">공식 블로그</a>에서 간단히 확인할 수 있다. </p><p>간단하게 블로그 내용을 정리해보면 기존의 VPN 방식은 Hub-and-spoke 방식으로 아래 그림과 같이 Gateway 방식으로 모든 클라이언트와 서버를 연결하는게 기존의 방식이다. 새로운 클라이언트나 서버가 추가될 경우 새로운 키를 모든 사용자에게 배포하게 되고 이는 장비가 증가함에 따라 많은 작업이 필요로 하게 된다.</p><p><img loading="lazy" src="https://tailscale.com/blog/how-tailscale-works/hub-and-spoke-single.svg" alt="hub" class="img_E7b_"></p><p>Wireguard 터널을 이용하면 노드간의 연결이 직접 이뤄지게 되고 이는 아래 그림과 같이 메쉬 형태로 구성되게 된다. </p><p><img loading="lazy" src="https://tailscale.com/blog/how-tailscale-works/mesh-network.svg" alt="mesh" class="img_E7b_"></p><p>이런 메쉬방식의 가장 큰 단점은 피어끼리 연결하는 노드 네트워크의 경우 연결되는 경우의 수가 <code>n(n-1)</code>으로 그림의 예시에서도 10*9 = 90개의 연결 구성이 필요하게 된다. 모든 노드가 해당 사항으로 Wireguard의 key를 로테이트하거나 사용자를 추가, 제거할때마다 각 노드에 업데이트가 되어야 한다. 만약에라도 각 노드에 static ip가 없을 경우 노드끼리 찾는일이 결고 쉽지는 않을 것이다. 특히 방화벽을 운영하는 엔터프라이즈 조직의 경우에 더욱더 까다로운 일이 된다고 말한다.</p><p>그래서 Tailscale에서 이야기하는 가장 핵심은 노드 간의 트래픽을 감사, 통제할 수 있는 컨트롤 플레인을 두는것이다. 방화벽이나 static ip가 없는 환경에서도 노드, 피어간의 통제가 가능한 환경을 제공하는 것이 기본 사상이다. </p><p><img loading="lazy" src="https://tailscale.com/blog/how-tailscale-works/mesh-coordination-server.svg" alt="controlplane" class="img_E7b_"></p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="기본-작동방식">기본 작동방식<a class="hash-link" href="#기본-작동방식" title="Direct link to heading">​</a></h3><ul><li>각 노드(클라이언트)는 랜덤 공개키와 개인키를 생성하고 공개키를 ID(tailscale account)와 연결한다.</li><li>노드는 중앙의 tailscale서버에 공개키와 해당 노드가 현재 연결가능한지와 도메인 정보(client name) 정보를 전달한다. </li><li>노드는 tailscale서버 업데이트된 도메인의 공개키 및 주소 목록을 다운로드 한다.</li><li>노드는 내려받은 공개 키 세트로 Wireguard 인스턴스를 구성한다.</li></ul><p>이는 다시 hub-and-spoke 모델로 돌아간것 같지만 실제 컨트롤 플레인과 데이터 플레인을 분리해서 처리하기 때문에 실제 중앙 서버가 관리하는 것은 공개키 세트와 연결가능한 노드 리스트 정보뿐이다.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="tailscale-테스트">Tailscale 테스트<a class="hash-link" href="#tailscale-테스트" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="talescale-설치-macos-기준">talescale 설치 (macOS 기준)<a class="hash-link" href="#talescale-설치-macos-기준" title="Direct link to heading">​</a></h3><ul><li><a href="https://tailscale.com/download" target="_blank" rel="noopener noreferrer">https://tailscale.com/download</a></li></ul><p>macOS용 CLI 설치 정보는 아래 링크에서 확인할 수 있다. </p><ul><li><a href="https://tailscale.com/kb/1065/macos-variants/" target="_blank" rel="noopener noreferrer">https://tailscale.com/kb/1065/macos-variants/</a></li></ul><p>macOS용 GUI 클라이언트에 CLI도 내장되어 있기 때문에 <code>.zshrc</code>에 alias를 추가했다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">alias tailscale=&quot;/Applications/Tailscale.app/Contents/MacOS/Tailscale&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>2022년 2월 5일자 기준으로 1.20.2 버전을 사용한다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ tailscale version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1.20.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tailscale commit: 312750ddd288cf4073cfaef56a45102b9c1e8421</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  other commit: 2c164d9c7443e2f3014fa54ea45e946b35152680</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  go version: go1.17.6-tse44d304e54</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>windows에서도 쉽게 설치가 가능하고, 물론 애정하는 Synology에도 패키지를 설치할 수 있다. </p><p><a href="https://github.com/tailscale/tailscale-synology" target="_blank" rel="noopener noreferrer">https://github.com/tailscale/tailscale-synology</a></p><p>설치된 클라이언트 모두를 tailscale 계정으로 로그인하면 VPN연결이 끝난다. </p><p>연결된 머신리스트는 아래와 같이 <a href="https://login.tailscale.com/admin/machines" target="_blank" rel="noopener noreferrer">Machines</a> 메뉴 에서 확인할 수 있고 각 노드나 클라이언트로 할당된 <code>100.*</code> 대역 IP로 접속이 가능하다. </p><p><img loading="lazy" alt="machine" src="/assets/images/tailscale-web-3a41c37cafdc8bbc9c7868e3dfe96040.png" width="948" height="1024" class="img_E7b_"></p><p>여기서 machine name으로 직접 접속이 가능하기 위해서는 MagicDNS 기능을 사용해야 하는데 <code>beta</code> 기능으로 <a href="https://login.tailscale.com/admin/dns" target="_blank" rel="noopener noreferrer">활성화</a>를 할 수 있고 네트워크에 있는 장치의 DNS 이름을 자동으로 등록하는 기능이다.</p><ul><li>DNS 설정가이드 : <a href="https://tailscale.com/kb/1081/magicdns/" target="_blank" rel="noopener noreferrer">https://tailscale.com/kb/1081/magicdns/</a></li></ul><p>CLI로 현재 연결된 client 정보나 publickey 등을 확인할 수 있다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ tailscale status</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">100.89.226.113  88665a4a51c4         ddiiwoong@   macOS   -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">100.76.233.116  jinwoonuimbp141      ddiiwoong@   macOS   offline</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">100.95.209.95   proxy                ddiiwoong@   linux   -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">100.106.65.5    win11                ddiiwoong@   windows -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ tailscale status --json | jq &#x27;.Self.PublicKey&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;nodekey:97c4dc44ecdf56******************adb3246d87fd9e270&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>DNS 등록 방식은 아래와 같이 구성되고</p><p><img loading="lazy" src="https://tailscale.com/kb/1081/magicdns/magic-dns-naming.png" alt="magicdns" class="img_E7b_"></p><p>내가 등록한 머신리스트에서 win11 은 다음 정보로 도메인이 등록된다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">win11.ddiiwoong.gmail.com.beta.tailscale.net</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>두가지 방식으로 해당 머신에 ping check를 할 수 있다.</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ ping win11</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PING win11.ddiiwoong.gmail.com.beta.tailscale.net (100.106.65.5): 56 data bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">64 bytes from 100.106.65.5: icmp_seq=0 ttl=128 time=124.031 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">64 bytes from 100.106.65.5: icmp_seq=1 ttl=128 time=2.180 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">64 bytes from 100.106.65.5: icmp_seq=2 ttl=128 time=2.776 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ ping win11.ddiiwoong.gmail.com.beta.tailscale.net</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PING win11.ddiiwoong.gmail.com.beta.tailscale.net (100.106.65.5): 56 data bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">64 bytes from 100.106.65.5: icmp_seq=0 ttl=128 time=5.086 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">64 bytes from 100.106.65.5: icmp_seq=1 ttl=128 time=2.060 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">64 bytes from 100.106.65.5: icmp_seq=2 ttl=128 time=2.213 ms</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="kubernetes-환경구성">kubernetes 환경구성<a class="hash-link" href="#kubernetes-환경구성" title="Direct link to heading">​</a></h3><p>kubernetes 리소스로 tailscale을 구성을 해보자. 먼저 <code>1.16</code> 버전 이상의 kubernetes 클러스터를 준비한다. 아래 구성환경은 <code>1.21.5</code> 버전으로 eksctl로 설치한 기본 EKS 클러스터이다. </p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get node</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                                 STATUS   ROLES    AGE   VERSION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ip-192-168-101-195.ap-northeast-2.compute.internal   Ready    &lt;none&gt;   19h   v1.21.5-eks-9017834</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ip-192-168-134-35.ap-northeast-2.compute.internal    Ready    &lt;none&gt;   19h   v1.21.5-eks-9017834</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ip-192-168-186-235.ap-northeast-2.compute.internal   Ready    &lt;none&gt;   19h   v1.21.5-eks-9017834</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="authkey-발급-및-secret-등록">authKey 발급 및 Secret 등록<a class="hash-link" href="#authkey-발급-및-secret-등록" title="Direct link to heading">​</a></h3><p>authKey는 tailscale 네트워크에 등록하기 위한 Key로 아래와 같이 관리를 Web에서 할 수 있다.</p><p><img loading="lazy" alt="key" src="/assets/images/tailscale-key-7bc957707fe91c3c4465cb95ad0af640.png" width="1119" height="700" class="img_E7b_"></p><p><a href="https://login.tailscale.com/admin/settings/keys" target="_blank" rel="noopener noreferrer">Keys</a> 메뉴로 이동해서 auth Key를 발급받는다. 발급을 할때 여러머신에서 사용할 경우는 <code>Reusable</code>, 임시로 키를 사용할때는 <code>Ephemeral</code> 옵션을 사용할 수도 있다. 아래와 같은 형식으로 발급되고, 해당 key는 kubernetes <code>Secret</code> 리소스에 등록을 해서 사용할 것이다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">tskey-kZAinb5CNTRL-********************</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>해당 auth Key를 Secret으로 생성한다.</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> tailscale</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">auth</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">stringData</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">AUTH_KEY</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> tskey</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">kZAinb5CNTRL</span><span class="token punctuation" style="color:#393A34">-</span><span class="token important">********************</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get secret -n tailscale</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                    TYPE                                  DATA   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">default-token-fww2j     kubernetes.io/service-account-token   3      18h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tailscale-auth          Opaque                                3      18h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tailscale-token-7cgsc   kubernetes.io/service-account-token   3      17h</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="image-build--push">image build &amp; push<a class="hash-link" href="#image-build--push" title="Direct link to heading">​</a></h3><p>tailscale image를 빌드한다. 자세한 내용은 아래 링크를 참고한다.  </p><ul><li><a href="https://github.com/tailscale/tailscale/tree/main/docs/k8s" target="_blank" rel="noopener noreferrer">https://github.com/tailscale/tailscale/tree/main/docs/k8s</a></li></ul><p>Dockerfile은 다음과 같이 공식 이미지를 사용한다. </p><div class="codeBlockContainer_I0IT language-dockerfile theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-dockerfile codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">FROM ghcr.io/tailscale/tailscale:latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">COPY run.sh /run.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CMD &quot;/run.sh&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p><a href="https://github.com/tailscale/tailscale/blob/main/docs/k8s/run.sh" target="_blank" rel="noopener noreferrer">run.sh</a>을 살펴보면 <code>tailscaled</code> 데몬을 실행할때 몇가지 환경변수를 입력받아 처리하는 것을 알 수 있다. </p><p><code>AUTH_KEY</code>와 <code>KUBE_SECRET</code>은 위 Secret으로 처리를 하고 여러 사용 모드(router, userspace)도 컨테이너 실행시 입력받아 처리한다. 또한, 마지막 구문을 보면 목적지 IP DNAT 처리를 위한 iptables 등록 옵션도 있다.</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">#! /bin/sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export PATH=$PATH:/tailscale/bin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AUTH_KEY=&quot;${AUTH_KEY:-}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ROUTES=&quot;${ROUTES:-}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DEST_IP=&quot;${DEST_IP:-}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EXTRA_ARGS=&quot;${EXTRA_ARGS:-}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">USERSPACE=&quot;${USERSPACE:-true}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">KUBE_SECRET=&quot;${KUBE_SECRET:-tailscale}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set -e</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TAILSCALED_ARGS=&quot;--state=kube:${KUBE_SECRET} --socket=/tmp/tailscaled.sock&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if [[ &quot;${USERSPACE}&quot; == &quot;true&quot; ]]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if [[ ! -z &quot;${DEST_IP}&quot; ]]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    echo &quot;IP forwarding is not supported in userspace mode&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    exit 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  TAILSCALED_ARGS=&quot;${TAILSCALED_ARGS} --tun=userspace-networking&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if [[ ! -d /dev/net ]]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mkdir -p /dev/net</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if [[ ! -c /dev/net/tun ]]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mknod /dev/net/tun c 10 200</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;Starting tailscaled&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tailscaled ${TAILSCALED_ARGS} &amp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PID=$!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">UP_ARGS=&quot;--accept-dns=false&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if [[ ! -z &quot;${ROUTES}&quot; ]]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  UP_ARGS=&quot;--advertise-routes=${ROUTES} ${UP_ARGS}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if [[ ! -z &quot;${AUTH_KEY}&quot; ]]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  UP_ARGS=&quot;--authkey=${AUTH_KEY} ${UP_ARGS}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if [[ ! -z &quot;${EXTRA_ARGS}&quot; ]]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  UP_ARGS=&quot;${UP_ARGS} ${EXTRA_ARGS:-}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;Running tailscale up&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tailscale --socket=/tmp/tailscaled.sock up ${UP_ARGS}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if [[ ! -z &quot;${DEST_IP}&quot; ]]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  echo &quot;Adding iptables rule for DNAT&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  iptables -t nat -I PREROUTING -d &quot;$(tailscale --socket=/tmp/tailscaled.sock ip -4)&quot; -j DNAT --to-destination &quot;${DEST_IP}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wait ${PID}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>build하고 레지스트리로 push 하자.</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ export IMAGE_TAG=ddiiwoong/tailscale-k8s:latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ docker build . -t $(IMAGE_TAG)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ docker push $(IMAGE_TAG)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ docker images ddiiwoong/tailscale-k8s:latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">REPOSITORY            TAG       IMAGE ID       CREATED        SIZE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ddiiwoong/tailscale-k8s   latest    9dc489da64c4   18 hours ago   44.1MB</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="rbac-리소스-생성">RBAC 리소스 생성<a class="hash-link" href="#rbac-리소스-생성" title="Direct link to heading">​</a></h3><p>rbac 설정을 위해서 <code>role</code>, <code>rolebinding</code>, <code>serviceaccount</code>를 생성한다.</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">export SA_NAME=tailscale</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export KUBE_SECRET=tailscale-auth</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>위 ENV값을 치환해서 생성한다.</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ServiceAccount</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> tailscale</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> rbac.authorization.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Role</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> tailscale</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">rules</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">apiGroups</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># &quot;&quot; indicates the core API group</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">resources</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;secrets&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Create can not be restricted to a resource name.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">verbs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;create&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">apiGroups</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># &quot;&quot; indicates the core API group</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">resourceNames</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;tailscale-auth&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">resources</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;secrets&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">verbs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;get&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;update&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> rbac.authorization.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> RoleBinding</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> tailscale</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">subjects</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ServiceAccount</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> tailscale</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">roleRef</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Role</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> tailscale</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">apiGroup</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> rbac.authorization.k8s.io</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="sidecar-배포">sidecar 배포<a class="hash-link" href="#sidecar-배포" title="Direct link to heading">​</a></h3><p>sidecar 생성을 위해 manifest를 확인한다. 자세히 살펴보면 <code>ts-sidecar</code> 컨테이너 securityContext에 <code>NET_ADMIN</code> 권한이 추가된것을 볼수 있다. 이는 sidecar 파드가 터널 인터페이스를 구성하기 위해 상위 노드 <code>CAP_NET_ADMIN</code> 권한을 취득하기 위함이다. 자세한 내용은 <a href="https://kubernetes.io/docs/tasks/configure-pod-container/security-context/#set-capabilities-for-a-container" target="_blank" rel="noopener noreferrer">Set capabilities for a Container</a> 문서를 확인하자. </p><p>그리고 추가 sidecar로 <code>nicolaka/netshoot</code>를 추가했는데 이는 <a href="https://github.com/nicolaka/netshoot" target="_blank" rel="noopener noreferrer">네트워크 장애 처리에 유용한 프로젝트</a>로 여러가지 네트워크 정보를 확인할 수 있다.</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">serviceAccountName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> tailscale</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">containers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> netshoot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> nicolaka/netshoot </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">command</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;tail&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">args</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;-f&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;/dev/null&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ts</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">sidecar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">imagePullPolicy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Always</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ddiiwoong/tailscale</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">k8s</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">env</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># Store the state in a k8s secret</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> KUBE_SECRET</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> tailscale</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">auth</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> USERSPACE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;false&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> AUTH_KEY</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">valueFrom</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">secretKeyRef</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> tailscale</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">auth</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> AUTH_KEY</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">optional</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">securityContext</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">capabilities</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">add</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> NET_ADMIN</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>생성을 하고 살펴보면 sidecar nginx 파드가 생성된 것을 확인할 수 있다.</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pod nginx -n tailscale</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME    READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nginx   3/3     Running   0          25s</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>tailscale sidecar 로그를 잠깐 살펴보자. 새로운 <code>tailscale0</code> tun 인터페이스가 추가되고 원래 pod eth0 인터페이스 ip도 확인이 된다. 또한 <code>wireguard</code> device도 올라오는 것을 확인할 수 있다. </p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl logs nginx ts-sidecar -n tailscale</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Starting tailscaled</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Running tailscale up</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022/02/05 12:20:26 logtail started</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022/02/05 12:20:26 Program starting: v1.20.2-t8e643357d, Go 1.17.6-tse44d304e54: []string{&quot;tailscaled&quot;, &quot;--state=kube:tailscale-auth&quot;, &quot;--socket=/tmp/tailscaled.sock&quot;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022/02/05 12:20:26 LogID: 31416c9a454e3667661bf0f21ccde8ebf72604d7434660b0db55e838be372bc4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022/02/05 12:20:26 logpolicy: using system state directory &quot;/var/lib/tailscale&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">logpolicy.Read /var/lib/tailscale/tailscaled.log.conf: open /var/lib/tailscale/tailscaled.log.conf: no such file or directory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022/02/05 12:20:26 wgengine.NewUserspaceEngine(tun &quot;tailscale0&quot;) ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022/02/05 12:20:26 router: disabling tunneled IPv6 due to system IPv6 config: disable_ipv6 is set</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022/02/05 12:20:26 dns: [rc=unknown ret=direct]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022/02/05 12:20:26 dns: using *dns.directManager</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022/02/05 12:20:26 link state: interfaces.State{defaultRoute=eth0 ifs={eth0:[192.168.118.89/32]} v4=true v6=false}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022/02/05 12:20:26 magicsock: disco key = d:1b04c57ebf000fe0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022/02/05 12:20:26 Creating wireguard device...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022/02/05 12:20:26 Bringing wireguard device up...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022/02/05 12:20:26 Bringing router up...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022/02/05 12:20:26 external route: up</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022/02/05 12:20:26 Clearing router settings...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022/02/05 12:20:26 Starting link monitor...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022/02/05 12:20:26 Engine created.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022/02/05 12:20:26 netmap packet filter: (not ready yet)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022/02/05 12:20:26 Start</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022/02/05 12:20:26 using backend prefs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022/02/05 12:20:28 active login: ddiiwoong@gmail.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022/02/05 12:20:28 netmap packet filter: 1 filters</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022/02/05 12:20:28 dns: Set: {DefaultResolvers:[] Routes:{} SearchDomains:[] Hosts:4}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022/02/05 12:20:28 dns: Resolvercfg: {Routes:{} Hosts:4 LocalDomains:[]}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022/02/05 12:20:28 dns: OScfg: {Nameservers:[] SearchDomains:[] MatchDomains:[]}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022/02/05 12:20:28 Taildrop disabled; no state directory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022/02/05 12:20:28 peerapi starting without Taildrop directory configured</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022/02/05 12:20:28 peerapi: serving on http://100.95.209.95:34980</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>netshoot 파드내에서도 <code>tailscale0</code> 인터페이스가 추가된 것을 확인할 수 있다.</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl exec -it nginx -c netshoot -- ip -c addr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    inet 127.0.0.1/8 scope host lo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       valid_lft forever preferred_lft forever</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3: eth0@if8: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 9001 qdisc noqueue state UP group default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    link/ether 6e:f8:f5:f3:47:11 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    inet 192.168.118.89/32 scope global eth0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       valid_lft forever preferred_lft forever</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4: tailscale0: &lt;POINTOPOINT,MULTICAST,NOARP,UP,LOWER_UP&gt; mtu 1280 qdisc pfifo_fast state UNKNOWN group default qlen 500</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    link/none</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    inet 100.95.209.95/32 scope global tailscale0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       valid_lft forever preferred_lft forever</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>로컬에서 <code>tailscale</code> CLI를 통해 IP정보도 동일한 것을 확인 할 수 있다.</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ tailscale status</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">100.89.226.113  88665a4a51c4         ddiiwoong@   macOS   -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">100.76.233.116  jinwoonuimbp141      ddiiwoong@   macOS   offline</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">100.95.209.95   nginx                ddiiwoong@   linux   -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">100.106.65.5    win11                ddiiwoong@   windows -</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>먼저 어떠한 kubernetes 서비스도 없는 것을 확인하고, 미리 magicdns를 구성해놨기 때문에 <code>nginx</code> 주소로 직접 통신을 시도해보자. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get svc -n A</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">No resources found in A namespace.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ ping nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PING nginx.ddiiwoong.gmail.com.beta.tailscale.net (100.95.209.95): 56 data bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">64 bytes from 100.95.209.95: icmp_seq=0 ttl=255 time=193.606 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">64 bytes from 100.95.209.95: icmp_seq=1 ttl=255 time=95.747 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">64 bytes from 100.95.209.95: icmp_seq=2 ttl=255 time=94.441 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ curl http://nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;!DOCTYPE html&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;html&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;head&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="userspace-sidecar-테스트">Userspace Sidecar 테스트<a class="hash-link" href="#userspace-sidecar-테스트" title="Direct link to heading">​</a></h3><p>userspace 모드로 실행해보자. 위와 차이점은 <code>NET_ADMIN</code> 권한을 빼고, <code>runAsUser: 1000</code>와 <code>runAsGroup: 1000</code>을 추가했다. 해당 클라이언트나 노드가 외부로 통신을 위해서는 <a href="https://tailscale.com/kb/1112/userspace-networking/" target="_blank" rel="noopener noreferrer">SOCKS5 이나 HTTP proxy 모드</a>로 실행되어야 한다. 이번 데모에서는 구성하지 않는다.</p><p>userspace 모드는 주로 서버리스 워크로드(Heroku, Google Cloud Run, AWS Lambda, Github Action)에서 활용을 할 때 좋다. 단 보안을 위해 authKey를 <code>ephemeral</code> 형태로 구성하는게 좋다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  serviceAccountName: tailscale</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - name: nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    image: nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - name: netshoot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    image: nicolaka/netshoot </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    command: [&quot;tail&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    args: [&quot;-f&quot;, &quot;/dev/null&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - name: ts-sidecar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    imagePullPolicy: Always</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    image: ddiiwoong/tailscale-k8s:latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    securityContext:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      runAsUser: 1000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      runAsGroup: 1000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    env:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - name: KUBE_SECRET</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      value: tailscale-auth</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - name: USERSPACE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      value: &quot;true&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - name: AUTH_KEY</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      valueFrom:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        secretKeyRef:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          name: tailscale-auth</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          key: AUTH_KEY</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          optional: true</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>동일하게 접속이 가능한데, userspace 모드 이기 때문에 netshoot 컨테이너로 인터페이스를 확인하면 권한이 없기 때문에 eth0 만 확인 가능하다. </p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl exec -it nginx -c netshoot -- ip -c addr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    inet 127.0.0.1/8 scope host lo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       valid_lft forever preferred_lft forever</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3: eth0@if10: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 9001 qdisc noqueue state UP group default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    link/ether 3a:c5:b6:cf:d1:bd brd ff:ff:ff:ff:ff:ff link-netnsid 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    inet 192.168.117.251/32 scope global eth0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       valid_lft forever preferred_lft forever</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="proxy-모드-테스트">Proxy 모드 테스트<a class="hash-link" href="#proxy-모드-테스트" title="Direct link to heading">​</a></h3><p>기존의 배포된 Service 리소스에 연결하는 방식이다. 미리 nginx를 띄워 놓고 ClusterIP를 확인한다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl create deployment nginx --image nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl expose deployment nginx --port 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get svc nginx -o=jsonpath=&#x27;{.spec.clusterIP}&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment.apps/nginx created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service/nginx exposed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10.100.213.92%</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Proxy 파드를 배포한다. 참고할 사항은 <code>sysctler</code> 컨테이너인데, 기본적으로 <code>net.ipv4.ip_forward</code> 플래그는 <code>Kubelet</code>에서 화이트리스트 처리가 되어 있지 않으므로 내부에서 IP Forwarding을 위해서 추가 설정이 필요하다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: proxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  serviceAccountName: tailscale</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  initContainers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - name: sysctler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    image: busybox</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    securityContext:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      privileged: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    command: [&quot;/bin/sh&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    args:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - -c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - sysctl -w net.ipv4.ip_forward=1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    resources:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      requests:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cpu: 1m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        memory: 1Mi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - name: tailscale</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    imagePullPolicy: Always</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    image: ddiiwoong/tailscale-k8s:latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    env:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - name: KUBE_SECRET</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      value: tailscale-auth</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - name: USERSPACE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      value: &quot;false&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - name: AUTH_KEY</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      valueFrom:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        secretKeyRef:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          name: tailscale-auth</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          key: AUTH_KEY</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          optional: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - name: DEST_IP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      value: 10.100.213.92</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    securityContext:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      capabilities:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        add:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - NET_ADMIN</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pod -n tailscale</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                     READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nginx-6799fc88d8-5g49v   1/1     Running   0          5m59s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">proxy                    1/1     Running   0          22s</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>정상적으로 배포된 proxy 컨테이너로 접속해보면 동일하게 접근이 되는 것을 확인할 수 있다.  </p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ tailscale status</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">100.89.226.113  88665a4a51c4         ddiiwoong@   macOS   -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">100.76.233.116  jinwoonuimbp141      ddiiwoong@   macOS   offline</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">100.95.209.95   proxy                ddiiwoong@   linux   idle, tx 788 rx 1452</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">100.106.65.5    win11                ddiiwoong@   windows -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ curl https://proxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;!DOCTYPE html&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;html&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;head&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="subnet-router-모드-테스트">Subnet Router 모드 테스트<a class="hash-link" href="#subnet-router-모드-테스트" title="Direct link to heading">​</a></h3><p>Tailscale에서 Subnet Router 모드를 사용하면 전체 클러스터의 subnet 대역으로 접근이 가능하다. </p><p>기본적으로 EKS API는 서비스 subnet으로 <code>10.100.0.0/16</code> 또는 <code>172.20.0.0/16</code> 을 사용한다. 배포한 eksctl로 구성한 EKS 클러스터 subnet은 3개 AZ에 19bit로 나뉘어 배포되었고 <code>192.168.96.0/19</code>, <code>192.168.128.0/19</code>, <code>192.168.160.0/19</code>으로 구성되어 있다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get node -o wide</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                                 STATUS   ROLES    AGE   VERSION               INTERNAL-IP       EXTERNAL-IP   OS-IMAGE         KERNEL-VERSION                CONTAINER-RUNTIME</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ip-192-168-101-195.ap-northeast-2.compute.internal   Ready    &lt;none&gt;   23h   v1.21.5-eks-9017834   192.168.101.195   &lt;none&gt;        Amazon Linux 2   5.4.172-90.336.amzn2.x86_64   docker://20.10.7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ip-192-168-134-35.ap-northeast-2.compute.internal    Ready    &lt;none&gt;   23h   v1.21.5-eks-9017834   192.168.134.35    &lt;none&gt;        Amazon Linux 2   5.4.172-90.336.amzn2.x86_64   docker://20.10.7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ip-192-168-186-235.ap-northeast-2.compute.internal   Ready    &lt;none&gt;   23h   v1.21.5-eks-9017834   192.168.186.235   &lt;none&gt;        Amazon Linux 2   5.4.172-90.336.amzn2.x86_64   docker://20.10.7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pod -o wide</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                     READY   STATUS    RESTARTS   AGE     IP                NODE                                                 NOMINATED NODE   READINESS GATES</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nginx-6799fc88d8-5g49v   1/1     Running   0          11m     192.168.112.183   ip-192-168-101-195.ap-northeast-2.compute.internal   &lt;none&gt;           &lt;none&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">proxy                    1/1     Running   0          5m39s   192.168.155.196   ip-192-168-134-35.ap-northeast-2.compute.internal    &lt;none&gt;           &lt;none&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get svc -o wide</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME    TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE   SELECTOR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nginx   ClusterIP   10.100.213.92   &lt;none&gt;        80/TCP    11m   app=nginx</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>해당 subnet 대역을 접속하기 위해서 서비스 대역인 <code>10.100.0.0/16</code>와 파드 대역인 <code>192.168.96.0/19</code>, <code>192.168.128.0/19</code>, <code>192.168.160.0/19</code>를 설정해서 router 모드로 tailscale을 실행하자.</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> subnet</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">router</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> tailscale</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">serviceAccountName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> tailscale</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">containers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> tailscale</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">imagePullPolicy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Always</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ddiiwoong/tailscale</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">k8s</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">env</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> KUBE_SECRET</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> tailscale</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">auth</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> USERSPACE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;true&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> AUTH_KEY</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">valueFrom</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">secretKeyRef</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> tailscale</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">auth</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> AUTH_KEY</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">optional</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ROUTES</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 10.100.0.0/16</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">192.168.96.0/19</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">192.168.128.0/19</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">192.168.160.0/19</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">securityContext</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">runAsUser</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">runAsGroup</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1000</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>배포된 router 디바이스와, 내부의 서비스에 접근하기 위해 파드와 서비스 IP를 확인한다.</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ tailscale status</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">100.89.226.113  88665a4a51c4         ddiiwoong@   macOS   -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">100.76.233.116  jinwoonuimbp141      ddiiwoong@   macOS   offline</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">100.95.209.95   subnet-router        ddiiwoong@   linux   idle, tx 1556 rx 2908</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">100.106.65.5    win11                ddiiwoong@   windows -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pod -n tailscale</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                     READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nginx-6799fc88d8-5g49v   1/1     Running   0          39m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">subnet-router            1/1     Running   0          9m47s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pod -n tailscale -o wide</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                     READY   STATUS    RESTARTS   AGE   IP                NODE                                                 NOMINATED NODE   READINESS GATES</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nginx-6799fc88d8-5g49v   1/1     Running   0          39m   192.168.112.183   ip-192-168-101-195.ap-northeast-2.compute.internal   &lt;none&gt;           &lt;none&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">subnet-router            1/1     Running   0          10m   192.168.137.188   ip-192-168-134-35.ap-northeast-2.compute.internal    &lt;none&gt;           &lt;none&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get svc -n tailscale</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME    TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nginx   ClusterIP   10.100.213.92   &lt;none&gt;        80/TCP    40m</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>바로 접속을 해보면 접속이 안된다는걸 알수 있다. <a href="https://login.tailscale.com/admin/machines" target="_blank" rel="noopener noreferrer">tailscale 서비스</a>로 이동해 route 설정에서 접근할 대역을 아래와 같이 활성화하고 curl로 접속해보면 정상적으로 접근이 된다는걸 알수 있다. 이걸로 생각해봤을 때 <code>NetworkPolicy</code> 등과 함께 설정을 하면 내부 리소스 접근 통제도 가능할 것으로 생각된다. </p><p><img loading="lazy" alt="router" src="/assets/images/subnetmode-1a9c172f146ddde3e0182a3f40eb7393.png" width="1172" height="720" class="img_E7b_"></p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ curl 192.168.112.183</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;!DOCTYPE html&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;html&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;head&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ curl 10.100.213.92</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;!DOCTYPE html&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;html&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;head&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="활용방안">활용방안<a class="hash-link" href="#활용방안" title="Direct link to heading">​</a></h2><p>기존에는 집 내부에 있는 자원 NAS나 macOS 등을 원격으로 관리하기 위한 용도였다면, 이번 테스트를 통해 기본 Personal 무료 Plan으로도 활용가능한 몇가지 유스케이스를 생각해봤다.  </p><ul><li>추가적인 VPN 구성없이 원격지 쿠버네티스 클러스터에 존재하는 애플리케이션 디버깅 및 관리 가능 (Telepresence 대체)</li><li>sidecar 모드로 활용시 Private 리소스에 대한 서비스 구성 및 IP관리 불필요 </li><li>Prometheus Service Discovry를 tailscale로 진행하여 개인 관리 디바이스 전체 모니터링</li><li>모바일 웹앱 테스트시 본인 휴대폰으로 직접 액세스 가능</li><li>현재 개인 프로젝트로 활용중인 Plex(미디어서버), 노트 앱 등을 서비스 구성없이 ACL 및 MFA 적용을 통한 보안 강화</li><li>wireguard 프로토콜을 활용하기 때문에 어디서든 끊김없이 클러스터 리소스 접근</li><li>현재 구성중인 site-to-site vpn 대체 (OCI-OCI간)</li></ul><p>더 많은 활용방안이 있을텐데 일단 생각나는 것들만 적어보았다.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="정리">정리<a class="hash-link" href="#정리" title="Direct link to heading">​</a></h2><p>이번 포스팅은 네트워크 스터디를 진행하면서 과제로 작성된 부분이 없지 않다. 정말 이번 스터디는 역대급으로 퀄리티나 여러가지면에서 좋은 점이 많다. 항상 대단하다고 느끼는 분들과 함께하고 있어서 마지막까지 완주할 수 있도록 조금 더 공부해야 겠다는 생각이 든다. 다시한번 <a href="https://www.facebook.com/jongho.seo.5811" target="_blank" rel="noopener noreferrer">가시다</a>님을 <code>shout-out</code> 하고 2022년 첫 포스팅은 이것으로 마무리한다.</p><blockquote><p>해당 포스팅은 현재 재직중인 회사에 관련이 없고, 개인 역량 개발을 위한 자료로 활용할 예정입니다.</p></blockquote></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_h6_j"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/kubernetes/">Kubernetes</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/wireguard/">wireguard</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/tailscale/">tailscale</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/vpn/">vpn</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/network/">network</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/ddiiwoong/newblog/tree/main/blog/2022-02-05-what-is-tailscale.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><div></div><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/kubernetes/eks-anywhere/"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">EKS Anywhere on vSphere Homelab</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/prometheus/synology-prometheus/"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Synology monitoring with Prometheus and snmp exporter</div></a></div></nav></main><div class="col col--2"><div class="tableOfContents_cNA8 thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#wireguard" class="table-of-contents__link toc-highlight">Wireguard</a><ul><li><a href="#wireguard-in-calico-cni" class="table-of-contents__link toc-highlight">Wireguard in Calico CNI</a></li><li><a href="#참고자료" class="table-of-contents__link toc-highlight">참고자료</a></li></ul></li><li><a href="#tailscale" class="table-of-contents__link toc-highlight">Tailscale</a><ul><li><a href="#기본-작동방식" class="table-of-contents__link toc-highlight">기본 작동방식</a></li></ul></li><li><a href="#tailscale-테스트" class="table-of-contents__link toc-highlight">Tailscale 테스트</a><ul><li><a href="#talescale-설치-macos-기준" class="table-of-contents__link toc-highlight">talescale 설치 (macOS 기준)</a></li><li><a href="#kubernetes-환경구성" class="table-of-contents__link toc-highlight">kubernetes 환경구성</a></li><li><a href="#authkey-발급-및-secret-등록" class="table-of-contents__link toc-highlight">authKey 발급 및 Secret 등록</a></li><li><a href="#image-build--push" class="table-of-contents__link toc-highlight">image build &amp; push</a></li><li><a href="#rbac-리소스-생성" class="table-of-contents__link toc-highlight">RBAC 리소스 생성</a></li><li><a href="#sidecar-배포" class="table-of-contents__link toc-highlight">sidecar 배포</a></li><li><a href="#userspace-sidecar-테스트" class="table-of-contents__link toc-highlight">Userspace Sidecar 테스트</a></li><li><a href="#proxy-모드-테스트" class="table-of-contents__link toc-highlight">Proxy 모드 테스트</a></li><li><a href="#subnet-router-모드-테스트" class="table-of-contents__link toc-highlight">Subnet Router 모드 테스트</a></li></ul></li><li><a href="#활용방안" class="table-of-contents__link toc-highlight">활용방안</a></li><li><a href="#정리" class="table-of-contents__link toc-highlight">정리</a></li></ul></div></div></div></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Blog</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/">Home</a></li><li class="footer__item"><a class="footer__link-item" href="/archive/">Archive</a></li><li class="footer__item"><a class="footer__link-item" href="/tags/">Tags</a></li></ul></div><div class="col footer__col"><div class="footer__title">Sponsors</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/pang4u/">Pang4U</a></li><li class="footer__item"><a href="https://ko-fi.com/ddiiwoong" target="_blank" rel="noopener noreferrer" class="footer__link-item">Buy Me a Coffee<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/ddiiwoong" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/ddiiwoong" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.facebook.com/ddiiwoong" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://kr.linkedin.com/in/ddiiwoong" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div></div></footer></div>
<script src="/assets/js/runtime~main.b55c82e1.js"></script>
<script src="/assets/js/main.17aa71ed.js"></script>
</body>
</html>