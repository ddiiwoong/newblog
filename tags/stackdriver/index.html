<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-tags-post-list-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.18">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="Act as a catalyst RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Act as a catalyst Atom Feed">
<link rel="alternate" type="application/json" href="/feed.json" title="Act as a catalyst JSON Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","G-4ZT898XDT2","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-4ZT898XDT2"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-4ZT898XDT2",{anonymize_ip:!0})</script>
<link rel="search" type="application/opensearchdescription+xml" title="Cloud Catalyst" href="/opensearch.xml">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4362752107119680" crossorigin="anonymous"></script><title data-rh="true">One post tagged with &quot;Stackdriver&quot; | Cloud Catalyst</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://ddii.dev/tags/stackdriver/"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="naver-site-verification" content="cbcc03783e5594725d3951f4e7f16ede80e69881"><meta data-rh="true" property="og:title" content="One post tagged with &quot;Stackdriver&quot; | Cloud Catalyst"><meta data-rh="true" name="docusaurus_tag" content="blog_tags_posts"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_tags_posts"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://ddii.dev/tags/stackdriver/"><link data-rh="true" rel="alternate" href="https://ddii.dev/tags/stackdriver/" hreflang="en"><link data-rh="true" rel="alternate" href="https://ddii.dev/tags/stackdriver/" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://UTLA0DRN66-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.1e7a31ee.css">
<link rel="preload" href="/assets/js/runtime~main.d09d7680.js" as="script">
<link rel="preload" href="/assets/js/main.36bea237.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top navbarHideable_ObN2"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo-catalyst.svg" alt="Cloud Catalyst" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/logo-catalyst.svg" alt="Cloud Catalyst" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">Cloud Catalyst</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/">Posts</a><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" docid="introduction" href="/docs/prometheus/introduction/">Docs</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/prometheus/introduction/">Prometheus</a></li></ul></div></div><div class="navbar__items navbar__items--right"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/tags/">Tags</a><a class="navbar__item navbar__link" href="/presentation/">Presentation</a><a class="navbar__item navbar__link" href="/archive/">Archive</a><a class="navbar__item navbar__link" href="/about/">About</a><a class="navbar__item navbar__link" href="/pang4u/">Pang4u</a><a href="https://github.com/ddiiwoong/newblog" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_S7eR colorModeToggle_vKtC"><button class="clean-btn toggleButton_rCf9 toggleButtonDisabled_Pu9x" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_v35p"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_nQuB"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_qEbK"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_a9qW thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_uKok margin-bottom--md">Recent Posts</div><ul class="sidebarItemList_Kvuv"><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kubernetes/tetragon/">Tetragon</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kubernetes/istio-ambient/">Istio Ambient Mode on K3d</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kubernetes/gatewayapi/">AWS Gateway API Controller</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kubernetes/headless-service/">Kubernetes Headless Service</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kubernetes/externaldns/">ExternalDNS</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><header class="margin-bottom--xl"><h1>One post tagged with &quot;Stackdriver&quot;</h1><a href="/tags/">View All Tags</a></header><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/kubernetes/microservices-demo/">Cloud-Native Microservices Demo Application with OpenCensus</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2019-03-07T00:00:00.000Z" itemprop="datePublished">March 7, 2019</time> · <!-- -->14 min read</div></header><div class="markdown" itemprop="articleBody"><p><a href="https://github.com/GoogleCloudPlatform/microservices-demo" target="_blank" rel="noopener noreferrer">https://github.com/GoogleCloudPlatform/microservices-demo</a>에서 소개된 Demo Application인 <code>Hipster Shop</code>을 Kubernetes 기반으로 배포하고 관련 오픈소스들을 더 알아보고자 한다.</p><p>위 링크에 가서 보면 알수 있지만 <code>Hipster Shop</code> 아래 그림처럼 10개의 Microservice로 구성되어 있고 상품을 검색 및 구매할 수있는 웹 기반 이커머스 Application으로 구성 되어있다.</p><p><img loading="lazy" src="https://github.com/GoogleCloudPlatform/microservices-demo/raw/master/docs/img/architecture-diagram.png" alt="arch" class="img_E7b_"></p><p>각각의 서비스는 <strong>gRPC</strong> 로 통신하고 외부 사용자만 HTTP로 접근한다. 모든 서비스는 서로 다른 언어(Go, C#, Node.js, Python, Java)로 구성되어 있고 대부분의 Microservice들은 <code>Istio</code> service mesh 형태로 구성할수 있도록 되어있다. <code>Skaffold</code>를 통해 배포하고 <code>OpenCensus</code>라고 하는 gRPC/HTTP기반 Tracing tool을 활용하여 Google <code>Stackdriver</code>로 보내도록 되어있지만  Prometheus에 통합하는 방향으로 작성하기 위해서 Prometheus 기반으로 Metric을 수집하는 Fork된 데모 Application을 검색을 통해 찾을수 있었다.<br>
<a href="https://github.com/census-ecosystem/opencensus-microservices-demo" target="_blank" rel="noopener noreferrer">https://github.com/census-ecosystem/opencensus-microservices-demo</a>  </p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="opencensus">OpenCensus<a class="hash-link" href="#opencensus" title="Direct link to heading">​</a></h2><p><a href="https://opencensus.io/" target="_blank" rel="noopener noreferrer">OpenCensus(OC)</a>는 Microservice 및 Monolith 서비스를 Tracing 및 Metric Monitoring 할 수 있는 라이브러리를 제공하는 오픈소스이다.</p><p>아래와 같이 다양한 언어를 지원 한다.</p><ul><li>Java , Go, Python, C++, Nodejs, Erlang, Ruby, PHP, C#</li></ul><p>또한 수집된 데이터를 Prometheus, Stackdriver Tracing and Monitoring, DataDog, Graphite, Zipkin, Jaeger, Azure Insights 등 과 같은 백엔드 Application으로 내보낼 수 있기 때문에 개발자, 운영자 측면에서 좋은 선택사항이 될 수 있다.  </p><p>Microservice와 같은 분산 시스템에서 개발자/운영자 관점의 가장 중요한 미션은 각각의 수행되는 서비스들의 실행 시간을 확인하고 상호 API간 통신이 얼마나 걸리는지를 확인하고 Span(아래 그림참조)에서 가장 지연이 발생하는 서비스를 빨리 찾아내 확인하고 조치하는 것이라 할 수 있다.</p><p><img loading="lazy" src="https://www.jaegertracing.io/img/spans-traces.png" alt="span" class="img_E7b_"></p><p>OpenCensus는 주로 두가지 기능으로 활용된다.<br>
<!-- -->첫번째는 Metric 수집이고 두번째는 Tracing 기능이다.<br>
<!-- -->Log같은 경우 현재 미지원이지만 다음 메이저 릴리즈에 추가될 예정이라고 하니 조금더 지켜보면 좋을것 같다.</p><ul><li><p>Metrics</p><ul><li>데이터베이스 및 API의 응답시간, 요청 content length, open file descriptor 수와 같이 추적하고자하는 정량 데이터를 말한다. Metric 을 시각화해서 보면 응용 프로그램 및 서비스의 성능과 품질을 측정하는 데 도움이 될 수 있다. 예를 들면 요청 응답시간의 평균값이나 cache hit/miss 수와 같은 것들이 될 수 있다. </li></ul></li><li><p>Traces</p><ul><li>서비스 요청에 대한 애플리케이션 또는 서비스 구조를 확인할수 있고 모든 서비스 간 데이터 흐름을 시각화하여 아키텍처상의 병목 현상을 파악하는 데 도움이 된다.</li></ul></li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="hipster-shop-demo">Hipster Shop Demo<a class="hash-link" href="#hipster-shop-demo" title="Direct link to heading">​</a></h2><p>위에서 언급했던 내용처럼 GCP에서 작성한 <a href="https://github.com/GoogleCloudPlatform/microservices-demo" target="_blank" rel="noopener noreferrer">Hipster Shop Demo</a>는 minikube 및 GCP 데모로 되어있고 코드안에 기본 Metric 설정이 Stackdriver으로 되어있어 Prometheus Exporter 적용을 하려면 코드 수정이 필요하기 때문에 Prometheus기반으로 작성된 <a href="https://github.com/census-ecosystem/opencensus-microservices-demo" target="_blank" rel="noopener noreferrer">Forked Repo</a>를 살펴보기로 하였다.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="requirement">Requirement<a class="hash-link" href="#requirement" title="Direct link to heading">​</a></h3><p>현재 가지고 있는 MacOS 환경에서 구동하였다. 최소 스펙은 따로 기재하지 않았으나 K8s 1.11 이상을 권장한다.</p><ul><li>kubectl : v1.10.7</li><li>Minikube : v0.34.1</li><li>Kubernetes : v1.13.3</li><li><a href="https://github.com/GoogleContainerTools/skaffold/#installation" target="_blank" rel="noopener noreferrer">skaffold</a> : v0.24</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="minikube-기동">minikube 기동<a class="hash-link" href="#minikube-기동" title="Direct link to heading">​</a></h3><p>최소 3 CPU, 6Gb Memory가 필요하다. 그냥 minikube를 구동시기면 4 CPU, 8Gb 로 구동이 되기 때문에 별다른 옵션 없이 default로 구동하면 된다. </p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ minikube start</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get nodes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME       STATUS    ROLES     AGE       VERSION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">minikube   Ready     master    6h        v1.13.3</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="repository-clone">Repository Clone<a class="hash-link" href="#repository-clone" title="Direct link to heading">​</a></h3><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone https://github.com/census-ecosystem/opencensus-microservices-demo.git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token builtin class-name">cd</span><span class="token plain"> opencensus-microservices-demo</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>내부 구조를 살펴보면 기본적으로 <a href="https://github.com/GoogleContainerTools/skaffold" target="_blank" rel="noopener noreferrer">skaffold</a>를 활용하여 배포를 진행을 하는 것을 알수있다.<br>
<code>skaffold</code>는 로컬에서 Kubernetes 기반 어플리케이션 개발과 배포(CD)를 빠르게 도와주는 CLI tool이다. 소스코드의 변화를 감지하여 build, registry push/tagging, deploy까지 자동으로 할 수 있는 로컬 기반 도구이다.</p><p><code>skaffold dev</code>는 로컬 환경의 반복적인 개발에 활용하고 실제 배포는 CI Process에서 <code>skaffold run</code>을 통해 배포를 진행할 수 있다.  </p><p><img loading="lazy" src="https://github.com/GoogleContainerTools/skaffold/raw/master/docs/static/img/intro.gif" alt="skaffold demo" class="img_E7b_"></p><p>Kubernetes 배포툴에 대해 비교한 글은 <a href="https://blog.hasura.io/draft-vs-gitkube-vs-helm-vs-ksonnet-vs-metaparticle-vs-skaffold-f5aa9561f948/" target="_blank" rel="noopener noreferrer">블로그 링크</a>를 통해 확인할 수 있다.</p><p>아래에서는 <code>skaffold</code>에 대한 자세한 내용은 미뤄두고 배포하는 도구로서만 설명한다.  </p><p>기본적으로 구성을 하고자 하는 내용은 helm처럼 template 파일을 사용하게 되는데 프로젝트 root에 <code>skaffold.yaml</code> 에 build를 위한 image name, tag, src 위치등 기본적인 내용을 기재한다. 파일내용을 살펴보면 build에 관련된 내용들을 작성하고 deploy할 manifests의 위치까지 지정하도록 되어있다. 로컬환경에서 확인을 위해 grafana, prometheus, jaeger가 추가된 것을 확인할 수 있다.</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> skaffold/v1alpha2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">build</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">tagPolicy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">gitCommit</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">artifacts</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">imageName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gcr.io/opencensus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">microservices</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo/emailservice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">workspace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> src/emailservice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">imageName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gcr.io/opencensus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">microservices</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo/productcatalogservice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">workspace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> src/productcatalogservice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">imageName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gcr.io/opencensus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">microservices</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo/recommendationservice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">workspace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> src/recommendationservice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">imageName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gcr.io/opencensus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">microservices</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo/shippingservice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">workspace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> src/shippingservice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">imageName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gcr.io/opencensus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">microservices</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo/checkoutservice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">workspace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> src/checkoutservice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">imageName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gcr.io/opencensus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">microservices</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo/paymentservice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">workspace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> src/paymentservice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">imageName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gcr.io/opencensus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">microservices</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo/currencyservice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">workspace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> src/currencyservice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">imageName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gcr.io/opencensus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">microservices</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo/cartservice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">workspace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> src/cartservice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">imageName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gcr.io/opencensus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">microservices</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo/frontend</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">workspace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> src/frontend</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">imageName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gcr.io/opencensus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">microservices</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo/loadgenerator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">workspace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> src/loadgenerator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">imageName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gcr.io/opencensus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">microservices</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo/adservice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">workspace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> src/adservice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">imageName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gcr.io/opencensus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">microservices</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo/grafana</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">workspace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> src/grafana</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">imageName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gcr.io/opencensus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">microservices</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo/prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">workspace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> src/prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">imageName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gcr.io/opencensus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">microservices</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo/jaeger</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">workspace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> src/jaeger</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">deploy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">kubectl</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">manifests</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> ./kubernetes</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">manifests/</span><span class="token important">**.yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Go로 작성된 Frontend microservice을 살펴보자. <!-- -->[<strong>./src/frontend/main.go</strong>]</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="library-추가-및-http-handler-초기화">library 추가 및 http handler 초기화<a class="hash-link" href="#library-추가-및-http-handler-초기화" title="Direct link to heading">​</a></h3><p>Go기반 exporter 패키지(jaeger,prometheus)를 추가적으로 import 하고 http handler를 위한 <a href="https://godoc.org/go.opencensus.io/plugin/ochttp" target="_blank" rel="noopener noreferrer">ochttp 패키지</a>를 추가하였다. </p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;go.opencensus.io/exporter/jaeger&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;go.opencensus.io/exporter/prometheus&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;go.opencensus.io/plugin/ochttp&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;go.opencensus.io/plugin/ochttp/propagation/b3&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> handler http</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Handler </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> r</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        handler </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">logHandler</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">log</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> log</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> next</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> handler</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        handler </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ensureSessionID</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">handler</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// add opencensus instrumentation</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        handler </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">ochttp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Handler</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Handler</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">     handler</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Propagation</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">b3</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">HTTPFormat</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Infof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;starting server on &quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> addr </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;:&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> srvPort</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Fatal</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">http</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ListenAndServe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr</span><span class="token operator" style="color:#393A34">+</span><span class="token string" style="color:#e3116c">&quot;:&quot;</span><span class="token operator" style="color:#393A34">+</span><span class="token plain">srvPort</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> handler</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="exporter-등록jaeger-tracing-및-prometheus-exporter">exporter 등록(Jaeger Tracing 및 Prometheus exporter)<a class="hash-link" href="#exporter-등록jaeger-tracing-및-prometheus-exporter" title="Direct link to heading">​</a></h3><p>예시처럼 각각의 서비스에 jaeger와 prometheus exporter Endpoint를 쉽게 등록할수 있다.<br>
<!-- -->또한 initTracing() 에서는 데모를 위해 trace.AlwaysSample()을 사용하였다. 실제 운영환경에서는 <a href="https://github.com/census-instrumentation/opencensus-specs/blob/master/trace/Sampling.md" target="_blank" rel="noopener noreferrer">다음 링크</a>를 참고해서 사용하는 것을 권고하고 있다. </p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">initJaegerTracing</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">log logrus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">FieldLogger</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// Register the Jaeger exporter to be able to retrieve</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// the collected spans.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        exporter</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> jaeger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewExporter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">jaeger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Options</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Endpoint</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;http://jaeger:14268&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Process</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> jaeger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Process</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ServiceName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;frontend&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Fatal</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        trace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">RegisterExporter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">exporter</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">initTracing</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">log logrus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">FieldLogger</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// This is a demo app with low QPS. trace.AlwaysSample() is used here</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// to make sure traces are available for observation and analysis.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// In a production environment or high QPS setup please use</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// trace.ProbabilitySampler set at the desired probability.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        trace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ApplyConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">trace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Config</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                DefaultSampler</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> trace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">AlwaysSample</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">initJaegerTracing</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">log</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">initPrometheusStatsExporter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">log logrus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">FieldLogger</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">prometheus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Exporter </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    exporter</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> prometheus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewExporter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">prometheus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Options</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Fatal</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;error registering prometheus exporter&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    view</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">RegisterExporter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">exporter</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> exporter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">startPrometheusExporter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">log logrus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">FieldLogger</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> exporter </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">prometheus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Exporter</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    addr </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;:9090&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Infof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;starting prometheus server at %s&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> addr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    http</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Handle</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;/metrics&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> exporter</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Fatal</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">http</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ListenAndServe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="demo-application-배포">Demo Application 배포<a class="hash-link" href="#demo-application-배포" title="Direct link to heading">​</a></h3><p>minikube에 Hipster Shop Demo를 배포한다. 단순하게 <code>skaffold run</code> 명령으로 진행하면 된다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ skaffold run</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>현재 사용중인 2018 Macbook Pro(3.1 GHz Intel Core i7, 16GB) 상의 Docker기반 minikube 환경으로도 배포를 하였는데 시간이 꽤 소요되었다.(20분이상)<br>
<!-- -->코드를 실시간으로 수정하고 빌드, 배포되는 것은 <code>skaffold dev</code> 명령으로 확인할 수 있다. 진행되는 과정을 보면 <a href="https://draft.sh/" target="_blank" rel="noopener noreferrer">draft.sh</a> 프로젝트와도 꽤 유사하다고 볼 수 있다.  </p><p>에러없이 run이 실행되고 난후 minikube에 배포된 pod와 service를 확인한다. 중간에 loadgenerator가 init인 이유는 minikube 자원이 부족해서 발생하는 현상이다.</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                     READY     STATUS     RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">adservice-7c7d687dcb-xzr4m               </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1       Running    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">          4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cartservice-f54bcb9ff-tcfgn              </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1       Running    </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">          4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">checkoutservice-576446687b-95bwj         </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1       Running    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">          4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">currencyservice-5bd99bf97d-28mtz         </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1       Running    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">          4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">emailservice-6cb587798d-wwzdh            </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1       Running    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">          4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">frontend-6bf9796f7b-ch9pl                </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1       Running    </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">          4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">grafana-6678c5c5d9-2qx75                 </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1       Running    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">          4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">jaeger-5b66bdf7f7-csdzx                  </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1       Running    </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">          4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">loadgenerator-7c4f446774-68djg           </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">/1       Init:0/1   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">          4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">paymentservice-fc4c8589-wrfg7            </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1       Running    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">          4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">productcatalogservice-84878c8b9c-jhgnw   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1       Running    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">          4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-58d98b7578-87td6              </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1       Running    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">          4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">recommendationservice-8564f9d894-smlpf   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1       Running    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">          4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">redis-cart-798bc66d58-xn6ff              </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1       Running    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">          4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">shippingservice-789656f6bc-rgzrp         </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1       Running    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">          4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get svc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                    TYPE           CLUSTER-IP       EXTERNAL-IP   PORT</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">S</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">                                                            AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">adservice               ClusterIP      </span><span class="token number" style="color:#36acaa">10.107</span><span class="token plain">.196.115   </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">9555</span><span class="token plain">/TCP,9090/TCP                                                  4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cartservice             ClusterIP      </span><span class="token number" style="color:#36acaa">10.98</span><span class="token plain">.151.164    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">7070</span><span class="token plain">/TCP                                                           4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">checkoutservice         ClusterIP      </span><span class="token number" style="color:#36acaa">10.97</span><span class="token plain">.9.197      </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">5050</span><span class="token plain">/TCP                                                           4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">currencyservice         ClusterIP      </span><span class="token number" style="color:#36acaa">10.103</span><span class="token plain">.112.225   </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">7000</span><span class="token plain">/TCP                                                           4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">emailservice            ClusterIP      </span><span class="token number" style="color:#36acaa">10.97</span><span class="token plain">.184.174    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">5000</span><span class="token plain">/TCP                                                           4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">frontend                ClusterIP      </span><span class="token number" style="color:#36acaa">10.103</span><span class="token plain">.40.138    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">80</span><span class="token plain">/TCP,9090/TCP                                                    4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">frontend-external       LoadBalancer   </span><span class="token number" style="color:#36acaa">10.108</span><span class="token plain">.170.241   </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">pending</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">80</span><span class="token plain">:31944/TCP                                                       4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">grafana                 ClusterIP      </span><span class="token number" style="color:#36acaa">10.104</span><span class="token plain">.141.254   </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">3000</span><span class="token plain">/TCP                                                           4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">grafana-external        LoadBalancer   </span><span class="token number" style="color:#36acaa">10.102</span><span class="token plain">.166.138   </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">pending</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">3000</span><span class="token plain">:30459/TCP                                                     4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">jaeger                  ClusterIP      </span><span class="token number" style="color:#36acaa">10.98</span><span class="token plain">.71.173     </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">9411</span><span class="token plain">/TCP,5775/UDP,6831/UDP,6832/UDP,5778/TCP,16686/TCP,14268/TCP   4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">jaeger-external         LoadBalancer   </span><span class="token number" style="color:#36acaa">10.96</span><span class="token plain">.164.126    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">pending</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">16686</span><span class="token plain">:32362/TCP                                                    4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubernetes              ClusterIP      </span><span class="token number" style="color:#36acaa">10.96</span><span class="token plain">.0.1        </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">443</span><span class="token plain">/TCP                                                            6h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">paymentservice          ClusterIP      </span><span class="token number" style="color:#36acaa">10.109</span><span class="token plain">.31.241    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">50051</span><span class="token plain">/TCP                                                          4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">productcatalogservice   ClusterIP      </span><span class="token number" style="color:#36acaa">10.101</span><span class="token plain">.124.106   </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">3550</span><span class="token plain">/TCP                                                           4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus              ClusterIP      </span><span class="token number" style="color:#36acaa">10.103</span><span class="token plain">.107.213   </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">9090</span><span class="token plain">/TCP                                                           4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">recommendationservice   ClusterIP      </span><span class="token number" style="color:#36acaa">10.104</span><span class="token plain">.225.28    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">8080</span><span class="token plain">/TCP                                                           4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">redis-cart              ClusterIP      </span><span class="token number" style="color:#36acaa">10.101</span><span class="token plain">.24.157    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">6379</span><span class="token plain">/TCP                                                           4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">shippingservice         ClusterIP      </span><span class="token number" style="color:#36acaa">10.104</span><span class="token plain">.224.18    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">50051</span><span class="token plain">/TCP                                                          4h</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="서비스-접속-및-metrictracing-확인">서비스 접속 및 Metric/Tracing 확인<a class="hash-link" href="#서비스-접속-및-metrictracing-확인" title="Direct link to heading">​</a></h3><p>로컬 minikube환경이기 때문에 external service가 pending이므로 service를 minikube NAT IP로 expose 시킨다.</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ minikube </span><span class="token function" style="color:#d73a49">service</span><span class="token plain"> frontend-external</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ minikube </span><span class="token function" style="color:#d73a49">service</span><span class="token plain"> grafana-external</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ minikube </span><span class="token function" style="color:#d73a49">service</span><span class="token plain"> jaeger-external</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ minikube </span><span class="token function" style="color:#d73a49">service</span><span class="token plain"> list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain">-------------</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">-----------------------</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">-----------------------------</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain">  NAMESPACE  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">         NAME          </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">             URL             </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain">-------------</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">-----------------------</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">-----------------------------</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> default     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> adservice             </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> No </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> port                </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> default     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> cartservice           </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> No </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> port                </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> default     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> checkoutservice       </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> No </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> port                </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> default     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> currencyservice       </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> No </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> port                </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> default     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> emailservice          </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> No </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> port                </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> default     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> frontend              </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> No </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> port                </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> default     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> frontend-external     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> http://192.168.99.101:31944 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> default     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> grafana               </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> No </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> port                </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> default     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> grafana-external      </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> http://192.168.99.101:30459 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> default     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> jaeger                </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> No </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> port                </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> default     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> jaeger-external       </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> http://192.168.99.101:32362 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> default     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> kubernetes            </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> No </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> port                </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> default     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> paymentservice        </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> No </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> port                </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> default     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> productcatalogservice </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> No </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> port                </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> default     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> prometheus            </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> No </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> port                </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> default     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> recommendationservice </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> No </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> port                </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> default     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> redis-cart            </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> No </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> port                </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> default     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> shippingservice       </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> No </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> port                </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> kube-system </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> kube-dns              </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> No </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> port                </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain">-------------</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">-----------------------</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">-----------------------------</span><span class="token operator" style="color:#393A34">|</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>3개의 서비스로 각각 접속이 되는것을 확인할수 있다.
Grafana 대시보드로 들어가면 현재 수집되는 prometheus source(http://prometheus:9090)를 통해 OpenCensus기반 Application Metric을 확인할 수 있다.</p><p><img loading="lazy" alt="hipster_grafana" src="/assets/images/hipster_grafana-13ab198ab40c06a5c6ba6bc61e3725ad.png" width="2878" height="1488" class="img_E7b_"></p><p>그림에서 보면 전체 서비스 응답에 대한 99% 백분위 지연시간이 944ms 인것을 확인할 수 있다. </p><p>또한 Jaeger를 통해 DAG(Directed acyclic graph) 및 서비스간 Tracing 을 확인할 수 있다.</p><p><img loading="lazy" alt="DAG" src="/assets/images/dag-0e49356be3f8676a292785832fbc1981.png" width="3146" height="1782" class="img_E7b_"></p><p><img loading="lazy" alt="tracing" src="/assets/images/tracing-b9038c7a3151b467c5f7d4dc08786f75.png" width="3172" height="1442" class="img_E7b_"></p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="정리">정리<a class="hash-link" href="#정리" title="Direct link to heading">​</a></h2><p>OpenCensus 기반으로 개발자가 코드를 작성하고 Microservice를 minikube에서 배포하고 Prometheus, Jaeger Exporter 연동을 통해 시스템뿐만이 아닌 Application기반 Metrics/Stats을 수집하고 개발자가 작성한 코드를 직접 Tracing하는 간단한 데모를 진행하였다. (Istio를 포함해서 Public환경에 배포해봐도 좋은 공부가 될 것 같다)  </p><p>향후 <a href="https://openmetrics.io/" target="_blank" rel="noopener noreferrer">OpenMetric</a>과 <a href="https://opencensus.io/" target="_blank" rel="noopener noreferrer">Opencensus</a>가 실제 개발자 기반으로 활성화되고 적용이 된다면 Telemetric 측면에서 많은 Use-Case가 도출될 수 있을것 같다.  </p><p>위에서 언급했듯이 Prometheus기반 Kubernetes 클러스터를 운영하고 있는 팀의 경우 개발자의 작성 코드를 최소화할 수 있는 도구로서 충분히 활용될 수 있어 보인다.  </p><p>꼭 Cloud Native 기반 Web 개발이 아니더라도 기존 공장, 금융, 병원 등 의 IoT나 센서/설비를 위한 비즈니스에도 Backend로서 확장성있는 도구로서 활용이 될 수 있을것 같다.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/kubernetes/">Kubernetes</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/istio/">Istio</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/stackdriver/">Stackdriver</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/prometheus/">Prometheus</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/g-rpc/">gRPC</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/open-census/">OpenCensus</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/skaffold/">skaffold</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Cloud-Native Microservices Demo Application with OpenCensus" href="/kubernetes/microservices-demo/"><b>Read More</b></a></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></main></div></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Blog</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/">Home</a></li><li class="footer__item"><a class="footer__link-item" href="/archive/">Archive</a></li><li class="footer__item"><a class="footer__link-item" href="/tags/">Tags</a></li></ul></div><div class="col footer__col"><div class="footer__title">Sponsors</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/pang4u/">Pang4U</a></li><li class="footer__item"><a href="https://ko-fi.com/ddiiwoong" target="_blank" rel="noopener noreferrer" class="footer__link-item">Buy Me a Coffee<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/ddiiwoong" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/ddiiwoong" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.facebook.com/ddiiwoong" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://kr.linkedin.com/in/ddiiwoong" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div></div></footer></div>
<script src="/assets/js/runtime~main.d09d7680.js"></script>
<script src="/assets/js/main.36bea237.js"></script>
</body>
</html>