<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-tags-post-list-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.18">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="Act as a catalyst RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Act as a catalyst Atom Feed">
<link rel="alternate" type="application/json" href="/feed.json" title="Act as a catalyst JSON Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","G-4ZT898XDT2","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-4ZT898XDT2"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-4ZT898XDT2",{anonymize_ip:!0})</script>
<link rel="search" type="application/opensearchdescription+xml" title="Cloud Catalyst" href="/opensearch.xml">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4362752107119680" crossorigin="anonymous"></script><title data-rh="true">6 posts tagged with &quot;CI/CD&quot; | Cloud Catalyst</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://ddii.dev/tags/ci-cd/"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="naver-site-verification" content="cbcc03783e5594725d3951f4e7f16ede80e69881"><meta data-rh="true" property="og:title" content="6 posts tagged with &quot;CI/CD&quot; | Cloud Catalyst"><meta data-rh="true" name="docusaurus_tag" content="blog_tags_posts"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_tags_posts"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://ddii.dev/tags/ci-cd/"><link data-rh="true" rel="alternate" href="https://ddii.dev/tags/ci-cd/" hreflang="en"><link data-rh="true" rel="alternate" href="https://ddii.dev/tags/ci-cd/" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://UTLA0DRN66-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.1e7a31ee.css">
<link rel="preload" href="/assets/js/runtime~main.658e9364.js" as="script">
<link rel="preload" href="/assets/js/main.a75c27ce.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top navbarHideable_ObN2"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo-catalyst.svg" alt="Cloud Catalyst" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/logo-catalyst.svg" alt="Cloud Catalyst" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">Cloud Catalyst</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/">Posts</a><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" docid="introduction" href="/docs/prometheus/introduction/">Docs</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/prometheus/introduction/">Prometheus</a></li></ul></div></div><div class="navbar__items navbar__items--right"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/tags/">Tags</a><a class="navbar__item navbar__link" href="/presentation/">Presentation</a><a class="navbar__item navbar__link" href="/archive/">Archive</a><a class="navbar__item navbar__link" href="/about/">About</a><a class="navbar__item navbar__link" href="/pang4u/">Pang4u</a><a href="https://github.com/ddiiwoong/newblog" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_S7eR colorModeToggle_vKtC"><button class="clean-btn toggleButton_rCf9 toggleButtonDisabled_Pu9x" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_v35p"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_nQuB"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_qEbK"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_a9qW thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_uKok margin-bottom--md">Recent Posts</div><ul class="sidebarItemList_Kvuv"><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kubernetes/k6-prometheus/">prometheus grafana 스택으로 k6 테스트 결과 확인하기</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kubernetes/kyverno/">kyverno를 활용한 Kubernetes 정책 엔진 적용</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kubernetes/argo-rollout-advanced/">Advanced Argo Rollout</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kubernetes/kops-cilium/">kOps with Cilium</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kubernetes/kops-cloud9/">kOps with Cloud9</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><header class="margin-bottom--xl"><h1>6 posts tagged with &quot;CI/CD&quot;</h1><a href="/tags/">View All Tags</a></header><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/devops/circleci-ecs/">CircleCI로 AWS BATCH(ECS) CI/CD Pipeline 구성</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2019-06-30T00:00:00.000Z" itemprop="datePublished">June 30, 2019</time> · <!-- -->11 min read</div></header><div class="markdown" itemprop="articleBody"><p><a href="https://ddii.dev/devops/circleci/" target="_blank" rel="noopener noreferrer">이전 포스팅</a>에서 EKS 클러스터와 어플리케이션 배포 및 테스트를 간단하게 해봤다.  이번에는 AWS ECS 또는 AWS Batch Application을 CircleCI를 통해 배포 및 업데이트 하는 것을 알아본다.  </p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="application-요구사항">Application 요구사항<a class="hash-link" href="#application-요구사항" title="Direct link to heading">​</a></h2><p>기본적으로 현재 업무 중에 IBM클라우드에서 AWS로 데이터를 가져와야 하는 업무가 생겨서 시작되었고 정기적으로 매일 새벽에 크롤링(Pull)방식으로 데이터를 복제해야하는 Use-Case를 구현해야 했다.<br>
<!-- -->CI/CD Pipeline구성이 주 목적으로 Application구현은 포스팅 내용에서 제외하였다.  </p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="기본-요구사항">기본 요구사항<a class="hash-link" href="#기본-요구사항" title="Direct link to heading">​</a></h3><ul><li>Github Account</li><li>CircleCI Account (Github Auth)</li><li>AWS ECR(Elastic Container Registry)</li><li>AWS Batch(ECS) </li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="cicd-구성안">CI/CD 구성안<a class="hash-link" href="#cicd-구성안" title="Direct link to heading">​</a></h2><p>실제 프로젝트에 적용할 구성안이다.<br>
<!-- -->기본적으로 모든 구성은 최대한 비용이 들지 않고 AWS 종속성을 제거한 방법으로 구성하였다.  </p><ul><li>Code Repository : Github</li><li>CI : CircleCI</li><li>Registry : AWS ECR</li><li>CD : CircleCI</li><li>Target : AWS Batch(ECS)</li><li>Notification : Slack</li></ul><p>이번 데모에서는 다음과 같은 시나리오로 진행하려고 한다.  </p><ol><li>Terraform으로 AWS Batch 생성</li><li>Github에 수정된 Batch Code(Shell Script) Commit &amp; Triggering CircleCI</li><li>Docker Build &amp; AWS ECR로 Push</li><li>S3로 myjob shell 파일 복사</li><li>AWS Batch(ECS) Job Definition 변경(Change Image)</li></ol><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="aws-batch">AWS Batch<a class="hash-link" href="#aws-batch" title="Direct link to heading">​</a></h3><p>기본적으로 Batch 컴퓨팅을 목적으로 하는 서비스로 컴퓨팅 타입을 Fargate 또는 EC2 중 하나를 선택하여 동적으로 프로비저닝하는 서비스이다.<br>
<!-- -->초기 설정이 번거롭긴 하지만 한번 구성하고 나면 별도 관리가 필요없고 Batch작업이 발생하는것과 컨테이너 이미지 보관비용 이외에는 추가 비용이 발생하지 않기 때문에 비용측면에서 장점이 있는 서비스이다.<br>
<!-- -->위에서 이야기한 정기적으로 새벽마다 크롤링(Pull)방식으로 데이터를 복제해야하는 Use-Case를 구현하는것이 적당한 워크로드 구현방법이라 생각했기 때문에 AWS Batch 서비스를 사용하게 되었다.  </p><p>간단한 Batch demo는 <a href="https://github.com/awslabs/aws-batch-helpers/" target="_blank" rel="noopener noreferrer">https://github.com/awslabs/aws-batch-helpers/</a>에서 확인이 가능하며 CircleCI연동을 위해 Fork후  진행하였다.</p><p>Demo Repository : <a href="https://github.com/ddiiwoong/aws-batch-helpers/" target="_blank" rel="noopener noreferrer">https://github.com/ddiiwoong/aws-batch-helpers/</a></p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="circleci">CircleCI<a class="hash-link" href="#circleci" title="Direct link to heading">​</a></h3><p>모든 Pipeline은 CircleCI기반으로 작성하였다.  혹자는 AWS Code Commit, Pipeline을 사용하지 않느냐고 문의하시는 분들도 있는데 다음과 같은 이유로 CircleCI를 선택하였다.  </p><ul><li>Fully Managed (Serverless)</li><li>AWS 종속성 최소화  </li><li>Git, Registry, CD영역의 확장성 고려</li><li>AWS Console 접속 최소화</li><li>쉽고 단순하게 빌드 환경구성</li><li>소규모 프로젝트 빠르게 시작 가능</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="amazon-elastic-container-registry-ecr">Amazon Elastic Container Registry (ECR)<a class="hash-link" href="#amazon-elastic-container-registry-ecr" title="Direct link to heading">​</a></h3><p>개인적으로 Registry는 구축형보다는 Managed서비스를 사용하는것이 좋다고 보기 때문에 Webhook을 Native하게 지원하는 DockerHub도 대체 가능하다고 생각한다.  </p><ul><li>Fully Managed</li><li>Security (IAM) 연동</li><li>CircleCI Orbs 제공</li><li>EKS, ECS 연동 용이</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="terraform">Terraform<a class="hash-link" href="#terraform" title="Direct link to heading">​</a></h3><p><a href="https://www.terraform.io/docs/providers/aws/index.html" target="_blank" rel="noopener noreferrer">https://www.terraform.io/docs/providers/aws/index.html</a>  </p><p>선언적 인프라스트럭처 관리 도구로 많이 사용하고 있는 도구이며 Docs와 블로그 자료가 많은 관계로 따로 설명하지 않겠다.<br>
<!-- -->이번 포스트에서는 AWS Batch를 생성하는 영역을 Terraform이 담당한다.  </p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="circleci-config-작성">CircleCI Config 작성<a class="hash-link" href="#circleci-config-작성" title="Direct link to heading">​</a></h2><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2.1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">orbs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">aws-ecr</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> circleci/aws</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ecr@6.1.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">aws-ecs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> circleci/aws</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ecs@0.0.8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">aws-s3</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> circleci/aws</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">s3@1.0.11</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">aws-cli</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> circleci/aws</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">cli@0.1.13</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">jobs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">sh-s3-upload</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">docker</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;circleci/python:2.7&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">steps</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> checkout</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">aws-s3/copy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">from</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ./myjob.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">to</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;s3://batch-ecr-test/myjob.sh&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">deploy-batch</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">executor</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> aws</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">cli/default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">steps</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> checkout</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> aws</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">cli/install</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Update AWS Batch Job</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">command</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token scalar string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">            aws batch register-job-definition --job-definition-name fetch_and_run --type container --container-properties &#x27;{ &quot;image&quot;: &quot;823928750534.dkr.ecr.ap-northeast-2.amazonaws.com/fetch_and_run:v20190623&quot;, &quot;vcpus&quot;: 1, &quot;memory&quot;: 512}&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">workflows</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">build-and-deploy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">jobs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">aws-ecr/build-and-push-image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">repo</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $AWS_RESOURCE_NAME_PREFIX</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">tag</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v20190623</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">sh-s3-upload</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> sh</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">s3</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">upload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">requires</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> aws</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ecr/build</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">and</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">push</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">deploy-batch</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> deploy</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">batch</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">requires</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> sh</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">s3</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">upload</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>단계별 설명을 위해 부분적으로 설명하도록 하겠다.  </p><ol><li><p>Terraform으로 Batch 배포</p><div class="codeBlockContainer_I0IT language-json theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-json codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">resource </span><span class="token string" style="color:#e3116c">&quot;aws_batch_compute_environment&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;default&quot;</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  compute_environment_name = </span><span class="token string" style="color:#e3116c">&quot;env_fetch_and_run&quot;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  compute_resources </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    instance_role = </span><span class="token string" style="color:#e3116c">&quot;arn:aws:iam::823928750534:instance-profile/ecsInstanceRole&quot;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    instance_type = </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;optimal&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    desired_vcpus = </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    max_vcpus = </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    min_vcpus = </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    security_group_ids = </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;sg-0632cf81b5c4dff17&quot;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    subnets = </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;subnet-0c4f8135b536e8fab&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;subnet-0a261950d894cf27e&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    type = </span><span class="token string" style="color:#e3116c">&quot;EC2&quot;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  service_role = </span><span class="token string" style="color:#e3116c">&quot;arn:aws:iam::823928750534:role/service-role/AWSBatchServiceRole&quot;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type =</span><span class="token string" style="color:#e3116c">&quot;MANAGED&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Batch Computing 환경을 구성하게 되는데 <code>&quot;aws_batch_compute_environment&quot;</code>를 사용한다.  </p><ul><li>compute_environment_name : (필수) 컴퓨팅 환경 이름</li><li>compute_resources.instance_role : (필수) EC2에 적용되는 Role</li><li>compute_resources.instance_type : (필수) 사용 가능한 instance 유형</li><li>compute_resources.desired_vcpus : (옵션) 원하는 CPU수</li><li>compute_resources.max_vcpus : (필수) 최대 CPU수  </li><li>compute_resources.min_vcpus : (필수) 최소 CPU수</li><li>compute_resources.security_group_ids : (필수) EC2에 적용되는 Security Group</li><li>compute_resources.subnets : (필수) Subnets 목록</li><li>compute_resources.type : (필수) EC2를 기반으로 생성, SPOT instance 사용가능  </li><li>service_role : (필수) AWS Batch가 다른 AWS 서비스를 호출 할수있게 해주는 IAM Role(ARN)</li><li>type : (필수) MANAGED나 UNMANAGED를 선택할 수 있고, MANAGED의 경우 compute_resources에 세부 사항을 설정할 수 있다.  </li></ul><div class="codeBlockContainer_I0IT language-json theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-json codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">resource </span><span class="token string" style="color:#e3116c">&quot;aws_batch_job_definition&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;default&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name = </span><span class="token string" style="color:#e3116c">&quot;fetch_and_run&quot;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = </span><span class="token string" style="color:#e3116c">&quot;container&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  container_properties = &lt;&lt;CONTAINER_PROPERTIES</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;command&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;image&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;823928750534.dkr.ecr.ap-northeast-2.amazonaws.com/fetch_and_run:v20190623&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;vcpus&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;memory&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">512</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;volumes&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;environment&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;mountPoints&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;ulimits&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CONTAINER_PROPERTIES</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Job Definition 정의(&quot;aws_batch_job_definition&quot;)에서는 Resource spec 및 Command(Docker RUN), Container IMAGE 등을 선언하게 된다.  </p><ul><li>name : (필수) Job Definition 이름</li><li>type : (필수) Job Definition 유형, ECS로 처리하기 위해 container로 선택</li><li>container_properties : (선택) JSON 형태로 작성하는 container 속성정보 (Image, Resources, Command, MountPoint 등)</li></ul></li><li><p>.circleci/config.yml에 CircleCI 버전 명시 및 관련 orb(ecr,ecs,s3,cli) 추가<br>
<!-- -->기본적으로 2.1로 설정을 해야 ecs, eks orb 사용이 가능하다.</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2.1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">orbs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">aws-ecr</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> circleci/aws</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ecr@6.1.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">aws-ecs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> circleci/aws</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ecs@0.0.8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">aws-s3</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> circleci/aws</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">s3@1.0.11</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">aws-cli</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> circleci/aws</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">cli@0.1.13</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></li><li><p>workflow 구성</p><p><code>build-and-push-image</code> -&gt; <code>sh-s3-upload</code> -&gt; <code>deploy-batch</code> 순으로 순차적으로 pipeline구성을 하였다.  </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">workflows:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  build-and-deploy:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jobs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - aws-ecr/build-and-push-image:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          repo: $AWS_RESOURCE_NAME_PREFIX # data-crawler-test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          tag: v20190623</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          # create-repo: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          # dockerfile: Dockerfile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - sh-s3-upload:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          name: sh-s3-upload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          requires:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - aws-ecr/build-and-push-image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - deploy-batch:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          name: deploy-batch</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          requires:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - sh-s3-upload</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>기본적으로 CircleCI에서는 orb job을 <!-- -->[orb name]<!-- -->/<!-- -->[predefined-job]<!-- --> 형식으로 선언한다.  </p><p>I. 첫번째 step에서는 container image를 build하고 push하는 Job을 수행하므로 <code>aws-ecr/build-and-push-image</code>을 선언한다.<br>
<!-- -->자세한 내용은 <a href="https://circleci.com/orbs/registry/orb/circleci/aws-ecr" target="_blank" rel="noopener noreferrer">https://circleci.com/orbs/registry/orb/circleci/aws-ecr</a>를 확인하자.  </p><p>II. 두번째 step에서는 S3에 배치스크립트를 올리는 Custom Job을 수행한다.  Job은 Step의 모음으로 선행되어야할 Job은 상위에 <code>requires:</code> 에서 선언하면 된다.  </p><p>III. 세번째 step에서는 AWS Batch job definition의 container image를 교체(revision 변경)하는 Custom Job을 수행한다.  </p></li><li><p>custom job 구성
Workflow에서 선언한 Custom Job의 상세 definition을 기재한다.  </p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">jobs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">sh-s3-upload</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">docker</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;circleci/python:2.7&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">steps</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> checkout</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">aws-s3/copy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">from</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ./myjob.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">to</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;s3://batch-ecr-test/myjob.sh&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">deploy-batch</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">executor</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> aws</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">cli/default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">steps</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> aws</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">cli/install</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Update AWS Batch Job</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">command</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token scalar string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">            aws batch register-job-definition --job-definition-name fetch_and_run --type container --container-properties &#x27;{ &quot;image&quot;: &quot;823928750534.dkr.ecr.ap-northeast-2.amazonaws.com/fetch_and_run:v20190623&quot;, &quot;vcpus&quot;: 1, &quot;memory&quot;: 512}&#x27;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>I. <code>sh-s3-upload</code> 에서는 <code>aws-s3/copy</code> 를 사용하여 원하는 S3버킷에 사용할 스크립트를 업로드 한다.  <code>checkout</code>에서는 현재 상태의 git repo를 clone하게 된다.  </p><p>II. <code>deploy-batch</code> 에서는 <code>aws-cli/install</code> 를 사용하여 기존에 작성한 Batch Job definition을 awscli로 원하는 새로운 image로 업데이트 하게 된다.  </p></li></ol><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="circleci-실행">CircleCI 실행<a class="hash-link" href="#circleci-실행" title="Direct link to heading">​</a></h2><p>빌드 및 배포과정을 간단하게 설명하면 코드가 업데이트되면 CircleCI는 해당 저장소의 <code>.circleci/config.yml</code> 을 기준으로 빌드 및 배포를 시작하게 된다.  </p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="readmemd에-build-status-badge-달기">README.md에 Build Status Badge 달기<a class="hash-link" href="#readmemd에-build-status-badge-달기" title="Direct link to heading">​</a></h2><p><a href="https://circleci.com/docs/2.0/status-badges/" target="_blank" rel="noopener noreferrer">https://circleci.com/docs/2.0/status-badges/</a>  </p><p><img loading="lazy" alt="badge" src="/assets/images/circle-badge-24ad544bce8cfd19a433ce635078fa5c.png" width="1000" height="660" class="img_E7b_">
위 링크와 설정을 참고하여 아래 그림과 같이 Build Statud Badge를 달 수 있다.  </p><p><img loading="lazy" alt="badge" src="/assets/images/circle-badge-ss-0aa981c32cb500f9508dd854153420ae.png" width="854" height="374" class="img_E7b_"></p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="정리">정리<a class="hash-link" href="#정리" title="Direct link to heading">​</a></h2><p>이번에는 CircleCI를 가지고 AWS Batch job을 구성하는 데모를 진행하였다.  </p><p>얼마전인가에도 <a href="https://github.com/leoh0" target="_blank" rel="noopener noreferrer">어형부형</a>님께서도 언급하신 선언적인 구성 기반에 최대한 serverless 환경에서의 배포를 추구하게 되다 보니 아래와 같은 <code>CI/CD Pipeline 시나리오</code>를 구상하게 되었다.  </p><p><img loading="lazy" alt="cicd" src="/assets/images/circlecicd-01a869820c0d70040071bbc7a5704933.png" width="972" height="599" class="img_E7b_"></p><p>새로운 기능의 브랜치(New Feature)가 Git에 push되면 빌드와 테스트가 트리거되어 자동으로 진행되고 동시에 개발자가 PR을 작성하면 동료 및 담당 상급자에게 코드 리뷰를 받게 된다.  </p><p>리뷰가 통과되고 CircleCI에서 빌드가 성공했다면 승인단계를 통해 Merge를 하고 CircleCI 가 한 번 더 빌드를 시작하고 배포까지 수행하게 된다.  </p><p>ECS나 Batch로 배포는 CircleCI를 통해 직접 배포를 하고 EC2나 EKS로의 배포는 Terraform 및 ArgoCD를 통해 배포를 진행하는 방식이다.  </p><p>다음번 포스팅에는 위 그림 기반으로 CircleCI와 ArgoCD를 활용하여 EKS기반 배포과정을 정리할 예정이다.  </p><p><a href="https://ko-fi.com/X8X1W6OZ" target="_blank" rel="noopener noreferrer"><img loading="lazy" src="https://www.ko-fi.com/img/githubbutton_sm.svg" alt="ko-fi" class="img_E7b_"></a></p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/dev-ops/">DevOps</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ci-cd/">CI/CD</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/pipeline/">Pipeline</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/circle-ci/">CircleCI</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/git-hub/">GitHub</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/git-ops/">GitOps</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ecs/">ECS</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/aws-batch/">AWS Batch</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about CircleCI로 AWS BATCH(ECS) CI/CD Pipeline 구성" href="/devops/circleci-ecs/"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/devops/circleci/">CircleCI - GitHub 연동 및 EKS 구성하기</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2019-06-18T00:00:00.000Z" itemprop="datePublished">June 18, 2019</time> · <!-- -->11 min read</div></header><div class="markdown" itemprop="articleBody"><p>CI/CD는 개발단계에서 지속적인 통합, 배포를 통해 효율성을 높여주는 도구라고 말할수 있다.  특히 GitOps가 중요시 되는 최근 트렌드에서 Public Git서비스와 통합은 필수적인 요소이다. </p><p><a href="https://github.com/marketplace" target="_blank" rel="noopener noreferrer">GitHub MarketPlace</a>에서 <code>CI</code> 라고 검색하면 다음과 같은 결과를 얻을수 있다.  </p><p><img loading="lazy" alt="github-ci" src="/assets/images/github-ci-a6a8bfaf143484e079fd19a79207b6c2.png" width="2020" height="1370" class="img_E7b_"></p><p>CircleCI, Travis CI, Google Cloud Build 등 최근 트렌드한 도구들을 확인할 수 있다.  </p><p>이번 포스팅에서는 <code>CircleCI</code>를 <code>GitHub</code>과 연동해서 AWS ECR Push 및 EKS로 배포하는 간단한 Pipeline을 구성하는 방법을 적어보고자 한다.  </p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="circleci---github-accout-연동">CircleCI - GitHub Accout 연동<a class="hash-link" href="#circleci---github-accout-연동" title="Direct link to heading">​</a></h2><p><a href="https://circleci.com" target="_blank" rel="noopener noreferrer">circleci.com</a>에 접속하여 Sign Up을 진행하면 GitHub과 BitBucket 계정을 연동할 수 있는데 일반적인 GitHub 3rd Party OAuth연동 진행을 하게된다.  </p><p><img loading="lazy" alt="init" src="/assets/images/circleci-init-b44a7c81c0dbf4cf4ff0a4b775427186.png" width="2482" height="1928" class="img_E7b_"></p><p>위 그림처럼 모든 Repository가 확인되고 Follow할 Repository를 선택하면 초기 구성이 완료된다.  </p><p><img loading="lazy" alt="error" src="/assets/images/init-error-dde1c8ca577589b364d02c1f94c47230.png" width="2476" height="2024" class="img_E7b_"></p><p>첫 연동이 되면 Build를 진행하게 되는데 위 그림과 같이 error를 보게 되는데 이는 기본적으로 circleci가 필요로 하는 기본 설정값(.circleci/config.yaml)이 없어서 발생하는 오류이다.  </p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/sh -eo pipefail</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># No configuration was found in your project. Please refer to https://circleci.com/docs/2.0/ to get started with your configuration.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># -------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Warning: This configuration was auto-generated to show you the message above.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Don&#x27;t rerun this job. Rerunning will have no effect.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">false</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>위에서 보이는것 처럼 config를 체크하는것도 하나의 가상머신(컨테이너)이 진행하는데 CircleCI콘솔에서 <code>Spin up Environment</code> 로그를 보면 Docker(18.09.6)로 aws Linux기반으로 환경구성을 하는 것을 알 수 있다.</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">Build-agent version 1.0.11727-b0960fc9 (2019-05-23T02:12:54+0000)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Docker Engine Version: 18.09.6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Kernel Version: Linux 9a20a41aeae4 4.15.0-1035-aws #37-Ubuntu SMP Mon Mar 18 16:15:14 UTC 2019 x86_64 Linux</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Starting container bash:4.4.19</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  using image bash@sha256:9f0a4aa3c9931bd5fdda51b1b2b74a0398a8eabeaf9519d807e010b9d9d41993</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="circleci-grossary">CircleCI Grossary<a class="hash-link" href="#circleci-grossary" title="Direct link to heading">​</a></h2><p>아래 링크는 CircleCI에서 자주 사용하는 용어들을 따로 정리한 페이지이다.  주로 컨테이너 기반으로 동작하기 때문에 용어들은 Docker에서 사용하는 용어과 겹치는 부분이 많다.   </p><p><a href="https://circleci.com/docs/2.0/glossary/" target="_blank" rel="noopener noreferrer">https://circleci.com/docs/2.0/glossary/</a></p><p>위 링크 내용을 확인하면 <code>Orbs</code>라는 용어가 나오는데 이는 공유가능한 패키지로 Jenkins의 Plugin과 유사한 개념이라고 보면 된다. CircleCI에서 제공하는 자체 패키지 뿐만 아니라 3rd Party orbs를 제공하고 있다. </p><p>MacOS에서는 brew를 통해 cli를 설치하고 orb 리스트를 확인하거나 <a href="https://circleci.com/orbs/registry/" target="_blank" rel="noopener noreferrer">https://circleci.com/orbs/registry/</a>에서 확인할 수 있다.  </p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ brew install circleci</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ circleci orb list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Orbs found: 43. Showing only certified orbs.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Add --uncertified for a list of all orbs.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">circleci/android (0.1.0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">circleci/artifactory (1.0.0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">circleci/aws-cli (0.1.13)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">circleci/aws-code-deploy (0.0.9)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">circleci/aws-ecr (6.1.0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">circleci/aws-ecs (0.0.8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">circleci/aws-eks (0.1.0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">circleci/aws-s3 (1.0.11)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">circleci/jira (1.0.5)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">circleci/jq (1.9.0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">circleci/kubernetes (0.3.0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">circleci/lein-nvd (0.0.2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">circleci/maven (0.0.8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">circleci/node (1.0.1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">circleci/slack (3.2.0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">circleci/twilio (0.0.1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">circleci/welcome-orb (0.3.1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">In order to see more details about each orb, type: `circleci orb info orb-namespace/orb-name`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Search, filter, and view sources for all Orbs online at https://circleci.com/orbs/registry/</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="circle-architecture">Circle Architecture<a class="hash-link" href="#circle-architecture" title="Direct link to heading">​</a></h2><p><img loading="lazy" src="https://circleci.com/docs/assets/img/docs/arch.png" alt="circle-arch" class="img_E7b_"></p><p>GitHub 또는 Bitbucket에서 관리하는 Repository가 CircleCI 프로젝트로 승인되면 최초에는 컨테이너나 가상머신환경(2core 4GB)이 프로비저닝 되고 자동으로 테스트가 진행된다.  </p><p>테스트가 완료된 후 성공 또는 실패에 대한 Alert설정(Email, Slack)이 가능하고 각 단계(job, workflow)에 대한 결과는 각 단계별 세부 정보 페이지에서 확인할 수 있다.  </p><p>또한 배포는 AWS CodeDeploy, AWS ECS, AWS S3, AWS EKS, Google Kubernetes Engine (GKE) 및 Heroku 등 다양한 환경에 코드를 배포하도록 구성 할 수 있다. 이외의 클라우드 서비스 배포는 SSH를 통해 직접 사용하거나 terraform과 같은 도구를 가지고 해당 클라우드 서비스의 API통해 자동화가 가능한 구조로 되어있다.  </p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="circelci-aws-eks">CircelCI AWS EKS<a class="hash-link" href="#circelci-aws-eks" title="Direct link to heading">​</a></h2><p><a href="https://github.com/CircleCI-Public/circleci-demo-aws-eks" target="_blank" rel="noopener noreferrer">https://github.com/CircleCI-Public/circleci-demo-aws-eks</a></p><p>위 demo는 CircleCI를 이용하여 다음과 같은 workflow (상세내용 아래 config.yaml 참고)를 수행한다.  </p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2.1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">orbs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">aws-eks</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> circleci/aws</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">eks@0.1.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">aws-ecr</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> circleci/aws</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ecr@3.1.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">kubernetes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> circleci/kubernetes@0.3.0</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>공통적으로 orb를 3가지를 추가하였기 때문에 각단계마다 관련 orb를 추가하는 단계를 거치게 된다.</p><ol><li>환경설정 및 Docker Build 및 ECR로 Push<div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">workflows</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">deployment</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">jobs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">aws-ecr/build_and_push_image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> build</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">and</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">push</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">account-url</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> AWS_ECR_URL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">region</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> AWS_DEFAULT_REGION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">repo</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> eks_orb_demo_app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">dockerfile</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ~/project/demo_app/Dockerfile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ~/project/demo_app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">tag</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">CIRCLE_SHA1</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic"># repository가 없을 경우 생성하는 옵션</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic"># create-repo: true</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></li></ol><ul><li>environment variables 설정 <ul><li>Project - BUILD SETTINGS - Environment Variables 에서 Key-Value형태로 입력  <ul><li>AWS_DEFAULT_REGION : <code>us-west-2</code></li><li>AWS_ECR_URL : <code>219547004475.dkr.ecr.us-west-2.amazonaws.com/eks_orb_demo_app</code>  </li></ul></li></ul></li><li>github 연동 (ssh-key 연동 및 repo clone)</li><li>aws cli 설치 및 AWS Access, Secret Key설정</li><li>ECR Login</li><li>Image Build (<a href="https://github.com/ddiiwoong/circleci-demo-aws-eks/blob/master/demo_app/Dockerfile" target="_blank" rel="noopener noreferrer">https://github.com/ddiiwoong/circleci-demo-aws-eks/blob/master/demo_app/Dockerfile</a>)</li><li>Push Image to ECR</li></ul><ol><li>EKS클러스터 생성 (No Scripts)<div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">workflows</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">deployment</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">jobs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">aws-eks/create-cluster</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">cluster-name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> eks</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">orb</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">app</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">aws-region</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $AWS_DEFAULT_REGION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">requires</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> build</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">and</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">push</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">image</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></li></ol><ul><li>kops, kubectl, aws iam authenticator, aws cli 설치</li><li>kubectl config 설정 (aws iam authenticator)</li><li>eksctl 설치</li><li>eksctl로 클러스터 생성 및 검증 (Cloudformation)<ul><li>variables 사전 설정가능 ($AWS_DEFAULT_REGION)</li></ul></li></ul><ol start="2"><li>Demo Application 배포<div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">jobs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">deploy-application</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">executor</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> aws</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">eks/python3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">parameters</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">steps</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> checkout</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Create deployment manifest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">command</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token scalar string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">            BUILD_DATE=$(date &#x27;+%Y%m%d%H%M%S&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">            cat deployment/demo-app-deployment.yaml.template |\</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">              sed &quot;s|DOCKER_IMAGE_NAME|&lt;&lt; parameters.docker-image-name &gt;&gt;|\</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">                g;s|BUILD_DATE_VALUE|$BUILD_DATE|g;s|VERSION_INFO_VALUE|\</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">                &lt;&lt; parameters.version-info &gt;&gt;|g&quot; &gt; deployment/demo-app-deployment.yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">aws-eks/update-kubeconfig-with-authenticator</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">cluster-name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> &lt;&lt; parameters.cluster</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">name </span><span class="token punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">install-kubectl</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">aws-region</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> &lt;&lt; parameters.aws</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">region </span><span class="token punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">kubernetes/create-or-update-resource</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">resource-file-path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;deployment/demo-app-deployment.yaml&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">get-rollout-status</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">resource-name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> deployment/demoapp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">kubernetes/create-or-update-resource</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">resource-file-path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;deployment/demo-app-service.yaml&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">workflows</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">deployment</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">jobs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">deploy-application</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">cluster-name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> eks</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">orb</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">app</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">aws-region</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $AWS_DEFAULT_REGION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">docker-image-name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;${AWS_ECR_URL}/eks_orb_demo_app:${CIRCLE_SHA1}&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">version-info</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;${CIRCLE_SHA1}&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">requires</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> aws</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">eks/create</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">cluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></li></ol><ul><li>deployment manifest생성 (deployment template)</li><li>kops, kubectl, aws iam authenticator, aws cli 설치 (orb설정: aws-eks,kubernetes)</li><li>kubectl config 설정 (aws iam authenticator)</li><li>resource(deployment, service) 배포 (orb설정: aws-eks,kubernetes)</li><li>rollout 수행 (0-&gt;3)</li></ul><ol start="3"><li>application test<div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">workflows</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">deployment</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">jobs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">test-application</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> test</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">application</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">cluster-name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> eks</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">orb</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">app</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">aws-region</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $AWS_DEFAULT_REGION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">expected-version-info</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;${CIRCLE_SHA1}&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">requires</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> deploy</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">application</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">jobs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">test-application</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">executor</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> aws</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">eks/python3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">parameters</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">steps</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">aws-eks/update-kubeconfig-with-authenticator</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">cluster-name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> &lt;&lt; parameters.cluster</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">name </span><span class="token punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">install-kubectl</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">aws-region</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> &lt;&lt; parameters.aws</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">region </span><span class="token punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Wait for service to be ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">command</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token scalar string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">            kubectl get pods</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">            kubectl get services</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">            sleep 30</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">            for attempt in {1..20}; do</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">              EXTERNAL_IP=$(kubectl get service demoapp | awk &#x27;{print $4}&#x27; | tail -n1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">              echo &quot;Checking external IP: ${EXTERNAL_IP}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">              if [ -n &quot;${EXTERNAL_IP}&quot; ] &amp;&amp; [ -z $(echo &quot;${EXTERNAL_IP}&quot; | grep &quot;pending&quot;) ]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">                break</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">              fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">              echo &quot;Waiting for external IP to be ready: ${EXTERNAL_IP}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">              sleep 10</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">            done</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">            sleep 180</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">            curl -s --retry 10 &quot;http://$EXTERNAL_IP&quot; | grep &quot;&lt;&lt; parameters.expected-version-info &gt;&gt;&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></li></ol><ul><li>kops, kubectl, aws iam authenticator, aws cli 설치 (orb설정: aws-eks,kubernetes)</li><li>kubectl config 설정 (aws iam authenticator)</li><li>External IP 체크 및 curl 테스트</li></ul><ol start="4"><li>Demo Application 삭제<div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">jobs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">undeploy-application</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">executor</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> aws</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">eks/python3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">parameters</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">steps</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">aws-eks/update-kubeconfig-with-authenticator</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">cluster-name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> &lt;&lt; parameters.cluster</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">name </span><span class="token punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">install-kubectl</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">aws-region</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> &lt;&lt; parameters.aws</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">region </span><span class="token punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">kubernetes/delete-resource</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">resource-types</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;deployment,service&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">label-selector</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;app=demo&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">wait</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Check on pod status</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">command</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token scalar string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">            kubectl get pods</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">workflows</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">deployment</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">jobs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">undeploy-application</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">cluster-name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> eks</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">orb</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">app</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">aws-region</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $AWS_DEFAULT_REGION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">requires</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> test</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">application</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></li></ol><ul><li>kops, kubectl, aws iam authenticator, aws cli 설치 (orb설정: aws-eks,kubernetes)</li><li>kubectl config 설정 (aws iam authenticator)</li><li>deployment 삭제 및 상태 체크</li></ul><ol start="5"><li>EKS클러스터 삭제 (No Scripts)<div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">workflows</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">deployment</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">jobs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">aws-eks/delete-cluster</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">cluster-name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> eks</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">orb</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">app</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">aws-region</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $AWS_DEFAULT_REGION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">wait</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">requires</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> undeploy</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">application</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></li></ol><ul><li>kops, kubectl, aws iam authenticator, aws cli 설치 (orb설정: aws-eks,kubernetes)</li><li>kubectl config 설정 (aws iam authenticator)</li><li>eksctl 설치</li><li>eksctl로 클러스터 삭제 및 검증 (Cloudformation)</li></ul><p>상세 config는 다음 링크에서 확인할 수 있다.<br>
<a href="https://github.com/ddiiwoong/circleci-demo-aws-eks/blob/master/.circleci/config.yml" target="_blank" rel="noopener noreferrer">https://github.com/ddiiwoong/circleci-demo-aws-eks/blob/master/.circleci/config.yml</a></p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="pipeline-수행">pipeline 수행<a class="hash-link" href="#pipeline-수행" title="Direct link to heading">​</a></h2><p>위 Workflow를 수행하게 되면 마지막에 어플리케이션과 클러스터를 삭제하기 때문에 해당 workflow는 제외하고 수행한다. 해당 config를 commit하면 바로 해당 CI가 트리거 되어 시작되게 된다.</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># - undeploy-application:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">#     cluster-name: eks-orb-demo-app-deployment</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">#     aws-region: $AWS_DEFAULT_REGION</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">#     requires:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">#       - test-application</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># - aws-eks/delete-cluster:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">#     cluster-name: eks-orb-demo-app-deployment</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">#     aws-region: $AWS_DEFAULT_REGION</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">#     wait: true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">#     requires:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">#     - undeploy-application</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p><img loading="lazy" alt="result" src="/assets/images/workflow-result-1507577220f3902e6add662d37db5fcf.png" width="1218" height="473" class="img_E7b_"></p><p>클러스터 구성포함해서 총 20분정도 소요되었다. 실제 <code>eksctl</code>로 프로비저닝하게 되면 CloudFormation으로 수행되기 때문에 약 15-20분 정도 소요되니 간단한 빌드,배포,테스트는 5분정도 소요된것을 알 수 있다.  </p><p>삭제는 역순으로 진행하거나 위에 주석 처리된 영역만 수행하면 된다.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="정리">정리<a class="hash-link" href="#정리" title="Direct link to heading">​</a></h2><p>간단하게 CircleCI를 가지고 GitOps와 CI/CD를 구성하는 데모를 진행하였다.  </p><p>CircleCI는 Jenkins와 유사하지만 Public서비스이고 Slave관리에 대해서 의존적이지 않기 때문에 기존에 Jenkins를 사용한 경험이 있다면 아주 쉽게 구성할 수 있다.  </p><p><a href="https://circleci.com/docs/2.0/migrating-from-jenkins" target="_blank" rel="noopener noreferrer">https://circleci.com/docs/2.0/migrating-from-jenkins</a>를 참고하면 Jenkins와 차이점을 알 수 있는데 가장 큰 장점은 병렬로 테스트나 Job을 수행할수 있다는 점과 Lambda와 같은 서버리스 앱을 배포할때 정말 서버리스 환경으로 구성할수 있다는 점이다.  </p><p>이는 Git Repository를 연동할때도 Java Plugin을 설치해야하는 번거로움을 덜 수 있다. 가장 중요한건 SaaS라는 장점도 무시할수 없다. Travis 무료 플랜과 비교해도 작은 프로젝트의 경우 별도의 Docker environment(2core, 4GB)를 제공받기 때문에 지연없이 바로 빌드가 가능하다는 점이다.  </p><p>다음번 포스팅에는 terraform을 통해 ECR과 ECS로 배포하는 workflow를 살펴보려고 한다.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/dev-ops/">DevOps</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ci-cd/">CI/CD</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/pipeline/">Pipeline</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/circle-ci/">CircleCI</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/git-hub/">GitHub</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/git-ops/">GitOps</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/eks/">EKS</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about CircleCI - GitHub 연동 및 EKS 구성하기" href="/devops/circleci/"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/kubernetes/spinnaker-advanced-3/">Spinnaker on Kubernetes #3 (Kayenta)</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2018-12-04T00:00:00.000Z" itemprop="datePublished">December 4, 2018</time> · <!-- -->15 min read</div></header><div class="markdown" itemprop="articleBody"><p>3번째 포스팅이다.</p><p>11/23 &quot;Kubernetes Meetup&quot; 1Day에서 발표한 이야기 연장선으로 작성한다.</p><p>고객에게 오퍼링을 위해 준비한 내용과 Kubernetes monitoring과 연계한 내용에 대해서 적어보려고 한다.
최근 발표를 다니면서 많이 받는 질문이 실제 사용할만 한가?라는 질문과 어떻게 활용해야 하는지에 대한 질문들을 많이 받는다.
오늘 최근 Spinnaker Summit 2018에서 중요하게 다뤘던 Kayenta 프로젝트를 가지고 이야기 해보려고 한다. </p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="kayenta">Kayenta<a class="hash-link" href="#kayenta" title="Direct link to heading">​</a></h2><p>Kayenta는 자동 Canary 분석 오픈소스(Automated Canary Service(ACA))로 Spinnaker의 마이크로서비스중 하나로 동작한다.<br>
<!-- -->Automated Canary Deployments에 사용되고 자세한 내용은 <a href="https://www.spinnaker.io/guides/user/canary/stage/" target="_blank" rel="noopener noreferrer">canary documentation</a>을 확인하면 된다.  </p><p>새 종류의 하나인 Canary는 1차 세계대전중에 인간이 해를 입기 전에 독성가스를 탐지하는 용도로 사용되었다고 한다.
DevOps에서는 CD(Continuous Deployment) 프로세스의 일부로 사용되며 Canary 릴리즈는 새로운 버전의 Software를 Production에 배포하는 위험을 줄여주는 기술이라고 생각하면 된다.</p><p>Canary 신규 버전의 Software를 안정적인 기존 버전과 함께 배포하고 특정사용자나 일부 대상에게 트래픽 일부를 흘려 기존 사용자에게 영향을 최소하하고 새로운 버전의 문제를 신속하게 발견하고 이전의 안정된 버전으로 트래픽을 다시 라우팅시키는것이 주요 기능이라고 보면 된다.  </p><p>보통 품질 테스트 용도로 현재 운영 버전과 신규 버전의 주요한 지표(주로 Prometheus Metric)를 비교하여 평가를 진행하는데 이를 단위 테스트나 통합 테스트를 대체하여 사용해서는 절대 안된다.<br>
<!-- -->위에서 언급하였듯이 예기치 않은 위험을 최소화 하거나 문제를 신속하게 발견하는 것을 주 목적으로 하기 때문이다.</p><p>Spinnaker에서는 기본적으로 3가지 Cluster(Logical Application Group)를 사용한다.</p><ul><li>Production Cluster - 현재 실행중인 운영 버전으로 Replica는 임의로 변경할 수 있다. </li><li>Baseline Cluster - Production Cluster와 동일한 버전으로 실행됨</li><li>Canary Cluster - 변경된 신규 버전의 Software로 실행됨</li></ul><p>기본적으로 수동으로 진행할 경우에는 로그와 수집된 메트릭을 분석하고 객관적인 지표로 평가를 진행하는게 기본이다.
하지만 직접 사람이 하는 일이라 메트릭 데이터를 보다 보면 편견과 착오가 발생할 수 밖에 없다.</p><p>그래서 Netflix는 ACA(Automated Canary Service)라고 하는 자동화된 접근 방식을 통해 카나리 분석을 진행하고 있다.
수동으로 계산된 여러가지 지표를 가중치 기반으로 점수를 내리고 원하는 점수에 도달하면 배포하는 자동화된 방식이다.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="requirements">Requirements<a class="hash-link" href="#requirements" title="Direct link to heading">​</a></h2><ul><li>spinnaker cluster - 1.8+ (1.9.3 이상 추천)</li><li>halyard - 1.0+</li><li>kubernetes cluster - 1.9+</li><li>metric services - datadog, prometheus, stackdriver, signalfx</li><li>persistent storage - S3(or compatible S3), minio, GCS</li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="kayenta-service-추가하기">Kayenta Service 추가하기<a class="hash-link" href="#kayenta-service-추가하기" title="Direct link to heading">​</a></h2><p>이번 포스팅에서는 아래 환경으로 작성하였다.</p><ul><li>spinnaker cluster - 1.10.5</li><li>halyard - 1.11</li><li>kubernetes cluster - 1.9.7</li><li>metric services - prometheus</li><li>persistent storage - compatible S3(IBM Object Storage)</li></ul><p>일단 기존 halyard config를 백업하자. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ hal backup create</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+ Create backup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Success</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+ Successfully created a backup at location:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/Users/ddii/halbackup-Wed_Nov_28_13-35-31_KST_2018.tar</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>나중에 복구는 아래와 같이 하면 된다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ hal backup restore --backup-path &lt;backup-name&gt;.tar</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>기존 halyard config를 살펴보면 아래와 같이 canary.enabled=false 로 되어있는 것을 확인 할수 있다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">currentDeployment: default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deploymentConfigurations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- name: default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  canary</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    enabled: false</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>canary analysis을 활성화 한다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ hal config canary enable</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>그리고 default judgement algorithm은 <code>NetflixACAJudge-v1.0</code> 로 되어있다 다른 걸 이용하려면 다음과 같이 설정할수 있다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ hal config canary edit --default-judge CUSTOM_JUDGE</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>메트릭 소스로 prometheus를 설정한다. 물론 기존에 사용중인 prometheus endpoint url이 필요하다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">hal config canary prometheus enable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hal config canary prometheus account add my-prometheus --base-url http://YOUR_PROMETHEUS_SERVER:PORT</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>여기서는 IBM Cloud Object Storage(S3 Compatible)을 사용하였지만 aws로 설정한다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ hal config canary aws enable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ hal config canary aws account add my-s3 --bucket spin-bucket --endpoint \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    s3.seo-ap-geo.objectstorage.service.networklayer.com --access-key-id ACCESS_ID \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --secret-access-key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ hal config canary aws edit --s3-enabled=true</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>여러개의 메트릭을 동시에 설정 및 수집이 가능하므로 그중 prometheus 및 관련 account를 기본으로 설정한다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ hal config canary edit --default-metrics-store prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ hal config canary edit --default-metrics-account my-prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ hal config canary edit --default-storage-account my-s3</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>모든 spinnaker cluster가 준비된 상태의 컨피그는 아래와 같다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">currentDeployment: default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deploymentConfigurations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- name: default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  canary:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    enabled: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    serviceIntegrations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - name: google</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      enabled: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      accounts: []</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      gcsEnabled: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      stackdriverEnabled: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - name: prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      enabled: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      accounts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - name: my-prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        endpoint:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          baseUrl: http://YOUR_PROMETHEUS_SERVER:PORT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        supportedTypes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - METRICS_STORE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - name: datadog</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      enabled: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      accounts: []</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - name: aws</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      enabled: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      accounts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - name: my-s3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        bucket: spin-bucket</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rootFolder: kayenta</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        endpoint: s3.seo-ap-geo.objectstorage.service.networklayer.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        accessKeyId: ACCESS_ID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        secretAccessKey: ACCESS_KEY</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        supportedTypes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - OBJECT_STORE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - CONFIGURATION_STORE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      s3Enabled: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    reduxLoggerEnabled: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    defaultMetricsAccount: my-prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    defaultStorageAccount: my-s3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    defaultJudge: NetflixACAJudge-v1.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    defaultMetricsStore: prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    stagesEnabled: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    templatesEnabled: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    showAllConfigsEnabled: true</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Spinnaker Cluster를 재배포하게 되면 아래와 같이 spin-kayenta deployments가 추가된 것을 확인할 수 있다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ hal deploy apply</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                READY     STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spin-clouddriver-555cfc9765-kvnl8   1/1       Running   0          6d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spin-deck-85845b5b48-49ncm          1/1       Running   0          6d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spin-echo-5f9dd4d8ff-mvt7g          1/1       Running   0          6d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spin-fiat-5b945645d8-s2qcq          1/1       Running   0          6d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spin-front50-5c57fcf587-tqz28       1/1       Running   0          6d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spin-gate-57576b8c45-w5v6r          1/1       Running   0          6d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spin-kayenta-6dcd7767d6-rgb9w       1/1       Running   0          6d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spin-orca-788df6b9cc-tk6lk          1/1       Running   0          6d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spin-redis-6c87c456fc-6qbl2         1/1       Running   0          6d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spin-rosco-f6f845d49-btjnd          1/1       Running   0          6d</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>이후 Dashboard에 접속하고 application중 하나의 Config에 들어가면 Features에 Canary메뉴가 생긴것을 확인할 수 있다. 사용설정하고 캐싱하는데 시간이 다소 필요하고 Tasks 메뉴에서 해당 job에 대한 내용을 확인할수 있다. </p><p><img loading="lazy" alt="canary" src="/assets/images/canary_config-57ef01bd86dbbbe0b3463b2bb83c0243.png" width="1045" height="603" class="img_E7b_"></p><p>이후 application delivery 메뉴를 보면 pipelines, canary configs, canary reports라는 메뉴가 생기게 된다. </p><p><img loading="lazy" alt="delivery" src="/assets/images/delivery-eef9175b5a136e62f7cd72a689bcefde.png" width="766" height="169" class="img_E7b_"></p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="simple-deploy-pipeline-추가">simple deploy pipeline 추가<a class="hash-link" href="#simple-deploy-pipeline-추가" title="Direct link to heading">​</a></h2><p><a href="https://cloud.google.com/solutions/automated-canary-analysis-kubernetes-engine-spinnaker" target="_blank" rel="noopener noreferrer">https://cloud.google.com/solutions/automated-canary-analysis-kubernetes-engine-spinnaker</a> 가이드 처럼 구성해봐도 되나 <code>stackdriver</code>를 써야하고 <code>prometheus metric</code>을 활용한 가이드가 필요해서 적어보고자 한다.</p><p>새로 파이프라인을 추가한 다음 </p><p><img loading="lazy" alt="newpipe" src="/assets/images/newpipe-d4e9f69e18fde50d33ae018234d68016.png" width="595" height="261" class="img_E7b_"></p><p>Pipeline Actions - Edit Pipeline JSON 에서
<a href="https://raw.githubusercontent.com/ddiiwoong/canary-demo-spinnaker/master/simple-deploy.json" target="_blank" rel="noopener noreferrer">https://raw.githubusercontent.com/ddiiwoong/canary-demo-spinnaker/master/simple-deploy.json</a> 을 추가해준다.  </p><p>해당 json pipeline을 추가하고 나면 다음과 같은 화면을 확인할수 있다.
<img loading="lazy" alt="pipe1" src="/assets/images/samplepipe1-fb6117126a3a4c5b9d9f314a19f0aad9.png" width="1151" height="1314" class="img_E7b_">
<img loading="lazy" alt="pipe2" src="/assets/images/samplepipe2-8387265c6cb69906e7cb8adc4c304432.png" width="1058" height="871" class="img_E7b_"></p><p>반드시 Deploy Config, Deploy Stage에서 배포할 Account 지정을 해야한다. </p><p><code>sampleapp image - ddiiwoong/canary-demo-spinnaker:latest</code></p><p>해당 pipeline내의 sampleapp은 python flask 기반으로 구성되어 간단히 internal 500 error를 원하는 비율을 configmap 변수로 구현할 수 있다. <a href="https://github.com/prometheus/client_python#counter" target="_blank" rel="noopener noreferrer">prometheus python client</a>를 사용하여 Gauge, Counter, Metric 서버를 간단하게 구성을 해보았다. 그리고 코드내에서 500 error rate를 구한 이유는 18년 11월 기준 spinnaker kayenta 버전에서는 PromQL(rate,irate와 같은 함수) 지원이 되지 않는다. 개발중인 코드에 포함이 된것을 확인하였고 12월 kubecon때 정식 릴리즈에 포함될거라 생각한다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">#!/usr/bin/env python</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from random import randrange</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from flask import Flask</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from prometheus_client import start_http_server, Gauge, Counter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import os</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">app = Flask(&#x27;kayenta-tester&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">c = Counter(&#x27;requests&#x27;, &#x27;Number of requests served, by http code&#x27;, [&#x27;http_code&#x27;])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">g = Gauge(&#x27;rate_requests&#x27;, &#x27;Rate of success requests&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">responce_500 = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">responce_200 = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rate_responce = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@app.route(&#x27;/&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def hello():</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    global responce_500</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    global responce_200</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    global rate_responce</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if randrange(1, 100) &gt; int(os.environ[&#x27;SUCCESS_RATE&#x27;]):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        c.labels(http_code=&#x27;500&#x27;).inc()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        responce_500 = responce_500 + 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rate_responce = responce_500 / (responce_500+responce_200) * 100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        g.set(rate_responce)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return &quot;Internal Server Error\n&quot;, 500</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        c.labels(http_code = &#x27;200&#x27;).inc()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        responce_200 = responce_200 + 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rate_responce = responce_500 / (responce_500+responce_200) * 100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        g.set(rate_responce)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return &quot;Hello World!\n&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">start_http_server(8000)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">app.run(host = &#x27;0.0.0.0&#x27;, port = 8080)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>해당앱을 Start Manual Execuction을 통해 배포한다. Comfirm Execution창에서 SUCCESS_RATE를 원하는 값(예:70%)으로 선택하고 배포를 하고 나면 Infrastructure - Clusters 메뉴에서 해당 샘플앱을 확인할 수 있다. </p><p><img loading="lazy" alt="manaul deploy" src="/assets/images/manual-e2292b9d8cb972b8689b76e151c51dae.png" width="1199" height="389" class="img_E7b_">
<img loading="lazy" alt="success rate" src="/assets/images/successrate-85ead10953b6d655a150d6471669df12.png" width="1212" height="483" class="img_E7b_">
<img loading="lazy" alt="manaul deploy2" src="/assets/images/manual2-7342db27f311edd70cc2d1b07d7c8500.png" width="938" height="383" class="img_E7b_"></p><p>실제 해당 서비스를 접속해보면 위에 설정한 SUCCESS_RATE 비율로 200화면과 500에러를 확인할 수 있다. </p><p><img loading="lazy" alt="flaskweb" src="/assets/images/flaskweb-99e15d6c7aaf0a8305fd3fad53916d95.png" width="606" height="176" class="img_E7b_">
<img loading="lazy" alt="flaskweb2" src="/assets/images/flaskweb2-ca32501038173b934174ce58ecea90a5.png" width="614" height="162" class="img_E7b_"></p><p>해당 메트릭의 통계를 확인하기 위해 curl을 반복적으로 실행하는 injection container 를 실행한다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl -n default run injector --image=alpine -- \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /bin/sh -c &quot;apk add --no-cache --yes curl; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    while true; do curl -sS --max-time 3 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    http://sampleapp:8080/; done&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>5분정도 후에 Prometheus로 접속하여 코드내 작성한 rate_requests 메트릭을 확인해본다.<br>
<!-- -->PromQL은 아래 쿼리를 실행하였다.  </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">rate_requests{app=&quot;sampleapp&quot;,version=&quot;prod&quot;}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>아래 그림과 같이 4개의 pod에서 70% 정도 200 OK, 30% 정도 500 Error가 발생하는 것을 확인할 수 있다. </p><p><img loading="lazy" alt="500rate" src="/assets/images/500rate-09760c0ab86a09095865edd35592cec8.png" width="1215" height="837" class="img_E7b_"></p><p>이 메트릭을 Spinnaker 에서 확인하기 위해 Canary Pipeline을 만들자.</p><p><a href="https://raw.githubusercontent.com/ddiiwoong/canary-demo-spinnaker/master/automated-canary.json" target="_blank" rel="noopener noreferrer">https://raw.githubusercontent.com/ddiiwoong/canary-demo-spinnaker/master/automated-canary.json</a>를 JSON으로 Pipeline을 생성한다. </p><p><img loading="lazy" alt="canary_auto" src="/assets/images/canary_auto-b1920304073dfe8192b4b35af39902ad.png" width="996" height="471" class="img_E7b_"></p><p>Stage별로 살펴 보기전에 </p><ul><li>Prerequisite<br>Canary Config 구성이 먼저 필요하다. Delivery - Canary Configs 메뉴에서 신규 컨피그를 작성한다. <ul><li>Configuration Name - <code>kayenta-test</code></li><li>Filter Templates 메뉴를 먼저 생성한다. Canary, Baseline구분을 위해 version 정보를 선택하였다. </li><li>Metrics - Add Metric 은 분석을 위한 Prometheus Metric을 설정하는 단계로 <code>error_rate</code>가 증가(increase)하면 Pipeline을 중단시키고 Metric은 앞에서 확인한 <code>rate_requests</code>를 지정한다. Filter Template은 위에서 지정한 version을 선택한다. <img loading="lazy" alt="metric config" src="/assets/images/metric_config-cf291dbd8899fdbbbc5c6ccad0f45988.png" width="894" height="663" class="img_E7b_"></li><li>SCORING - 어짜피 예제는 한가지 Metric분석으로 0점 아니면 100점으로 나올것이므로 Maginal 75, Pass 95를 설정한다.</li></ul></li></ul><ol><li>1st Stage<ul><li>Configuration - Pipeline 실행시 초기 입력값(0-100, 10단위)으로 설정가능한 successRate 라는 Parameter를 설정한다. </li></ul></li><li>2nd Stage<ul><li>Find Baseline - 위에서 작성한 기본 Deploy Pipeline이 선택되었는지와 확인한다.</li><li>Deploy Canary Config - 앞에서 선택한 새로운 Parameter(successRate)를 신규 배포할 Canary Pod ConfigMap으로 설정하는 단계이다.</li></ul></li><li>3rd Stage<ul><li>Deploy Canary - yaml manifest로 Canary 버전을 배포한다. Replicas는 1로 설정하였고 배포될 Account(K8s Cluster)를 지정한다. </li><li>Deploy Baseline - yaml manifest로 Baseline 버전을 배포한다. 위와 동일하게 Replicas는 1로 설정하였고 배포될 Account(K8s Cluster)를 지정한다. </li></ul></li><li>4th Stage<ul><li>Canary Analysis - 중요한 Canary 분석 단계로 아래와 같이 설정을 확인한다. Prerequisite에서 설정한 Config(<code>kayenta-test</code>)를 선택하고 짧은 분석을 위해 1분(60초) 간격으로 3번 수행을 하도록 한다.   Filter Template에서 지정한 version(<code>version=&quot;${scope}&quot;</code>) 분석을 위해 Baseline, Canary 설정을 하고 Location은 Namespaces로 생각하면 된다. <img loading="lazy" alt="aca config" src="/assets/images/aca_config-a0aaf5a5c7a7867a01913ee1d9cca704.png" width="720" height="947" class="img_E7b_"></li></ul></li><li>5th Stage<ul><li>Deploy to Production - Canary 분석이 통과하였을 경우 운영에 배포</li><li>Delete Canary, Delete Baseline - 성공이던 실패이던 Canary, Baseline 배포본을 삭제 </li></ul></li><li>6th Stage<ul><li>Successful deployment - Canary 분석이 통과하였을 경우 최종 완료 표기하는 단계</li></ul></li></ol><p>설정이 마무리가 되면 저장을 하고 Canary 분석에 들어간다.
최초에 <code>successRate</code>을 70으로 배포했다면 그 이하로 설정했을 경우에는 아래와 같이 Score 0점으로 배포가 실패하고 Pipeline이 종료된다.   </p><p><img loading="lazy" alt="fail" src="/assets/images/canary_fail-6eb5d2e8dc82e42f62b21d41acce9f6f.png" width="853" height="1001" class="img_E7b_">  </p><p>70 이상으로 설정하게 되면 Score 100점으로 정상 배포됨을 확인할 수 있다.</p><p><img loading="lazy" alt="success" src="/assets/images/canary_success-27d5394bff7c7d0c7e17dd2697c2d267.png" width="865" height="793" class="img_E7b_">  </p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="정리">정리<a class="hash-link" href="#정리" title="Direct link to heading">​</a></h2><p>간단하게 Spinnaker 와 Prometheus Metric을 활용하여 Kayenta 기반 Canary 배포를 해봤다. 현재 Spinnaker 1.10에서 istio가 지원된다고 하니 다시 한번 확인하고 istio 기반 canary 배포와 함께 사용하는 방법을 더 연구해봐야 할 것 같다.  </p><p>올해 AWS re:invent 끝나고 작년보다 큰 현자타임이 왔다. 오픈소스로 먹고사는 사람들의 기분은 다 비슷할거 같다고 생각이 든다. 12월 11일 부터 Kubecon이 열린다고 하니 Kubernetes 관련한 새로운 프로젝트와 기능들에 집중해서 남들보다 한발 나아가야하지 않을까? 오픈소스로 먹고사시는 분들 다들 힘냈으면 좋겠다.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ci-cd/">CI/CD</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/kubernetes/">Kubernetes</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/spinnaker/">Spinnaker</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/continuous-delivery/">Continuous Delivery</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/continuous-deployment/">Continuous Deployment</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/pipeline/">Pipeline</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/canary/">Canary</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/canary-analysis/">Canary analysis</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/kayenta/">Kayenta</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/automated-canary-service/">Automated Canary Service</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Spinnaker on Kubernetes #3 (Kayenta)" href="/kubernetes/spinnaker-advanced-3/"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/kubernetes/spinnaker-advanced-2/">Spinnaker on Kubernetes #2</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2018-09-27T00:00:00.000Z" itemprop="datePublished">September 27, 2018</time> · <!-- -->8 min read</div></header><div class="markdown" itemprop="articleBody"><p>이전 포스팅 <a href="https://ddii.dev/kubernetes/spinnaker-advanced-1/" target="_blank" rel="noopener noreferrer">Spinnaker on Kubernetes #1</a>에서 검토할때는 많이 개념을 이해하기 어려웠던것 같지만 어느정도 시간이 지났고 또 몇일 후에 발표도 있어서 다른 이야기를 해보고자 한다.  </p><p>지난 포스팅에 대충 집고 넘어간 용어들에 대한 정리를 다시 하고 기본적인 사상들을 정리해보고자 한다. 허접한 플랫폼 엔지니어 생각이니 언제든 다른 의견을 환영하는 바이다. </p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="what-is-spinnaker-history">What is spinnaker? (+History)<a class="hash-link" href="#what-is-spinnaker-history" title="Direct link to heading">​</a></h2><p>최근 트렌드인 멀티 클라우드를 지향하는 오픈소스 플랫폼이다.<br>
<!-- -->2014년 Netflix의 Asgard로 시작되어 2015년에 오픈소스화 되었다.<br>
<!-- -->빠른 속도와 신뢰도있는 소프트웨어 릴리즈를 위해 만들어졌으며 대부분의 메이저 클라우드 프로바이더들을 지원한다.(AWS,GCP,Azure,openstack..)<br>
<!-- -->현재 Netflix, Google, MS, Veritas등이 Contribution을 하고 있다.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="왜-spinnaker를-써야하지">왜 Spinnaker를 써야하지?<a class="hash-link" href="#왜-spinnaker를-써야하지" title="Direct link to heading">​</a></h2><p>여러가지 이유가 있겠지만</p><ul><li>Multi-Cloud용 Continuous Delivery/Deployment Platform 으로 대체가 가능</li><li>다양한 pipeline 형태로 배포가 가능하고 Rollback이 쉬움</li><li>빠른 배포가 가능하고 여러번 배포가 용이함</li><li>유연한 pipeline management system을 가지고 있음</li><li>다양한 배포전략을 가진다(Blue-Green, Rolling Red/Black, Canary)</li><li>community 활동 활발 (github, slack) - 답은 잘 안해줌 ㅠㅠ</li><li>VM과 Container 동시에 통합관리 가능</li><li>CI통합 용이(Jenkins)</li><li>CLI를 통한 설치 및 관리(halyard)</li><li>VM, Helm Packaging 가능</li><li>RBAC 지원</li><li>Notification - Email, Slack, Hipchat등</li><li>Safe Deployment - Judgement (승인기능)</li><li>Chaos Monkey Built-in</li></ul><p>이정도면 무조건 써야하지 않을까?</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="jenkins-vs-spinnaker">Jenkins vs Spinnaker<a class="hash-link" href="#jenkins-vs-spinnaker" title="Direct link to heading">​</a></h2><table><thead><tr><th align="center">Jenkins</th><th align="center">Spinnaker</th></tr></thead><tbody><tr><td align="center">강력한 빌드서버</td><td align="center">클라우드 자원의 1차 연동</td></tr><tr><td align="center">완전한 deployment tool이 아님</td><td align="center">vm &amp; deployments 안에 빌드되어 있음</td></tr><tr><td align="center">스크립팅이 많이 필요함</td><td align="center">별도의 스크립팅이 많이 필요없음</td></tr><tr><td align="center">기능들이 모두 플러그인 형태</td><td align="center">CI tool이 아님(CI tools이 백엔드로)</td></tr></tbody></table><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="kubernetes-vs-spinnaker">Kubernetes vs Spinnaker<a class="hash-link" href="#kubernetes-vs-spinnaker" title="Direct link to heading">​</a></h2><table><thead><tr><th align="center">Kubernetes</th><th align="center">Spinnaker</th></tr></thead><tbody><tr><td align="center">리소스 사용 제한</td><td align="center">정의한 퍼센트로 rollout</td></tr><tr><td align="center">slow rollout</td><td align="center">각 단계별 검증 가능</td></tr><tr><td align="center">High rollback cost</td><td align="center">Fast rollbacks</td></tr><tr><td align="center">Linear rollouts</td><td align="center">resource 사용량이 큼</td></tr><tr><td align="center">검증단계가 없음</td><td align="center"></td></tr></tbody></table><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="deploy-pipeline">Deploy Pipeline<a class="hash-link" href="#deploy-pipeline" title="Direct link to heading">​</a></h2><p>Spinnaker를 사용할때 기본적으로 아래와 같은 파이프라인으로 구성한다.<br>
<!-- -->수동으로 UI나 API로 트리거링할수 있고, 자동으로 Jenkins 등과 트리거 연동하여 빌드완료시 배포되도록 할수 있다.</p><p><img loading="lazy" alt="spinnaker-pipeline" src="/assets/images/spinnaker-pipeline-7b27fbf5bddf6d0c506c5f20a8a9f36a.png" width="942" height="399" class="img_E7b_"></p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="deployment-strategies">Deployment Strategies<a class="hash-link" href="#deployment-strategies" title="Direct link to heading">​</a></h2><p>Spinnaker에서의 배포전략은 다음과 같이 제공된다.</p><p><img loading="lazy" src="https://www.spinnaker.io/concepts/deployment-strategies.png" alt="deployment-strategies" class="img_E7b_"></p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="red--black-same-as-blue--green">Red / Black (same as Blue / Green)<a class="hash-link" href="#red--black-same-as-blue--green" title="Direct link to heading">​</a></h3><ul><li>동일한 양의 instance로 이루어진 새로운 Server Group을 생성한다</li><li>신규 Server Group이 정상상태가 되면 LB는 신규 Server Group에 트래픽을 분산한다. </li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="rolling-redblack">Rolling red/black<a class="hash-link" href="#rolling-redblack" title="Direct link to heading">​</a></h3><ul><li>이전과 동일하지만 인스턴스별 또는 그룹별로 rolling</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="canary">Canary<a class="hash-link" href="#canary" title="Direct link to heading">​</a></h3><ul><li>가장 작은 개수의 인스턴스를 교체시키고</li><li>새로운 버전으로 트래픽을 분산시킨다 (1~5프로)</li><li>새로운 버전에 이슈가 없을때까지 테스트를 진행하고</li><li>특정시간까지 이슈가 없으면 배포를 늘려간다. </li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="용어정리-2탄">용어정리 2탄<a class="hash-link" href="#용어정리-2탄" title="Direct link to heading">​</a></h2><p>이전 <a href="https://ddiiwoong.github.io/2018/spinnaker-advanced-1/" target="_blank" rel="noopener noreferrer">post</a>에서 정리한걸 다시 복기하고 추가적인 내용을들 적어봤다.</p><p>사용하면서 혼돈이 많이 생기는 부분이다 이게 GCE나 EC2를 쓰면 용어 매칭이 쉬운데 k8s를 위한 별도의 메뉴가 아닌 기능을 통합하다보니 용어가 조금 혼동스럽게 구성이 되었다.<br>
<!-- -->특히 Load Balancer 부분은 Service로 매핑되고 퍼블릭 k8s에서 제공하는 Type LoadBalancer는 미지원한다.<br>
<!-- -->그리고 모든 Resource들은 Deploy, Delete, Scale, Rollout(Undo, Pause, Resume)을 지원하며 Versioning이 지원된다.  Versioning은 <a href="https://www.spinnaker.io/reference/providers/kubernetes-v2/#strategy" target="_blank" rel="noopener noreferrer">여기</a>에 설명된 대로 <code>strategy.spinnaker.io/versioned</code> annotation을 통해 manifest별로 재정의가 가능하다.</p><table><thead><tr><th align="center">Spinnaker</th><th align="center">Kubernetes</th><th align="center">비고</th></tr></thead><tbody><tr><td align="center">Server Group</td><td align="center"><a href="https://www.spinnaker.io/reference/providers/kubernetes-v2/#workloads" target="_blank" rel="noopener noreferrer">Workloads</a></td><td align="center"><a href="https://www.spinnaker.io/guides/developer/crd-extensions/" target="_blank" rel="noopener noreferrer">CRD의 경우 별도 Build</a></td></tr><tr><td align="center">Clusters</td><td align="center">Logical Server Group</td><td align="center"></td></tr><tr><td align="center">Load Balancer</td><td align="center">Services</td><td align="center">LoadBalancer(k8s) 미지원</td></tr><tr><td align="center">Firewall</td><td align="center">NetworkPolicies</td><td align="center"></td></tr></tbody></table><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="application-management">Application Management<a class="hash-link" href="#application-management" title="Direct link to heading">​</a></h3><p>Spinnaker에서 Application 이란 배포하려는 서비스를 나타내는 구조라 생각하면 된다.  </p><ul><li>pipeline</li><li>Clusters, Server Group의 집합이며, firewall과 loadbalancer를 포함한다.</li><li>Canary Config</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="cluster">Cluster<a class="hash-link" href="#cluster" title="Direct link to heading">​</a></h3><p>Kubernetes의 Cluster가 아니라 Spinnaker에서 Server Group의 논리적인 그룹</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="server-group">Server Group<a class="hash-link" href="#server-group" title="Direct link to heading">​</a></h3><p>기본자원인 서버그룹은 배포할수 있는 artifacts(vm image, docker image, source)와 인스턴스(pod) 수, Auto-Scaling, metadata 등 기본 구성등을 가지고 있다.<br>
<!-- -->서버그룹은 LoadBalacer나 Firewall 도 선택적으로 연결되고, vm이나 pod 형태로 배포된 application의 집합체라 볼수 있다.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="cloud-provider">Cloud Provider<a class="hash-link" href="#cloud-provider" title="Direct link to heading">​</a></h3><ul><li>IaaS - AWS, GCP, Azure, Oracle, Openstack</li><li>PaaS -  Google App Engine</li><li>Orchestrator - K8s, DC/OS</li><li>Docker v2 Registry</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="account">Account<a class="hash-link" href="#account" title="Direct link to heading">​</a></h3><p>Cloud Provider에 인증하기 위한 Spinnaker에서만 사용하는 Account Name</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="pipeline">Pipeline<a class="hash-link" href="#pipeline" title="Direct link to heading">​</a></h3><p>Pipeline은 주요 배포 관리도구로 사용된다.
Stage라고하는 일련의 Action으로 구성되며 파이프라인을 따라 Stage간 매개변수 전달이 가능하다.<br>
<!-- -->수동으로 시작하거나, Jenkins 작업완료, Docker Registry 신규 Docker 이미지, Cron일정 또는 다른 Stage와 같은 이벤트에 의해 자동으로 트리거링되도록 구성할수 있다.<br>
<!-- -->Pipeline 실행중에(시작/완료/실패) mail, slack, hipchat(사라짐)을 통해 Alert가 가능하다.</p><p><img loading="lazy" src="https://www.spinnaker.io/concepts/pipelines.png" alt="pipeline" class="img_E7b_"></p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="stage-atomic-building-block">Stage (atomic building block)<a class="hash-link" href="#stage-atomic-building-block" title="Direct link to heading">​</a></h3><p>Pipeline이 수행할 동작을 말한다.<br>
<!-- -->Deploy, Resize, Disable, Manual Judgement 등을 수행할수 있다.</p><p><img loading="lazy" src="https://www.spinnaker.io/concepts/pipelines/pipeline-tasks.png" alt="stage" class="img_E7b_"></p><ul><li>Stage - Multiple steps</li><li>Step - 진행되기전에 교정/폴링이 필요한 tasks</li><li>Task - 특정 Cloud Platform으로 동시에 여러 API호출</li><li>Operation - 단위 API</li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="정리">정리<a class="hash-link" href="#정리" title="Direct link to heading">​</a></h2><p>용어나 개념은 어느정도 정리된듯 하고 다음 포스팅에서는 실제 multi cluster 환경에서 deploy하고 pipeline을 사용하는 내용을 적어볼 예정이다.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ci-cd/">CI/CD</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/kubernetes/">Kubernetes</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/spinnaker/">Spinnaker</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/continuous-delivery/">Continuous Delivery</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/continuous-deployment/">Continuous Deployment</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/pipeline/">Pipeline</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Spinnaker on Kubernetes #2" href="/kubernetes/spinnaker-advanced-2/"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/kubernetes/spinnaker-advanced-1/">Spinnaker on Kubernetes #1</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2018-07-03T00:00:00.000Z" itemprop="datePublished">July 3, 2018</time> · <!-- -->4 min read</div></header><div class="markdown" itemprop="articleBody"><p>지난번 <a href="https://www.slideshare.net/openstack_kr/openinfra-days-korea-2018-track-4-provisioning-dedicated-game-server-on-kubernetes-cluster" target="_blank" rel="noopener noreferrer">OpenInfraDay발표</a>때 질문을 해주셨는데 요즘 Spinnaker를 많이들 쓰거나 검토를 많이 하는것으로 알고 있다.  </p><p>Spinnaker를 설치하는 내용은 많이 있으니 아래 halyard로 설치하는 포스트를 참고하면 된다.</p><p><a href="https://yunsangjun.github.io/blog/spinnaker/2018/06/03/installing-spinnaker.html" target="_blank" rel="noopener noreferrer">윤상준의 기술 블로그 - Spinnaker 설치하기</a></p><p>이번에 이야기하고자 하는 부분은 실제 Spinnaker를 설치하고 난 후 운영상에 고려해야할 부분들과 팁들을 공유해보려고 한다.</p><p>사실 Spinnaker를 구성하면서 가장 어려웠던 부분들은 용어, halyard config 관리와 custom resourse 인식부분 이였다. 나머지들은 뭐 튜토리얼을 따라가면 별로 어렵진 않으니 아래 내용을 차근차근 따라가면서 이해하면 될것 같다. </p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="용어들">용어들<a class="hash-link" href="#용어들" title="Direct link to heading">​</a></h2><p>사용하면서 혼돈이 많이 생기는 부분이다 이게 GCE나 EC2를 쓰면 용어 매칭이 쉬운데 k8s를 위한 별도의 메뉴가 아닌 기능을 통합하다보니 용어가 조금 혼동스럽게 구성이 되었다.<br>
<!-- -->특히 Load Balancer 부분은 Service로 매핑되고 퍼블릭 k8s에서 제공하는 Type LoadBalancer는 미지원한다.<br>
<!-- -->그리고 모든 Resource들은 Deploy, Delete, Scale, Rollout(Undo, Pause, Resume)을 지원하며 Versioning이 지원된다.  Versioning은 <a href="https://www.spinnaker.io/reference/providers/kubernetes-v2/#strategy" target="_blank" rel="noopener noreferrer">여기</a>에 설명된 대로 <code>strategy.spinnaker.io/versioned</code> annotation을 통해 manifest별로 재정의가 가능하다.</p><table><thead><tr><th align="center">Spinnaker</th><th align="center">Kubernetes</th><th align="center">비고</th></tr></thead><tbody><tr><td align="center">Server Group</td><td align="center"><a href="https://www.spinnaker.io/reference/providers/kubernetes-v2/#workloads" target="_blank" rel="noopener noreferrer">Workloads</a></td><td align="center"><a href="https://www.spinnaker.io/guides/developer/crd-extensions/" target="_blank" rel="noopener noreferrer">CRD의 경우 별도 Build</a></td></tr><tr><td align="center">Clusters</td><td align="center">Logical Server Group</td><td align="center"></td></tr><tr><td align="center">Load Balancer</td><td align="center">Services</td><td align="center">LoadBalancer(k8s) 미지원</td></tr><tr><td align="center">Firewall</td><td align="center">NetworkPolicies</td><td align="center"></td></tr></tbody></table><p>Spinnaker Server Group으로 분류 된 항목은 모두 Spinnaker의 클러스터 탭에 표시가 된다. 가능한 경우 모든 포드가 표기되지만, 해당 <a href="https://www.spinnaker.io/reference/providers/kubernetes-v2/#workloads" target="_blank" rel="noopener noreferrer">Workloads</a> 이외의 CRD(Custom Resource Definition)는 halconfig에서 아래와 같이 customResources config를 추가하면 deploy는 가능하나 Spinnaker UI에서 보이지는 않는다.  </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubernetes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      enabled: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      accounts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - name: my-k8s-account</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        customResources:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - kubernetesKind: GameServer</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>이유는 바로 다음 링크처럼 <a href="https://www.spinnaker.io/guides/developer/crd-extensions/" target="_blank" rel="noopener noreferrer">(CRD의 경우 별도 Build필요)</a>
별도로 Java를 빌드해야 한다. Spinnaker Slack에 문의를 몇번했는데 질문하는 사람만 있고 답은 아무도 안해준다는...<br>
<a href="https://spinnakerteam.slack.com/" target="_blank" rel="noopener noreferrer">https://spinnakerteam.slack.com/</a></p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="jenkins-연동">Jenkins 연동<a class="hash-link" href="#jenkins-연동" title="Direct link to heading">​</a></h2><p><a href="https://www.spinnaker.io/setup/ci/jenkins/" target="_blank" rel="noopener noreferrer">Spinnaker, Jenkins integration 상세내용 공식문서 </a></p><p>Jenkins와 연동하면서 가장 어이없이 헤맨부분은 아래 그림처럼 되어있어야 하는데 Security Realm을 Jenkins Default admin 계정만을 가지고 integration 하려다가 계속 실패하였다. Delegate to servlet container 말고 Jenkins 자체 사용자 DB로 별도 계정을 생성하고 아래 그림처럼 설정을 해야한다.</p><p><img loading="lazy" alt="Jenkins Config" src="/assets/images/jenkins_config-ebc060e294614bf3e83967c95b1cb527.png" width="896" height="778" class="img_E7b_"></p><p>위 설정 이후 아래와 같이 Spinnaker UI에서 Jenkins API연동이 가능하다.  </p><p><img loading="lazy" alt="Spinnaker Jenkins" src="/assets/images/spin_jenkins-dd2e9b5ec5faf44637c141dba0020e45.png" width="1176" height="888" class="img_E7b_"></p><p>오늘은 여기까지만 하고 다음글에서는 배포전략이나 Network Policy 연동등을 상세히 적어볼 예정이다.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ci-cd/">CI/CD</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/kubernetes/">Kubernetes</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/spinnaker/">Spinnaker</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Spinnaker on Kubernetes #1" href="/kubernetes/spinnaker-advanced-1/"><b>Read More</b></a></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/tags/ci-cd/page/2/"><div class="pagination-nav__label">Older Entries</div></a></div></nav></main></div></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Blog</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/">Home</a></li><li class="footer__item"><a class="footer__link-item" href="/archive/">Archive</a></li><li class="footer__item"><a class="footer__link-item" href="/tags/">Tags</a></li></ul></div><div class="col footer__col"><div class="footer__title">Sponsors</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/pang4u/">Pang4U</a></li><li class="footer__item"><a href="https://ko-fi.com/ddiiwoong" target="_blank" rel="noopener noreferrer" class="footer__link-item">Buy Me a Coffee<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/ddiiwoong" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/ddiiwoong" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.facebook.com/ddiiwoong" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://kr.linkedin.com/in/ddiiwoong" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div></div></footer></div>
<script src="/assets/js/runtime~main.658e9364.js"></script>
<script src="/assets/js/main.a75c27ce.js"></script>
</body>
</html>