<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-tags-post-list-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.18">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="Act as a catalyst RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Act as a catalyst Atom Feed">
<link rel="alternate" type="application/json" href="/feed.json" title="Act as a catalyst JSON Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","G-4ZT898XDT2","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-4ZT898XDT2"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-4ZT898XDT2",{anonymize_ip:!0})</script>
<link rel="search" type="application/opensearchdescription+xml" title="Cloud Catalyst" href="/opensearch.xml">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4362752107119680" crossorigin="anonymous"></script><title data-rh="true">26 posts tagged with &quot;Kubernetes&quot; | Cloud Catalyst</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://ddii.dev/tags/kubernetes/page/3/"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="naver-site-verification" content="cbcc03783e5594725d3951f4e7f16ede80e69881"><meta data-rh="true" property="og:title" content="26 posts tagged with &quot;Kubernetes&quot; | Cloud Catalyst"><meta data-rh="true" name="docusaurus_tag" content="blog_tags_posts"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_tags_posts"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://ddii.dev/tags/kubernetes/page/3/"><link data-rh="true" rel="alternate" href="https://ddii.dev/tags/kubernetes/page/3/" hreflang="en"><link data-rh="true" rel="alternate" href="https://ddii.dev/tags/kubernetes/page/3/" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://UTLA0DRN66-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.1e7a31ee.css">
<link rel="preload" href="/assets/js/runtime~main.013d1f47.js" as="script">
<link rel="preload" href="/assets/js/main.f4c31e34.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top navbarHideable_ObN2"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo-catalyst.svg" alt="Cloud Catalyst" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/logo-catalyst.svg" alt="Cloud Catalyst" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">Cloud Catalyst</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/">Posts</a><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" docid="introduction" href="/docs/prometheus/introduction/">Docs</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/prometheus/introduction/">Prometheus</a></li></ul></div></div><div class="navbar__items navbar__items--right"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/tags/">Tags</a><a class="navbar__item navbar__link" href="/presentation/">Presentation</a><a class="navbar__item navbar__link" href="/archive/">Archive</a><a class="navbar__item navbar__link" href="/about/">About</a><a class="navbar__item navbar__link" href="/pang4u/">Pang4u</a><a href="https://github.com/ddiiwoong/newblog" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_S7eR colorModeToggle_vKtC"><button class="clean-btn toggleButton_rCf9 toggleButtonDisabled_Pu9x" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_v35p"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_nQuB"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_qEbK"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_a9qW thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_uKok margin-bottom--md">Recent Posts</div><ul class="sidebarItemList_Kvuv"><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kubernetes/kops/">kOps with Cloud9</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kubernetes/eks-cni-custom/">EKS CNI Custom Networking</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kubernetes/eks-anywhere-adv/">EKS Anywhere Advanced Usages</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kubernetes/eks-anywhere/">EKS Anywhere on vSphere Homelab</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kubernetes/what-is-tailscale/">What is Tailscale?</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><header class="margin-bottom--xl"><h1>26 posts tagged with &quot;Kubernetes&quot;</h1><a href="/tags/">View All Tags</a></header><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/kubernetes/git-sync/">git-sync</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2019-03-21T00:00:00.000Z" itemprop="datePublished">March 21, 2019</time> · <!-- -->9 min read</div></header><div class="markdown" itemprop="articleBody"><p>git repo를 kubernetes volume으로 구현할수 있는 sidecar pattern <code>git-sync</code> 프로젝트에 대해서 알아본다.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="git-sync">git-sync<a class="hash-link" href="#git-sync" title="Direct link to heading">​</a></h2><p><a href="https://github.com/kubernetes" target="_blank" rel="noopener noreferrer">Kubernetes Github</a>에 방문하면 다양한 프로젝트들을 볼 수 있다.<br>
<a href="https://github.com/kubernetes/kubernetes" target="_blank" rel="noopener noreferrer">Kubernetes Project</a>부터 minikube, kubeadm, kubectl, kubelet, dashboard등 필수적으로 필요하거나 많이 사용되는 프로젝트를 볼 수 있는데,
기존에 storage volume 으로 활용되던 <a href="https://kubernetes.io/docs/concepts/storage/volumes/#gitrepo" target="_blank" rel="noopener noreferrer">gitrepo</a>가 <code>deprecated</code> 되어서 방법을 찾다가 유사한 프로젝트를 공식 repo에서 우연히 발견하게 되었다.  </p><p><a href="https://github.com/kubernetes/git-sync" target="_blank" rel="noopener noreferrer">git-sync</a>는 sidecar 방식으로 git repository를 clone하는 프로젝트이다.  </p><p>최초 한번 clone도 가능하고 일정한 간격으로 끌어와서 응용프로그램에 사용할 수 있고 원하는 branch, Tag 또는 특정 git hash 기반으로 pulling이 가능하다.  </p><p>upstream의 repository에서 대상이 변경되었을때 다시 pulling하고, webhook기능을 추가하여 비동기성으로 POST 요청이 있을때만 git-sync를 수행할수 있기 때문에
Continuous Deployment를 간단하게 구현하는데 활용될 수 있다. </p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="github-ssh설정">GitHub SSH설정<a class="hash-link" href="#github-ssh설정" title="Direct link to heading">​</a></h2><p>git 내용을 pulling을 할때 https, ssh 방법을 사용하는데 GitHub ssh key를 kubernetes cluster의 secret으로 사용을 할수 있기 때문에 ssh 방식을 사용하는 방법을 작성하였다.  </p><p>아래 모든 과정은 MacOS에서 진행하였고 다른 OS는 아래 링크에서 확인 가능하다.<br>
<a href="https://help.github.com/en/articles/connecting-to-github-with-ssh" target="_blank" rel="noopener noreferrer">https://help.github.com/en/articles/connecting-to-github-with-ssh</a></p><p>사용하고자 하는 터미널에서 등록키를 확인하자.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="기존에-등록된-ssh-key-확인">기존에 등록된 SSH key 확인<a class="hash-link" href="#기존에-등록된-ssh-key-확인" title="Direct link to heading">​</a></h3><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ ls -al ~/.ssh</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="새로운-ssh-key-생성">새로운 SSH key 생성<a class="hash-link" href="#새로운-ssh-key-생성" title="Direct link to heading">​</a></h3><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ ssh-keygen -t rsa -b 4096 -C &quot;ddiiwoong@gmail.com&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Start the SSH key creation process</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; Enter file in which the key is (/Users/you/.ssh/id_rsa): [Hit enter]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; Key has comment &#x27;/Users/you/.ssh/id_rsa&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; Enter new passphrase (empty for no passphrase): [Type new passphrase]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; Enter same passphrase again: [One more time for luck]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; Your identification has been saved with the new passphrase.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="ssh-agent-실행중인지-확인">ssh agent 실행중인지 확인<a class="hash-link" href="#ssh-agent-실행중인지-확인" title="Direct link to heading">​</a></h3><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">eval “$(ssh-agent -s)”</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; Agent pid 59566</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="생성된-키를-keychain에-저장-및-확인">생성된 키를 keychain에 저장 및 확인<a class="hash-link" href="#생성된-키를-keychain에-저장-및-확인" title="Direct link to heading">​</a></h3><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ ssh-add -K ~/.ssh/id_rsa</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ cat ~/.ssh/id_rsa.pub</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="복사-및-github에-추가">복사 및 github에 추가<a class="hash-link" href="#복사-및-github에-추가" title="Direct link to heading">​</a></h3><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ pbcopy &lt; ~/.ssh/id_rsa.pub</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Setting - SSH and GPG keys - SSH keys - New SSH key<br>
<code>Title</code>은 구분자로 입력하고 GitHub password를 한번더 입력하고 완료한다.  </p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="터미널에서-ssh접속-확인">터미널에서 SSH접속 확인<a class="hash-link" href="#터미널에서-ssh접속-확인" title="Direct link to heading">​</a></h3><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ ssh -T git@github.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Hi ddiiwoong! You&#x27;ve successfully authenticated, but GitHub does not provide shell access.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="git-sync를-위한-secret-등록">git-sync를 위한 secret 등록<a class="hash-link" href="#git-sync를-위한-secret-등록" title="Direct link to heading">​</a></h2><p><a href="https://github.com/kubernetes/git-sync/blob/master/docs/ssh.md" target="_blank" rel="noopener noreferrer">https://github.com/kubernetes/git-sync/blob/master/docs/ssh.md</a></p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="secret-생성">secret 생성<a class="hash-link" href="#secret-생성" title="Direct link to heading">​</a></h3><p>위에서 생성한 SSH key를 Kubernetes Cluster에 Secret resource로 저장을 한다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ ssh-keyscan github.com &gt; /tmp/known_hosts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># github.com:22 SSH-2.0-babeld-9d924d26</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># github.com:22 SSH-2.0-babeld-9d924d26</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># github.com:22 SSH-2.0-babeld-9d924d26</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>known_hosts와 key를 Secret으로 저장한다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl create secret generic git-creds \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --from-file=ssh=$HOME/.ssh/id_rsa \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --from-file=known_hosts=/tmp/known_hosts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get secret git-creds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME        TYPE      DATA      AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">git-creds   Opaque    2         1d</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="sample-ngnix-배포">sample ngnix 배포<a class="hash-link" href="#sample-ngnix-배포" title="Direct link to heading">​</a></h2><p>기본적으로 <code>git-sync/cmd/git-sync/main.go</code> 소스를 확인하면 여러가지 flag를 확인할 수 있는데 주로 사용하는 옵션은 다음과 같다.</p><ul><li>ssh : pulling 방식 (default=false)</li><li>root : git clone이 수행되는 root directory (default=&quot;$HOME/git&quot;)</li><li>repo : clone 대상 Repository (default=&quot;&quot;)</li><li>branch : branch (default=master)</li><li>rev : git revision (tag or hash) to check out</li><li>depth : commit depth (default=0)</li><li>dest : repository 배포 directory</li></ul><p>기타 옵션들은 <code>git-sync/cmd/git-sync/main.go</code> 에서 확인이 가능하며 해당 옵션들을 변수로 처리하여 활용하면 된다.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="git-sync-demoyaml-작성">git-sync-demo.yaml 작성<a class="hash-link" href="#git-sync-demoyaml-작성" title="Direct link to heading">​</a></h3><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: extensions/v1beta1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    app: git-sync-demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: git-sync-demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  namespace: default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  replicas: 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  selector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    matchLabels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      app: git-sync-demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  template:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        app: git-sync-demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - name: nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        image: nginx:1.14-alpine</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ports:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - containerPort: 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        volumeMounts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - name: git-sync-volume</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          mountPath: /usr/share/nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - name: git-sync</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        image: k8s.gcr.io/git-sync:v3.1.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        imagePullPolicy: Always</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        args:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         - &quot;-ssh&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         - &quot;-repo=git@github.com:ddiiwoong/git-sync-demo.git&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         - &quot;-root=/usr/share/nginx&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         - &quot;-dest=html&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         - &quot;-branch=master&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         - &quot;-depth=1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        volumeMounts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - name: git-sync-volume</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          mountPath: /usr/share/nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - name: git-secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          mountPath: /etc/git-secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      volumes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - name: git-sync-volume</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        emptyDir: {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - name: git-secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        secret:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          secretName: git-creds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          defaultMode: 288 # = mode 0440</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      securityContext:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fsGroup: 65533 # to make SSH key readable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: git-sync-demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type: NodePort</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  selector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    app: git-sync-demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ports:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - protocol: TCP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    port: 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    targetPort: 80</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="확인사항">확인사항<a class="hash-link" href="#확인사항" title="Direct link to heading">​</a></h3><p>일단 ngnix로 1.14-alpine Image를 기본으로 하고 git-sync container가 sidecar로 들어가도록 작성하였다.<br>
<!-- -->실제 동작하는 순서대로 manifest를 아래서부터 살펴보자.</p><ul><li>git-sync-volume은 <code>emptyDir</code>, git-secret은 <code>secret</code> volume 설정<div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    volumes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - name: git-sync-volume</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      emptyDir: {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - name: git-secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      secret:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        secretName: git-creds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        defaultMode: 288 # = mode 0440</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></li><li>sidecar container image를 <code>k8s.gcr.io/git-sync:v3.1.1</code>로 설정</li><li><code>git-sync-volume</code>, <code>git-sync-volume</code> volume을 <code>git-sync</code> sidecar에 마운트</li><li>위에서 이야기한 <code>git-sync</code> flag, args로 설정<div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - name: git-sync</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      image: k8s.gcr.io/git-sync:v3.1.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      imagePullPolicy: Always</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      args:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       - &quot;-ssh&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       - &quot;-repo=git@github.com:ddiiwoong/git-sync-demo.git&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       - &quot;-root=/usr/share/nginx&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       - &quot;-dest=html&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       - &quot;-branch=master&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       - &quot;-depth=1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      volumeMounts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - name: git-sync-volume</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mountPath: /usr/share/nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - name: git-secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mountPath: /etc/git-secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></li><li>nginx 기본 위치가 <code>/usr/share/nginx</code> 이므로 mount 위치를 git-sync-volume으로 설정<div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - name: nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      image: nginx:1.14-alpine</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ports:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - containerPort: 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      volumeMounts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - name: git-sync-volume</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mountPath: /usr/share/nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></li></ul><p>위 nginx를 배포하고 접속하면 <code>Hello git-sync demo v1.0</code>를 확인할 수 있다.</p><p>결국 git repo code (static html page)는 <code>/usr/share/nginx/html</code> 위치에 clone 되는것처럼 보이지만
실제 clone 위치를 확인해보면 symbolic link로 특정 revision dir를 가리키고 있다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl exec -it git-sync-demo-665c9c9ddf-6nwc4 sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Defaulting container name to nginx.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Use &#x27;kubectl describe pod/git-sync-demo-665c9c9ddf-6nwc4 -n default&#x27; to see all of the containers in this pod.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/ # cd /usr/share/nginx/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/usr/share/nginx # ls -al</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">total 16</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxrwsrwx    4 root     nogroup       4096 Mar 21 06:54 .</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-xr-x    1 root     root          4096 Mar  8 03:09 ..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-sr-x    9 65533    nogroup       4096 Mar 21 06:54 .git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lrwxrwxrwx    1 65533    nogroup         44 Mar 21 06:54 html -&gt; rev-07aa36f719091d75b5665203fa5846a549e7d540</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-sr-x    2 65533    nogroup       4096 Mar 21 06:54 rev-07aa36f719091d75b5665203fa5846a549e7d540</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/usr/share/nginx # cat ./html/index.html</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;!DOCTYPE html&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;html&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;head&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;title&gt;Hello git-sync demo&lt;/title&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;/head&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;body&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;h1&gt;Hello git-sync demo v1.0&lt;/h1&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;/body&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;/html&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>github에 있는 위 index.html 내용을 수정하고 commit을 하게 되면 실시간으로 아래와 같이 revision 정보 및 내용이 바뀐것을 확인할수 있다.  </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">/usr/share/nginx # ls -al</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">total 16</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxrwsrwx    4 root     nogroup       4096 Mar 21 13:40 .</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-xr-x    1 root     root          4096 Mar  8 03:09 ..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-sr-x    9 65533    nogroup       4096 Mar 21 13:40 .git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lrwxrwxrwx    1 65533    nogroup         44 Mar 21 13:40 html -&gt; rev-b125908649135856d79c515c17decba68797a6cb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-sr-x    2 65533    nogroup       4096 Mar 21 13:40 rev-b125908649135856d79c515c17decba68797a6cb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/usr/share/nginx # cat ./html/index.html</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;!DOCTYPE html&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;html&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;head&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;title&gt;Hello git-sync demo&lt;/title&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;/head&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;body&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;h1&gt;Hello git-sync demo v1.1&lt;/h1&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;/body&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;/html&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="정리">정리<a class="hash-link" href="#정리" title="Direct link to heading">​</a></h2><p>git-sync를 간단하게 테스트해봤다.<br>
<!-- -->간단하게 <code>sidecar</code> 방식의 clone tool로서 <code>git-sync</code>를 활용하면 여러가지로 충분히 활용이 가능할 것이다.<br>
<!-- -->포스팅을 작성하면서 떠오른 활용용도를 정리하면 아래와 같다. 어찌보면 sidecar pattern의 활용방안이라고도 볼수 있다.</p><ul><li>CDN을 사용하지 않고 git에서 소규모로 컨텐츠를 가져올때</li><li>DBMS가 필요없을 정도의 적은 데이터를 가져올때</li><li>jekyll이나 hugo 같은 정적 사이트(블로그)의 sidecar 패턴 (GitPage처럼 markdown을 추가하고 git commit하면 바로 사이트에 반영되는 방식)</li><li>nginx, haproxy, apache와 같이 config 변경이 필요할때 webhook방식으로 설정을 변경한후 pod를 재기동하는 GitOps 구현</li></ul></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/git-sync/">git-sync</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/git-ops/">GitOps</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/kubernetes/">Kubernetes</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ssh-git/">ssh git</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/sidecar/">sidecar</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/sidecar-pattern/">sidecar pattern</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about git-sync" href="/kubernetes/git-sync/"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/tools/vscode-server/">VScode Server</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2019-03-20T00:00:00.000Z" itemprop="datePublished">March 20, 2019</time> · <!-- -->6 min read</div></header><div class="markdown" itemprop="articleBody"><p>IntelliJ IDEA를 사용하다가 개발업무를 거의 손놓다시피 하다보니 라이센스를 연장하지 못하게 되었고 주로 Local에서 VScode를 사용하고 있다. 현재 부서와 업무도 바뀌었고 워낙 고가다보니 IDE를 부서비로 구매하도 어렵다. 뭐 얼마나 한다고 말할수도 있겠지만 업무특성상 개발툴을 사달라고 할수 없고 최근 크롬북이나 아이패드 프로같은 태블릿을 가지고 다니시는 분들도 많고 단순 필기나 메모가 아닌 온라인 환경에서 블로깅 포스팅 정도는 할수 있다는 가정으로 Web IDE를 구성하는 포스팅을 시작해본다. </p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="web-ide">Web IDE<a class="hash-link" href="#web-ide" title="Direct link to heading">​</a></h2><p>이번 포스팅을 쓰기 시작하면서 2017년 AWS re;invent에선가 Cloud9 제품이 출시되어서 Lambda에서 사용했던 장면이 갑자기 떠올랐다. Cloud 9은 <a href="https://github.com/c9/core" target="_blank" rel="noopener noreferrer">https://github.com/c9/core</a>를 기반으로 instance를 띄는것을 기본으로 한다. Lambda의 기본 에디터도 나쁘진 않지만 Cloud9에서 강조하는 부분은 코드 협업이다. </p><p><img loading="lazy" src="https://d1.awsstatic.com/product-marketing/Tulip/C9-Collab-Image@3x.e03a65d9488633c154358430540ab363dd1e8f45.png" alt="cloud9" class="img_E7b_"></p><p>AWS에서 서비스로 출시되기 이전에도 Dockerhub에서도 종종 확인할수 있었지만 현재는 찾아보기 어렵다. </p><p>국내에는 Cloud 형태로 <a href="https://ide.goorm.io/" target="_blank" rel="noopener noreferrer">GoormIDE</a> 제품이 있다.<br>
<!-- -->Free 에디션도 있으니 따로 확인해보면 된다. (응원합니다!)</p><p>이외에도 <a href="https://github.com/theia-ide/theia" target="_blank" rel="noopener noreferrer">https://github.com/theia-ide/theia</a>, <a href="https://github.com/codercom/code-server" target="_blank" rel="noopener noreferrer">https://github.com/codercom/code-server</a>와 같은 Web기반 오픈소스가 존재하고 둘다 상용이나 Beta형태로 서비스 중이다. </p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="code-server">code-server<a class="hash-link" href="#code-server" title="Direct link to heading">​</a></h2><p><a href="https://github.com/codercom/code-server" target="_blank" rel="noopener noreferrer">code-server</a>는 원격서버 형태로 동작하는 브라우저 기반 <a href="https://github.com/Microsoft/vscode" target="_blank" rel="noopener noreferrer">VSCode</a> IDE이다.</p><p>그런데 왜 구지 VScode 설치형을 냅두고 Server로 구동하느냐? 아래와 같이 설명하고 있다.</p><ul><li>Chromebook, Table(IPAD) 에서 Coding 가능</li><li>저사양 Client에서도 Cloud 기반 Server의 이점 사용가능</li><li>Battery! (제일 중요포인트) </li></ul><p>구동방식은 여러방식이 존재한다. </p><ul><li>Hosted : <a href="https://coder.com/" target="_blank" rel="noopener noreferrer">coder</a> - Enterprise </li><li>Docker<div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ docker run -t -p 127.0.0.1:8443:8443 -v &quot;${PWD}:/root/project&quot; codercom/code-server code-server --allow-http --no-auth</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></li><li>Bianry<div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ code-server &lt;initial directory to open&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="code-server-kubernetes에-배포">code-server kubernetes에 배포<a class="hash-link" href="#code-server-kubernetes에-배포" title="Direct link to heading">​</a></h2><p>공식 <a href="https://hub.docker.com/r/codercom/code-server" target="_blank" rel="noopener noreferrer">Image</a>와 <a href="https://github.com/codercom/code-server/blob/master/Dockerfile" target="_blank" rel="noopener noreferrer">Dockerfile</a>는 해당 링크를 참조한다.
살짝 변경해서 재빌드하려고 했는데 맥북 메모리가 부족한지 <code>yarn build</code>할때 <code>Serve fails with Error Code 137</code> 가 발생하였다. 이문제는 나중에 해결하기로 하고 일단 배포하자.  </p><p>로컬 minikube에서 테스트하기 위해<br>
<a href="https://github.com/codercom/code-server/blob/master/deployment/deployment.yaml" target="_blank" rel="noopener noreferrer">https://github.com/codercom/code-server/blob/master/deployment/deployment.yaml</a> 에서 ClusterIP를  NodePort로 수정하고 패스워드를 로그에서 확인하지 않고 사용할수 있도록 <code>1234</code>로 설정하고 배포한다. </p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="deploymentyaml">deployment.yaml<a class="hash-link" href="#deploymentyaml" title="Direct link to heading">​</a></h3><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Namespace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: code-server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> name: code-server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> namespace: code-server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ports:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> - port: 8443</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   name: https</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   protocol: TCP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> selector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   app: code-server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> type: NodePort</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: extensions/v1beta1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    app: code-server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: code-server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  namespace: code-server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  selector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    matchLabels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      app: code-server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  replicas: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  template:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        app: code-server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - image: codercom/code-server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        imagePullPolicy: Always</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        name: code-server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ports:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - containerPort: 8443</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          name: https</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        args:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         - &quot;--password=1234&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl create -f deployment.yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>이후 서비스 확인 및 minikube service로 expose 시킨다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get svc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME          TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">code-server   NodePort   10.111.206.64   &lt;none&gt;        8443:32665/TCP   15m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ minikube service code-server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ minikube service list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-------------|---------------|-----------------------------|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  NAMESPACE  |     NAME      |             URL             |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-------------|---------------|-----------------------------|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| code-server | code-server   | http://192.168.99.102:32665 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| default     | git-sync-demo | http://192.168.99.102:31595 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| default     | kubernetes    | No node port                |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| kube-system | kube-dns      | No node port                |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-------------|---------------|-----------------------------|</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>해당 URL로 접속하여 패스워드 <code>1234</code>를 입력하면 vscode가 원격으로 실행된 것을 확인할수 있다.
<img loading="lazy" alt="vscode" src="/assets/images/vscode-9cbf83b87dd9237022b17c9f3a7c07b2.png" width="1810" height="1263" class="img_E7b_"></p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="정리">정리<a class="hash-link" href="#정리" title="Direct link to heading">​</a></h2><p>실제 사용을 해보면 아직 버그가 많다. 애드온이나 플러그인 설치시 제대로 동작을 하지 않는 경우도 있었고
<a href="https://github.com/kubernetes/git-sync" target="_blank" rel="noopener noreferrer">git-sync</a> 프로젝트와 연동을 통해 실제 gitOPS를 구현해보고자 하였으나 배포후에 mount된 repository volume에 변경사항이 발생시 갑자기 UI가 먹통이 되는 경우가 발생하기도 하였다. Kubernetes플랫폼을 개발자에게 PaaS형태로 제공하는 경우 webIDE의 좋은 옵션이 될수 있을것 같다.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/vscode/">vscode</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/code-server/">code-server</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/kubernetes/">kubernetes</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/online-coding/">online coding</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/goorm-ide/">GoormIDE</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/cloud-9/">Cloud9</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about VScode Server" href="/tools/vscode-server/"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/kubernetes/k3s-homelab/">K3s on Raspberry Pi Cluster</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2019-03-11T00:00:00.000Z" itemprop="datePublished">March 11, 2019</time> · <!-- -->13 min read</div></header><div class="markdown" itemprop="articleBody"><p>이번에는 경량 Kubernetes라고 이야기하는 <a href="https://github.com/rancher/k3s" target="_blank" rel="noopener noreferrer">K3s</a>를 Raspberry Pi 클러스터상에 구동하려고 한다.
순수하게 개인의견으로 작성하였고 절대 제품이나 부품홍보를 하고자 하는 의도는 전혀 없다.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="k3s">K3s?<a class="hash-link" href="#k3s" title="Direct link to heading">​</a></h2><p><strong>K3s</strong>는 Rancher Lab에서 최소자원을 사용하는 Kubernetes 클러스터 구성을 위한 솔루션으로 시작되었고 2019년 3월 12일 현재 0.2버전이 릴리즈된 상태이다. 바이너리 전체가 40mb가 되지 않고 설치가 쉽다는 점에서 최근 트위터 상에서 이슈가 되고 있는 프로젝트라고 할 수 있다. </p><p>주로 Edge, IoT 등 저전력, 저사양 기반 ARM계열 컴퓨팅에 최적화 되어 있고 실제 실험적이긴 하지만 간단한 기능이나 baremetal 기반 클러스터 테스트를 집에서 해보기에는 딱 좋은 프로젝트라 할 수 있다. 이미 vSphere, OpenStack기반으로 테스트는 차고 넘치게 해봤지만 일단 물리적인 케이스부터 보고나면 하드웨어를 좋아하는 사람들에게는 아주 재미있는 장난감이 아닐수 없을 것이다. </p><p><a href="https://github.com/rancher/k3s" target="_blank" rel="noopener noreferrer">K3s Github</a> 상세 설명에 보면 Cloud Provider, Storage Plugin은 제거하였고  default 저장소가 <code>etcd</code>가 아닌 <code>sqlite3</code>으로 되어있다고 한다. </p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="사전-준비사항">사전 준비사항<a class="hash-link" href="#사전-준비사항" title="Direct link to heading">​</a></h2><ul><li><p>최소 2개 이상의 Raspberry Pi 2B/3B/3B+, 4ea<br>
<!-- -->오픈마켓에서 할인쿠폰 적용해서 Raspberry Pi 3B+, 4ea를 <code>166,820원</code>(대당 42,000원) 정도에 구매하였다.<br>
<!-- -->최저가 검색으로 대당 46,000원 정도 했던것 같다. </p></li><li><p>Stackable Case<br>
<a href="https://www.amazon.com/gp/product/B07CTG5N3V/ref=ppx_yo_dt_b_asin_title_o00_s00?ie=UTF8&amp;psc=1" target="_blank" rel="noopener noreferrer">iUniker Raspberry Pi Cluster Case</a> 강추!! (개인적으로 쿨러와 디자인이 맘에 듬)<br>
<!-- -->배송비포함 29.19달러, 약 <code>33,000원</code></p></li><li><p>micro SDHC 4ea<br>
<!-- -->16GB로도 충분하지만 삼성전자 micro SDHC CLASS10 UHS-I EVO (32GB), 4ea를 오픈마켓에서 사게되면 배송료 포함해서 8,500원 * 4ea = <code>34,000원</code>에 구매가 가능하다. 오픈마켓에서는 개당 배송료를 내야한다. 하지만 쿠팡에서는 2ea를 로켓배송으로 15,380원에 구매가 가능하므로 약 <code>31,000원</code>에 4개를 구매할수 있다. </p></li><li><p>멀티충전기<br>
<!-- -->1만원대 후반에서 2만원 초반이면 6포트 충전기를 구매할수 있는데 구매했던 가장 큰 기준은 Pi 4대를 동시에 2.5A 전류를 안정적으로 공급하려면 최대 10A를 지원하는 멀티 충전기를 사야했었고 4-5포트 짜리 충전기들은 대부분 최대 전류가 8A로 충족하지 못해 4포트만 사용하더라도 안정적인 전류 공급을 위해 6포트 충전기로 선택하였다.<br>
<!-- -->쿠팡 로켓배송 - 포*지 가정용 6포트 급속 멀티 충전기, <code>22,900원</code></p></li><li><p>micro 5pin 20cm 2.4A 지원 케이블 4ea<br>
<!-- -->Pi 권장 전류가 2.5A라고 했지만 2.4A, 3A 짜리중에 저렴한 2.4A 지원 숏케이블로 구매하였다.<br>
<!-- -->오픈마켓에서 배송료 포함, <code>7800원</code></p></li><li><p>UTP Cat5e 30cm 케이블 4ea<br>
<!-- -->그냥 제일싼걸로 오픈마켓에서 배송료 포함 <code>4,100원</code>에 구매하였다.</p></li><li><p>기가비트 지원되는 5포트 이상 스위치 허브(공유기)<br>
<!-- -->집에 있던 공유기 활용 (iptime A1004) 하였지만 최저 5포트 이상 스위치 허브중 제일 싼 모델은 <code>16,000원</code>대로 가격 형성중이다. </p></li></ul><p>실제 위 스펙으로 대충 구매를 진행하게 되면 18.4 + 3.3 + 3.1 + 2.3 + 0.8 + 0.4 + 1.6 = <code>29.9만원</code> 정도 소요가 될 것으로 예상된다. 집에 굴러다는 부품이나 충전기, 케이블, SD카드들을 활용하면 <code>25만원</code> 이내로도 충분히 가능하다.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="구매-제품-조립">구매 제품 조립<a class="hash-link" href="#구매-제품-조립" title="Direct link to heading">​</a></h2><p>조립은 그다지 어렵지 않은데 케이스 구매시 제공되는 방열판(CPU, GPU, RAM)을 꼼꼼하게 붙이고 쿨러를 GPIO에 연결한다.<br>
<!-- -->그렇게 어려운 점은 없지만 본체를 케이스에 고정할때 너트가 작아 손이 큰 사람은 조금 힘들 수도 있을 것 같다. </p><p>케이스의 CPU 쿨러가 화룡점정이다.</p><p><img loading="lazy" alt="cases" src="/assets/images/cases-614af9823c3d08feb1cdfd6feecda887.jpg" width="1224" height="689" class="img_E7b_"><br>
<img loading="lazy" alt="heat" src="/assets/images/heat-7b312fa5a5ca45bc55e98323ffdbb690.jpg" width="689" height="1224" class="img_E7b_"><br>
<img loading="lazy" alt="cooler" src="/assets/images/cooler-01a1339b8c2d113ec8cdd527cd9a51f8.jpg" width="1224" height="689" class="img_E7b_">
<img loading="lazy" alt="3stack" src="/assets/images/3stack-c5510bb36fd5f49a56c318a4a175f3fb.jpg" width="1224" height="689" class="img_E7b_">
<img loading="lazy" alt="charger" src="/assets/images/charger-fbc5086db8ea25c819ef915b0f298f5e.jpg" width="1224" height="689" class="img_E7b_">
<img loading="lazy" alt="full" src="/assets/images/fullstack-a0ea32c22662582ec85641753804eaf0.jpg" width="1224" height="689" class="img_E7b_">
<img loading="lazy" alt="complete" src="/assets/images/complete-8db0eac9257463f0ad669a0bc12541ef.jpg" width="1224" height="689" class="img_E7b_"></p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="os-설치">OS 설치<a class="hash-link" href="#os-설치" title="Direct link to heading">​</a></h2><p>SD카드에 설치는 MacOS상에서 진행하였다.</p><p><a href="https://www.raspberrypi.org/downloads/raspbian/" target="_blank" rel="noopener noreferrer">Raspbian Lite</a>를 내려받아 <a href="https://www.balena.io/etcher/" target="_blank" rel="noopener noreferrer">Etcher</a>를 사용하여 OS를 설치한다. </p><p>자세한 추가적인 설치방법은 다음 링크를 통해서도 확인이 가능하다.<br>
<a href="https://www.raspberrypi.org/documentation/installation/installing-images/README.md" target="_blank" rel="noopener noreferrer">Installing operating system images</a>  </p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="환경-설정">환경 설정<a class="hash-link" href="#환경-설정" title="Direct link to heading">​</a></h2><p>Mac에서는 <code>/Volumes/boot</code>에 마운트가 된다. OS마다 다르지만 Linux에서는 <code>/mnt/boot</code>, Windows에서는 <code>boot</code> 로 마운트가 된다.</p><p>SSH Service 자동 활성화를 위해 위 OS별 mount된 root 경로에 ssh 빈 파일을 생성하게 되면 reboot이후에 SSH 접속이 가능해진다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo touch /Volumes/boot/ssh</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>또한 container 사용을 위해 root경로의 <code>cmdline.txt</code> 파일 마지막에 cgroup 설정을 추가한다.  </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">cgroup_memory=1 cgroup_enable=memory</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>SD카드를 만들고 각각의 Pi에 장착후에 UTP케이블과 전원을 모두 연결한다.
부팅이 완료되면 default id/pass 인 <code>pi/raspberry</code>로 로그인 하고 <code>sudo raspi-config</code> 를 통해 패스워드 변경, hostname 설정, GPU memory split 설정 등을 완료하자.<br>
<!-- -->나중에는 PXE booting 및 ansible 자동화로 구현하면 무인환경 설치가 가능할것 같다. (Edge Computing)</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">┌───────────────────┤ Raspberry Pi Software Configuration Tool (raspi-config) ├────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                                                                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│        1 Change User Password Change password for the current user                               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│        2 Network Options      Configure network settings                                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│        3 Boot Options         Configure options for start-up                                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│        4 Localisation Options Set up language and regional settings to match your location       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│        5 Interfacing Options  Configure connections to peripherals                               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│        6 Overclock            Configure overclocking for your Pi                                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│        7 Advanced Options     Configure advanced settings                                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│        8 Update               Update this tool to the latest version                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│        9 About raspi-config   Information about this configuration tool                          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                                                                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                                                                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                                                                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                           &lt;Select&gt;                           &lt;Finish&gt;                            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                                                                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└──────────────────────────────────────────────────────────────────────────────────────────────────┘</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><ul><li>1 Change User Password</li><li>2 Network Options - hostname<ul><li>k3s-master, k3s-slave-01, k3s-slave-02, k3s-slave-03</li></ul></li><li>4 Localisation Options - TimeZone<ul><li>Asia, Seoul</li></ul></li><li>7 Advanced Options - GPU Memory split <ul><li>16mb</li></ul></li></ul><p>모두 완료가 되었으면 pi들을 재기동하자.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo reboot</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="k3s-클러스터-생성">k3s 클러스터 생성<a class="hash-link" href="#k3s-클러스터-생성" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="server-기동">Server 기동<a class="hash-link" href="#server-기동" title="Direct link to heading">​</a></h3><p>armhf(arm hard float) 지원이 되는 최신 릴리즈 v0.2.0를 다운받는다.  </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ wget -O k3s https://github.com/rancher/k3s/releases/download/v0.2.0/k3s-armhf &amp;&amp; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  chmod +x k3s &amp;&amp; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  sudo mv k3s /usr/local/bin/k3s</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Master node 기동 (백그라운드)</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo k3s server &amp;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>해당 node를 Control plane 형태로 분리시켜 workload에서 제외하려면 <code>--disable-agent</code> 옵션을 사용한다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">&amp; k3s server --disable-agent</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>정상적으로 k3s 기동이 완료되면 <code>/etc/rancher/k3s/k3s.yaml</code>에서 Kubeconfig를 확인할수 있다. 그리고 node 상태도 확인이 가능하다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo k3s kubectl get nodes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME          STATUS   ROLES    AGE   VERSION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">k3s-master    Ready    &lt;none&gt;   21h   v1.13.4-k3s.1</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="node-추가">node 추가<a class="hash-link" href="#node-추가" title="Direct link to heading">​</a></h3><p><code>/var/lib/rancher/k3s/server/manifests</code> 에서 TOKEN을 확인한다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo cat /var/lib/rancher/k3s/server/node-token</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">K100fa5235031f2b8e92e01b8bd3255142422a7aeaa47657ad4c68969d35cddbf3a::node:431342ac6204466e8f81445edb8c2e3a</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>worker node에 접속한다음 동일하게 최신 릴리즈 v0.2.0를 다운받는다.  </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ wget -O k3s https://github.com/rancher/k3s/releases/download/v0.2.0/k3s-armhf &amp;&amp; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  chmod +x k3s &amp;&amp; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  sudo mv k3s /usr/local/bin/k3s</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>위에서 나온 TOKEN값과 Kube API Endpoint정보로 node들을 차례로 추가 시키면 모든 작업이 완료된다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ export NODE_TOKEN=&quot;K100fa5235031f2b8e92e01b8bd3255142422a7aeaa47657ad4c68969d35cddbf3a::node:431342ac6204466e8f81445edb8c2e3a&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ export MASTER_IP=&quot;https://192.168.0.14:6443&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo k3s agent --server https://${MASTER_IP}:6443 --token ${NODE_TOKEN} &amp;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>완성된 클러스터를 확인한다. 외부 로컬에서 확인하려면 <code>/etc/rancher/k3s/k3s.yaml</code> 파일을 <code>~/.kube/config</code>에 추가하면 된다. 클러스터 내부에서 kubectl 명령은 k3s 바이너리 내부에 포함되어 있으므로 <code>sudo k3s kubectl</code> 명령을 사용하였다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo k3s kubectl get node -o wide</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME          STATUS   ROLES    AGE   VERSION         INTERNAL-IP    EXTERNAL-IP   OS-IMAGE                         KERNEL-VERSION   CONTAINER-RUNTIME</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">k3s-master    Ready    &lt;none&gt;   22h   v1.13.4-k3s.1   192.168.1.14   &lt;none&gt;        Raspbian GNU/Linux 9 (stretch)   4.14.79-v7+      containerd://1.2.4+unknown</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">k3s-slave01   Ready    &lt;none&gt;   21h   v1.13.4-k3s.1   192.168.1.15   &lt;none&gt;        Raspbian GNU/Linux 9 (stretch)   4.14.79-v7+      containerd://1.2.4+unknown</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">k3s-slave02   Ready    &lt;none&gt;   10h   v1.13.4-k3s.1   192.168.1.16   &lt;none&gt;        Raspbian GNU/Linux 9 (stretch)   4.14.79-v7+      containerd://1.2.4+unknown</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">k3s-slave03   Ready    &lt;none&gt;   10h   v1.13.4-k3s.1   192.168.1.17   &lt;none&gt;        Raspbian GNU/Linux 9 (stretch)   4.14.79-v7+      containerd://1.2.4+unknown</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>node 상세정보를 보면 기본적으로 K8s <code>v1.13.4</code>, runtime은 <code>containerd</code>를 사용하고 있음을 알 수 있다.  </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo k3s kubectl get svc --all-namespaces</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAMESPACE     NAME         TYPE           CLUSTER-IP     EXTERNAL-IP                 PORT(S)                      AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">default       kubernetes   ClusterIP      10.43.0.1      &lt;none&gt;                      443/TCP                      21h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   kube-dns     ClusterIP      10.43.0.10     &lt;none&gt;                      53/UDP,53/TCP,9153/TCP       21h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   traefik      LoadBalancer   10.43.19.160   192.168.1.14,192.168.1.15   80:32304/TCP,443:31690/TCP   21h</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Rancher쪽에서도 오늘날짜(3/12)로 F5가 Nginx를 인수하는것을 예견했던 것일까?<br>
<!-- -->Service를 확인하면 traefik이 기본으로 되어있다. 아래처럼 기본적으로 loadbalancer로 활용되고 있는 traefik을 Helm Chart CRD를 통해 배포된것을 확인할 수 있다. 또한 얼마전 졸업한 CoreDNS도 보인다.   </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo k3s kubectl get pod --all-namespaces</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAMESPACE     NAME                             READY   STATUS      RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   coredns-7748f7f6df-qflx9         1/1     Running     0          21h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   helm-install-traefik-dqqg9       0/1     Completed   0          21h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   svclb-traefik-598fd65c97-4xtkf   2/2     Running     0          21h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   svclb-traefik-598fd65c97-vbsqv   2/2     Running     0          19h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system   traefik-6876857645-2sqg9         1/1     Running     0          21h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo k3s kubectl get crd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                            CREATED AT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">addons.k3s.cattle.io            2019-03-11T16:46:22Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helmcharts.k3s.cattle.io        2019-03-11T16:46:22Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">listenerconfigs.k3s.cattle.io   2019-03-11T16:46:22Z</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="정리">정리<a class="hash-link" href="#정리" title="Direct link to heading">​</a></h2><p>아주 적은비용(?)으로 취미삼아 k3s 클러스터를 구성해봤다.<br>
<!-- -->아직 ARM계열에서 kubernetes workload를 구동하는 것은 시기상조이긴 하지만 기존에 kubeadm을 가지고 pi에 배포하는것에 비하면 설치 난이도나 자원사용량 측면에서 장점이 많은 프로젝트이다.<br>
<!-- -->해외 블로그나 트위터를 보면 최근 <code>k3s</code>에 대한 관심도가 높아지는것을 확인할 수 있는데 단순히 취미생활만이 아니라 IoT, Edge에서의 Serverless Workload 수행이라던지 ARM 계열 최적화된 모습만으로도 충분히 가능성은 보여준것 같다.<br>
<!-- -->Rancher 2.0 이후로 Kubernetes 연관된 관심도가 떨어졌었는데 엔지니어들의 관심을 끄는데는 성공한듯 하고 AWS의 Greengrass, Firecracker와 동일선상에서 봐도 견줄만한 가치가 있다고 생각된다.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/kubernetes/">Kubernetes</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/rancher/">Rancher</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/k-3-s/">K3s</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/raspberry/">Raspberry</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/homelab/">Homelab</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about K3s on Raspberry Pi Cluster" href="/kubernetes/k3s-homelab/"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/kubernetes/microservices-demo/">Cloud-Native Microservices Demo Application with OpenCensus</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2019-03-07T00:00:00.000Z" itemprop="datePublished">March 7, 2019</time> · <!-- -->14 min read</div></header><div class="markdown" itemprop="articleBody"><p><a href="https://github.com/GoogleCloudPlatform/microservices-demo" target="_blank" rel="noopener noreferrer">https://github.com/GoogleCloudPlatform/microservices-demo</a>에서 소개된 Demo Application인 <code>Hipster Shop</code>을 Kubernetes 기반으로 배포하고 관련 오픈소스들을 더 알아보고자 한다.</p><p>위 링크에 가서 보면 알수 있지만 <code>Hipster Shop</code> 아래 그림처럼 10개의 Microservice로 구성되어 있고 상품을 검색 및 구매할 수있는 웹 기반 이커머스 Application으로 구성 되어있다.</p><p><img loading="lazy" src="https://github.com/GoogleCloudPlatform/microservices-demo/raw/master/docs/img/architecture-diagram.png" alt="arch" class="img_E7b_"></p><p>각각의 서비스는 <strong>gRPC</strong> 로 통신하고 외부 사용자만 HTTP로 접근한다. 모든 서비스는 서로 다른 언어(Go, C#, Node.js, Python, Java)로 구성되어 있고 대부분의 Microservice들은 <code>Istio</code> service mesh 형태로 구성할수 있도록 되어있다. <code>Skaffold</code>를 통해 배포하고 <code>OpenCensus</code>라고 하는 gRPC/HTTP기반 Tracing tool을 활용하여 Google <code>Stackdriver</code>로 보내도록 되어있지만  Prometheus에 통합하는 방향으로 작성하기 위해서 Prometheus 기반으로 Metric을 수집하는 Fork된 데모 Application을 검색을 통해 찾을수 있었다.<br>
<a href="https://github.com/census-ecosystem/opencensus-microservices-demo" target="_blank" rel="noopener noreferrer">https://github.com/census-ecosystem/opencensus-microservices-demo</a>  </p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="opencensus">OpenCensus<a class="hash-link" href="#opencensus" title="Direct link to heading">​</a></h2><p><a href="https://opencensus.io/" target="_blank" rel="noopener noreferrer">OpenCensus(OC)</a>는 Microservice 및 Monolith 서비스를 Tracing 및 Metric Monitoring 할 수 있는 라이브러리를 제공하는 오픈소스이다.</p><p>아래와 같이 다양한 언어를 지원 한다.</p><ul><li>Java , Go, Python, C++, Nodejs, Erlang, Ruby, PHP, C#</li></ul><p>또한 수집된 데이터를 Prometheus, Stackdriver Tracing and Monitoring, DataDog, Graphite, Zipkin, Jaeger, Azure Insights 등 과 같은 백엔드 Application으로 내보낼 수 있기 때문에 개발자, 운영자 측면에서 좋은 선택사항이 될 수 있다.  </p><p>Microservice와 같은 분산 시스템에서 개발자/운영자 관점의 가장 중요한 미션은 각각의 수행되는 서비스들의 실행 시간을 확인하고 상호 API간 통신이 얼마나 걸리는지를 확인하고 Span(아래 그림참조)에서 가장 지연이 발생하는 서비스를 빨리 찾아내 확인하고 조치하는 것이라 할 수 있다.</p><p><img loading="lazy" src="https://www.jaegertracing.io/img/spans-traces.png" alt="span" class="img_E7b_"></p><p>OpenCensus는 주로 두가지 기능으로 활용된다.<br>
<!-- -->첫번째는 Metric 수집이고 두번째는 Tracing 기능이다.<br>
<!-- -->Log같은 경우 현재 미지원이지만 다음 메이저 릴리즈에 추가될 예정이라고 하니 조금더 지켜보면 좋을것 같다.</p><ul><li><p>Metrics</p><ul><li>데이터베이스 및 API의 응답시간, 요청 content length, open file descriptor 수와 같이 추적하고자하는 정량 데이터를 말한다. Metric 을 시각화해서 보면 응용 프로그램 및 서비스의 성능과 품질을 측정하는 데 도움이 될 수 있다. 예를 들면 요청 응답시간의 평균값이나 cache hit/miss 수와 같은 것들이 될 수 있다. </li></ul></li><li><p>Traces</p><ul><li>서비스 요청에 대한 애플리케이션 또는 서비스 구조를 확인할수 있고 모든 서비스 간 데이터 흐름을 시각화하여 아키텍처상의 병목 현상을 파악하는 데 도움이 된다.</li></ul></li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="hipster-shop-demo">Hipster Shop Demo<a class="hash-link" href="#hipster-shop-demo" title="Direct link to heading">​</a></h2><p>위에서 언급했던 내용처럼 GCP에서 작성한 <a href="https://github.com/GoogleCloudPlatform/microservices-demo" target="_blank" rel="noopener noreferrer">Hipster Shop Demo</a>는 minikube 및 GCP 데모로 되어있고 코드안에 기본 Metric 설정이 Stackdriver으로 되어있어 Prometheus Exporter 적용을 하려면 코드 수정이 필요하기 때문에 Prometheus기반으로 작성된 <a href="https://github.com/census-ecosystem/opencensus-microservices-demo" target="_blank" rel="noopener noreferrer">Forked Repo</a>를 살펴보기로 하였다.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="requirement">Requirement<a class="hash-link" href="#requirement" title="Direct link to heading">​</a></h3><p>현재 가지고 있는 MacOS 환경에서 구동하였다. 최소 스펙은 따로 기재하지 않았으나 K8s 1.11 이상을 권장한다.</p><ul><li>kubectl : v1.10.7</li><li>Minikube : v0.34.1</li><li>Kubernetes : v1.13.3</li><li><a href="https://github.com/GoogleContainerTools/skaffold/#installation" target="_blank" rel="noopener noreferrer">skaffold</a> : v0.24</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="minikube-기동">minikube 기동<a class="hash-link" href="#minikube-기동" title="Direct link to heading">​</a></h3><p>최소 3 CPU, 6Gb Memory가 필요하다. 그냥 minikube를 구동시기면 4 CPU, 8Gb 로 구동이 되기 때문에 별다른 옵션 없이 default로 구동하면 된다. </p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ minikube start</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get nodes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME       STATUS    ROLES     AGE       VERSION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">minikube   Ready     master    6h        v1.13.3</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="repository-clone">Repository Clone<a class="hash-link" href="#repository-clone" title="Direct link to heading">​</a></h3><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone https://github.com/census-ecosystem/opencensus-microservices-demo.git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token builtin class-name">cd</span><span class="token plain"> opencensus-microservices-demo</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>내부 구조를 살펴보면 기본적으로 <a href="https://github.com/GoogleContainerTools/skaffold" target="_blank" rel="noopener noreferrer">skaffold</a>를 활용하여 배포를 진행을 하는 것을 알수있다.<br>
<code>skaffold</code>는 로컬에서 Kubernetes 기반 어플리케이션 개발과 배포(CD)를 빠르게 도와주는 CLI tool이다. 소스코드의 변화를 감지하여 build, registry push/tagging, deploy까지 자동으로 할 수 있는 로컬 기반 도구이다.</p><p><code>skaffold dev</code>는 로컬 환경의 반복적인 개발에 활용하고 실제 배포는 CI Process에서 <code>skaffold run</code>을 통해 배포를 진행할 수 있다.  </p><p><img loading="lazy" src="https://github.com/GoogleContainerTools/skaffold/raw/master/docs/static/img/intro.gif" alt="skaffold demo" class="img_E7b_"></p><p>Kubernetes 배포툴에 대해 비교한 글은 <a href="https://blog.hasura.io/draft-vs-gitkube-vs-helm-vs-ksonnet-vs-metaparticle-vs-skaffold-f5aa9561f948/" target="_blank" rel="noopener noreferrer">블로그 링크</a>를 통해 확인할 수 있다.</p><p>아래에서는 <code>skaffold</code>에 대한 자세한 내용은 미뤄두고 배포하는 도구로서만 설명한다.  </p><p>기본적으로 구성을 하고자 하는 내용은 helm처럼 template 파일을 사용하게 되는데 프로젝트 root에 <code>skaffold.yaml</code> 에 build를 위한 image name, tag, src 위치등 기본적인 내용을 기재한다. 파일내용을 살펴보면 build에 관련된 내용들을 작성하고 deploy할 manifests의 위치까지 지정하도록 되어있다. 로컬환경에서 확인을 위해 grafana, prometheus, jaeger가 추가된 것을 확인할 수 있다.</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> skaffold/v1alpha2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">build</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">tagPolicy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">gitCommit</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">artifacts</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">imageName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gcr.io/opencensus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">microservices</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo/emailservice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">workspace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> src/emailservice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">imageName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gcr.io/opencensus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">microservices</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo/productcatalogservice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">workspace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> src/productcatalogservice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">imageName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gcr.io/opencensus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">microservices</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo/recommendationservice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">workspace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> src/recommendationservice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">imageName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gcr.io/opencensus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">microservices</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo/shippingservice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">workspace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> src/shippingservice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">imageName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gcr.io/opencensus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">microservices</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo/checkoutservice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">workspace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> src/checkoutservice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">imageName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gcr.io/opencensus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">microservices</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo/paymentservice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">workspace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> src/paymentservice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">imageName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gcr.io/opencensus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">microservices</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo/currencyservice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">workspace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> src/currencyservice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">imageName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gcr.io/opencensus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">microservices</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo/cartservice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">workspace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> src/cartservice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">imageName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gcr.io/opencensus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">microservices</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo/frontend</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">workspace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> src/frontend</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">imageName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gcr.io/opencensus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">microservices</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo/loadgenerator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">workspace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> src/loadgenerator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">imageName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gcr.io/opencensus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">microservices</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo/adservice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">workspace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> src/adservice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">imageName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gcr.io/opencensus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">microservices</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo/grafana</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">workspace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> src/grafana</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">imageName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gcr.io/opencensus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">microservices</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo/prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">workspace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> src/prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">imageName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gcr.io/opencensus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">microservices</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo/jaeger</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">workspace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> src/jaeger</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">deploy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">kubectl</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">manifests</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> ./kubernetes</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">manifests/</span><span class="token important">**.yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Go로 작성된 Frontend microservice을 살펴보자. <!-- -->[<strong>./src/frontend/main.go</strong>]</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="library-추가-및-http-handler-초기화">library 추가 및 http handler 초기화<a class="hash-link" href="#library-추가-및-http-handler-초기화" title="Direct link to heading">​</a></h3><p>Go기반 exporter 패키지(jaeger,prometheus)를 추가적으로 import 하고 http handler를 위한 <a href="https://godoc.org/go.opencensus.io/plugin/ochttp" target="_blank" rel="noopener noreferrer">ochttp 패키지</a>를 추가하였다. </p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;go.opencensus.io/exporter/jaeger&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;go.opencensus.io/exporter/prometheus&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;go.opencensus.io/plugin/ochttp&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;go.opencensus.io/plugin/ochttp/propagation/b3&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> handler http</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Handler </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> r</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        handler </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">logHandler</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">log</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> log</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> next</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> handler</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        handler </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ensureSessionID</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">handler</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// add opencensus instrumentation</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        handler </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">ochttp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Handler</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Handler</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">     handler</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Propagation</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">b3</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">HTTPFormat</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Infof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;starting server on &quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> addr </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;:&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> srvPort</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Fatal</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">http</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ListenAndServe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr</span><span class="token operator" style="color:#393A34">+</span><span class="token string" style="color:#e3116c">&quot;:&quot;</span><span class="token operator" style="color:#393A34">+</span><span class="token plain">srvPort</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> handler</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="exporter-등록jaeger-tracing-및-prometheus-exporter">exporter 등록(Jaeger Tracing 및 Prometheus exporter)<a class="hash-link" href="#exporter-등록jaeger-tracing-및-prometheus-exporter" title="Direct link to heading">​</a></h3><p>예시처럼 각각의 서비스에 jaeger와 prometheus exporter Endpoint를 쉽게 등록할수 있다.<br>
<!-- -->또한 initTracing() 에서는 데모를 위해 trace.AlwaysSample()을 사용하였다. 실제 운영환경에서는 <a href="https://github.com/census-instrumentation/opencensus-specs/blob/master/trace/Sampling.md" target="_blank" rel="noopener noreferrer">다음 링크</a>를 참고해서 사용하는 것을 권고하고 있다. </p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">initJaegerTracing</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">log logrus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">FieldLogger</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// Register the Jaeger exporter to be able to retrieve</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// the collected spans.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        exporter</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> jaeger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewExporter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">jaeger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Options</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Endpoint</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;http://jaeger:14268&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Process</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> jaeger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Process</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ServiceName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;frontend&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Fatal</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        trace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">RegisterExporter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">exporter</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">initTracing</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">log logrus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">FieldLogger</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// This is a demo app with low QPS. trace.AlwaysSample() is used here</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// to make sure traces are available for observation and analysis.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// In a production environment or high QPS setup please use</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// trace.ProbabilitySampler set at the desired probability.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        trace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ApplyConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">trace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Config</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                DefaultSampler</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> trace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">AlwaysSample</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">initJaegerTracing</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">log</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">initPrometheusStatsExporter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">log logrus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">FieldLogger</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">prometheus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Exporter </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    exporter</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> prometheus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewExporter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">prometheus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Options</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Fatal</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;error registering prometheus exporter&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    view</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">RegisterExporter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">exporter</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> exporter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">startPrometheusExporter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">log logrus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">FieldLogger</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> exporter </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">prometheus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Exporter</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    addr </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;:9090&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Infof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;starting prometheus server at %s&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> addr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    http</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Handle</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;/metrics&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> exporter</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Fatal</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">http</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ListenAndServe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="demo-application-배포">Demo Application 배포<a class="hash-link" href="#demo-application-배포" title="Direct link to heading">​</a></h3><p>minikube에 Hipster Shop Demo를 배포한다. 단순하게 <code>skaffold run</code> 명령으로 진행하면 된다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ skaffold run</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>현재 사용중인 2018 Macbook Pro(3.1 GHz Intel Core i7, 16GB) 상의 Docker기반 minikube 환경으로도 배포를 하였는데 시간이 꽤 소요되었다.(20분이상)<br>
<!-- -->코드를 실시간으로 수정하고 빌드, 배포되는 것은 <code>skaffold dev</code> 명령으로 확인할 수 있다. 진행되는 과정을 보면 <a href="https://draft.sh/" target="_blank" rel="noopener noreferrer">draft.sh</a> 프로젝트와도 꽤 유사하다고 볼 수 있다.  </p><p>에러없이 run이 실행되고 난후 minikube에 배포된 pod와 service를 확인한다. 중간에 loadgenerator가 init인 이유는 minikube 자원이 부족해서 발생하는 현상이다.</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                     READY     STATUS     RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">adservice-7c7d687dcb-xzr4m               </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1       Running    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">          4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cartservice-f54bcb9ff-tcfgn              </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1       Running    </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">          4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">checkoutservice-576446687b-95bwj         </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1       Running    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">          4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">currencyservice-5bd99bf97d-28mtz         </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1       Running    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">          4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">emailservice-6cb587798d-wwzdh            </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1       Running    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">          4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">frontend-6bf9796f7b-ch9pl                </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1       Running    </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">          4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">grafana-6678c5c5d9-2qx75                 </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1       Running    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">          4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">jaeger-5b66bdf7f7-csdzx                  </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1       Running    </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">          4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">loadgenerator-7c4f446774-68djg           </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">/1       Init:0/1   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">          4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">paymentservice-fc4c8589-wrfg7            </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1       Running    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">          4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">productcatalogservice-84878c8b9c-jhgnw   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1       Running    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">          4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus-58d98b7578-87td6              </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1       Running    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">          4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">recommendationservice-8564f9d894-smlpf   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1       Running    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">          4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">redis-cart-798bc66d58-xn6ff              </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1       Running    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">          4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">shippingservice-789656f6bc-rgzrp         </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1       Running    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">          4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get svc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                    TYPE           CLUSTER-IP       EXTERNAL-IP   PORT</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">S</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">                                                            AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">adservice               ClusterIP      </span><span class="token number" style="color:#36acaa">10.107</span><span class="token plain">.196.115   </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">9555</span><span class="token plain">/TCP,9090/TCP                                                  4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cartservice             ClusterIP      </span><span class="token number" style="color:#36acaa">10.98</span><span class="token plain">.151.164    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">7070</span><span class="token plain">/TCP                                                           4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">checkoutservice         ClusterIP      </span><span class="token number" style="color:#36acaa">10.97</span><span class="token plain">.9.197      </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">5050</span><span class="token plain">/TCP                                                           4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">currencyservice         ClusterIP      </span><span class="token number" style="color:#36acaa">10.103</span><span class="token plain">.112.225   </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">7000</span><span class="token plain">/TCP                                                           4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">emailservice            ClusterIP      </span><span class="token number" style="color:#36acaa">10.97</span><span class="token plain">.184.174    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">5000</span><span class="token plain">/TCP                                                           4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">frontend                ClusterIP      </span><span class="token number" style="color:#36acaa">10.103</span><span class="token plain">.40.138    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">80</span><span class="token plain">/TCP,9090/TCP                                                    4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">frontend-external       LoadBalancer   </span><span class="token number" style="color:#36acaa">10.108</span><span class="token plain">.170.241   </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">pending</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">80</span><span class="token plain">:31944/TCP                                                       4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">grafana                 ClusterIP      </span><span class="token number" style="color:#36acaa">10.104</span><span class="token plain">.141.254   </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">3000</span><span class="token plain">/TCP                                                           4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">grafana-external        LoadBalancer   </span><span class="token number" style="color:#36acaa">10.102</span><span class="token plain">.166.138   </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">pending</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">3000</span><span class="token plain">:30459/TCP                                                     4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">jaeger                  ClusterIP      </span><span class="token number" style="color:#36acaa">10.98</span><span class="token plain">.71.173     </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">9411</span><span class="token plain">/TCP,5775/UDP,6831/UDP,6832/UDP,5778/TCP,16686/TCP,14268/TCP   4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">jaeger-external         LoadBalancer   </span><span class="token number" style="color:#36acaa">10.96</span><span class="token plain">.164.126    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">pending</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">16686</span><span class="token plain">:32362/TCP                                                    4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubernetes              ClusterIP      </span><span class="token number" style="color:#36acaa">10.96</span><span class="token plain">.0.1        </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">443</span><span class="token plain">/TCP                                                            6h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">paymentservice          ClusterIP      </span><span class="token number" style="color:#36acaa">10.109</span><span class="token plain">.31.241    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">50051</span><span class="token plain">/TCP                                                          4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">productcatalogservice   ClusterIP      </span><span class="token number" style="color:#36acaa">10.101</span><span class="token plain">.124.106   </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">3550</span><span class="token plain">/TCP                                                           4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prometheus              ClusterIP      </span><span class="token number" style="color:#36acaa">10.103</span><span class="token plain">.107.213   </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">9090</span><span class="token plain">/TCP                                                           4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">recommendationservice   ClusterIP      </span><span class="token number" style="color:#36acaa">10.104</span><span class="token plain">.225.28    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">8080</span><span class="token plain">/TCP                                                           4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">redis-cart              ClusterIP      </span><span class="token number" style="color:#36acaa">10.101</span><span class="token plain">.24.157    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">6379</span><span class="token plain">/TCP                                                           4h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">shippingservice         ClusterIP      </span><span class="token number" style="color:#36acaa">10.104</span><span class="token plain">.224.18    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">50051</span><span class="token plain">/TCP                                                          4h</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="서비스-접속-및-metrictracing-확인">서비스 접속 및 Metric/Tracing 확인<a class="hash-link" href="#서비스-접속-및-metrictracing-확인" title="Direct link to heading">​</a></h3><p>로컬 minikube환경이기 때문에 external service가 pending이므로 service를 minikube NAT IP로 expose 시킨다.</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ minikube </span><span class="token function" style="color:#d73a49">service</span><span class="token plain"> frontend-external</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ minikube </span><span class="token function" style="color:#d73a49">service</span><span class="token plain"> grafana-external</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ minikube </span><span class="token function" style="color:#d73a49">service</span><span class="token plain"> jaeger-external</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ minikube </span><span class="token function" style="color:#d73a49">service</span><span class="token plain"> list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain">-------------</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">-----------------------</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">-----------------------------</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain">  NAMESPACE  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">         NAME          </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">             URL             </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain">-------------</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">-----------------------</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">-----------------------------</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> default     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> adservice             </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> No </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> port                </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> default     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> cartservice           </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> No </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> port                </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> default     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> checkoutservice       </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> No </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> port                </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> default     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> currencyservice       </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> No </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> port                </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> default     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> emailservice          </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> No </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> port                </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> default     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> frontend              </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> No </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> port                </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> default     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> frontend-external     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> http://192.168.99.101:31944 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> default     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> grafana               </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> No </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> port                </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> default     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> grafana-external      </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> http://192.168.99.101:30459 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> default     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> jaeger                </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> No </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> port                </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> default     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> jaeger-external       </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> http://192.168.99.101:32362 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> default     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> kubernetes            </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> No </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> port                </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> default     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> paymentservice        </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> No </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> port                </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> default     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> productcatalogservice </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> No </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> port                </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> default     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> prometheus            </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> No </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> port                </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> default     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> recommendationservice </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> No </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> port                </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> default     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> redis-cart            </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> No </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> port                </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> default     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> shippingservice       </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> No </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> port                </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> kube-system </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> kube-dns              </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> No </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> port                </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain">-------------</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">-----------------------</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">-----------------------------</span><span class="token operator" style="color:#393A34">|</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>3개의 서비스로 각각 접속이 되는것을 확인할수 있다.
Grafana 대시보드로 들어가면 현재 수집되는 prometheus source(http://prometheus:9090)를 통해 OpenCensus기반 Application Metric을 확인할 수 있다.</p><p><img loading="lazy" alt="hipster_grafana" src="/assets/images/hipster_grafana-13ab198ab40c06a5c6ba6bc61e3725ad.png" width="2878" height="1488" class="img_E7b_"></p><p>그림에서 보면 전체 서비스 응답에 대한 99% 백분위 지연시간이 944ms 인것을 확인할 수 있다. </p><p>또한 Jaeger를 통해 DAG(Directed acyclic graph) 및 서비스간 Tracing 을 확인할 수 있다.</p><p><img loading="lazy" alt="DAG" src="/assets/images/dag-0e49356be3f8676a292785832fbc1981.png" width="3146" height="1782" class="img_E7b_"></p><p><img loading="lazy" alt="tracing" src="/assets/images/tracing-b9038c7a3151b467c5f7d4dc08786f75.png" width="3172" height="1442" class="img_E7b_"></p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="정리">정리<a class="hash-link" href="#정리" title="Direct link to heading">​</a></h2><p>OpenCensus 기반으로 개발자가 코드를 작성하고 Microservice를 minikube에서 배포하고 Prometheus, Jaeger Exporter 연동을 통해 시스템뿐만이 아닌 Application기반 Metrics/Stats을 수집하고 개발자가 작성한 코드를 직접 Tracing하는 간단한 데모를 진행하였다. (Istio를 포함해서 Public환경에 배포해봐도 좋은 공부가 될 것 같다)  </p><p>향후 <a href="https://openmetrics.io/" target="_blank" rel="noopener noreferrer">OpenMetric</a>과 <a href="https://opencensus.io/" target="_blank" rel="noopener noreferrer">Opencensus</a>가 실제 개발자 기반으로 활성화되고 적용이 된다면 Telemetric 측면에서 많은 Use-Case가 도출될 수 있을것 같다.  </p><p>위에서 언급했듯이 Prometheus기반 Kubernetes 클러스터를 운영하고 있는 팀의 경우 개발자의 작성 코드를 최소화할 수 있는 도구로서 충분히 활용될 수 있어 보인다.  </p><p>꼭 Cloud Native 기반 Web 개발이 아니더라도 기존 공장, 금융, 병원 등 의 IoT나 센서/설비를 위한 비즈니스에도 Backend로서 확장성있는 도구로서 활용이 될 수 있을것 같다.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/kubernetes/">Kubernetes</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/istio/">Istio</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/stackdriver/">Stackdriver</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/prometheus/">Prometheus</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/g-rpc/">gRPC</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/open-census/">OpenCensus</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/skaffold/">skaffold</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Cloud-Native Microservices Demo Application with OpenCensus" href="/kubernetes/microservices-demo/"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/kubernetes/knative-using-gloo/">Knative with Gloo</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2019-02-28T00:00:00.000Z" itemprop="datePublished">February 28, 2019</time> · <!-- -->9 min read</div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="knative-routing">Knative Routing<a class="hash-link" href="#knative-routing" title="Direct link to heading">​</a></h2><p>Knative는 앞에서도 몇번 언급하였지만 기본적으로 <code>Routing</code>을 사용하여 외부에 노출할 서비스들에 대한 HTTP Endpoint를 제공한다. 어떻게 보면 기본적으로 API Gateway 역할을 하기도 하고 Ingress 역할을 하기도 한다. 보통 Service mesh인 <code>Istio</code>를 사용하여 ingress를 구현하는것이 당연하다고 생각하기도 하지만 Istio의 모든 기능이 Knative에 필요하지는 않고 설치되는것 자체가 리소스 소모가 꽤 된다는것은 설치 해본사람은 알고 있을것이다. </p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="service">Service<a class="hash-link" href="#service" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="kubernetes">Kubernetes<a class="hash-link" href="#kubernetes" title="Direct link to heading">​</a></h3><p><img loading="lazy" src="https://www.nginx.com/wp-content/uploads/2017/09/NGINX-Plus-Features-Kubernetes-Ingress-Controller-644x372@2x.png" alt="ingress" class="img_E7b_"><br>
<!-- -->이미지출처 : <a href="https://www.nginx.com/blog/announcing-nginx-ingress-controller-for-kubernetes-release-1-3-0/" target="_blank" rel="noopener noreferrer">https://www.nginx.com/blog/announcing-nginx-ingress-controller-for-kubernetes-release-1-3-0/</a></p><p>Kubernetes에서는 일반적으로 서비스 접속을 구현하게 되면 기본적으로 Pod와 Service를 생성하고 Ingress를 사용하여 클러스터 내부로 들어오는 트래픽을 처리하게 된다.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="knative">Knative<a class="hash-link" href="#knative" title="Direct link to heading">​</a></h3><p><img loading="lazy" src="https://i1.wp.com/blog.openshift.com/wp-content/uploads/intro.png?w=499&amp;ssl=1" alt="Serving" class="img_E7b_"><br>
<!-- -->이미지출처 : <a href="https://blog.openshift.com/knative-serving-your-serverless-services/" target="_blank" rel="noopener noreferrer">https://blog.openshift.com/knative-serving-your-serverless-services/</a></p><p>Knative에서는 앞선 Knative 관련 포스팅에서도 설명했듯이 <code>Automatic scaling up and down to zero</code> 특성을 가지고 있기에 Pod가 최초 실행되어있지 않은 상태에서 트래픽이 들어오게 되면 <a href="https://github.com/knative/serving/blob/master/docs/scaling/DEVELOPMENT.md" target="_blank" rel="noopener noreferrer">Knative Serving Activator</a>에 의해서 Pod가 없는 Revision을 확인하고 Cold Start 형태로 프로비저닝하게 된다. 나는 이게 진정한 서버리스라고 생각하지만 주변에 반박하시는 분들도 간혹 있다.</p><p>이후 Pod가 Warm 상태가 되고 나면 Istio Route(Ingress Gateway)를 통해 트래픽이 Pod로 전달되어 통신이 이뤄지게 된다.</p><p>현재 Knative는 현재 Ingress Gateway 의존성을 가지고 있고 Envoy기반 Service Mesh인 <code>Istio</code>, Envoy기반 API Gateway인 <code>Gloo</code> 두가지 옵션으로 Ingress 구현이 가능하다.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="istio">Istio<a class="hash-link" href="#istio" title="Direct link to heading">​</a></h2><p>Knative는 기본적으로 Ingress Gateway기능을 탑재하고 있는데 이는 Istio의 기능중 하나다.<br>
<!-- -->Istio는 다음과 같은 Core Feature를 가진다. 상세한 내용은 <a href="https://istio.io/docs/concepts/what-is-istio/" target="_blank" rel="noopener noreferrer">https://istio.io/docs/concepts/what-is-istio/</a> 에서 확인하면 된다.</p><ul><li>Traffic management</li><li>Security</li><li>Policies and Telemetry</li><li>Performance and Scalability</li></ul><p>Istio는 48개의 <code>CRDs</code>(CustomResourceDefinition objects)를 가지고 있는데 이중 Knative Serving에서 사용하는건 <code>VirtualService</code> 단 하나다.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="gloo">Gloo<a class="hash-link" href="#gloo" title="Direct link to heading">​</a></h2><p><a href="https://gloo.solo.io/" target="_blank" rel="noopener noreferrer">Gloo</a>는 Kubernetes-native ingress controller이자 <a href="https://medium.com/solo-io/announcing-gloo-the-function-gateway-3f0860ef6600" target="_blank" rel="noopener noreferrer">Next Generation API Gateway</a> 를 위해 시작된 프로젝트이다. 실제 Redhat에서 Openshift기반 Microservice 및 Istio 개발업무를 하다가 최근에 solo.io의 CTO로 이직한 <a href="https://blog.christianposta.com/" target="_blank" rel="noopener noreferrer">Christian Posta</a>가 밀고 있는 프로젝트이기도 하다. </p><p><img loading="lazy" src="https://cdn-images-1.medium.com/max/1600/0*Z0Jb5DJFOyeY91sN." alt="gloo" class="img_E7b_"></p><p><code>Gloo</code>는 Envoy Proxy 기반으로 동작하며
기존 Legacy부터 Container서비스, FaaS(AWS Lambda, Azure Functions, GCP Functions)영역의 Application들을 REST, gRPC, SOAP, Web Socker기반으로 Aggregate 해서 Function 기반 추상화를 구현해 주는 오픈소스 프로젝트라 정의 할 수 있다. </p><p>Istio의 Ingress기능외의 여러가지 부가 기능(Telemetry, Security, Policy Enforcement)들은 Knative에서는 필요로 하지 않는다. </p><p>Knative API Gateway 로서 Istio가 아닌 Gloo가 조금더 경량화된 대안으로 결정되었고 Gloo를 통해 Knative 설치가 가능하게 되었다. 단, Knative Eventing 컴포넌트는 현재 지원하지 않는다고 한다. </p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="install-knative-with-gloo">Install Knative with Gloo<a class="hash-link" href="#install-knative-with-gloo" title="Direct link to heading">​</a></h2><p>참고: <a href="https://github.com/knative/docs/blob/master/install/Knative-with-Gloo.md" target="_blank" rel="noopener noreferrer">Install with Gloo</a></p><p>간단하게 gloo와 Knative 설치를 해보자.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="requirements">Requirements<a class="hash-link" href="#requirements" title="Direct link to heading">​</a></h3><ul><li>Kubernetes cluster v1.11 or newer </li><li>Enable <a href="https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#how-do-i-turn-on-an-admission-controller" target="_blank" rel="noopener noreferrer">MutatingAdmissionWebhook admission controller</a></li><li>kubectl v1.10 or newer</li><li>Bash in Mac or Linux</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="install-glooctl">Install Glooctl<a class="hash-link" href="#install-glooctl" title="Direct link to heading">​</a></h3><p>gloo CLI (glooctl) Download<br>
<a href="https://github.com/solo-io/gloo/releases" target="_blank" rel="noopener noreferrer">https://github.com/solo-io/gloo/releases</a></p><p>또는 직접 Download</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ curl -sL https://run.solo.io/gloo/install | sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Attempting to download glooctl version v0.8.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Downloading glooctl-darwin-amd64...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Download complete!, validating checksum...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Checksum valid.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Gloo was successfully installed 🎉</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Add the gloo CLI to your path with:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  export PATH=$HOME/.gloo/bin:$PATH</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Now run:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  glooctl install gateway     # install gloo&#x27;s function gateway functionality into the &#x27;gloo-system&#x27; namespace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  glooctl install ingress     # install very basic Kubernetes Ingress support with Gloo into namespace gloo-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  glooctl install knative     # install Knative serving with Gloo configured as the default cluster ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Please see visit the Gloo Installation guides for more:  https://gloo.solo.io/installation/</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>PATH 등록</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ export PATH=$HOME/.gloo/bin:$PATH</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>gloo CLI 확인</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ glooctl --version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">glooctl version 0.8.1</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>GCP 무료플랜으로 3-node 클러스터를 생성한다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ gcloud container clusters create gloo \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --region=asia-east1-a \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --cluster-version=latest \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --machine-type=n1-standard-2 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --enable-autorepair \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --num-nodes=3</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>cluster 생성된것을 확인하고 cluster-admin 권한을 할당한다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get nodes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                  STATUS    ROLES     AGE       VERSION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gke-gloo-default-pool-f6bcc479-f8v9   Ready     &lt;none&gt;    9m        v1.11.7-gke.6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gke-gloo-default-pool-f6bcc479-fl78   Ready     &lt;none&gt;    9m        v1.11.7-gke.6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gke-gloo-default-pool-f6bcc479-gfgw   Ready     &lt;none&gt;    9m        v1.11.7-gke.6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl create clusterrolebinding cluster-admin-binding \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt;   --clusterrole=cluster-admin \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt;   --user=$(gcloud config get-value core/account)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Your active configuration is: [cloudshell-25974]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clusterrolebinding.rbac.authorization.k8s.io &quot;cluster-admin-binding&quot; created</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Gloo와 Knative 설치를 한다. 미리 <code>glooctl install knative --dry-run</code> 으로 전체 manifest를 확인할 수 있다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ glooctl install knative</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>위에서 설치 과정은 생략했지만 Istio에 비해 CRD 개수가 적은 것을 알수있다. 또한 설치된 컴포넌트 역시 Istio에 비해서 간소화된 것을 알수 있다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pods --namespace gloo-system                                                                                         </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                   READY     STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clusteringress-proxy-59fd6fb56-dmwwm   1/1       Running   0          7m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">discovery-779884d4cc-xlql2             1/1       Running   6          7m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gloo-844fc79445-f4zvg                  1/1       Running   6          7m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ingress-7d75c99874-s4m76               1/1       Running   6          7m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pods --namespace knative-serving</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                          READY     STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">activator-746f6bb684-49tfh    1/1       Running   0          12m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">autoscaler-955f679cd-tx5vw    1/1       Running   0          12m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">controller-7fc84c6584-jbn69   1/1       Running   0          12m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">webhook-7797ffb6bf-6pgsw      1/1       Running   0          12m</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>이전 포스팅에서도 사용했던 <code>gcr.io/knative-sample/helloworld-go</code> 이미지를 활용하여 샘플앱 Knative Service를 만든다.</p><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="serviceyaml">service.yaml<a class="hash-link" href="#serviceyaml" title="Direct link to heading">​</a></h4><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ vi service.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: serving.knative.dev/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: helloworld-go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  namespace: default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  runLatest:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    configuration:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      revisionTemplate:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          container:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            image: gcr.io/knative-sample/helloworld-go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            env:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              - name: TARGET</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                value: &quot;Go Sample v1&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl apply --filename service.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service.serving.knative.dev &quot;helloworld-go&quot; created</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>앞에서도 설명했지만 <code>Automatic scaling up and down to zero</code> 으로 Cold Start가 되고 잠시후에 아래와 같이 Knative Service를 확인할 수 있다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get ksvc helloworld-go -n default  --output=custom-columns=NAME:.metadata.name,DOMAIN:.status.domain]($ kubectl get ksvc helloworld-go -n default  --output=custom-columns=NAME:.metadata.name,DOMAIN:.status.d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">omain</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME            DOMAIN</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helloworld-go   helloworld-go.default.example.com</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Gloo Ingress를 확인한다. GKE에서 설치했기 때문에 자동으로 LoadBalancer가 연동되어 있는것을 확인할 수 있다. </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get svc -n gloo-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                   TYPE           CLUSTER-IP     EXTERNAL-IP   PORT(S)                      AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clusteringress-proxy   LoadBalancer   10.3.244.54    34.**.**.54   80:30978/TCP,443:32448/TCP   39m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gloo                   ClusterIP      10.3.243.231   &lt;none&gt;        9977/TCP                     39m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ glooctl proxy url --name clusteringress-proxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">http://34.**.**.54:80</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>위에서 얻은 두가지 정보로 생성된 app을 테스트한다. Cold Start(default timeout 5분) 때문에 응답이 늦어질 수도 있지만 잠시 기다리면 응답을 확인할 수 있다.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ curl -H &quot;Host: helloworld-go.default.example.com&quot; http://34.**.**.54:80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Hello Go Sample v1!</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>물론 <code>Revision</code>이나 <code>Route</code>를 활용하여 Knative의 기능에 대해서도 확인이 가능하다.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="정리">정리<a class="hash-link" href="#정리" title="Direct link to heading">​</a></h2><p>Gloo는 Knative ClusterIngress CRD를 기반으로 동작하는 Istio의 대안으로서 가능성을 보여주고 있다. 이외에도 The Service Mesh Orchestration Platform <code>SuperGloo</code>, Debugger for microservices <code>Squash</code> 등 다양한 Mesh Layer기반의 오픈소스들을 확인할수 있다. 또다른 스쳐지나갈수도 있는 오픈소스일수도 있겠지만 현재 개발되는 로드맵(<a href="https://www.solo.io/)%EC%9D%84" target="_blank" rel="noopener noreferrer">https://www.solo.io/)을</a> 보면 Knative가 고도화되는 여정에 같이 가는 모습을 확인할 수 있다. </p><p>next-generation API Gateway로서 다양한 프로토콜을 지원하기 때문에 (HTTP1, HTTP2, gRPC, REST/OpenAPISpec, SOAP, WebSockets, Lambda/Cloud Functions) 더욱더 Microservices 및 Serverless Workload를 수행하기에 더욱 적합한 오픈소스로 보인다. </p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="다음-주제">다음 주제<a class="hash-link" href="#다음-주제" title="Direct link to heading">​</a></h2><p>현재 해보고 싶은것은 베어메탈 Kubernetes Cluster기반 BGP로 동작하는 <a href="https://metallb.universe.tf/" target="_blank" rel="noopener noreferrer">MetalLB</a>나 <a href="https://cilium.io/try-eks/" target="_blank" rel="noopener noreferrer">Cillium on AWS</a> 인데 시간나는 대로 테스트 해봐야 겠다.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/knative/">Knative</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/kubernetes/">Kubernetes</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/faa-s/">FaaS</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/serverless/">Serverless</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/cr-ds/">CRDs</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/cloud-events/">CloudEvents</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/mesh/">Mesh</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/gloo/">Gloo</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Knative with Gloo" href="/kubernetes/knative-using-gloo/"><b>Read More</b></a></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/tags/kubernetes/page/2/"><div class="pagination-nav__label">Newer Entries</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/tags/kubernetes/page/4/"><div class="pagination-nav__label">Older Entries</div></a></div></nav></main></div></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Blog</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/">Home</a></li><li class="footer__item"><a class="footer__link-item" href="/archive/">Archive</a></li><li class="footer__item"><a class="footer__link-item" href="/tags/">Tags</a></li></ul></div><div class="col footer__col"><div class="footer__title">Sponsors</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/pang4u/">Pang4U</a></li><li class="footer__item"><a href="https://ko-fi.com/ddiiwoong" target="_blank" rel="noopener noreferrer" class="footer__link-item">Buy Me a Coffee<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/ddiiwoong" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/ddiiwoong" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.facebook.com/ddiiwoong" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://kr.linkedin.com/in/ddiiwoong" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div></div></footer></div>
<script src="/assets/js/runtime~main.013d1f47.js"></script>
<script src="/assets/js/main.f4c31e34.js"></script>
</body>
</html>