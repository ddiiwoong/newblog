"use strict";(self.webpackChunkddii=self.webpackChunkddii||[]).push([[5166],{3905:function(e,n,t){t.d(n,{Zo:function(){return p},kt:function(){return k}});var a=t(67294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function o(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function i(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?o(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):o(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function s(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)t=o[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)t=o[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var l=a.createContext({}),u=function(e){var n=a.useContext(l),t=n;return e&&(t="function"==typeof e?e(n):i(i({},n),e)),t},p=function(e){var n=u(e.components);return a.createElement(l.Provider,{value:n},e.children)},m={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},c=a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,o=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),c=u(t),k=r,N=c["".concat(l,".").concat(k)]||c[k]||m[k]||o;return t?a.createElement(N,i(i({ref:n},p),{},{components:t})):a.createElement(N,i({ref:n},p))}));function k(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var o=t.length,i=new Array(o);i[0]=c;var s={};for(var l in n)hasOwnProperty.call(n,l)&&(s[l]=n[l]);s.originalType=e,s.mdxType="string"==typeof e?e:r,i[1]=s;for(var u=2;u<o;u++)i[u]=t[u];return a.createElement.apply(null,i)}return a.createElement.apply(null,t)}c.displayName="MDXCreateElement"},43355:function(e,n,t){t.r(n),t.d(n,{assets:function(){return p},contentTitle:function(){return l},default:function(){return k},frontMatter:function(){return s},metadata:function(){return u},toc:function(){return m}});var a=t(87462),r=t(63366),o=(t(67294),t(3905)),i=["components"],s={layout:"single",title:"EKS CNI Custom Networking",comments:!0,classes:"wide",description:"Terraform null_resource\ub97c \ud65c\uc6a9\ud558\uc5ec EKS CNI network\ub97c \uad6c\uc131\ud558\ub294 \ubc29\ubc95",authors:"jinwoong",toc:!0,toc_label:"Table of Contents",slug:"kubernetes/eks-cni-custom/",date:new Date("2022-12-16T00:00:00.000Z"),categories:["Kubernetes"],tags:["Kubernetes","EKS","CNI","Terraform"]},l=void 0,u={permalink:"/kubernetes/eks-cni-custom/",editUrl:"https://github.com/ddiiwoong/newblog/tree/main/blog/2022-12-16-eks-cni-custom.md",source:"@site/blog/2022-12-16-eks-cni-custom.md",title:"EKS CNI Custom Networking",description:"Terraform null_resource\ub97c \ud65c\uc6a9\ud558\uc5ec EKS CNI network\ub97c \uad6c\uc131\ud558\ub294 \ubc29\ubc95",date:"2022-12-16T00:00:00.000Z",formattedDate:"December 16, 2022",tags:[{label:"Kubernetes",permalink:"/tags/kubernetes"},{label:"EKS",permalink:"/tags/eks"},{label:"CNI",permalink:"/tags/cni"},{label:"Terraform",permalink:"/tags/terraform"}],readingTime:10.79,truncated:!0,authors:[{name:"Jinwoong Kim",title:"Technologist and Cloud Consultant",url:"https://www.linkedin.com/in/ddiiwoong/",imageURL:"https://s.gravatar.com/avatar/e8bfebcbeacb5b9a0c90614e792febf2?s=80",key:"jinwoong"}],frontMatter:{layout:"single",title:"EKS CNI Custom Networking",comments:!0,classes:"wide",description:"Terraform null_resource\ub97c \ud65c\uc6a9\ud558\uc5ec EKS CNI network\ub97c \uad6c\uc131\ud558\ub294 \ubc29\ubc95",authors:"jinwoong",toc:!0,toc_label:"Table of Contents",slug:"kubernetes/eks-cni-custom/",date:"2022-12-16T00:00:00.000Z",categories:["Kubernetes"],tags:["Kubernetes","EKS","CNI","Terraform"]},prevItem:{title:"kOps with Cilium",permalink:"/kubernetes/kops-cilium/"},nextItem:{title:"EKS Anywhere Advanced Usages",permalink:"/kubernetes/eks-anywhere-adv/"}},p={authorsImageUrls:[void 0]},m=[{value:"EKS CNI Networking \uc81c\uc57d\uc0ac\ud56d",id:"eks-cni-networking-\uc81c\uc57d\uc0ac\ud56d",level:2},{value:"Terraform \uc73c\ub85c CNI \uad6c\uc131\ud558\ub294 \uc2a4\ud06c\ub9bd\ud2b8 \uc2e4\ud589",id:"terraform-\uc73c\ub85c-cni-\uad6c\uc131\ud558\ub294-\uc2a4\ud06c\ub9bd\ud2b8-\uc2e4\ud589",level:2},{value:"\uc815\ub9ac",id:"\uc815\ub9ac",level:2}],c={toc:m};function k(e){var n=e.components,t=(0,r.Z)(e,i);return(0,o.kt)("wrapper",(0,a.Z)({},c,t,{components:n,mdxType:"MDXLayout"}),(0,o.kt)("h2",{id:"eks-cni-networking-\uc81c\uc57d\uc0ac\ud56d"},"EKS CNI Networking \uc81c\uc57d\uc0ac\ud56d"),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/cni-custom-network.html#custom-networking-automatically-apply-eniconfig"},"https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/cni-custom-network.html#custom-networking-automatically-apply-eniconfig"),"  "),(0,o.kt)("p",null,"AWS\uc5d0\ub294 \uae30\ubcf8 ENI\uac00 \ud3ec\ud568\ub41c \uc11c\ube0c\ub137\uc5d0\uc11c \uc0ac\uc6a9\ud560 \uc218 \uc788\ub294 IP\uac1c\uc218\ub294 \uc81c\ud55c\ub418\uc5b4 \uc788\ub2e4. \ud30c\ub4dc\uc758 \uc218 \uc81c\ud55c\uc774 \ubc1c\uc0dd\ud560 \uc218 \uc788\uae30 \ub54c\ubb38\uc5d0 secondary ENI\uc5d0 \ub2e4\ub978 \uc11c\ube0c\ub137\uc744 \uc0ac\uc6a9\ud558\uc5ec \uac00\uc6a9 IP\uac1c\uc218\ub97c \ub298\ub9b4\uc218 \uc788\ub2e4. \ub610\ud55c \ubcf4\uc548\uc0c1\uc758 \uc774\uc720\ub85c \ud30c\ub4dc\ub294 \ub178\ub4dc\uc758 \uae30\ubcf8 \ub124\ud2b8\uc6cc\ud06c \uc778\ud130\ud398\uc774\uc2a4\uc640 \ub2e4\ub978 \uc11c\ube0c\ub137 \ub610\ub294 \ubcf4\uc548 \uadf8\ub8f9\uc744 \uc0ac\uc6a9\ud574\uc57c \ud560 \uc218 \uc788\ub2e4.   "),(0,o.kt)("p",null,"CNI Custom Networking\uc774 \ud65c\uc131\ud654\uac00 \ub418\uba74 \ud30c\ub4dc\ub294 \ub2e4\ub978 \uc11c\ube0c\ub137\uc5d0 \uc0dd\uc131\uc774 \ub418\uace0, \ub178\ub4dc \uc11c\ube0c\ub137\uc758 \uc544\uc774\ud53c\ub97c \uc0ac\uc6a9\ud558\uc9c0 \uc54a\ub294\ub2e4."),(0,o.kt)("p",null,"EKS\uc5d0\uc11c \ud30c\ub4dc \ub300\uc5ed\uc744 \ubd84\ub9ac \ud558\uae30 \uc704\ud574\uc11c CNI Custom Networking \uc124\uc815\uc744 \uc9c4\ud589\ud55c\ub2e4. \ud574\ub2f9 env \uac12\uc744 \ubcc0\uacbd\ud558\uba74 \uc989\uc2dc aws-node \uac00 \uad50\uccb4\ub41c\ub2e4."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"kubectl set env daemonset aws-node -n kube-system AWS_VPC_K8S_CNI_CUSTOM_NETWORK_CFG=true\n")),(0,o.kt)("p",null,"\ud30c\ub4dc\ub97c \ubc30\ud3ec\ud558\ub824\ub294 \uac01 \uc11c\ube0c\ub137\uc5d0 \ub300\ud574\uc11c \uc544\ub798\uc640 \uac19\uc740 \ud615\uc2dd\uc73c\ub85c ENIConfig \ub9ac\uc18c\uc2a4\ub97c \uc0dd\uc131\ud574\uc57c \ud55c\ub2e4. \uc0ac\uc6a9\ud558\ub824\ub294 \uc11c\ube0c\ub137\uacfc SG\uc744 \uc120\uc5b8\ud574\uc57c \uae30\ubcf8\uc801\uc778 \uad6c\uc131\uc774 \uac00\ub2a5\ud558\ub2e4. "),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'apiVersion: crd.k8s.amazonaws.com/v1alpha1  \nkind: ENIConfig  \nmetadata:  \nname: "ap-northeast-2a"  \nspec:  \nsubnet: "${subnet_a}"  \nsecurityGroups:  \n- ${NODE_SG}  \n  \napiVersion: crd.k8s.amazonaws.com/v1alpha1  \nkind: ENIConfig  \nmetadata:  \nname: "ap-northeast-2b"  \nspec:  \nsubnet: "${subnet_c}"  \nsecurityGroups:  \n- ${NODE_SG}  \n  \napiVersion: crd.k8s.amazonaws.com/v1alpha1  \nkind: ENIConfig  \nmetadata:  \nname: "ap-northeast-2c"  \nspec:  \nsubnet: "${subnet_d}"  \nsecurityGroups:  \n- ${NODE_SG}\n')),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"aws-node")," ",(0,o.kt)("inlineCode",{parentName:"p"},"DaemonSet"),"\ub97c \uc5c5\ub370\uc774\ud2b8\ud558\uc5ec \ud074\ub7ec\uc2a4\ud130\uc5d0 \uc0dd\uc131\ub41c \ubaa8\ub4e0 \ub178\ub4dc\uc5d0 \uac00\uc6a9 \uc601\uc5ed\uc758 ",(0,o.kt)("inlineCode",{parentName:"p"},"ENIConfig"),"\ub97c \uc790\ub3d9\uc73c\ub85c \uc801\uc6a9\ud560 \uc218 \uc788\ub2e4."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"kubectl set env daemonset aws-node -n kube-system ENI_CONFIG_LABEL_DEF=topology.kubernetes.io/zone\n")),(0,o.kt)("p",null,"\uc774\ub54c \uba87\uac00\uc9c0 \uc81c\uc57d\uc0ac\ud56d\uc774 \uc0dd\uae30\uac8c \ub41c\ub2e4."),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"\ud574\ub2f9 \uc124\uc815\uc744 \ubc30\ud3ec\ud558\uace0 \ub09c \uc774\ud6c4 \ucd94\uac00\ub41c \ub178\ub4dc\uc5d0 \ub300\ud574\uc11c\ub9cc \uc0c8\ub85c\uc6b4 \uc11c\ube0c\ub137 IP\ub85c \ud560\ub2f9\uc774 \ub418\uae30 \ub54c\ubb38\uc5d0, \uae30\uc874 \ub178\ub4dc\ub97c \uc7ac\uc2dc\uc791\ud558\uac70\ub098 \uc0ad\uc81c\ub97c \ud574\uc57c \ud30c\ub4dc\uc5d0 \uc0c8\ub85c\uc6b4 IP\uac00 \ud560\ub2f9\uc774 \ub41c\ub2e4.")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"CNI Custom Networking \uc124\uc815\uc5d0\uc11c\ub294 \ub2e4\uc911 \uc11c\ube0c\ub137\uc744 \ud560\ub2f9\ud560 \uc218 \uc5c6\uace0 \uc11c\ube0c\ub137 \ubcc4\ub85c custom name\uc73c\ub85c \uc124\uc815\ud558\uace0 \ubaa8\ub4e0 node \uac01\uac01\uc5d0 \uc785\ub825\ud55c \ubcc4\ub3c4\uc758 annotation\uc744 \ucd94\uac00\ud574\uc57c\ud55c\ub2e4. (",(0,o.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/cni-custom-network.html#custom-networking-deploy-nodes"},"https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/cni-custom-network.html#custom-networking-deploy-nodes"),")")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"AWS\uc758 \uc778\uc2a4\ud134\uc2a4 \ud0c0\uc785\ubcc4 ENI \uac1c\uc218 \uc81c\ud55c\uc73c\ub85c Pod \uc0dd\uc131\uc774 \ubd88\uac00\ub2a5\ud560 \uc218 \uc788\uc73c\ubbc0\ub85c Kubelet BootstrapArguments \ud30c\ub77c\ubbf8\ud130\ub97c launch template \uc5d0\uc11c \uc0ac\uc804\uc5d0 \uc815\uc758\ub41c \uac12\uc73c\ub85c \ubcc0\uacbd\ud558\uc5ec \ub178\ub4dc\uac00 \uc0dd\uc131\ub418\ub3c4\ub85d \ud55c\ub2e4.")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"MAX PODS = (Number of network interfaces \xd7 ","[the number of IP addresses per network interface \u2013 1]",") + 2")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},(0,o.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-eni.html#AvailableIpPerENI"},"https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-eni.html#AvailableIpPerENI")))),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'MIME-Version: 1.0\nContent-Type: multipart/mixed; boundary="==MYBOUNDARY=="\n\n--==MYBOUNDARY==\nContent-Type: text/x-shellscript; charset="us-ascii"\n#!/bin/bash\n/etc/eks/bootstrap.sh {Cluster Name} --use-max-pods false --kubelet-extra-args \'--max-pods=110\'--==MYBOUNDARY==--\\\n')),(0,o.kt)("p",null,"\uc774\ub7ec\ud55c \uc81c\uc57d\uc0ac\ud56d\ub4e4\uc744 \ucc98\ub9ac\ud558\uae30 \uc704\ud574\uc11c CNI Custom Networking \uad6c\ud604\uc744 Terraform Pipeline\uc73c\ub85c \uad6c\ud604\uc744 \uc9c4\ud589\ud55c\ub2e4."),(0,o.kt)("h2",{id:"terraform-\uc73c\ub85c-cni-\uad6c\uc131\ud558\ub294-\uc2a4\ud06c\ub9bd\ud2b8-\uc2e4\ud589"},"Terraform \uc73c\ub85c CNI \uad6c\uc131\ud558\ub294 \uc2a4\ud06c\ub9bd\ud2b8 \uc2e4\ud589"),(0,o.kt)("p",null,"EKS\ub97c \ud504\ub85c\ube44\uc800\ub2dd \ud558\ub294 Terraform \ucf54\ub4dc\ub294 \ub9ce\uc774 \uacf5\uac1c\ub418\uc5b4 \uc788\uae30 \ub54c\ubb38\uc5d0 \uc774\ubc88 \ud3ec\uc2a4\ud2b8\uc5d0\uc11c\ub294 \uc0dd\ub7b5\ud558\uae30\ub85c \ud558\uace0 VPC Custom CNI\ub97c \uad6c\uc131\ud558\ub294 \ubd80\ubd84\ub9cc \uc0b4\ud3b4\ubcf4\uc790."),(0,o.kt)("p",null,"\uae30\ubcf8\uc801\uc73c\ub85c VPC CNI\ub97c \ubc30\ud3ec\ud558\uac8c \ub418\uba74 aws-node \uc7ac\uc2dc\uc791\uc774 \ub418\uae30 \ub54c\ubb38\uc5d0 Workload NodeGroup\uc774 \uad6c\uc131\ub418\uae30 \uc774\uc804\uc5d0 \uc544\ub798 \uc2a4\ud06c\ub9bd\ud2b8\ub97c ",(0,o.kt)("inlineCode",{parentName:"p"},"null_resource")," \ub9ac\uc18c\uc2a4\ub97c \uc0ac\uc6a9\ud558\uc5ec \ub2e4\uc74c\uacfc \uac19\uc740 \uc21c\uc11c\ub85c Batch\ub97c \uc2e4\ud589\ud558\ub3c4\ub85d \ud588\ub2e4."),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"kubectl \uc124\uce58")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"AWS Authentication (Assume role)")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"kubeconfig update")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"VPC CNI Custom manifest (\ubc84\uc804 v1.11.2) \uc801\uc6a9 - ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/aws/amazon-vpc-cni-k8s"},"https://github.com/aws/amazon-vpc-cni-k8s"))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"\uae30\ubcf8 \ud15c\ud50c\ub9bf : ",(0,o.kt)("a",{parentName:"p",href:"https://raw.githubusercontent.com/aws/amazon-vpc-cni-k8s/v1.11.2/config/master/aws-k8s-cni.yaml"},"https://raw.githubusercontent.com/aws/amazon-vpc-cni-k8s/v1.11.2/config/master/aws-k8s-cni.yaml"))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},(0,o.kt)("inlineCode",{parentName:"p"},"ENABLE_POD_ENI=true")," : Security Group for Pods\ub97c \uc704\ud55c \uad6c\uc131\uc73c\ub85c Node\uc5d0 trunk ENI \ucd94\uac00\ub97c \ud558\uae30 \uc704\ud55c ",(0,o.kt)("inlineCode",{parentName:"p"},"vpc.amazonaws.com/has-trunk-attached")," \ub97c \ucd94\uac00\ud55c\ub2e4. "),(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"Pod ENI\ub97c \ud65c\uc131\ud654\ud55c \uacbd\uc6b0 Branch ENI\ub97c \uc0dd\uc131\ud558\ub294 \ubd80\ubd84\uc5d0\uc11c ENI \uc0dd\uc131 ",(0,o.kt)("a",{parentName:"li",href:"https://github.com/aws/amazon-vpc-resource-controller-k8s/blob/master/pkg/aws/vpc/limits.go"},"\uc81c\uc57d\uc0ac\ud56d"),"\uc774 \ubc1c\uc0dd\ud560\uc218 \uc788\ub2e4."))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},(0,o.kt)("inlineCode",{parentName:"p"},"DISABLE_TCP_EARLY_DEMUX=true")," : ",(0,o.kt)("inlineCode",{parentName:"p"},"ENABLE_POD_ENI"),"\uac00 true\ub85c \uc124\uc815\ub41c \uacbd\uc6b0 kubelet\uc774 TCP\ub97c \ud1b5\ud574 \ud3ec\ub4dc \ubcf4\uc548 \uadf8\ub8f9\uc744 \uc0ac\uc6a9\ud558\ub294 \ud3ec\ub4dc\uc5d0 \uc5f0\uacb0\ud558\ub824\uba74 ",(0,o.kt)("inlineCode",{parentName:"p"},"DISABLE_TCP_EARLY_DEMUX"),"\ub97c initcontainers \ucee8\ud14c\uc774\ub108(amazon-k8s-cni-init)\ub97c \ud1b5\ud574 true\ub85c \uc124\uc815\ud574\uc57c \ud55c\ub2e4.")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},(0,o.kt)("inlineCode",{parentName:"p"},"AWS_VPC_K8S_CNI_CUSTOM_NETWORK_CFG=true")," : worker \ub178\ub4dc\uc5d0\uc11c \ud30c\ub4dc\uac00 \ubcc4\ub3c4\uc758 \uc11c\ube0c\ub137 \ubc0f \ubcf4\uc548 \uadf8\ub8f9\uc744 \uc0ac\uc6a9\ud560 \uc218 \uc788\ub2e4\uace0 \uc9c0\uc815\ud55c\ub2e4. IPAMD\uac00 ENI \ud560\ub2f9\uc744 \uc704\ud574 worker \ub178\ub4dc\uc758 ",(0,o.kt)("inlineCode",{parentName:"p"},"ENIConfig"),"\uc5d0\uc11c \uc9c0\uc815\ud55c \ubcf4\uc548 \uadf8\ub8f9\uacfc VPC \uc11c\ube0c\ub137\uc744 \uc0ac\uc6a9\ud558\uac8c \ub41c\ub2e4. ")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},(0,o.kt)("inlineCode",{parentName:"p"},"ENI_CONFIG_LABEL_DEF=topology.kubernetes.io/zone")," - ",(0,o.kt)("inlineCode",{parentName:"p"},"ENIConfig"),"\uc640 \ub9e4\uce6d\ub418\ub3c4\ub85d \ub178\ub4dc\uc5d0\uc11c \uc0ac\uc6a9\ud560 \uac00\uc6a9\uc601\uc5ed\uc744 zone \ubcc4\ub85c \uad6c\uc131\ud558\ub294 label\uc744 \ucd94\uac00\ud55c\ub2e4."),(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"ENIConfig")," \ub77c\ub294 \ucee4\uc2a4\ud140 \ub9ac\uc18c\uc2a4\ub97c \uc0dd\uc131\ud55c\ub2e4. \ud574\ub2f9 \uc124\uc815\uc740 \ud30c\ub4dc\uc6a9 IP\ub300\uc5ed\uc744 \uc704\ud55c secondary ENI\uc5d0 \uc801\uc6a9\ub420 \uac12\uc73c\ub85c subnet id\uc640 sg \uac12\uc744 spec\uc5d0 \uc9c0\uc815\ud574\uc57c \ud55c\ub2e4. \uc544\ub798 subnet\uacfc sg id\ub294 terraform\uc5d0\uc11c EKS\ud074\ub7ec\uc2a4\ud130\uac00 \ud504\ub85c\ube44\uc800\ub2dd \ub420\ub54c \uacb0\uacfc\ub97c env\ub85c \uc800\uc7a5\ub41c \uac12\uc744 \uac00\uc838\uc624\ub294 \ubc29\uc2dd\uc73c\ub85c \ucc98\ub9ac \ud560\uc218 \uc788\ub3c4\ub85d \ud558\uc600\ub2e4."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"ENIConfig"),"\ub97c \uc0ac\uc6a9\ud560 \uac00\uc6a9 \uc601\uc5ed\uacfc \ub3d9\uc77c\ud558\uac8c ",(0,o.kt)("inlineCode",{parentName:"li"},"ENIConfig"),"\uc758 name\uc744 \uc9c0\uc815\ud558\ub294 \uac83\uc774 \uc88b\ub2e4. \ub9cc\uc57d custom name\uc73c\ub85c \uc124\uc815\ud558\uac8c \ub418\uba74 \ubaa8\ub4e0 node \uac01\uac01\uc5d0 \uc785\ub825\ud55c \ubcc4\ub3c4\uc758 annotation\uc744 \ucd94\uac00\ud574\uc57c \ud55c\ub2e4. (",(0,o.kt)("a",{parentName:"li",href:"https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/cni-custom-network.html#custom-networking-deploy-nodes"},"https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/cni-custom-network.html#custom-networking-deploy-nodes"),")"))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},(0,o.kt)("inlineCode",{parentName:"p"},"ENABLE_PREFIX_DELEGATION=true")," \ud30c\ub77c\ubbf8\ud130\ub97c \uc0ac\uc6a9\ud558\uc5ec \ub124\ud2b8\uc6cc\ud06c \uc778\ud130\ud398\uc774\uc2a4\uc5d0 \uc811\ub450\uc0ac\ub97c \ud560\ub2f9\ud558\ub3c4\ub85d VPC CNI \ud50c\ub7ec\uadf8\uc778\uc744 \uad6c\uc131\ud55c\ub2e4. ")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},(0,o.kt)("inlineCode",{parentName:"p"},"WARM_IP_TARGET=1"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"MINIMUM_IP_TARGET=30")),(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"AWS VPC CNI\uc5d0\ub294 \ub450 \uac00\uc9c0 \uad6c\uc131 \uc694\uc18c\uac00 \uc788\ub2e4. CNI \ud50c\ub7ec\uadf8\uc778 \ubc14\uc774\ub108\ub9ac (/opt/cni/bin/aws-cni)\ubc0f \ub85c\uceecIP \uc8fc\uc18c\ub97c \uad00\ub9ac\ud558\ub294 ",(0,o.kt)("inlineCode",{parentName:"li"},"ipamd"),"\ub294 aws-node\ub77c\ub294 kubernetes daemonset \uc73c\ub85c \uc2e4\ud589\ub418\uba70 \uc778\uc2a4\ud134\uc2a4\uc5d0 \uc5f0\uacb0\ub41c \ubaa8\ub4e0 ENI \ubc0f IP\ub97c \ucd94\uc801\ud558\ub294 \ubaa8\ub4e0 \ub178\ub4dc\uc5d0 \ud30c\ub4dc\ub97c \ucd94\uac00\ud55c\ub2e4."),(0,o.kt)("li",{parentName:"ul"},"CNI \ud50c\ub7ec\uadf8\uc778\uc740 \ud638\uc2a4\ud2b8 \ub124\ud2b8\uc6cc\ud06c \uc5f0\uacb0\uacfc \uc62c\ubc14\ub978 \ub124\ud2b8\uc6cc\ud06c \uc778\ud130\ud398\uc774\uc2a4\ub97c \ud30c\ub4dc\uc758 \ub124\uc784\uc2a4\ud398\uc774\uc2a4\uc5d0 \ucd94\uac00\ud558\ub294 \uc5ed\ud560\uc744 \ud55c\ub2e4. CNI \ud50c\ub7ec\uadf8\uc778\uc740 \uc6d0\uaca9 \ud504\ub85c\uc2dc\uc800 \ud638\ucd9c(gRPC)\uc744 \ud1b5\ud574 ",(0,o.kt)("inlineCode",{parentName:"li"},"IPAMD"),"\uc640 \ud1b5\uc2e0\ud55c\ub2e4."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"WARM_IP_TARGET"),"\uc740 ENI \uc804\uccb4\ub97c Warm Pool\ub85c \uac00\uc838\uac00\uc9c0 \uc54a\uace0 \ud2b9\uc815 IP \uac1c\uc218\ub9cc\ud07c\ub9cc Warm Pool\uc744 \ud655\ubcf4\ud558\uaca0\ub2e4\ub77c\ub294 \uc124\uc815\uc774\ub2e4. ",(0,o.kt)("inlineCode",{parentName:"li"},"WARM_IP_TARGET=1"),"\ub85c \uc124\uc815\ub418\uba74 Pod\uc774 \uc0dd\uc131\ub420 \ub54c\ub9c8\ub2e4 Secondary IP\ub97c 1\uac1c\uc529 \ucd94\uac00\ub85c \ud560\ub2f9\ud55c\ub2e4."),(0,o.kt)("li",{parentName:"ul"},"Pod\uc758 \uc0dd\uc131\uacfc \uc885\ub8cc\uac00 \ube48\ubc88\ud55c \uacbd\uc6b0, \uc778\uc2a4\ud134\uc2a4\uc5d0 IP\ub97c Attach/Detach \ud558\ub294 API call\uc758 \uc218\uac00 \ub298\uc5b4\ub098 ENI\ub97c \ucd94\uac00\ud558\uac70\ub098 IP\ub97c \ucd94\uac00\ud558\ub294 throttling\uc744 \ubc29\uc9c0\ud558\uae30 \uc704\ud574 ",(0,o.kt)("inlineCode",{parentName:"li"},"MINIMUM_IP_TARGET"),"\uc744 \ud568\uaed8 \uc124\uc815\ud55c\ub2e4. \ub178\ub4dc\uc5d0 \uc77c\ubc18\uc801\uc73c\ub85c \uc720\uc9c0\ub418\ub294 Pod\uc758 \uc218\ub97c ",(0,o.kt)("inlineCode",{parentName:"li"},"MINIMUM_IP_TARGET"),"\uc73c\ub85c \uc9c0\uc815\ud574 \ub193\uc73c\uba74 \ud574\ub2f9 \uc218\ub9cc\ud07c ENI\uc5d0 \ubbf8\ub9ac IP\uac00 \ud560\ub2f9\ub41c\ub2e4. "),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"WARM_PREFIX_TARGET=1")," \ub294 \uc704 \uc124\uc815\uc744 \uc801\uc6a9\ud558\uba74 \uc7ac\uc815\uc758 \ub41c\ub2e4."))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},(0,o.kt)("inlineCode",{parentName:"p"},"AWS_VPC_K8S_CNI_EXTERNALSNAT=true")," : \ud30c\ub4dc\ubcc4 ENI\uc5d0 \ud560\ub2f9\ub41c IP\uc8fc\uc18c\ub97c \uc81c\uc5b4\ud560\uc218 \uc788\ub3c4\ub85d Node IP\ub85c SNAT \ub418\uc9c0\uc54a\ub3c4\ub85d \uc124\uc815\ud558\ub294 \uad6c\uc131\uc774\ub2e4.")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},(0,o.kt)("inlineCode",{parentName:"p"},"ENIConfig")," \uad6c\uc131\uc744 \uc704\ud574 Pod\uac00 \uc0ac\uc6a9\ud560 \ub300\uc5ed\uc744 \ubcc0\uc218(",(0,o.kt)("inlineCode",{parentName:"p"},"subnet_a"),",",(0,o.kt)("inlineCode",{parentName:"p"},"subnet_b"),",",(0,o.kt)("inlineCode",{parentName:"p"},"subnet_c"),")\ub85c \ubc1b\uc544 kubectl\ub85c \uc124\uc815\ud55c\ub2e4."))),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sh"},'#!/bin/bash  \n \nKUBE_CONFIG="$(mktemp)"  \naws eks update-kubeconfig --name "${CLUSTER_NAME}" --kubeconfig "${KUBE_CONFIG}"  \n  \n## Apply VPC CNI manifests (origin: https://raw.githubusercontent.com/aws/amazon-vpc-cni-k8s/v1.11.2/config/master/aws-k8s-cni.yaml)  \n# Security group for pod env configurations ; ENABLE_POD_ENI=true  \n# https://github.com/aws/amazon-vpc-cni-k8s#disable_tcp_early_demux-v173 ; DISABLE_TCP_EARLY_DEMUX=true  \n# Custom networking ; AWS_VPC_K8S_CNI_CUSTOM_NETWORK_CFG=true  \n# Custom networking ; ENI_CONFIG_LABEL_DEF=topology.kubernetes.io/zone  \n# Custom networking ; WARM_IP_TARGET=1  \n# Custom networking ; MINIMUM_IP_TARGET=30  \n# Custom networking ; WARM_PREFIX_TARGET=1  \n# Fewer API calls required to EC2 control plane ; ENABLE_PREFIX_DELEGATION=true  \n# Source NAT disabled ; AWS_VPC_K8S_CNI_EXTERNALSNAT=true  \n  \nKUBE_CONFIG="$(mktemp)"\naws eks update-kubeconfig --name "${CLUSTER_NAME}" --kubeconfig "${KUBE_CONFIG}"\n\n## Apply VPC CNI manifests (origin: https://raw.githubusercontent.com/aws/amazon-vpc-cni-k8s/v1.11.2/config/master/aws-k8s-cni.yaml)\n# Security group for pod env configurations ; ENABLE_POD_ENI=true\n# https://github.com/aws/amazon-vpc-cni-k8s#disable_tcp_early_demux-v173 ; DISABLE_TCP_EARLY_DEMUX=true\n# Custom networking ; AWS_VPC_K8S_CNI_CUSTOM_NETWORK_CFG=true\n# Custom networking ; ENI_CONFIG_LABEL_DEF=topology.kubernetes.io/zone\n# Custom networking ; WARM_IP_TARGET=1\n# Custom networking ; MINIMUM_IP_TARGET=30\n# Custom networking ; WARM_PREFIX_TARGET=1\n# Fewer API calls required to EC2 control plane ; ENABLE_PREFIX_DELEGATION=true\n# Source NAT disabled ; AWS_VPC_K8S_CNI_EXTERNALSNAT=true\n\nkubectl --kubeconfig "${KUBE_CONFIG}" apply -f ./scripts/aws-k8s-cni.yaml\n\n# set up ENIConfig \nsubnet_a=$(echo ${SUBNETS} |awk -F"," \'{print $1}\')\nsubnet_b=$(echo ${SUBNETS} |awk -F"," \'{print $2}\')\nsubnet_c=$(echo ${SUBNETS} |awk -F"," \'{print $3}\')\n\ncat <<EOF | kubectl --kubeconfig "${KUBE_CONFIG}" apply -f -\napiVersion: crd.k8s.amazonaws.com/v1alpha1\nkind: ENIConfig\nmetadata:\n  name: "ap-northeast-2a"\nspec:\n  subnet: "${subnet_a}"\n  securityGroups:\n  - ${CLUSTER_SG}\nEOF\n\ncat <<EOF | kubectl --kubeconfig "${KUBE_CONFIG}" apply -f -\napiVersion: crd.k8s.amazonaws.com/v1alpha1\nkind: ENIConfig\nmetadata:\n  name: "ap-northeast-2b"\nspec:\n  subnet: "${subnet_b}"\n  securityGroups:\n  - ${CLUSTER_SG}\nEOF\n\ncat <<EOF | kubectl --kubeconfig "${KUBE_CONFIG}" apply -f -\napiVersion: crd.k8s.amazonaws.com/v1alpha1\nkind: ENIConfig\nmetadata:\n  name: "ap-northeast-2c"\nspec:\n  subnet: "${subnet_c}"\n  securityGroups:\n  - ${CLUSTER_SG}\nEOF\n\n# remobe creds\nrm "${KUBE_CONFIG}"\n')),(0,o.kt)("p",null,"\ub2e4\uc74c\uc740 \uc704 \uc2a4\ud06c\ub9bd\ud2b8\ub97c \uc2e4\ud589\ud558\ub294 \ud14c\ub77c\ud3fc \ucf54\ub4dc\uc758 \uc608\uc2dc\uc774\ub2e4."),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"\uae30\ubcf8\uc801\uc73c\ub85c null_resource\ub97c \uc0ac\uc6a9\ud55c\ub2e4. ",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://registry.terraform.io/providers/hashicorp/null/latest/docs/resources/resource"},"https://registry.terraform.io/providers/hashicorp/null/latest/docs/resources/resource")))),(0,o.kt)("li",{parentName:"ul"},"\uc704\uc5d0\uc11c \uc791\uc131\ud55c \uc2a4\ud06c\ub9bd\ud2b8\ub97c network.sh \uc5d0\uc11c \ud658\uacbd\ubcc0\uc218\ub97c \ubc1b\uc544\uc11c \uc2e4\ud589\ud560 \uc218 \uc788\ub3c4\ub85d \uad6c\uc131\ud55c\ub2e4. "),(0,o.kt)("li",{parentName:"ul"},"eks \ubaa8\ub4c8\uc758 \uc758\uc874\uc131\uc744 \uac78\uc5b4 eks \ud074\ub7ec\uc2a4\ud130 \ubc30\ud3ec\uac00 \uc644\ub8cc\ub41c \uc774\ud6c4\uc5d0 \ud574\ub2f9 \uc2a4\ud06c\ub9bd\ud2b8\uac00 \ub3d9\uc791\ud558\ub3c4\ub85d \ud55c\ub2e4. ")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-terraform"},'# Configure CNI custom network\nresource "null_resource" "cni_patch" {\n  triggers = {\n    cluster_name  = local.cluster_name\n    cluster_sg    = module.eks.cluster_primary_security_group_id\n    intra_subnets = join(",", module.vpc.intra_subnets)\n    content       = file("${path.module}/scripts/network.sh")\n  }\n  provisioner "local-exec" {\n    environment = {\n      CLUSTER_NAME = self.triggers.cluster_name\n      CLUSTER_SG   = self.triggers.cluster_sg\n      SUBNETS      = self.triggers.intra_subnets\n    }\n    command     = "${path.cwd}/scripts/network.sh"\n    interpreter = ["bash"]\n  }\n  depends_on = [\n    module.eks\n  ]\n}\n')),(0,o.kt)("h2",{id:"\uc815\ub9ac"},"\uc815\ub9ac"),(0,o.kt)("p",null,"\ucd08\ubc18\uc5d0 \uc5b8\uae09\ud55c EKS CNI Custom Networking \uc81c\uc57d\uc0ac\ud56d\uc744 \ucc98\ub9ac\ud558\uace0 null_resource\ub85c EKS CNI\ub97c \ubc30\ud3ec\ud560 \ub54c \uc6d0\ud558\ub294 \ud615\ud0dc\ub85c \uc218\uc815\ud558\uc5ec ",(0,o.kt)("inlineCode",{parentName:"p"},"aws_node")," \uc7ac\uae30\ub3d9 \uc5c6\uc774 \ubc30\ud3ec\ud558\ub294 \ubc29\ubc95\uc744 \uc791\uc131\ud574\ubd24\ub2e4. "),(0,o.kt)("p",null,"\uc0d8\ud50c \ucf54\ub4dc\ub294 \uc544\ub798 \uc800\uc7a5\uc18c\uc5d0\uc11c \ud655\uc778\ud560 \uc218 \uc788\ub2e4.\n",(0,o.kt)("a",{parentName:"p",href:"https://github.com/jinwoongk/eks-cni-custom"},"https://github.com/jinwoongk/eks-cni-custom")),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"\ud574\ub2f9 \ud3ec\uc2a4\ud305\uc740 \ud604\uc7ac \uc7ac\uc9c1\uc911\uc778 \ud68c\uc0ac\uc5d0 \uad00\ub828\uc774 \uc5c6\uace0, \uac1c\uc778 \uc5ed\ub7c9 \uac1c\ubc1c\uc744 \uc704\ud55c \uc790\ub8cc\ub85c \ud65c\uc6a9\ud560 \uc608\uc815\uc785\ub2c8\ub2e4.")))}k.isMDXComponent=!0}}]);